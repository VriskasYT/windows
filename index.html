<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Windows 12 (UI Simulation)</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    :root{
      --accent: 99 102 241; /* indigo-500 */
      --fg: 255 255 255;
      --fg-muted: 229 231 235;
      --panel: 17 24 39;
      --panel-2: 15 23 42;
      --glass: 255 255 255;
      --glass-alpha: .08;
      --border: 255 255 255;
      --border-alpha: .14;
      --shadow: 0 24px 60px rgba(0,0,0,.45);
      --wallpaper: radial-gradient(1200px 700px at 10% 10%, rgba(99,102,241,.55), transparent 60%),
                   radial-gradient(900px 600px at 80% 25%, rgba(56,189,248,.45), transparent 55%),
                   radial-gradient(900px 700px at 55% 85%, rgba(244,114,182,.35), transparent 60%),
                   linear-gradient(180deg, #070B16, #060915);
      --taskbar-h: 56px;
      --radius: 16px;
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      color: rgb(var(--fg));
      background: #000;
      overflow: hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      user-select: none;
    }

    .wallpaper{ background: var(--wallpaper); background-size: cover; background-position: center; }

    .glass{
      background: rgba(var(--glass), var(--glass-alpha));
      border: 1px solid rgba(var(--border), var(--border-alpha));
      backdrop-filter: blur(18px) saturate(1.2);
      -webkit-backdrop-filter: blur(18px) saturate(1.2);
      box-shadow: var(--shadow);
    }

    .glass-weak{
      background: rgba(var(--glass), .06);
      border: 1px solid rgba(var(--border), .10);
      backdrop-filter: blur(14px) saturate(1.2);
      -webkit-backdrop-filter: blur(14px) saturate(1.2);
    }

    .win-surface{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(20px) saturate(1.2);
      -webkit-backdrop-filter: blur(20px) saturate(1.2);
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      border-radius: var(--radius);
      overflow: hidden;
    }

    /* Transparency off mode */
    html[data-transparency="0"] .glass,
    html[data-transparency="0"] .glass-weak,
    html[data-transparency="0"] .win-surface{
      background: rgba(10, 14, 24, .96) !important;
      border-color: rgba(255,255,255,.14) !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      box-shadow: 0 28px 70px rgba(0,0,0,.55);
    }

    .titlebar{
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px;
      gap: 10px;
      cursor: default;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-bottom: 1px solid rgba(255,255,255,.12);
    }

    html[data-transparency="0"] .titlebar{ background: rgba(255,255,255,.06); }
    .titlebar.dragging{ cursor: grabbing; }

    .titletext{ display:flex; align-items:center; gap:10px; min-width: 0; flex: 1; }

    .titletext .name{
      font-weight: 600;
      letter-spacing: .2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: .95;
    }

    .window-controls button{
      width: 34px;
      height: 28px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.05);
      transition: background .12s ease, border-color .12s ease, transform .12s ease;
    }
    .window-controls button:hover{ background: rgba(255,255,255,.10); transform: translateY(-.5px); }
    .window-controls button.danger:hover{ background: rgba(239,68,68,.35); border-color: rgba(239,68,68,.35); }

    .window-content{ height: calc(100% - 42px); overflow: auto; }

    .resize-handle{
      position: absolute;
      right: 2px;
      bottom: 2px;
      width: 16px;
      height: 16px;
      cursor: nwse-resize;
      opacity: .6;
    }
    .resize-handle:before{
      content: "";
      position:absolute;
      right: 2px;
      bottom: 2px;
      width: 10px;
      height: 10px;
      border-right: 2px solid rgba(255,255,255,.35);
      border-bottom: 2px solid rgba(255,255,255,.35);
      border-bottom-right-radius: 3px;
    }

    /* Window open animation */
    .win-in{ animation: winIn .16s ease-out; }
    @keyframes winIn{
      from{ transform: translateY(8px) scale(.985); opacity: 0; }
      to{ transform: translateY(0) scale(1); opacity: 1; }
    }

    .desktop-icon{
      width: 92px;
      padding: 8px 6px;
      border-radius: 14px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 8px;
      text-align:center;
      color: rgba(255,255,255,.92);
      font-size: 12px;
      line-height: 1.2;
      position: absolute;
      touch-action: none;
      transition: background .12s ease, transform .12s ease, outline-color .12s ease;
    }
    .desktop-icon:hover{ background: rgba(255,255,255,.08); }
    .desktop-icon.selected{ background: rgba(var(--accent), .20); outline: 1px solid rgba(var(--accent), .35); }
    .desktop-icon.dragging{ background: rgba(255,255,255,.10); outline: 1px solid rgba(255,255,255,.25); cursor: grabbing; transform: scale(1.02); }

    .taskbar{ height: var(--taskbar-h); transition: transform .22s ease, opacity .22s ease; }

    /* Taskbar autohide when active window maximized */
    body.tb-autohide #taskbar{
      transform: translateY(calc(var(--taskbar-h) + 18px));
      opacity: 0;
      pointer-events: none;
    }
    body.tb-autohide.tb-reveal #taskbar{
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    .taskbtn{
      height: 40px;
      min-width: 44px;
      padding: 0 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      position: relative;
      transition: background .12s ease, transform .12s ease;
    }
    .taskbtn:hover{ background: rgba(255,255,255,.10); transform: translateY(-.5px); }

    /* Windows 11-like underline */
    .taskbtn.running::after{
      content: "";
      position: absolute;
      bottom: 6px;
      width: 18px;
      height: 3px;
      border-radius: 999px;
      background: rgba(255,255,255,.35);
      opacity: .9;
      transition: width .12s ease, height .12s ease, background .12s ease;
    }
    .taskbtn.active::after{
      width: 26px;
      height: 4px;
      background: rgba(var(--accent), .95);
      opacity: 1;
    }

    .menu-item{ display:flex; align-items:center; gap:10px; padding: 10px 10px; border-radius: 12px; transition: background .12s ease; }
    .menu-item:hover{ background: rgba(255,255,255,.08); }

    .kbd{ font-size: 12px; color: rgba(255,255,255,.65); border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); padding: 2px 6px; border-radius: 8px; }

    .toast{ animation: toastIn .22s ease-out; }
    @keyframes toastIn{
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .scrollbar::-webkit-scrollbar{ width: 10px; height: 10px; }
    .scrollbar::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.12); border-radius: 999px; border: 2px solid transparent; background-clip: content-box; }
    .scrollbar::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,.18); border: 2px solid transparent; background-clip: content-box; }

    .thin-sep{ height: 1px; background: rgba(255,255,255,.10); }

    .snap-hint{
      position:absolute;
      inset: 10px;
      border-radius: 18px;
      border: 2px dashed rgba(var(--accent), .45);
      background: rgba(var(--accent), .08);
      pointer-events:none;
      display:none;
      animation: snapPulse .6s ease-in-out infinite alternate;
    }
    @keyframes snapPulse{
      from{ opacity: .7; }
      to{ opacity: 1; }
    }

    .sleep-overlay{
      position: fixed;
      inset: 0;
      background: radial-gradient(800px 500px at 50% 40%, rgba(255,255,255,.05), transparent 60%), rgba(0,0,0,.75);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 9999;
    }

    /* Night light overlay (doesn't break fixed elements) */
    #nightOverlay{
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 2500;
      display: none;
      background:
        radial-gradient(900px 520px at 50% 20%, rgba(255, 153, 102, .12), transparent 60%),
        radial-gradient(900px 700px at 40% 80%, rgba(255, 170, 120, .08), transparent 65%),
        rgba(255, 120, 70, .07);
      mix-blend-mode: multiply;
      animation: nightFade .18s ease-out;
    }
    @keyframes nightFade{ from{ opacity: 0; } to{ opacity: 1; } }

    /* Small helper */
    .btn{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      transition: background .12s ease, transform .12s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.10); transform: translateY(-.5px); }

    /* Mini games */
    .game-canvas{
      width: 100%;
      max-width: 520px;
      aspect-ratio: 1 / 1;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      display:block;
    }
    .game-panel{
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }

    /* Flyouts animation */
    .flyout{ animation: flyIn .16s ease-out; transform-origin: bottom left; }
    @keyframes flyIn{ from{ transform: translateY(8px) scale(.985); opacity: 0; } to{ transform: translateY(0) scale(1); opacity: 1; } }

    /* Extra animations / micro-interactions */
    .taskbtn:active, .btn:active, .menu-item:active{ transform: scale(.985); }
    .desktop-icon:active{ transform: scale(.99); }

    .win-out{ animation: winOut .14s ease-in forwards; }
    @keyframes winOut{
      from{ transform: translateY(0) scale(1); opacity: 1; }
      to{ transform: translateY(10px) scale(.985); opacity: 0; }
    }

    .win-min{ animation: winMin .16s ease-in forwards; }
    @keyframes winMin{
      from{ transform: translateY(0) scale(1); opacity: 1; }
      to{ transform: translateY(14px) scale(.96); opacity: 0; }
    }

    .fade-swap{ animation: fadeSwap .14s ease-out; }
    @keyframes fadeSwap{ from{ opacity: .2; transform: translateY(4px); } to{ opacity: 1; transform: translateY(0); } }

    .shimmer{
      position: relative;
      overflow: hidden;
    }
    .shimmer:after{
      content:"";
      position:absolute;
      inset:-40px;
      background: linear-gradient(110deg, transparent 30%, rgba(255,255,255,.16) 45%, transparent 60%);
      transform: translateX(-40%);
      animation: shimmer 1.15s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes shimmer{
      from{ transform: translateX(-55%); }
      to{ transform: translateX(55%); }
    }
  </style>
</head>
<body>
  <div id="root" class="relative w-screen h-screen wallpaper">
    <!-- Night light overlay -->
    <div id="nightOverlay"></div>

    <!-- Desktop -->
    <div id="desktop" class="absolute inset-0">
      <div class="absolute inset-0 pointer-events-none"></div>

      <!-- Icons layer -->
      <div id="desktopIcons" class="absolute inset-0"></div>

      <!-- Window layer -->
      <div id="windowLayer" class="absolute inset-0"></div>

      <!-- Snap hint overlay -->
      <div id="snapHint" class="snap-hint"></div>

      <!-- Selection rectangle -->
      <div id="selRect" class="absolute hidden border border-white/30 bg-white/10 rounded-md"></div>

      <!-- Desktop context menu -->
      <div id="ctxMenu" class="hidden absolute z-[5000] w-64 win-surface p-2 flyout">
        <div class="text-xs px-2 py-2 text-white/70">Рабочий стол</div>
        <button data-action="refresh" class="w-full text-left menu-item">
          <span class="w-5 h-5" id="icoRefresh"></span>
          <span>Обновить</span>
          <span class="ml-auto kbd">F5</span>
        </button>
        <div class="thin-sep my-1"></div>
        <div class="px-1">
          <div class="text-xs px-2 py-1 text-white/60">Создать</div>
          <button data-action="new-folder" class="w-full text-left menu-item">
            <span class="w-5 h-5" id="icoFolder"></span>
            <span>Папку</span>
          </button>
          <button data-action="new-note" class="w-full text-left menu-item">
            <span class="w-5 h-5" id="icoNote"></span>
            <span>Текстовый документ</span>
          </button>
        </div>
        <div class="thin-sep my-1"></div>
        <button data-action="personalize" class="w-full text-left menu-item">
          <span class="w-5 h-5" id="icoSettings"></span>
          <span>Персонализация</span>
        </button>
      </div>

      <!-- Icon context menu -->
      <div id="iconMenu" class="hidden absolute z-[5001] w-64 win-surface p-2 flyout"></div>

      <!-- Start menu -->
      <div id="startMenu" class="hidden absolute left-3 bottom-[calc(var(--taskbar-h)+10px)] w-[420px] max-w-[92vw] z-[4000] win-surface flyout">
        <div class="p-3">
          <div class="flex items-center gap-2">
            <div class="flex items-center gap-2 flex-1 min-w-0">
              <span class="w-5 h-5" id="icoSearch"></span>
              <input id="startSearch" class="w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60" placeholder="Поиск приложений, файлов и настроек" />
            </div>
            <button id="btnStartAll" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Все</button>
          </div>

          <div class="mt-3">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">Закреплённые</div>
              <div class="text-xs text-white/60">Подсказка: двойной клик по иконке на рабочем столе</div>
            </div>
            <div id="pinnedGrid" class="mt-2 grid grid-cols-5 gap-2"></div>
          </div>

          <div class="mt-3">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">Рекомендуемое</div>
              <button id="btnClearRecent" class="text-xs text-white/70 hover:text-white">Очистить</button>
            </div>
            <div id="recommended" class="mt-2 space-y-1"></div>
          </div>
        </div>
        <div class="border-t border-white/10 p-3 flex items-center justify-between">
          <button id="btnUser" class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10">
            <span class="w-6 h-6" id="icoUser"></span>
            <span class="text-sm">Локальный пользователь</span>
          </button>
          <div class="flex items-center gap-2">
            <button id="btnPower" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 flex items-center gap-2">
              <span class="w-5 h-5" id="icoPower"></span>
              <span class="text-sm">Питание</span>
            </button>
          </div>
        </div>

        <!-- Power menu -->
        <div id="powerMenu" class="hidden absolute right-3 bottom-16 w-56 win-surface p-2 flyout">
          <button data-power="sleep" class="w-full text-left menu-item">
            <span class="w-5 h-5" id="icoMoon"></span><span>Сон</span>
          </button>
          <button data-power="restart" class="w-full text-left menu-item">
            <span class="w-5 h-5" id="icoRestart"></span><span>Перезагрузка</span>
          </button>
          <button data-power="shutdown" class="w-full text-left menu-item">
            <span class="w-5 h-5" id="icoShutdown"></span><span>Выключение</span>
          </button>
        </div>
      </div>

      <!-- Search flyout (taskbar) -->
      <div id="searchFlyout" class="hidden absolute left-3 bottom-[calc(var(--taskbar-h)+10px)] w-[560px] max-w-[92vw] z-[4000] win-surface flyout">
        <div class="p-3">
          <div class="flex items-center gap-2">
            <span class="w-5 h-5" id="icoSearch2"></span>
            <input id="globalSearch" class="w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60" placeholder="Поиск" />
            <button id="btnSearchClose" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10">Закрыть</button>
          </div>
          <div class="mt-3 grid grid-cols-2 gap-3">
            <div>
              <div class="text-sm font-semibold">Приложения</div>
              <div id="searchApps" class="mt-2 space-y-1"></div>
            </div>
            <div>
              <div class="text-sm font-semibold">Файлы</div>
              <div id="searchFiles" class="mt-2 space-y-1"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick settings -->
      <div id="quickSettings" class="hidden absolute right-3 bottom-[calc(var(--taskbar-h)+10px)] w-[360px] max-w-[92vw] z-[4000] win-surface flyout">
        <div class="p-3">
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold">Быстрые настройки</div>
            <button id="btnOpenSettings" class="text-xs text-white/70 hover:text-white">Открыть параметры</button>
          </div>
          <div class="mt-3 grid grid-cols-3 gap-2">
            <button data-toggle="wifi" class="qs-toggle p-3 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10">
              <div class="flex items-center gap-2">
                <span class="w-5 h-5" id="icoWifi"></span>
                <div class="text-left">
                  <div class="text-sm font-semibold">Wi‑Fi</div>
                  <div class="text-xs text-white/60" data-sub="wifi">Вкл</div>
                </div>
              </div>
            </button>
            <button data-toggle="bt" class="qs-toggle p-3 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10">
              <div class="flex items-center gap-2">
                <span class="w-5 h-5" id="icoBt"></span>
                <div class="text-left">
                  <div class="text-sm font-semibold">Bluetooth</div>
                  <div class="text-xs text-white/60" data-sub="bt">Выкл</div>
                </div>
              </div>
            </button>
            <button data-toggle="night" class="qs-toggle p-3 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10">
              <div class="flex items-center gap-2">
                <span class="w-5 h-5" id="icoNight"></span>
                <div class="text-left">
                  <div class="text-sm font-semibold">Ночной свет</div>
                  <div class="text-xs text-white/60" data-sub="night">Выкл</div>
                </div>
              </div>
            </button>
          </div>
          <div class="mt-3">
            <div class="text-xs text-white/60 mb-2">Громкость</div>
            <input id="volSlider" type="range" min="0" max="100" class="w-full" />
          </div>
        </div>
      </div>

      <!-- Widgets flyout -->
      <div id="widgetsFlyout" class="hidden absolute left-3 bottom-[calc(var(--taskbar-h)+10px)] w-[520px] max-w-[92vw] z-[4000] win-surface flyout">
        <div class="p-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="w-6 h-6" id="icoWidgets"></span>
              <div class="text-sm font-semibold">Виджеты</div>
            </div>
            <button id="btnWidgetsClose" class="text-xs text-white/70 hover:text-white">Закрыть</button>
          </div>
          <div class="mt-3 grid grid-cols-2 gap-3">
            <div class="p-4 rounded-2xl border border-white/10 bg-white/5">
              <div class="text-sm font-semibold">Сводка системы</div>
              <div class="text-xs text-white/70 mt-2" id="sysSummary">—</div>
              <button id="btnBoost" class="mt-3 px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Ускорить (демо)</button>
            </div>
            <div class="p-4 rounded-2xl border border-white/10 bg-white/5">
              <div class="text-sm font-semibold">Фокус‑таймер</div>
              <div class="text-xs text-white/70 mt-2">Помодоро 25:00 — уведомит по завершению</div>
              <div class="mt-3 flex items-center justify-between">
                <div class="text-2xl font-semibold" id="focusTime">25:00</div>
                <div class="flex gap-2">
                  <button id="btnFocusStart" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Старт</button>
                  <button id="btnFocusReset" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Сброс</button>
                </div>
              </div>
            </div>
            <div class="p-4 rounded-2xl border border-white/10 bg-white/5 col-span-2">
              <div class="text-sm font-semibold">Советы</div>
              <div class="text-xs text-white/70 mt-2" id="tipsBox">—</div>
              <div class="mt-3 flex flex-wrap gap-2">
                <button class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm" id="btnTipNext">Следующий совет</button>
                <button class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm" id="btnOpenRun">Win+R: «Выполнить»</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Notification center -->
      <div id="notifCenter" class="hidden absolute right-3 bottom-[calc(var(--taskbar-h)+10px)] w-[380px] max-w-[92vw] z-[4000] win-surface flyout">
        <div class="p-3 flex items-center justify-between">
          <div>
            <div class="text-sm font-semibold">Уведомления</div>
            <div id="notifMeta" class="text-xs text-white/60">—</div>
          </div>
          <button id="btnClearNotifs" class="text-xs text-white/70 hover:text-white">Очистить</button>
        </div>
        <div class="thin-sep"></div>
        <div id="notifList" class="p-2 max-h-[420px] overflow-auto scrollbar"></div>
      </div>

      <!-- Toasts (disabled by default, can be enabled in Settings) -->
      <div id="toasts" class="absolute right-3 bottom-[calc(var(--taskbar-h)+10px)] z-[4500] flex flex-col gap-2"></div>

      <!-- Run dialog -->
      <div id="runDialog" class="hidden absolute left-1/2 top-[18%] -translate-x-1/2 z-[7000] win-surface w-[520px] max-w-[92vw] flyout">
        <div class="p-4">
          <div class="flex items-center gap-2">
            <span class="w-6 h-6" id="icoRun"></span>
            <div class="text-sm font-semibold">Выполнить</div>
            <div class="ml-auto text-xs text-white/60">Win+R</div>
          </div>
          <div class="mt-3 text-xs text-white/70">Введите имя приложения (например: <span class="kbd">notepad</span>, <span class="kbd">store</span>) или URL/поиск.</div>
          <div class="mt-3 flex gap-2">
            <input id="runInput" class="flex-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60" placeholder="Команда" />
            <button id="btnRunOk" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10">ОК</button>
            <button id="btnRunCancel" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10">Отмена</button>
          </div>
          <div class="mt-3 text-xs text-white/60">Поддерживается: запуск приложений, <span class="kbd">win://</span> страницы Edge, и поиск через Яндекс.</div>
        </div>
      </div>

      <!-- Shutdown overlay -->
      <div id="shutdownOverlay" class="hidden absolute inset-0 z-[9998] bg-black/80 backdrop-blur-md flex items-center justify-center">
        <div class="win-surface p-6 w-[520px] max-w-[92vw] text-center">
          <div class="mx-auto w-10 h-10" id="icoWin"></div>
          <div class="mt-3 text-xl font-semibold">Завершение работы</div>
          <div id="shutdownText" class="mt-2 text-white/70">Пожалуйста, подождите…</div>
          <div class="mt-4 flex items-center justify-center gap-2">
            <button id="btnShutdownCancel" class="px-4 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10">Отмена</button>
          </div>
        </div>
      </div>

      <!-- Sleep overlay -->
      <div id="sleepOverlay" class="sleep-overlay">
        <div class="win-surface p-6 w-[520px] max-w-[92vw] text-center">
          <div class="mx-auto w-10 h-10" id="icoLock"></div>
          <div class="mt-3 text-xl font-semibold">Сон</div>
          <div class="mt-2 text-white/70">Нажмите или нажмите любую клавишу, чтобы продолжить</div>
        </div>
      </div>

      <!-- Taskbar -->
      <div id="taskbar" class="taskbar fixed left-2 right-2 bottom-2 z-[3000] glass rounded-[18px] flex items-center justify-between px-2">
        <div class="flex items-center gap-2">
          <button id="btnStart" class="taskbtn">
            <span class="w-6 h-6" id="icoStart"></span>
          </button>
          <button id="btnSearch" class="taskbtn">
            <span class="w-5 h-5" id="icoSearch3"></span>
            <span class="text-sm text-white/80 hidden sm:block">Поиск</span>
          </button>
          <button id="btnWidgets" class="taskbtn" title="Виджеты">
            <span class="w-5 h-5" id="icoWidgets2"></span>
            <span class="text-sm text-white/80 hidden sm:block">Виджеты</span>
          </button>
          <div id="taskApps" class="flex items-center gap-2"></div>
        </div>

        <div class="flex items-center gap-2">
          <button id="btnNotifs" class="taskbtn" title="Уведомления">
            <span class="w-5 h-5" id="icoBell"></span>
            <span id="notifDot" class="hidden absolute -top-1 -right-1 w-2.5 h-2.5 rounded-full bg-[rgb(var(--accent))]"></span>
          </button>
          <button id="btnTray" class="taskbtn" title="Быстрые настройки">
            <div class="flex items-center gap-2">
              <span class="w-5 h-5" id="icoTrayNet"></span>
              <span class="w-5 h-5" id="icoTrayVol"></span>
              <span class="w-5 h-5" id="icoTrayBat"></span>
              <div class="text-right">
                <div id="clock" class="text-sm font-semibold leading-4">--:--</div>
                <div id="date" class="text-[11px] text-white/70 leading-4">--.--.----</div>
              </div>
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Utilities ----------
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const clamp = (v, a, b) => Math.min(b, Math.max(a, v));
    const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
    const fmt2 = (n) => String(n).padStart(2,'0');

    // App versioning (starting from v1)
    const W12_VERSION = '1.0.0';
    const W12_BUILD = 1;

    function h(tag, attrs={}, children=[]) {
      const el = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)) {
        if (k === 'class') el.className = v;
        else if (k.startsWith('on') && typeof v === 'function') el.addEventListener(k.slice(2), v);
        else if (k === 'html') el.innerHTML = v;
        else el.setAttribute(k, v);
      }
      for (const ch of (Array.isArray(children) ? children : [children])) {
        if (ch == null) continue;
        if (typeof ch === 'string') el.appendChild(document.createTextNode(ch));
        else el.appendChild(ch);
      }
      return el;
    }

    function downloadText(filename, text) {
      const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 500);
    }

    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result ?? ''));
        r.onerror = () => reject(r.error);
        r.readAsText(file);
      });
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function isProbablyUrl(v){
      const s = (v||'').trim();
      if (!s) return false;
      if (s.startsWith('win://')) return true;
      if (/^https?:\/\//i.test(s)) return true;
      if (s.includes(' ') || s.includes('\n') || s.includes('\t')) return false;
      return /\.[a-z]{2,}$/i.test(s) || s.includes(':');
    }

    // ---------- Simple inline icons ----------
    const Icons = {
      win: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 5.2 10.4 4v7H3V5.2Z" fill="rgba(255,255,255,.92)"/>
          <path d="M11.6 3.9 21 2.5V11h-9.4V3.9Z" fill="rgba(255,255,255,.82)"/>
          <path d="M3 12.2h7.4v7L3 18V12.2Z" fill="rgba(255,255,255,.82)"/>
          <path d="M11.6 12.2H21v8.5l-9.4-1.4v-7.1Z" fill="rgba(255,255,255,.92)"/>
        </svg>` ,
      store: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 8h16l-1.2 12.5a2 2 0 0 1-2 1.8H7.2a2 2 0 0 1-2-1.8L4 8Z" fill="rgba(56,189,248,.18)" stroke="rgba(255,255,255,.45)"/>
          <path d="M8 10v11M16 10v11" stroke="rgba(255,255,255,.18)"/>
          <path d="M9 8a3 3 0 0 1 6 0" stroke="rgba(255,255,255,.65)" stroke-width="2" stroke-linecap="round"/>
          <path d="M8 12h8" stroke="rgba(255,255,255,.25)"/>
          <path d="M11 15h2" stroke="rgba(99,102,241,.85)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      search: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="rgba(255,255,255,.85)" stroke-width="2"/>
          <path d="M16.6 16.6 21 21" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      folder: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3.5 7.5c0-1.1.9-2 2-2h4l2 2H18.5c1.1 0 2 .9 2 2v7.5c0 1.1-.9 2-2 2h-13c-1.1 0-2-.9-2-2V7.5Z" fill="rgba(255,255,255,.14)" stroke="rgba(255,255,255,.45)"/>
          <path d="M3.8 9h16.4" stroke="rgba(255,255,255,.35)"/>
        </svg>` ,
      note: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M7 3h8l4 4v14H7V3Z" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.45)"/>
          <path d="M15 3v5h5" stroke="rgba(255,255,255,.45)"/>
          <path d="M9 12h9M9 15h9M9 18h7" stroke="rgba(255,255,255,.35)" stroke-linecap="round"/>
        </svg>` ,
      calc: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="6" y="3" width="12" height="18" rx="3" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.45)"/>
          <rect x="8" y="6" width="8" height="3" rx="1" fill="rgba(255,255,255,.18)"/>
          <path d="M9 12h2M13 12h2M9 15h2M13 15h2M9 18h2M13 18h2" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      settings: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 15.2a3.2 3.2 0 1 0 0-6.4 3.2 3.2 0 0 0 0 6.4Z" stroke="rgba(255,255,255,.75)" stroke-width="2"/>
          <path d="M19.4 13a7.9 7.9 0 0 0 0-2l2-1.5-2-3.4-2.3 1a8 8 0 0 0-1.7-1l-.3-2.5H11l-.3 2.5c-.6.2-1.1.6-1.7 1L6.7 6.1l-2 3.4 2 1.5a8 8 0 0 0 0 2l-2 1.5 2 3.4 2.3-1c.5.4 1.1.7 1.7 1l.3 2.5h4l.3-2.5c.6-.2 1.1-.6 1.7-1l2.3 1 2-3.4-2-1.5Z" stroke="rgba(255,255,255,.55)" stroke-width="1.4" stroke-linejoin="round"/>
        </svg>` ,
      edge: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M20.5 12.6c0 5-4.2 8.9-9 8.9-3.8 0-7-2.2-8.3-5.5 2.2 1.4 5.2 1.2 7.1-.6 1.3-1.2 2-3 1.9-4.7-.2-2.6-2.3-4.8-5.1-5.1 1.4-1.7 3.6-2.8 6.1-2.8 4.8 0 7.3 3.6 7.3 7.9Z" fill="rgba(56,189,248,.65)"/>
          <path d="M3.2 16c.6-2.7 3-4.7 5.9-4.7 1.8 0 3.3.7 4.3 1.9-1 .4-1.8.9-2.5 1.6-1.6 1.6-2 3.9-1 5.7-2.6-.4-5-2.2-6.7-4.5Z" fill="rgba(99,102,241,.55)"/>
        </svg>` ,
      bell: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 22a2.2 2.2 0 0 0 2.1-1.5H9.9A2.2 2.2 0 0 0 12 22Z" fill="rgba(255,255,255,.8)"/>
          <path d="M6 9a6 6 0 0 1 12 0c0 6 2 6.5 2 8H4c0-1.5 2-2 2-8Z" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linejoin="round"/>
        </svg>` ,
      wifi: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M2.8 8.6C8.5 3.4 15.5 3.4 21.2 8.6" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
          <path d="M6 12c4.1-3.7 7.9-3.7 12 0" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
          <path d="M9.6 15.5c2.1-1.9 2.7-1.9 4.8 0" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
          <path d="M12 19.5h0" stroke="rgba(255,255,255,.75)" stroke-width="4" stroke-linecap="round"/>
        </svg>` ,
      wifiOff: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M2.8 8.6C6 5.7 9.6 4.5 13.3 4.9" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
          <path d="M21.2 8.6c-.9-.9-1.9-1.7-3-2.3" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
          <path d="M6 12c2-1.8 3.9-2.7 6-2.7" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
          <path d="M12 19.5h0" stroke="rgba(255,255,255,.55)" stroke-width="4" stroke-linecap="round"/>
          <path d="M4 4l16 16" stroke="rgba(239,68,68,.9)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      volume: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 10v4h3l5 4V6L7 10H4Z" fill="rgba(255,255,255,.75)"/>
          <path d="M16 9c1.3 1.3 1.3 4.7 0 6" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
          <path d="M18.5 7c2.6 2.6 2.6 7.4 0 10" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      volumeMute: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 10v4h3l5 4V6L7 10H4Z" fill="rgba(255,255,255,.65)"/>
          <path d="M16 10l5 5M21 10l-5 5" stroke="rgba(239,68,68,.9)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      battery: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="7" width="16" height="10" rx="2" stroke="rgba(255,255,255,.75)" stroke-width="2"/>
          <path d="M21 10v4" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
          <rect x="5" y="9" width="10" height="6" rx="1.5" fill="rgba(34,197,94,.65)"/>
        </svg>` ,
      user: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 12a4.2 4.2 0 1 0 0-8.4A4.2 4.2 0 0 0 12 12Z" fill="rgba(255,255,255,.75)"/>
          <path d="M4 20.2c1.7-4.1 14.3-4.1 16 0" stroke="rgba(255,255,255,.65)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      power: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3v10" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
          <path d="M7 5.2a8 8 0 1 0 10 0" stroke="rgba(255,255,255,.65)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      moon: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M21 14.7A7.6 7.6 0 0 1 9.3 3a6.5 6.5 0 1 0 11.7 11.7Z" fill="rgba(255,255,255,.75)"/>
        </svg>` ,
      restart: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M20 12a8 8 0 1 1-2.3-5.7" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
          <path d="M20 4v6h-6" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      shutdown: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3v10" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
          <path d="M6.5 6.5a8 8 0 1 0 11 0" stroke="rgba(239,68,68,.85)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      lock: (cls='w-10 h-10') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="6" y="11" width="12" height="10" rx="2.5" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.45)"/>
          <path d="M8 11V8.5a4 4 0 0 1 8 0V11" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      dots: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 12h0M12 12h0M18 12h0" stroke="rgba(255,255,255,.8)" stroke-width="4" stroke-linecap="round"/>
        </svg>` ,
      minimize: (cls='w-4 h-4') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 18h12" stroke="rgba(255,255,255,.8)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      maximize: (cls='w-4 h-4') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="7" y="7" width="10" height="10" rx="2" stroke="rgba(255,255,255,.8)" stroke-width="2"/>
        </svg>` ,
      restore: (cls='w-4 h-4') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="8" y="7" width="10" height="10" rx="2" stroke="rgba(255,255,255,.8)" stroke-width="2"/>
          <path d="M7 10V9a2 2 0 0 1 2-2h1" stroke="rgba(255,255,255,.8)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      close: (cls='w-4 h-4') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M7 7l10 10M17 7 7 17" stroke="rgba(255,255,255,.88)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      refresh: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M20 12a8 8 0 1 1-2.3-5.7" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
          <path d="M20 4v6h-6" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      bluetooth: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3v18l6-6-6-6 6-6-6 6-6-6" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>` ,
      night: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M21 14.7A7.6 7.6 0 0 1 9.3 3a6.5 6.5 0 1 0 11.7 11.7Z" stroke="rgba(255,255,255,.75)" stroke-width="2" fill="rgba(255,255,255,.10)"/>
        </svg>`,
      game: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M8 9.5 6.2 7.2A3.2 3.2 0 0 0 3.7 6H3.2C2 6 1 7 1.1 8.2l.6 6.3A3.8 3.8 0 0 0 5.5 18h1.7l2.2-2.2a3 3 0 0 1 4.2 0L15.8 18h1.7a3.8 3.8 0 0 0 3.8-3.5l.6-6.3C22 7 21 6 19.8 6h-.5c-1 0-1.9.5-2.5 1.2L16 9.5" stroke="rgba(255,255,255,.75)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M7.2 12h2.6M8.5 10.7v2.6" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
          <path d="M15.7 11.2h0" stroke="rgba(56,189,248,.9)" stroke-width="4" stroke-linecap="round"/>
          <path d="M18 12.8h0" stroke="rgba(99,102,241,.9)" stroke-width="4" stroke-linecap="round"/>
        </svg>`,
      widgets: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="3" width="8" height="8" rx="2" fill="rgba(56,189,248,.35)" stroke="rgba(255,255,255,.35)"/>
          <rect x="13" y="3" width="8" height="8" rx="2" fill="rgba(99,102,241,.28)" stroke="rgba(255,255,255,.30)"/>
          <rect x="3" y="13" width="8" height="8" rx="2" fill="rgba(244,114,182,.22)" stroke="rgba(255,255,255,.28)"/>
          <rect x="13" y="13" width="8" height="8" rx="2" fill="rgba(34,197,94,.18)" stroke="rgba(255,255,255,.28)"/>
        </svg>`,
      run: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 7.5A3.5 3.5 0 0 1 7.5 4h9A3.5 3.5 0 0 1 20 7.5v9A3.5 3.5 0 0 1 16.5 20h-9A3.5 3.5 0 0 1 4 16.5v-9Z" stroke="rgba(255,255,255,.65)" stroke-width="2"/>
          <path d="M8 12h8" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
          <path d="M13 9l3 3-3 3" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`
    };

    function setIcon(id, svgHtml) {
      const el = document.getElementById(id);
      if (el) el.innerHTML = svgHtml;
    }

    // ---------- Virtual FS ----------
    const FS_KEY = 'w12_fs_v3';
    function fsLoad() {
      try {
        const raw = localStorage.getItem(FS_KEY);
        if (raw) return JSON.parse(raw);
      } catch {}
      return {
        desktop: [
          { type: 'app', appId: 'explorer', name: 'Проводник' },
          { type: 'app', appId: 'edge', name: 'Microsoft Edge' },
          { type: 'app', appId: 'notepad', name: 'Блокнот' },
          { type: 'app', appId: 'calculator', name: 'Калькулятор' },
          { type: 'app', appId: 'store', name: 'Microsoft Store' },
          { type: 'app', appId: 'settings', name: 'Параметры' },
          { type: 'file', fileId: 'readme', name: 'Добро пожаловать.txt', ext: 'txt' }
        ],
        files: {
          readme: {
            id: 'readme',
            name: 'Добро пожаловать.txt',
            ext: 'txt',
            updatedAt: Date.now(),
            content: 'Это демонстрационный интерфейс «Windows 12» в одном HTML.\n\n— Окна: перетаскивание, изменение размера, Snap, сворачивание/разворачивание.\n— Рабочий стол: мультивыделение, рамка выделения, перетаскивание иконок.\n— «Пуск», поиск, быстрые настройки, центр уведомлений.\n— Приложения: Проводник, Блокнот, Калькулятор, Edge (симуляция), Store, Настройки.\n\nMicrosoft Store:\n• Flappy Bird — реализовано.\n• Остальные приложения — «Скоро».\n\nПодсказки:\n• Win — открыть/закрыть «Пуск»\n• Win+R — «Выполнить»\n• Esc — закрыть меню/панели\n• Alt+Tab — переключение окон\n• F5 — обновить рабочий стол\n'
          }
        }
      };
    }
    function fsSave(fs) {
      localStorage.setItem(FS_KEY, JSON.stringify(fs));
    }

    // ---------- Settings persistence ----------
    const UI_KEY = 'w12_ui_v3';
    function uiLoad() {
      try {
        const raw = localStorage.getItem(UI_KEY);
        if (raw) return JSON.parse(raw);
      } catch {}
      return {
        accent: [99,102,241],
        wallpaper: 'aurora',
        dark: true,
        volume: 46,
        toggles: { wifi: true, bt: false, night: false },
        recent: [],
        showToasts: false,
        transparency: true,
        installedApps: ['flappy'],
        edgeTabsBeta: false,
        edgeOpenInsideBeta: false,
        fullscreenPref: false
      };
    }
    function uiSave(ui) {
      localStorage.setItem(UI_KEY, JSON.stringify(ui));
    }

    // ---------- Wallpapers ----------
    const Wallpapers = {
      aurora: `radial-gradient(1200px 700px at 10% 10%, rgba(99,102,241,.55), transparent 60%),
              radial-gradient(900px 600px at 80% 25%, rgba(56,189,248,.45), transparent 55%),
              radial-gradient(900px 700px at 55% 85%, rgba(244,114,182,.35), transparent 60%),
              linear-gradient(180deg, #070B16, #060915)`,
      dunes: `radial-gradient(1000px 700px at 15% 10%, rgba(245,158,11,.30), transparent 60%),
             radial-gradient(900px 650px at 75% 25%, rgba(236,72,153,.22), transparent 60%),
             linear-gradient(180deg, #0b1020, #070b16)`,
      ocean: `radial-gradient(900px 650px at 15% 20%, rgba(34,211,238,.35), transparent 60%),
             radial-gradient(900px 650px at 80% 70%, rgba(59,130,246,.35), transparent 60%),
             linear-gradient(180deg, #051023, #040a18)`,
      graphite: `radial-gradient(1200px 800px at 50% 30%, rgba(255,255,255,.08), transparent 55%),
                linear-gradient(180deg, #0a0a0f, #07070c)`,
      blossom: `radial-gradient(900px 650px at 20% 25%, rgba(244,114,182,.38), transparent 60%),
               radial-gradient(900px 650px at 75% 35%, rgba(99,102,241,.32), transparent 60%),
               linear-gradient(180deg, #0b0b16, #060612)`
    };

    // ---------- App registry ----------
    const ComingSoon = (title, body='Скоро будет доступно в Microsoft Store.') => {
      const wrap = h('div', { class:'p-4' }, [
        h('div', { class:'text-xl font-semibold' }, title),
        h('div', { class:'text-white/70 mt-2' }, body),
        h('div', { class:'mt-4 p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Статус'),
          h('div', { class:'text-xs text-white/70 mt-1' }, 'Скоро (coming soon)')
        ])
      ]);
      return wrap;
    };

    const registry = {
      explorer: {
        id: 'explorer',
        name: 'Проводник',
        iconHtml: Icons.folder('w-6 h-6'),
        defaultSize: {w: 820, h: 520},
        build: (win) => buildExplorer(win)
      },
      notepad: {
        id: 'notepad',
        name: 'Блокнот',
        iconHtml: Icons.note('w-6 h-6'),
        defaultSize: {w: 760, h: 520},
        build: (win) => buildNotepad(win)
      },
      calculator: {
        id: 'calculator',
        name: 'Калькулятор',
        iconHtml: Icons.calc('w-6 h-6'),
        defaultSize: {w: 360, h: 520},
        build: (win) => buildCalculator(win)
      },
      edge: {
        id: 'edge',
        name: 'Microsoft Edge',
        iconHtml: Icons.edge('w-6 h-6'),
        defaultSize: {w: 920, h: 560},
        build: (win) => buildEdge(win)
      },
      store: {
        id: 'store',
        name: 'Microsoft Store',
        iconHtml: Icons.store('w-6 h-6'),
        defaultSize: {w: 980, h: 640},
        build: (win) => buildStore(win)
      },
      settings: {
        id: 'settings',
        name: 'Параметры',
        iconHtml: Icons.settings('w-6 h-6'),
        defaultSize: {w: 920, h: 600},
        build: (win) => buildSettings(win)
      },

      // Apps that are in Store (only Flappy is implemented now)
      flappy: {
        id: 'flappy',
        name: 'Flappy Bird',
        iconHtml: Icons.game('w-6 h-6'),
        defaultSize: {w: 560, h: 720},
        build: (win) => buildFlappy(win)
      },
      snake: {
        id: 'snake',
        name: 'Змейка',
        iconHtml: Icons.game('w-6 h-6'),
        defaultSize: {w: 560, h: 520},
        build: () => ComingSoon('Змейка', 'Игра появится позже. Пока доступна Flappy Bird.')
      },
      tetris: {
        id: 'tetris',
        name: 'Тетрис',
        iconHtml: Icons.game('w-6 h-6'),
        defaultSize: {w: 560, h: 520},
        build: () => ComingSoon('Тетрис', 'Игра появится позже. Пока доступна Flappy Bird.')
      },
      vscode: {
        id: 'vscode',
        name: 'Visual Studio Code',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 3.5 22 5.7v12.6l-4.5 2.2-7.5-6.9 7.5-6.1Z" fill="rgba(56,189,248,.55)"/><path d="M9.9 6.2 6.5 9 3 7.5 2 9l3.2 3-3.2 3 1 1.5L6.5 15l3.4 2.8" stroke="rgba(255,255,255,.7)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
        defaultSize: {w: 980, h: 640},
        build: () => ComingSoon('Visual Studio Code', 'Скоро. В демо будет облегчённый редактор.')
      },
      word: {
        id: 'word',
        name: 'Microsoft Word',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="4" width="16" height="16" rx="3" fill="rgba(59,130,246,.35)" stroke="rgba(255,255,255,.35)"/><path d="M8 8h3l1 5 1-5h3" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
        defaultSize: {w: 980, h: 640},
        build: () => ComingSoon('Microsoft Word', 'Скоро. В демо будет простой редактор документов.')
      },
      excel: {
        id: 'excel',
        name: 'Microsoft Excel',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="4" width="16" height="16" rx="3" fill="rgba(34,197,94,.25)" stroke="rgba(255,255,255,.35)"/><path d="M8 8h8M8 12h8M8 16h8M12 8v8" stroke="rgba(255,255,255,.7)"/></svg>`,
        defaultSize: {w: 980, h: 640},
        build: () => ComingSoon('Microsoft Excel', 'Скоро. В демо будет мини-таблица.')
      }
    };

    const STORE_CATALOG = [
      { id:'flappy', name:'Flappy Bird', category:'Игры', status:'available', iconHtml: registry.flappy.iconHtml, desc:'Реализовано. Управление: Space/Click.' },
      { id:'snake', name:'Змейка', category:'Игры', status:'soon', iconHtml: registry.snake.iconHtml, desc:'Скоро.' },
      { id:'tetris', name:'Тетрис', category:'Игры', status:'soon', iconHtml: registry.tetris.iconHtml, desc:'Скоро.' },
      { id:'vscode', name:'Visual Studio Code', category:'Продуктивность', status:'soon', iconHtml: registry.vscode.iconHtml, desc:'Скоро (демо-редактор кода).' },
      { id:'word', name:'Microsoft Word', category:'Продуктивность', status:'soon', iconHtml: registry.word.iconHtml, desc:'Скоро (демо-документ).' },
      { id:'excel', name:'Microsoft Excel', category:'Продуктивность', status:'soon', iconHtml: registry.excel.iconHtml, desc:'Скоро (демо-таблица).' }
    ];

    const OPTIONAL_APPS = new Set(['flappy','snake','tetris','vscode','word','excel']);

    // ---------- Global state ----------
    const ui = uiLoad();
    const fs = fsLoad();

    const state = {
      windows: new Map(),
      order: [],
      activeWinId: null,
      z: 20,
      dragging: null,
      resizing: null,
      altTabIndex: 0,
      volume: clamp(ui.volume ?? 46, 0, 100),
      toggles: { ...{wifi:true, bt:false, night:false}, ...(ui.toggles || {}) },
      recent: Array.isArray(ui.recent) ? ui.recent : [],
      showToasts: !!ui.showToasts,
      transparency: (ui.transparency ?? true),
      notifications: [],
      focusTimer: { running:false, remainingMs: 25*60*1000, startedAt: null, tickId: null },
      installedApps: new Set(Array.isArray(ui.installedApps) ? ui.installedApps : []),
      edgeTabsBeta: !!ui.edgeTabsBeta,
      edgeOpenInsideBeta: !!ui.edgeOpenInsideBeta,
      fullscreenPref: !!ui.fullscreenPref
    };

    function isInstalled(appId){
      if (!OPTIONAL_APPS.has(appId)) return true;
      return state.installedApps.has(appId);
    }

    // ---------- FS migration + defaults ----------
    function desktopWorkAreaRect() {
      const tb = $('#taskbar');
      const tbRect = tb.getBoundingClientRect();
      return {
        x: 0,
        y: 0,
        w: window.innerWidth,
        h: Math.max(200, window.innerHeight - (tbRect.height + 12))
      };
    }

    function findFreeDesktopSlot(){
      const startX = 16, startY = 16;
      const colW = 104, rowH = 104;
      const area = desktopWorkAreaRect();
      const used = new Set();
      for (const it of fs.desktop || []) {
        if (it.pos && Number.isFinite(it.pos.x) && Number.isFinite(it.pos.y)) {
          used.add(`${Math.round(it.pos.x)}:${Math.round(it.pos.y)}`);
        }
      }
      const maxCols = Math.max(1, Math.floor((area.w - startX) / colW));
      let col = 0, row = 0;
      for (let tries=0; tries<5000; tries++) {
        const x = startX + col*colW;
        const y = startY + row*rowH;
        const key = `${x}:${y}`;
        if (!used.has(key) && x < area.w - 96 && y < area.h - 96) return {x,y};
        col++;
        if (col >= maxCols) { col = 0; row++; }
      }
      return { x: 16, y: 16 };
    }

    function fsMigrateAndEnsureDefaults(){
      fs.desktop = Array.isArray(fs.desktop) ? fs.desktop : [];
      fs.files = fs.files || {};

      for (const it of fs.desktop) {
        if (!it.did) it.did = uid();
      }

      const ensureApp = (appId, name) => {
        const exists = fs.desktop.some(x => x.type === 'app' && x.appId === appId);
        if (!exists) fs.desktop.push({ did: uid(), type:'app', appId, name });
      };
      ensureApp('explorer','Проводник');
      ensureApp('edge','Microsoft Edge');
      ensureApp('notepad','Блокнот');
      ensureApp('calculator','Калькулятор');
      ensureApp('store','Microsoft Store');
      ensureApp('settings','Параметры');

      if (!fs.files.readme) {
        fs.files.readme = {
          id:'readme', name:'Добро пожаловать.txt', ext:'txt', updatedAt: Date.now(),
          content:'Добро пожаловать!\n'
        };
        fs.desktop.push({ did: uid(), type:'file', fileId:'readme', name: 'Добро пожаловать.txt', ext:'txt' });
      }

      // Assign default positions if missing
      const used = new Set();
      for (const it of fs.desktop) {
        if (it.pos && Number.isFinite(it.pos.x) && Number.isFinite(it.pos.y)) {
          used.add(`${Math.round(it.pos.x)}:${Math.round(it.pos.y)}`);
        }
      }
      const startX = 16, startY = 16;
      const colW = 104, rowH = 104;
      let col = 0, row = 0;
      const area = desktopWorkAreaRect();
      const maxCols = Math.max(1, Math.floor((area.w - startX) / colW));

      let changed = false;
      for (const it of fs.desktop) {
        if (it.pos && Number.isFinite(it.pos.x) && Number.isFinite(it.pos.y)) continue;
        let tries = 0;
        while (tries < 5000) {
          const x = startX + col * colW;
          const y = startY + row * rowH;
          const key = `${x}:${y}`;
          if (!used.has(key) && x < area.w - 96 && y < area.h - 96) {
            it.pos = { x, y };
            used.add(key);
            changed = true;
            break;
          }
          col++;
          if (col >= maxCols) { col = 0; row++; }
          tries++;
        }
      }

      if (changed) fsSave(fs);
    }

    // ---------- Apply UI settings ----------
    function applyUI() {
      const a = ui.accent || [99,102,241];
      document.documentElement.style.setProperty('--accent', `${a[0]} ${a[1]} ${a[2]}`);
      document.documentElement.style.setProperty('--wallpaper', Wallpapers[ui.wallpaper] || Wallpapers.aurora);
      document.documentElement.setAttribute('data-transparency', state.transparency ? '1' : '0');

      const nightOn = !!state.toggles.night;
      $('#nightOverlay').style.display = nightOn ? 'block' : 'none';
    }

    function persistUI() {
      ui.accent = ui.accent || [99,102,241];
      ui.wallpaper = ui.wallpaper || 'aurora';
      ui.dark = true;
      ui.volume = state.volume;
      ui.toggles = { ...state.toggles };
      ui.recent = state.recent.slice(0, 12);
      ui.showToasts = !!state.showToasts;
      ui.transparency = !!state.transparency;
      ui.installedApps = Array.from(state.installedApps);
      ui.edgeTabsBeta = !!state.edgeTabsBeta;
      ui.edgeOpenInsideBeta = !!state.edgeOpenInsideBeta;
      ui.fullscreenPref = !!state.fullscreenPref;
      uiSave(ui);
    }

    // ---------- Fullscreen (browser) ----------
    function isBrowserFullscreen(){
      return !!document.fullscreenElement;
    }

    async function setBrowserFullscreen(yes){
      const want = !!yes;
      try {
        if (want) {
          const el = document.documentElement;
          if (!el.requestFullscreen) throw new Error('Fullscreen API not supported');
          await el.requestFullscreen();
        } else {
          if (document.exitFullscreen) await document.exitFullscreen();
        }
      } catch (err) {
        // Some browsers block fullscreen unless initiated by user gesture.
        addNotification({
          title: 'Параметры',
          body: 'Не удалось переключить полноэкранный режим. Браузер мог заблокировать Fullscreen API. Попробуйте ещё раз и разрешите полноэкранный режим.',
          iconHtml: registry.settings.iconHtml,
          source: 'Параметры'
        });
      }
      state.fullscreenPref = isBrowserFullscreen();
      persistUI();
    }

    // ---------- Desktop icons (multi-select + group drag) ----------
    let selectedDids = new Set();

    function iconForItem(item) {
      if (item.type === 'app') return registry[item.appId]?.iconHtml || Icons.win('w-8 h-8');
      if (item.type === 'folder') return Icons.folder('w-8 h-8');
      if (item.type === 'file') return Icons.note('w-8 h-8');
      return Icons.win('w-8 h-8');
    }

    function applySelectionClasses(){
      $$('#desktopIcons .desktop-icon').forEach(el => {
        const did = el.getAttribute('data-did');
        el.classList.toggle('selected', selectedDids.has(did));
      });
    }

    function clearSelection(){
      selectedDids = new Set();
      applySelectionClasses();
    }

    function selectOnly(did){
      selectedDids = new Set([did]);
      applySelectionClasses();
    }

    function toggleSelect(did){
      if (selectedDids.has(did)) selectedDids.delete(did);
      else selectedDids.add(did);
      applySelectionClasses();
    }

    function setSelection(dids){
      selectedDids = new Set(dids);
      applySelectionClasses();
    }

    function renderDesktopIcons() {
      const wrap = $('#desktopIcons');
      wrap.innerHTML = '';

      for (const item of fs.desktop) {
        const did = item.did;
        const pos = item.pos || (item.pos = findFreeDesktopSlot());

        const el = h('button', {
          class: `desktop-icon ${selectedDids.has(did) ? 'selected' : ''}`,
          'data-did': did,
          title: item.name,
          style: `left:${pos.x}px; top:${pos.y}px;`
        }, [
          h('div', { class: 'w-10 h-10 flex items-center justify-center', html: iconForItem(item)}),
          h('div', { class: 'px-1' }, item.name)
        ]);

        // click: selection only
        el.addEventListener('click', (e) => {
          e.stopPropagation();
          const isToggle = (e.ctrlKey || e.metaKey);
          if (isToggle) toggleSelect(did);
          else selectOnly(did);
        });

        // dblclick: open (Windows-like)
        el.addEventListener('dblclick', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (!selectedDids.has(did)) selectOnly(did);
          openDesktopItem(item);
        });

        // context menu on icon (Open must be first)
        el.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          e.stopPropagation();
          // Windows-like: right click keeps current selection if item already selected
          if (!selectedDids.has(did)) selectOnly(did);
          showIconMenu(e.clientX, e.clientY, item);
        });

        // drag (group)
        let drag = null;
        el.addEventListener('pointerdown', (e) => {
          if (e.button !== 0) return;
          e.stopPropagation();

          // selection rules
          const isToggle = (e.ctrlKey || e.metaKey);
          if (!selectedDids.has(did)) {
            if (isToggle) toggleSelect(did);
            else selectOnly(did);
          }

          const selection = Array.from(selectedDids);
          const didToItem = new Map(fs.desktop.map(it => [it.did, it]));

          const origins = new Map();
          for (const sdid of selection) {
            const it = didToItem.get(sdid);
            if (!it) continue;
            const p = it.pos || {x:16,y:16};
            origins.set(sdid, { x: p.x, y: p.y });
          }

          drag = {
            pointerId: e.pointerId,
            startX: e.clientX,
            startY: e.clientY,
            origins,
            active: false
          };
          el.setPointerCapture(e.pointerId);
        });

        el.addEventListener('pointermove', (e) => {
          if (!drag || drag.pointerId !== e.pointerId) return;
          const dx = e.clientX - drag.startX;
          const dy = e.clientY - drag.startY;
          if (!drag.active && Math.hypot(dx, dy) > 6) {
            drag.active = true;
            // add dragging class to all selected
            for (const sdid of selectedDids) {
              const iconEl = $(`#desktopIcons .desktop-icon[data-did="${sdid}"]`);
              if (iconEl) iconEl.classList.add('dragging');
            }
          }
          if (!drag.active) return;

          const area = desktopWorkAreaRect();
          for (const [sdid, orig] of drag.origins.entries()) {
            const iconEl = $(`#desktopIcons .desktop-icon[data-did="${sdid}"]`);
            if (!iconEl) continue;
            const nx = clamp(orig.x + dx, 0, area.w - 96);
            const ny = clamp(orig.y + dy, 0, area.h - 96);
            iconEl.style.left = nx + 'px';
            iconEl.style.top = ny + 'px';
          }
        });

        el.addEventListener('pointerup', (e) => {
          if (!drag || drag.pointerId !== e.pointerId) return;
          try { el.releasePointerCapture(e.pointerId); } catch {}

          if (drag.active) {
            const didToItem = new Map(fs.desktop.map(it => [it.did, it]));
            for (const sdid of drag.origins.keys()) {
              const iconEl = $(`#desktopIcons .desktop-icon[data-did="${sdid}"]`);
              const it = didToItem.get(sdid);
              if (!iconEl || !it) continue;
              const left = parseFloat(iconEl.style.left) || 0;
              const top = parseFloat(iconEl.style.top) || 0;
              it.pos = { x: left, y: top };
            }
            fsSave(fs);
          }

          for (const sdid of selectedDids) {
            const iconEl = $(`#desktopIcons .desktop-icon[data-did="${sdid}"]`);
            if (iconEl) iconEl.classList.remove('dragging');
          }

          drag = null;
        });

        wrap.appendChild(el);
      }

      applySelectionClasses();
    }

    function openDesktopItem(item) {
      if (item.type === 'app') {
        openApp(item.appId);
        return;
      }
      if (item.type === 'file') {
        openNotepadWithFile(item.fileId);
        return;
      }
      if (item.type === 'folder') {
        openApp('explorer', { path: 'desktop' });
        return;
      }
    }

    // ---------- Window manager ----------
    function openApp(appId, opts={}) {
      const app = registry[appId];
      if (!app) {
        addNotification({ title: 'Система', body: `Приложение не найдено: ${appId}`, iconHtml: Icons.win('w-6 h-6'), source: 'Система' });
        return;
      }

      // block uninstalled optional apps
      if (!isInstalled(appId) && appId !== 'store') {
        addNotification({
          title: 'Microsoft Store',
          body: `Приложение «${app.name}» не установлено. Откройте Store.`,
          iconHtml: registry.store.iconHtml,
          source: 'Microsoft Store'
        });
        openApp('store', { focusAppId: appId });
        return;
      }

      // Settings single instance
      if (appId === 'settings') {
        const existing = Array.from(state.windows.values()).find(w => w.appId === 'settings');
        if (existing) { restoreWindow(existing.id); focusWindow(existing.id); return; }
      }

      const id = uid();
      const area = desktopWorkAreaRect();
      const ds = app.defaultSize || {w: 720, h: 520};
      const w = clamp(ds.w, 320, area.w - 20);
      const h = clamp(ds.h, 240, area.h - 20);
      const left = clamp(Math.round(area.w/2 - w/2 + (state.order.length*16)%120), 10, area.w - w - 10);
      const top = clamp(Math.round(area.h/2 - h/2 + (state.order.length*14)%90), 10, area.h - h - 10);

      const win = {
        id,
        appId,
        title: app.name,
        iconHtml: app.iconHtml,
        minimized: false,
        maximized: false,
        rect: { x: left, y: top, w, h },
        prevRect: null,
        createdAt: Date.now(),
        opts
      };

      state.windows.set(id, win);
      state.order.push(id);
      createWindowElement(win);
      focusWindow(id);
      updateTaskbar();

      addRecent({ kind: 'app', appId, name: app.name, ts: Date.now() });
      return id;
    }

    function createWindowElement(win) {
      const layer = $('#windowLayer');
      const el = h('div', {
        class: 'absolute win-surface win-in',
        'data-win': win.id,
        style: `left:${win.rect.x}px; top:${win.rect.y}px; width:${win.rect.w}px; height:${win.rect.h}px; z-index:${++state.z};`
      });
      setTimeout(() => el.classList.remove('win-in'), 220);

      const titlebar = h('div', { class: 'titlebar', 'data-titlebar': '1' });
      const titleLeft = h('div', { class: 'titletext' }, [
        h('div', { class: 'w-5 h-5 flex items-center justify-center', html: win.iconHtml }),
        h('div', { class: 'name' }, win.title)
      ]);

      const controls = h('div', { class: 'window-controls flex items-center gap-1' });

      // Snap menu (on hover of maximize)
      const snapMenu = h('div', { class: 'hidden absolute right-14 top-9 w-56 win-surface p-2 z-[6000] flyout', 'data-snap': '1' }, [
        h('div', { class: 'text-xs px-2 py-2 text-white/60' }, 'Размещение (Snap)'),
        h('div', { class: 'grid grid-cols-2 gap-2 px-1 pb-1' }, [
          snapBtn('left', 'Слева'),
          snapBtn('right', 'Справа'),
          snapBtn('top', 'Сверху'),
          snapBtn('bottom', 'Снизу'),
        ]),
        h('div', { class: 'thin-sep my-1' }),
        h('button', { class: 'w-full text-left menu-item', onclick: () => { maximizeWindow(win.id, true); hideAllPopovers(); } }, [
          h('div', { class: 'w-5 h-5', html: Icons.maximize('w-5 h-5') }),
          h('div', {}, 'Развернуть')
        ])
      ]);

      function snapBtn(where, label){
        return h('button', {
          class: 'px-3 py-3 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 text-left',
          onclick: () => { snapWindow(win.id, where); hideAllPopovers(); }
        }, [
          h('div', { class: 'text-sm font-semibold' }, label),
          h('div', { class: 'text-xs text-white/60' }, snapLabel(where))
        ]);
      }
      function snapLabel(where){
        return ({left:'1/2 экрана', right:'1/2 экрана', top:'верхняя половина', bottom:'нижняя половина'})[where] || '';
      }

      const btnMin = h('button', { title: 'Свернуть', onclick: (e) => { e.stopPropagation(); minimizeWindow(win.id); } });
      btnMin.innerHTML = Icons.minimize('w-4 h-4');

      const btnMax = h('button', { title: 'Развернуть / восстановить' });
      btnMax.innerHTML = Icons.maximize('w-4 h-4');

      const btnClose = h('button', { title: 'Закрыть', class: 'danger', onclick: (e) => { e.stopPropagation(); closeWindow(win.id); } });
      btnClose.innerHTML = Icons.close('w-4 h-4');

      controls.append(btnMin, btnMax, btnClose);
      titlebar.append(titleLeft, controls);
      el.append(titlebar);

      const content = h('div', { class: 'window-content scrollbar', 'data-content': '1' });
      el.append(content);

      const resizer = h('div', { class: 'resize-handle', 'data-resize': '1' });
      el.append(resizer);

      // Build app UI
      const app = registry[win.appId];
      content.appendChild(app.build(win));

      // Focus on click
      el.addEventListener('pointerdown', () => focusWindow(win.id));

      // Drag logic
      titlebar.addEventListener('pointerdown', (e) => {
        if (e.button !== 0) return;
        if (win.maximized) return;
        focusWindow(win.id);
        state.dragging = {
          winId: win.id,
          startX: e.clientX,
          startY: e.clientY,
          orig: { ...win.rect }
        };
        titlebar.classList.add('dragging');
        titlebar.setPointerCapture(e.pointerId);
      });

      titlebar.addEventListener('pointermove', (e) => {
        if (!state.dragging || state.dragging.winId !== win.id) return;
        const dx = e.clientX - state.dragging.startX;
        const dy = e.clientY - state.dragging.startY;
        const area = desktopWorkAreaRect();
        win.rect.x = clamp(state.dragging.orig.x + dx, 0, area.w - win.rect.w);
        win.rect.y = clamp(state.dragging.orig.y + dy, 0, area.h - win.rect.h);
        applyRect(el, win.rect);

        // Snap preview
        const margin = 18;
        const atLeft = e.clientX < margin;
        const atRight = e.clientX > (window.innerWidth - margin);
        const atTop = e.clientY < margin;
        const atBottom = e.clientY > (window.innerHeight - (margin + 56));
        const hint = $('#snapHint');
        if (atLeft || atRight || atTop || atBottom) hint.style.display = 'block';
        else hint.style.display = 'none';
      });

      titlebar.addEventListener('pointerup', (e) => {
        if (!state.dragging || state.dragging.winId !== win.id) return;
        titlebar.classList.remove('dragging');
        try { titlebar.releasePointerCapture(e.pointerId); } catch {}

        const margin = 18;
        const atLeft = e.clientX < margin;
        const atRight = e.clientX > (window.innerWidth - margin);
        const atTop = e.clientY < margin;
        const atBottom = e.clientY > (window.innerHeight - (margin + 56));
        $('#snapHint').style.display = 'none';

        if (atLeft) snapWindow(win.id, 'left');
        else if (atRight) snapWindow(win.id, 'right');
        else if (atTop) maximizeWindow(win.id, true);
        else if (atBottom) minimizeWindow(win.id);

        state.dragging = null;
        updateTaskbar();
      });

      // Resize
      resizer.addEventListener('pointerdown', (e) => {
        if (e.button !== 0) return;
        focusWindow(win.id);
        state.resizing = {
          winId: win.id,
          startX: e.clientX,
          startY: e.clientY,
          orig: { ...win.rect }
        };
        resizer.setPointerCapture(e.pointerId);
      });

      resizer.addEventListener('pointermove', (e) => {
        if (!state.resizing || state.resizing.winId !== win.id) return;
        const dx = e.clientX - state.resizing.startX;
        const dy = e.clientY - state.resizing.startY;
        const area = desktopWorkAreaRect();
        win.rect.w = clamp(state.resizing.orig.w + dx, 320, area.w - win.rect.x - 4);
        win.rect.h = clamp(state.resizing.orig.h + dy, 240, area.h - win.rect.y - 4);
        applyRect(el, win.rect);
      });

      resizer.addEventListener('pointerup', (e) => {
        if (!state.resizing || state.resizing.winId !== win.id) return;
        try { resizer.releasePointerCapture(e.pointerId); } catch {}
        state.resizing = null;
        updateTaskbar();
      });

      // Control buttons
      btnMax.addEventListener('click', (e) => {
        e.stopPropagation();
        if (win.maximized) maximizeWindow(win.id, false);
        else maximizeWindow(win.id, true);
        hideAllPopovers();
      });

      // Snap menu on hover
      let snapTimer = null;
      btnMax.addEventListener('pointerenter', () => {
        clearTimeout(snapTimer);
        snapTimer = setTimeout(() => {
          if (!state.windows.has(win.id)) return;
          hideAllPopovers();
          snapMenu.classList.remove('hidden');
        }, 220);
      });
      btnMax.addEventListener('pointerleave', () => {
        clearTimeout(snapTimer);
        snapTimer = setTimeout(() => snapMenu.classList.add('hidden'), 320);
      });
      snapMenu.addEventListener('pointerenter', () => clearTimeout(snapTimer));
      snapMenu.addEventListener('pointerleave', () => {
        clearTimeout(snapTimer);
        snapTimer = setTimeout(() => snapMenu.classList.add('hidden'), 220);
      });

      // Titlebar double-click
      titlebar.addEventListener('dblclick', () => {
        if (win.maximized) maximizeWindow(win.id, false);
        else maximizeWindow(win.id, true);
      });

      el.appendChild(snapMenu);
      layer.appendChild(el);
      updateWindowControls(el, win);
    }

    function updateWindowControls(winEl, win){
      const btns = $$('.window-controls button', winEl);
      const btnMax = btns[1];
      if (btnMax) btnMax.innerHTML = win.maximized ? Icons.restore('w-4 h-4') : Icons.maximize('w-4 h-4');
      const res = $('[data-resize]', winEl);
      if (res) res.style.display = win.maximized ? 'none' : 'block';
    }

    function applyRect(winEl, rect){
      winEl.style.left = rect.x + 'px';
      winEl.style.top = rect.y + 'px';
      winEl.style.width = rect.w + 'px';
      winEl.style.height = rect.h + 'px';
    }

    function focusWindow(winId){
      const win = state.windows.get(winId);
      if (!win) return;
      win.minimized = false;
      state.activeWinId = winId;
      const el = document.querySelector(`[data-win="${winId}"]`);
      if (el) el.style.zIndex = String(++state.z);
      $$('#windowLayer > [data-win]').forEach(wel => {
        wel.style.outline = 'none';
      });
      if (el) el.style.outline = '2px solid rgba(' + (ui.accent||[99,102,241]).join(',') + ',.45)';
      updateTaskbar();
      updateTaskbarAutoHide();
    }

    function minimizeWindow(winId){
      const win = state.windows.get(winId);
      if (!win) return;
      win.minimized = true;
      if (state.activeWinId === winId) {
        const next = state.order.slice().reverse().find(id => {
          const w = state.windows.get(id);
          return w && !w.minimized;
        });
        state.activeWinId = next || null;
      }
      const el = document.querySelector(`[data-win="${winId}"]`);
      if (el) {
        el.classList.remove('win-in','win-out');
        el.classList.add('win-min');
        setTimeout(() => {
          // may already be closed
          if (!state.windows.has(winId)) return;
          const el2 = document.querySelector(`[data-win="${winId}"]`);
          if (el2) {
            el2.style.display = 'none';
            el2.classList.remove('win-min');
          }
        }, 170);
      }
      updateTaskbar();
      updateTaskbarAutoHide();
    }

    function restoreWindow(winId){
      const win = state.windows.get(winId);
      if (!win) return;
      win.minimized = false;
      const el = document.querySelector(`[data-win="${winId}"]`);
      if (el) el.style.display = 'block';
      focusWindow(winId);
      updateTaskbarAutoHide();
    }

    // before-close handlers
    const beforeClose = new Map();
    const onClose = new Map();
    function registerBeforeClose(winId, fn){ beforeClose.set(winId, fn); }
    function registerOnClose(winId, fn){ onClose.set(winId, fn); }

    function closeWindow(winId){
      const guard = beforeClose.get(winId);
      if (guard) {
        try {
          const ok = guard();
          if (!ok) return;
        } catch {}
        beforeClose.delete(winId);
      }

      const win = state.windows.get(winId);
      if (!win) return;
      const el = document.querySelector(`[data-win="${winId}"]`);

      const finalize = () => {
        const cleanup = onClose.get(winId);
        if (cleanup) {
          try { cleanup(); } catch {}
          onClose.delete(winId);
        }
        const el2 = document.querySelector(`[data-win="${winId}"]`);
        if (el2) el2.remove();
        state.windows.delete(winId);
        state.order = state.order.filter(x => x !== winId);
        if (state.activeWinId === winId) state.activeWinId = null;
        const last = state.order.slice().reverse().find(id => {
          const w = state.windows.get(id);
          return w && !w.minimized;
        });
        if (last) focusWindow(last);
        updateTaskbar();
        updateTaskbarAutoHide();
      };

      if (el) {
        el.classList.remove('win-in','win-min');
        el.classList.add('win-out');
        setTimeout(finalize, 150);
      } else {
        finalize();
      }
    }

    function maximizeWindow(winId, yes){
      const win = state.windows.get(winId);
      if (!win) return;
      const el = document.querySelector(`[data-win="${winId}"]`);
      if (!el) return;
      if (yes && !win.maximized) {
        win.prevRect = { ...win.rect };
        const area = desktopWorkAreaRect();
        win.rect = { x: 8, y: 8, w: area.w - 16, h: area.h - 16 };
        win.maximized = true;
      } else if (!yes && win.maximized) {
        if (win.prevRect) win.rect = { ...win.prevRect };
        win.prevRect = null;
        win.maximized = false;
      }
      applyRect(el, win.rect);
      updateWindowControls(el, win);
      focusWindow(winId);
      updateTaskbarAutoHide();
    }

    function snapWindow(winId, where){
      const win = state.windows.get(winId);
      if (!win) return;
      const el = document.querySelector(`[data-win="${winId}"]`);
      if (!el) return;
      const area = desktopWorkAreaRect();
      if (!win.maximized) win.prevRect = win.prevRect || { ...win.rect };
      win.maximized = false;
      const pad = 10;
      if (where === 'left') win.rect = { x: pad, y: pad, w: Math.floor((area.w - 3*pad)/2), h: area.h - 2*pad };
      if (where === 'right') win.rect = { x: Math.floor(area.w/2) + pad/2, y: pad, w: Math.floor((area.w - 3*pad)/2), h: area.h - 2*pad };
      if (where === 'top') win.rect = { x: pad, y: pad, w: area.w - 2*pad, h: Math.floor((area.h - 3*pad)/2) };
      if (where === 'bottom') win.rect = { x: pad, y: Math.floor(area.h/2) + pad/2, w: area.w - 2*pad, h: Math.floor((area.h - 3*pad)/2) };
      applyRect(el, win.rect);
      updateWindowControls(el, win);
      focusWindow(winId);
      updateTaskbarAutoHide();
    }

    // ---------- Taskbar autohide ----------
    let tbHideTimer = null;
    function updateTaskbarAutoHide(){
      const w = state.activeWinId ? state.windows.get(state.activeWinId) : null;
      const shouldHide = !!(w && !w.minimized && w.maximized);
      document.body.classList.toggle('tb-autohide', shouldHide);
      if (!shouldHide) {
        document.body.classList.remove('tb-reveal');
        clearTimeout(tbHideTimer);
        tbHideTimer = null;
      }
    }
    function revealTaskbar(){
      if (!document.body.classList.contains('tb-autohide')) return;
      document.body.classList.add('tb-reveal');
      clearTimeout(tbHideTimer);
      tbHideTimer = setTimeout(() => {
        document.body.classList.remove('tb-reveal');
      }, 1200);
    }

    // ---------- Taskbar ----------
    function updateTaskbar(){
      const wrap = $('#taskApps');
      wrap.innerHTML = '';
      const wins = state.order.map(id => state.windows.get(id)).filter(Boolean);
      for (const w of wins) {
        const btn = h('button', {
          class: `taskbtn ${w.id === state.activeWinId && !w.minimized ? 'active' : ''} running`,
          title: w.title
        }, [
          h('span', { class: 'w-5 h-5', html: registry[w.appId]?.iconHtml || w.iconHtml })
        ]);
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (w.minimized) restoreWindow(w.id);
          else if (state.activeWinId === w.id) minimizeWindow(w.id);
          else focusWindow(w.id);
        });
        btn.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          e.stopPropagation();
          showTaskContextMenu(e.clientX, e.clientY, w.id);
        });
        wrap.appendChild(btn);
      }

      $('#icoTrayNet').innerHTML = state.toggles.wifi ? Icons.wifi('w-5 h-5') : Icons.wifiOff('w-5 h-5');
      $('#icoTrayVol').innerHTML = (state.volume === 0) ? Icons.volumeMute('w-5 h-5') : Icons.volume('w-5 h-5');
      $('#icoTrayBat').innerHTML = Icons.battery('w-5 h-5');

      const unseen = state.notifications.some(n => !n.seen);
      $('#notifDot').classList.toggle('hidden', !unseen);

      updateTaskbarAutoHide();
    }

    // Task context menu
    let taskCtx = null;
    function showTaskContextMenu(x, y, winId){
      hideTaskContextMenu();
      const win = state.windows.get(winId);
      if (!win) return;
      taskCtx = h('div', { class: 'absolute z-[5000] w-56 win-surface p-2 flyout', style: `left:${x}px; top:${y}px;` }, [
        h('div', { class: 'text-xs px-2 py-2 text-white/60' }, win.title),
        h('button', { class: 'w-full text-left menu-item', onclick: () => { restoreWindow(winId); hideTaskContextMenu(); } }, [
          h('div', { class: 'w-5 h-5', html: registry[win.appId]?.iconHtml || win.iconHtml }),
          h('div', {}, 'Открыть')
        ]),
        h('button', { class: 'w-full text-left menu-item', onclick: () => { minimizeWindow(winId); hideTaskContextMenu(); } }, [
          h('div', { class: 'w-5 h-5', html: Icons.minimize('w-5 h-5') }),
          h('div', {}, 'Свернуть')
        ]),
        h('button', { class: 'w-full text-left menu-item', onclick: () => { maximizeWindow(winId, !state.windows.get(winId)?.maximized); hideTaskContextMenu(); } }, [
          h('div', { class: 'w-5 h-5', html: Icons.maximize('w-5 h-5') }),
          h('div', {}, 'Развернуть/восстановить')
        ]),
        h('div', { class: 'thin-sep my-1' }),
        h('button', { class: 'w-full text-left menu-item', onclick: () => { closeWindow(winId); hideTaskContextMenu(); } }, [
          h('div', { class: 'w-5 h-5', html: Icons.close('w-5 h-5') }),
          h('div', {}, 'Закрыть')
        ])
      ]);
      $('#desktop').appendChild(taskCtx);
      requestAnimationFrame(() => {
        const r = taskCtx.getBoundingClientRect();
        const nx = clamp(r.left, 8, window.innerWidth - r.width - 8);
        const ny = clamp(r.top, 8, window.innerHeight - r.height - 8);
        taskCtx.style.left = nx + 'px';
        taskCtx.style.top = ny + 'px';
      });
    }
    function hideTaskContextMenu(){
      if (taskCtx) taskCtx.remove();
      taskCtx = null;
    }

    // ---------- Notifications ----------
    function addNotification({title, body, iconHtml, source='Система'}){
      const n = { id: uid(), title, body, source, iconHtml, ts: Date.now(), seen: false };
      state.notifications.unshift(n);
      renderNotifCenter();
      updateTaskbar();
      // by default: no toasts
      if (state.showToasts) showToast(n);
    }

    function showToast(n){
      const wrap = $('#toasts');
      const el = h('div', { class: 'toast win-surface p-3 w-[340px] max-w-[92vw]' }, [
        h('div', { class: 'flex items-start gap-3' }, [
          h('div', { class: 'w-8 h-8 flex items-center justify-center', html: n.iconHtml || Icons.bell('w-6 h-6') }),
          h('div', { class: 'min-w-0 flex-1' }, [
            h('div', { class: 'text-sm font-semibold' }, n.title),
            h('div', { class: 'text-xs text-white/70 mt-0.5 break-words' }, n.body)
          ]),
          h('button', { class: 'px-2 py-1 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 text-xs', onclick: () => el.remove() }, '×')
        ])
      ]);
      wrap.appendChild(el);
      setTimeout(() => { el.remove(); }, 5200);
    }

    function renderNotifCenter(){
      const meta = $('#notifMeta');
      const list = $('#notifList');
      const count = state.notifications.length;
      const unseen = state.notifications.filter(n => !n.seen).length;
      meta.textContent = count ? `${count} шт. • непрочитано: ${unseen}` : 'Нет уведомлений';

      list.innerHTML = '';
      if (!count) {
        list.appendChild(h('div', { class: 'p-6 text-center text-white/60' }, 'Здесь пока пусто'));
        return;
      }
      for (const n of state.notifications) {
        const card = h('button', { class: `w-full text-left p-3 rounded-2xl border border-white/10 ${n.seen ? 'bg-white/5' : 'bg-white/8'} hover:bg-white/10` }, [
          h('div', { class: 'flex gap-3 items-start' }, [
            h('div', { class: 'w-8 h-8 flex items-center justify-center', html: n.iconHtml || Icons.bell('w-6 h-6') }),
            h('div', { class: 'min-w-0 flex-1' }, [
              h('div', { class: 'flex items-center justify-between gap-2' }, [
                h('div', { class: 'text-sm font-semibold truncate' }, n.title),
                h('div', { class: 'text-[11px] text-white/60 whitespace-nowrap' }, fmtTime(n.ts))
              ]),
              h('div', { class: 'text-xs text-white/70 mt-0.5 break-words' }, n.body),
              h('div', { class: 'text-[11px] text-white/50 mt-1' }, n.source)
            ])
          ])
        ]);
        card.addEventListener('click', () => {
          n.seen = true;
          renderNotifCenter();
          updateTaskbar();
        });
        list.appendChild(card);
      }
    }

    function fmtTime(ts){
      const d = new Date(ts);
      return `${fmt2(d.getHours())}:${fmt2(d.getMinutes())}`;
    }

    // ---------- Popovers / menus ----------
    function hideAllPopovers(){
      $('#startMenu').classList.add('hidden');
      $('#searchFlyout').classList.add('hidden');
      $('#quickSettings').classList.add('hidden');
      $('#notifCenter').classList.add('hidden');
      $('#powerMenu').classList.add('hidden');
      $('#ctxMenu').classList.add('hidden');
      $('#widgetsFlyout').classList.add('hidden');
      $('#runDialog').classList.add('hidden');
      $('#iconMenu').classList.add('hidden');
      hideTaskContextMenu();
    }

    function toggleStart(){
      const m = $('#startMenu');
      const showing = !m.classList.contains('hidden');
      hideAllPopovers();
      if (!showing) {
        m.classList.remove('hidden');
        $('#startSearch').value = '';
        renderStart();
        $('#startSearch').focus();
      }
    }

    function toggleSearchFlyout(){
      const f = $('#searchFlyout');
      const showing = !f.classList.contains('hidden');
      hideAllPopovers();
      if (!showing) {
        f.classList.remove('hidden');
        $('#globalSearch').value = '';
        renderGlobalSearch('');
        $('#globalSearch').focus();
      }
    }

    function toggleQuickSettings(){
      const q = $('#quickSettings');
      const showing = !q.classList.contains('hidden');
      hideAllPopovers();
      if (!showing) {
        q.classList.remove('hidden');
        $('#volSlider').value = String(state.volume);
        renderQuickSettings();
      }
    }

    function toggleNotifCenter(){
      const n = $('#notifCenter');
      const showing = !n.classList.contains('hidden');
      hideAllPopovers();
      if (!showing) {
        n.classList.remove('hidden');
        renderNotifCenter();
      }
    }

    function toggleWidgets(){
      const w = $('#widgetsFlyout');
      const showing = !w.classList.contains('hidden');
      hideAllPopovers();
      if (!showing) {
        w.classList.remove('hidden');
        renderWidgets();
      }
    }

    // ---------- Start menu ----------
    function renderStart(){
      const pinned = $('#pinnedGrid');
      pinned.innerHTML = '';
      const pinnedApps = ['edge','explorer','notepad','calculator','store','settings'];
      for (const id of pinnedApps) {
        const app = registry[id];
        if (!app) continue;
        const tile = h('button', { class: 'p-3 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 flex flex-col items-center gap-2', title: app.name }, [
          h('div', { class: 'w-8 h-8', html: app.iconHtml }),
          h('div', { class: 'text-[12px] text-white/80 text-center leading-4' }, app.name)
        ]);
        tile.addEventListener('click', () => { openApp(id); hideAllPopovers(); });
        pinned.appendChild(tile);
      }

      renderRecommended();
      renderStartSearch('');
    }

    function addRecent(item){
      const key = item.kind + ':' + (item.appId || item.fileId || item.name);
      state.recent = state.recent.filter(r => (r.kind + ':' + (r.appId || r.fileId || r.name)) !== key);
      state.recent.unshift(item);
      state.recent = state.recent.slice(0, 12);
      persistUI();
      renderRecommended();
    }

    function renderRecommended(){
      const rec = $('#recommended');
      rec.innerHTML = '';
      const items = state.recent.slice(0, 6);
      if (!items.length) {
        rec.appendChild(h('div', { class: 'p-3 rounded-2xl border border-white/10 bg-white/5 text-white/60 text-sm' }, 'Пока нет недавних элементов'));
        return;
      }
      for (const it of items) {
        const icon = it.kind === 'app' ? registry[it.appId]?.iconHtml : Icons.note('w-6 h-6');
        const row = h('button', { class: 'w-full text-left menu-item' }, [
          h('div', { class: 'w-8 h-8 flex items-center justify-center', html: icon }),
          h('div', { class: 'min-w-0 flex-1' }, [
            h('div', { class: 'text-sm font-semibold truncate' }, it.name),
            h('div', { class: 'text-xs text-white/60' }, new Date(it.ts).toLocaleString('ru-RU'))
          ])
        ]);
        row.addEventListener('click', () => {
          if (it.kind === 'app') openApp(it.appId);
          if (it.kind === 'file') openNotepadWithFile(it.fileId);
          hideAllPopovers();
        });
        rec.appendChild(row);
      }
    }

    function renderStartSearch(q){
      const query = q.trim().toLowerCase();
      const apps = Object.values(registry).filter(a => a.name.toLowerCase().includes(query) || a.id.includes(query));
      let box = $('#startSearchResults');
      if (!box) {
        box = h('div', { id: 'startSearchResults', class: 'mt-3 hidden' });
        $('#startMenu .p-3').appendChild(box);
      }

      if (!query) {
        box.classList.add('hidden');
        return;
      }

      box.classList.remove('hidden');
      box.innerHTML = '';
      box.appendChild(h('div', { class: 'text-sm font-semibold mb-2' }, 'Результаты'));
      if (!apps.length) {
        box.appendChild(h('div', { class: 'p-3 rounded-2xl border border-white/10 bg-white/5 text-white/60 text-sm' }, 'Ничего не найдено'));
        return;
      }
      for (const a of apps.slice(0, 7)) {
        const row = h('button', { class: 'w-full text-left menu-item' }, [
          h('div', { class: 'w-8 h-8 flex items-center justify-center', html: a.iconHtml }),
          h('div', { class: 'min-w-0 flex-1' }, [
            h('div', { class: 'text-sm font-semibold truncate' }, a.name),
            h('div', { class: 'text-xs text-white/60' }, 'Приложение')
          ])
        ]);
        row.addEventListener('click', () => { openApp(a.id); hideAllPopovers(); });
        box.appendChild(row);
      }
    }

    // Global search
    function renderGlobalSearch(q){
      const query = q.trim().toLowerCase();
      const appsWrap = $('#searchApps');
      const filesWrap = $('#searchFiles');
      appsWrap.innerHTML = '';
      filesWrap.innerHTML = '';

      const apps = Object.values(registry).filter(a => a.name.toLowerCase().includes(query) || a.id.includes(query));
      const files = Object.values(fs.files).filter(f => (f.name||'').toLowerCase().includes(query) || (f.content||'').toLowerCase().includes(query));

      const renderRow = (iconHtml, title, subtitle, onClick) => {
        const row = h('button', { class: 'w-full text-left menu-item' }, [
          h('div', { class: 'w-8 h-8 flex items-center justify-center', html: iconHtml }),
          h('div', { class: 'min-w-0 flex-1' }, [
            h('div', { class: 'text-sm font-semibold truncate' }, title),
            h('div', { class: 'text-xs text-white/60 truncate' }, subtitle)
          ])
        ]);
        row.addEventListener('click', () => { onClick(); hideAllPopovers(); });
        return row;
      };

      if (!apps.length && query) appsWrap.appendChild(h('div', { class: 'p-3 rounded-2xl border border-white/10 bg-white/5 text-white/60 text-sm' }, 'Нет совпадений'));
      if (!files.length && query) filesWrap.appendChild(h('div', { class: 'p-3 rounded-2xl border border-white/10 bg-white/5 text-white/60 text-sm' }, 'Нет совпадений'));

      for (const a of apps.slice(0, 9)) {
        appsWrap.appendChild(renderRow(a.iconHtml, a.name, 'Приложение', () => openApp(a.id)));
      }
      for (const f of files.slice(0, 9)) {
        filesWrap.appendChild(renderRow(Icons.note('w-6 h-6'), f.name, 'Файл', () => openNotepadWithFile(f.id)));
      }

      if (!query) {
        appsWrap.appendChild(h('div', { class: 'p-3 rounded-2xl border border-white/10 bg-white/5 text-white/60 text-sm' }, 'Начните ввод для поиска приложений'));
        filesWrap.appendChild(h('div', { class: 'p-3 rounded-2xl border border-white/10 bg-white/5 text-white/60 text-sm' }, 'Начните ввод для поиска файлов'));
      }
    }

    // ---------- Desktop context menus ----------
    function showCtxMenu(x, y){
      hideAllPopovers();
      const m = $('#ctxMenu');
      m.classList.remove('hidden');
      m.style.left = x + 'px';
      m.style.top = y + 'px';
      requestAnimationFrame(() => {
        const r = m.getBoundingClientRect();
        m.style.left = clamp(r.left, 8, window.innerWidth - r.width - 8) + 'px';
        m.style.top = clamp(r.top, 8, window.innerHeight - r.height - 8) + 'px';
      });
    }

    function showIconMenu(x, y, item){
      const m = $('#iconMenu');
      m.innerHTML = '';
      m.classList.remove('hidden');
      m.style.left = x + 'px';
      m.style.top = y + 'px';

      // IMPORTANT: first item is "Open"
      const openBtn = h('button', { class:'w-full text-left menu-item' }, [
        h('div', { class:'w-5 h-5', html: iconForItem(item) }),
        h('div', {}, 'Открыть')
      ]);
      openBtn.addEventListener('click', () => { openDesktopItem(item); hideAllPopovers(); });

      const renameBtn = h('button', { class:'w-full text-left menu-item' }, [
        h('div', { class:'w-5 h-5', html: Icons.dots('w-5 h-5') }),
        h('div', {}, 'Переименовать')
      ]);
      renameBtn.addEventListener('click', () => {
        const name = prompt('Новое имя:', item.name);
        if (!name) return;
        item.name = name;
        if (item.type === 'file' && item.fileId && fs.files[item.fileId]) {
          fs.files[item.fileId].name = name;
          fs.files[item.fileId].updatedAt = Date.now();
        }
        fsSave(fs);
        renderDesktopIcons();
        hideAllPopovers();
        addNotification({ title:'Рабочий стол', body:`Переименовано: ${name}`, iconHtml: Icons.win('w-6 h-6'), source:'Система' });
      });

      const delBtn = h('button', { class:'w-full text-left menu-item' }, [
        h('div', { class:'w-5 h-5', html: Icons.close('w-5 h-5') }),
        h('div', {}, 'Удалить')
      ]);
      delBtn.addEventListener('click', () => {
        if (!confirm(`Удалить «${item.name}»?`)) return;
        fs.desktop = fs.desktop.filter(x => x !== item);
        if (item.type === 'file' && item.fileId) delete fs.files[item.fileId];
        fsSave(fs);
        renderDesktopIcons();
        hideAllPopovers();
        addNotification({ title:'Рабочий стол', body:`Удалено: ${item.name}`, iconHtml: Icons.win('w-6 h-6'), source:'Система' });
      });

      m.append(openBtn, renameBtn, h('div', { class:'thin-sep my-1' }), delBtn);

      requestAnimationFrame(() => {
        const r = m.getBoundingClientRect();
        m.style.left = clamp(r.left, 8, window.innerWidth - r.width - 8) + 'px';
        m.style.top = clamp(r.top, 8, window.innerHeight - r.height - 8) + 'px';
      });
    }

    function doRefresh(){
      const root = $('#root');
      root.animate([
        { filter: 'none' },
        { filter: 'blur(1.2px)' },
        { filter: 'none' }
      ], { duration: 260, easing: 'ease-out' });
      addNotification({
        title: 'Рабочий стол',
        body: 'Обновление завершено.',
        iconHtml: Icons.refresh('w-6 h-6'),
        source: 'Система'
      });
    }

    function createDesktopFolder(nameOverride=null){
      const name = nameOverride ?? prompt('Имя новой папки:', 'Новая папка');
      if (!name) return;
      fs.desktop.unshift({ did: uid(), type: 'folder', folderId: uid(), name, pos: findFreeDesktopSlot() });
      fsSave(fs);
      renderDesktopIcons();
      addNotification({ title: 'Создание', body: `Папка «${name}» создана на рабочем столе.`, iconHtml: Icons.folder('w-6 h-6'), source: 'Проводник' });
    }

    function createDesktopNote(nameOverride=null){
      const name = nameOverride ?? prompt('Имя файла:', 'Новый документ');
      if (!name) return;
      const id = uid();
      const filename = name.endsWith('.txt') ? name : (name + '.txt');
      fs.files[id] = { id, name: filename, ext: 'txt', updatedAt: Date.now(), content: '' };
      fs.desktop.unshift({ did: uid(), type: 'file', fileId: id, name: filename, ext: 'txt', pos: findFreeDesktopSlot() });
      fsSave(fs);
      renderDesktopIcons();
      addRecent({ kind: 'file', fileId: id, name: filename, ts: Date.now() });
      openNotepadWithFile(id);
    }

    // ---------- Quick settings ----------
    function renderQuickSettings(){
      for (const key of ['wifi','bt','night']) {
        const sub = document.querySelector(`[data-sub="${key}"]`);
        if (sub) sub.textContent = state.toggles[key] ? 'Вкл' : 'Выкл';
      }
      $$('.qs-toggle').forEach(btn => {
        const k = btn.getAttribute('data-toggle');
        const on = !!state.toggles[k];
        btn.style.background = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
        btn.style.borderColor = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
      });
      updateTaskbar();
    }

    function setToggle(key, val){
      const before = !!state.toggles[key];
      state.toggles[key] = !!val;
      applyUI();
      persistUI();
      renderQuickSettings();
      updateTaskbar();

      if (before !== !!val) {
        const label = ({wifi:'Wi‑Fi', bt:'Bluetooth', night:'Ночной свет'})[key] || key;
        addNotification({
          title: 'Быстрые настройки',
          body: `${label}: ${val ? 'включено' : 'выключено'}.`,
          iconHtml: key === 'wifi' ? (val ? Icons.wifi('w-6 h-6') : Icons.wifiOff('w-6 h-6')) : Icons.settings('w-6 h-6'),
          source: 'Система'
        });
      }
    }

    // ---------- Clock ----------
    function tickClock(){
      const d = new Date();
      $('#clock').textContent = `${fmt2(d.getHours())}:${fmt2(d.getMinutes())}`;
      $('#date').textContent = d.toLocaleDateString('ru-RU');
    }

    // ---------- Apps ----------
    function buildExplorer(win){
      const container = h('div', { class: 'p-3' });
      const topbar = h('div', { class: 'flex items-center gap-2' }, [
        h('div', { class: 'flex items-center gap-2 flex-1 min-w-0' }, [
          h('div', { class: 'w-5 h-5', html: Icons.folder('w-5 h-5') }),
          h('div', { class: 'text-sm font-semibold' }, 'Проводник'),
          h('div', { class: 'ml-2 text-xs text-white/60 truncate', id: `path_${win.id}` }, 'Этот компьютер > Рабочий стол')
        ]),
        h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm', onclick: () => explorerCreateFolder(win.id) }, 'Новая папка'),
        h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm', onclick: () => explorerCreateText(win.id) }, 'Новый файл')
      ]);

      const body = h('div', { class: 'mt-3 grid grid-cols-[220px_1fr] gap-3' });
      const sidebar = h('div', { class: 'p-2 rounded-2xl border border-white/10 bg-white/5' });
      const main = h('div', { class: 'p-2 rounded-2xl border border-white/10 bg-white/5 min-h-[340px]' });

      const places = [
        { id:'desktop', name:'Рабочий стол', icon: Icons.win('w-5 h-5') },
        { id:'documents', name:'Документы', icon: Icons.note('w-5 h-5') },
        { id:'downloads', name:'Загрузки', icon: Icons.folder('w-5 h-5') }
      ];

      const viewState = { path: win.opts?.path || 'desktop' };
      win.opts = win.opts || {};
      win.opts.path = viewState.path;
      if (!fs[viewState.path]) fs[viewState.path] = [];

      places.forEach(p => {
        const b = h('button', { class: 'w-full text-left menu-item', 'data-place': p.id }, [
          h('div', { class: 'w-8 h-8 flex items-center justify-center', html: p.icon }),
          h('div', { class: 'text-sm font-semibold' }, p.name)
        ]);
        b.addEventListener('click', () => { viewState.path = p.id; win.opts.path = p.id; renderExplorer(); });
        sidebar.appendChild(b);
      });

      const breadcrumb = $('#path_' + win.id);

      function renderExplorer(){
        $$('[data-place]', sidebar).forEach(b => {
          const on = b.getAttribute('data-place') === viewState.path;
          b.style.background = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.16)` : '';
          b.style.border = on ? `1px solid rgba(${(ui.accent||[99,102,241]).join(',')},.22)` : '1px solid transparent';
          b.style.borderRadius = '12px';
        });

        if (breadcrumb) {
          const map = { desktop:'Этот компьютер > Рабочий стол', documents:'Этот компьютер > Документы', downloads:'Этот компьютер > Загрузки' };
          breadcrumb.textContent = map[viewState.path] || viewState.path;
        }

        main.innerHTML = '';
        main.appendChild(h('div', { class: 'flex items-center justify-between px-2 py-2' }, [
          h('div', { class: 'text-sm font-semibold' }, 'Элементы'),
          h('div', { class: 'text-xs text-white/60' }, 'Двойной клик — открыть')
        ]));
        main.appendChild(h('div', { class:'thin-sep my-1'}));

        const list = h('div', { class: 'grid grid-cols-1 gap-1' });
        const items = (viewState.path === 'desktop') ? fs.desktop : (fs[viewState.path] || []);

        if (!items.length) {
          list.appendChild(h('div', { class: 'p-6 text-center text-white/60' }, 'Папка пуста'));
        }

        for (const it of items) {
          const row = h('button', { class: 'w-full text-left px-3 py-2 rounded-xl hover:bg-white/8 flex items-center gap-3' }, [
            h('div', { class: 'w-8 h-8 flex items-center justify-center', html: iconForItem(it) }),
            h('div', { class: 'min-w-0 flex-1' }, [
              h('div', { class: 'text-sm font-semibold truncate' }, it.name),
              h('div', { class: 'text-xs text-white/60' }, it.type === 'file' ? 'Текстовый документ' : it.type === 'folder' ? 'Папка' : 'Приложение')
            ]),
            h('div', { class: 'text-[11px] text-white/50' }, it.type === 'file' ? (new Date(fs.files[it.fileId]?.updatedAt || Date.now()).toLocaleDateString('ru-RU')) : '')
          ]);

          row.addEventListener('dblclick', () => {
            if (it.type === 'app') openApp(it.appId);
            if (it.type === 'file') openNotepadWithFile(it.fileId);
            if (it.type === 'folder') {
              addNotification({ title: 'Проводник', body: `Открытие папки «${it.name}» (демо)`, iconHtml: Icons.folder('w-6 h-6'), source: 'Проводник' });
            }
          });

          list.appendChild(row);
        }

        main.appendChild(list);
      }

      renderExplorer();
      body.append(sidebar, main);
      container.append(topbar, body);
      return container;
    }

    function explorerCurrentPath(winId){
      const win = state.windows.get(winId);
      return win?.opts?.path || 'desktop';
    }

    // SYNC: create folder/file in currently selected location (including Desktop)
    function explorerCreateFolder(winId){
      const path = explorerCurrentPath(winId);
      const name = prompt('Имя новой папки:', 'Новая папка');
      if (!name) return;

      if (path === 'desktop') {
        createDesktopFolder(name);
        refreshWindowContent(winId);
        return;
      }

      fs[path] = fs[path] || [];
      fs[path].unshift({ type: 'folder', folderId: uid(), name });
      fsSave(fs);
      addNotification({ title:'Проводник', body:`Папка «${name}» создана в «${path}».`, iconHtml: Icons.folder('w-6 h-6'), source:'Проводник' });
      refreshWindowContent(winId);
    }

    function explorerCreateText(winId){
      const path = explorerCurrentPath(winId);
      const name = prompt('Имя файла:', 'Новый документ');
      if (!name) return;

      const id = uid();
      const filename = name.endsWith('.txt') ? name : (name + '.txt');
      fs.files[id] = { id, name: filename, ext: 'txt', updatedAt: Date.now(), content: '' };

      if (path === 'desktop') {
        fs.desktop.unshift({ did: uid(), type: 'file', fileId: id, name: filename, ext: 'txt', pos: findFreeDesktopSlot() });
        fsSave(fs);
        renderDesktopIcons();
        addRecent({ kind: 'file', fileId: id, name: filename, ts: Date.now() });
        addNotification({ title:'Проводник', body:`Файл «${filename}» создан на рабочем столе.`, iconHtml: Icons.note('w-6 h-6'), source:'Проводник' });
        refreshWindowContent(winId);
        openNotepadWithFile(id);
        return;
      }

      fs[path] = fs[path] || [];
      fs[path].unshift({ type: 'file', fileId: id, name: filename, ext: 'txt' });
      fsSave(fs);
      addRecent({ kind: 'file', fileId: id, name: filename, ts: Date.now() });
      addNotification({ title:'Проводник', body:`Файл «${filename}» создан в «${path}».`, iconHtml: Icons.note('w-6 h-6'), source:'Проводник' });
      refreshWindowContent(winId);
      openNotepadWithFile(id);
    }

    function refreshWindowContent(winId){
      const win = state.windows.get(winId);
      if (!win) return;
      const el = document.querySelector(`[data-win="${winId}"]`);
      if (!el) return;
      const content = $('[data-content]', el);
      if (!content) return;
      content.innerHTML = '';
      content.appendChild(registry[win.appId].build(win));
    }

    // Notepad
    function openNotepadWithFile(fileId){
      const id = openApp('notepad', { fileId });
      const win = state.windows.get(id);
      if (win) win.opts.fileId = fileId;
      refreshWindowContent(id);
      addRecent({ kind: 'file', fileId, name: fs.files[fileId]?.name || 'Файл', ts: Date.now() });
    }

    function buildNotepad(win){
      const fileId = win.opts?.fileId || null;
      const file = fileId ? fs.files[fileId] : null;
      const defaultName = file ? file.name : 'Безымянный.txt';

      const wrap = h('div', { class: 'p-3' });
      const bar = h('div', { class: 'flex flex-wrap items-center gap-2' });

      const nameBox = h('div', { class: 'text-sm font-semibold mr-auto' }, defaultName);

      const btnNew = h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Новый');
      const btnOpen = h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Открыть');
      const btnSave = h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Сохранить');
      const btnSaveAs = h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Сохранить как');
      const btnFind = h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Найти');

      bar.append(nameBox, btnNew, btnOpen, btnSave, btnSaveAs, btnFind);

      const textarea = h('textarea', {
        class: 'mt-3 w-full h-[380px] sm:h-[420px] resize-none bg-white/5 border border-white/10 rounded-2xl p-3 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60 scrollbar',
        spellcheck: 'false',
        style: 'user-select:text;'
      });

      let dirty = false;
      textarea.value = file ? (file.content || '') : '';
      textarea.addEventListener('input', () => { dirty = true; });

      function setTitle(title){
        const winEl = document.querySelector(`[data-win="${win.id}"]`);
        if (winEl) {
          const nm = $('.titletext .name', winEl);
          if (nm) nm.textContent = title;
        }
      }

      async function doOpen(){
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.txt,text/plain';
        input.onchange = async () => {
          const f = input.files?.[0];
          if (!f) return;
          const text = await readFileAsText(f);
          textarea.value = text;
          dirty = true;
          nameBox.textContent = f.name;
          setTitle('Блокнот — ' + f.name);
          addNotification({ title: 'Блокнот', body: `Открыт файл: ${f.name}`, iconHtml: registry.notepad.iconHtml, source: 'Блокнот' });
        };
        input.click();
      }

      function doSave(){
        if (fileId && fs.files[fileId]) {
          fs.files[fileId].content = textarea.value;
          fs.files[fileId].updatedAt = Date.now();
          fsSave(fs);
          dirty = false;
          addNotification({ title: 'Блокнот', body: `Сохранено: ${fs.files[fileId].name}`, iconHtml: registry.notepad.iconHtml, source: 'Блокнот' });
          addRecent({ kind: 'file', fileId, name: fs.files[fileId].name, ts: Date.now() });
          return;
        }
        doSaveAs();
      }

      function doSaveAs(){
        const filename = prompt('Сохранить как…', nameBox.textContent || 'Безымянный.txt');
        if (!filename) return;
        const finalName = filename.endsWith('.txt') ? filename : (filename + '.txt');
        downloadText(finalName, textarea.value);
        dirty = false;
        addNotification({ title: 'Блокнот', body: `Файл скачан: ${finalName}`, iconHtml: registry.notepad.iconHtml, source: 'Блокнот' });
      }

      function doNew(){
        if (dirty && !confirm('Есть несохранённые изменения. Создать новый документ?')) return;
        textarea.value = '';
        dirty = false;
        nameBox.textContent = 'Безымянный.txt';
        setTitle('Блокнот');
      }

      function doFind(){
        const q = prompt('Найти:', '');
        if (!q) return;
        const text = textarea.value;
        const idx = text.toLowerCase().indexOf(q.toLowerCase());
        if (idx === -1) {
          addNotification({ title:'Блокнот', body:`«${q}» не найдено.`, iconHtml: registry.notepad.iconHtml, source:'Блокнот' });
          return;
        }
        textarea.focus();
        textarea.setSelectionRange(idx, idx + q.length);
        addNotification({ title:'Блокнот', body:`Найдено: «${q}»`, iconHtml: registry.notepad.iconHtml, source:'Блокнот' });
      }

      btnOpen.addEventListener('click', doOpen);
      btnSave.addEventListener('click', doSave);
      btnSaveAs.addEventListener('click', doSaveAs);
      btnNew.addEventListener('click', doNew);
      btnFind.addEventListener('click', doFind);

      wrap.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
          e.preventDefault();
          doSave();
        }
      });

      registerBeforeClose(win.id, () => {
        if (!dirty) return true;
        const wantSave = confirm('Есть несохранённые изменения. Сохранить перед закрытием?');
        if (wantSave) { doSave(); return true; }
        return confirm('Закрыть без сохранения?');
      });

      wrap.append(bar, textarea);
      setTitle(file ? ('Блокнот — ' + file.name) : 'Блокнот');
      return wrap;
    }

    // Calculator
    function buildCalculator(win){
      const wrap = h('div', { class: 'p-3' });
      const display = h('div', { class: 'p-4 rounded-2xl border border-white/10 bg-white/5 text-right' }, [
        h('div', { id: `calcExpr_${win.id}`, class: 'text-xs text-white/60 truncate' }, ' '),
        h('div', { id: `calcDisp_${win.id}`, class: 'text-3xl font-semibold tracking-tight' }, '0')
      ]);

      const keys = [
        ['C','CE','%','/'],
        ['7','8','9','*'],
        ['4','5','6','-'],
        ['1','2','3','+'],
        ['±','0','.','=']
      ];

      let expr = '';
      let curr = '0';
      let justEval = false;

      const exprEl = () => document.getElementById(`calcExpr_${win.id}`);
      const dispEl = () => document.getElementById(`calcDisp_${win.id}`);

      function setDisp(v){ curr = v; if (dispEl()) dispEl().textContent = curr; }
      function setExpr(v){ expr = v; if (exprEl()) exprEl().textContent = expr || ' '; }

      function press(k){
        if ('0123456789'.includes(k)) {
          if (justEval) { setExpr(''); justEval = false; setDisp('0'); }
          setDisp(curr === '0' ? k : (curr + k));
          return;
        }
        if (k === '.') {
          if (justEval) { setExpr(''); justEval = false; setDisp('0'); }
          if (!curr.includes('.')) setDisp(curr + '.');
          return;
        }
        if (k === 'C') { setExpr(''); setDisp('0'); justEval = false; return; }
        if (k === 'CE') { setDisp('0'); justEval = false; return; }
        if (k === '±') {
          if (curr === '0') return;
          setDisp(curr.startsWith('-') ? curr.slice(1) : ('-' + curr));
          return;
        }
        if (k === '%') {
          const v = Number(curr);
          if (!Number.isFinite(v)) return;
          setDisp(String(v/100));
          return;
        }
        if (['+','-','*','/'].includes(k)) {
          if (justEval) { justEval = false; }
          const token = curr;
          if (!expr) {
            setExpr(token + ' ' + k);
          } else {
            if (/[+\-*/]$/.test(expr.trim())) setExpr(expr.replace(/[+\-*/]\s*$/, k));
            else setExpr(expr + ' ' + token + ' ' + k);
          }
          setDisp('0');
          return;
        }
        if (k === '=') {
          let e = expr.trim();
          if (!e) return;
          if (/[+\-*/]$/.test(e)) e = e + ' ' + curr;
          else e = e + ' ' + curr;
          if (!/^[0-9+\-*/.\s]+$/.test(e)) return;
          try {
            const result = Function('"use strict"; return (' + e + ');')();
            if (!Number.isFinite(result)) throw new Error('NaN');
            setExpr(e + ' =');
            setDisp(String(Number(result.toFixed(10))));
            justEval = true;
            addNotification({ title:'Калькулятор', body:`Результат: ${curr}`, iconHtml: registry.calculator.iconHtml, source:'Калькулятор' });
          } catch {
            setExpr('Ошибка');
            setDisp('0');
            justEval = false;
            addNotification({ title:'Калькулятор', body:'Ошибка вычисления.', iconHtml: registry.calculator.iconHtml, source:'Калькулятор' });
          }
          return;
        }
      }

      const grid = h('div', { class: 'mt-3 grid grid-cols-4 gap-2' });
      keys.flat().forEach(k => {
        const isOp = ['+','-','*','/','='].includes(k);
        const btn = h('button', {
          class: `px-3 py-4 rounded-2xl border border-white/10 ${isOp ? 'bg-white/10' : 'bg-white/5'} hover:bg-white/15 text-lg font-semibold`,
          onclick: () => press(k)
        }, k);
        if (k === '=') {
          btn.style.background = `rgba(${(ui.accent||[99,102,241]).join(',')},.28)`;
          btn.style.borderColor = `rgba(${(ui.accent||[99,102,241]).join(',')},.35)`;
        }
        grid.appendChild(btn);
      });

      wrap.append(display, grid);
      wrap.tabIndex = 0;
      wrap.addEventListener('keydown', (e) => {
        const map = { 'Enter':'=', 'Escape':'C' };
        if (map[e.key]) { e.preventDefault(); press(map[e.key]); return; }
        if ('0123456789.+-*/'.includes(e.key)) {
          e.preventDefault();
          press(e.key);
        }
      });
      setTimeout(() => wrap.focus(), 50);
      return wrap;
    }

    // Edge (simulation + Yandex search + Tabs beta)
    function buildEdge(win){
      win.opts = win.opts || {};

      const pages = {
        'win://home': () => `
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-xl font-semibold">Edge (симуляция)</div>
              <div class="text-white/70 mt-1">Внутренние страницы: <span class="kbd">win://home</span>, <span class="kbd">win://news</span>, <span class="kbd">win://tips</span>.</div>
              <div class="text-white/70 mt-1">Любая строка без URL — будет искаться в <b>Яндексе</b>.</div>
            </div>
            <div class="w-12 h-12">${Icons.edge('w-12 h-12')}</div>
          </div>
          <div class="mt-4 p-4 rounded-2xl border border-white/10 bg-white/5">
            <div class="text-sm font-semibold">Поиск (Яндекс)</div>
            <div class="text-xs text-white/70 mt-1">Режим вкладок: <span class="kbd">Beta</span> — может открывать Яндекс внутри окна (если сайт позволит iframe).</div>
          </div>
          <div class="mt-4 grid sm:grid-cols-3 gap-3">
            <button data-nav="win://news" class="p-4 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-left">
              <div class="text-sm font-semibold">Новости</div>
              <div class="text-xs text-white/70 mt-1">Локальная лента</div>
            </button>
            <button data-nav="win://tips" class="p-4 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-left">
              <div class="text-sm font-semibold">Подсказки</div>
              <div class="text-xs text-white/70 mt-1">Горячие клавиши</div>
            </button>
            <button data-nav="yandex:Windows 12 UI" class="p-4 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-left">
              <div class="text-sm font-semibold">Поиск: Windows 12 UI</div>
              <div class="text-xs text-white/70 mt-1">Яндекс</div>
            </button>
          </div>
        `,
        'win://news': () => `
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xl font-semibold">Лента новостей</div>
              <div class="text-white/70 mt-1">Демо-контент для реалистичного окна браузера.</div>
            </div>
            <button data-nav="win://home" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Назад</button>
          </div>
          <div class="mt-4 grid gap-3">
            ${[1,2,3,4].map(i => `
              <div class="p-4 rounded-2xl border border-white/10 bg-white/5">
                <div class="text-sm font-semibold">Обновления интерфейса #${i}</div>
                <div class="text-xs text-white/70 mt-1">Store, мультивыделение и синхронизация рабочего стола с проводником.</div>
              </div>
            `).join('')}
          </div>
        `,
        'win://tips': () => `
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xl font-semibold">Подсказки</div>
              <div class="text-white/70 mt-1">Управление в этой симуляции:</div>
            </div>
            <button data-nav="win://home" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Домой</button>
          </div>
          <div class="mt-4 grid gap-3">
            <div class="p-4 rounded-2xl border border-white/10 bg-white/5">
              <div class="text-sm font-semibold">Рабочий стол</div>
              <div class="text-sm text-white/80 mt-2 space-y-1">
                <div>Одиночный клик — выделение</div>
                <div>Ctrl/⌘ + клик — мультивыделение</div>
                <div>Рамка выделения — выделить несколько</div>
                <div>Перетащите выделенные — двигаются вместе</div>
              </div>
            </div>
            <div class="p-4 rounded-2xl border border-white/10 bg-white/5">
              <div class="text-sm font-semibold">Клавиатура</div>
              <div class="text-sm text-white/80 mt-2 space-y-1">
                <div><span class="kbd">Win</span> — «Пуск»</div>
                <div><span class="kbd">Win</span>+<span class="kbd">R</span> — «Выполнить»</div>
                <div><span class="kbd">Esc</span> — закрыть меню/панели</div>
                <div><span class="kbd">Alt</span>+<span class="kbd">Tab</span> — переключение окон</div>
                <div><span class="kbd">F5</span> — обновить рабочий стол</div>
              </div>
            </div>
          </div>
        `
      };

      const wrap = h('div', { class: 'p-3' });

      // Beta toggles
      const betaPill = (label, get, set) => {
        const b = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-xs flex items-center gap-2' }, [
          h('span', { class:'kbd' }, 'beta'),
          h('span', {}, label)
        ]);
        const paint = () => {
          const on = !!get();
          b.style.background = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
          b.style.borderColor = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
        };
        b.addEventListener('click', () => { set(!get()); paint(); });
        paint();
        return b;
      };

      const btnTabs = betaPill('Вкладки', () => state.edgeTabsBeta, (v) => { state.edgeTabsBeta = !!v; persistUI(); });
      const btnInside = betaPill('Открывать Яндекс внутри', () => state.edgeOpenInsideBeta, (v) => { state.edgeOpenInsideBeta = !!v; persistUI(); });

      const address = h('input', {
        class: 'flex-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60',
        placeholder: 'Адрес / запрос (Яндекс)'
      });

      const btnGo = h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Перейти');
      const btnHome = h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Домой');
      const btnNew = h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Новая вкладка');

      const bar = h('div', { class: 'flex items-center gap-2 flex-wrap' }, [
        h('div', { class:'w-6 h-6', html: registry.edge.iconHtml }),
        address, btnGo, btnHome, btnNew, btnTabs, btnInside
      ]);

      const tabStrip = h('div', { class:'mt-3 flex items-center gap-2 overflow-auto scrollbar' });

      const view = h('div', { class: 'mt-3 p-0 rounded-2xl border border-white/10 bg-white/5 overflow-hidden min-h-[420px]' });
      const inner = h('div', { class: 'p-4 fade-swap' });
      view.appendChild(inner);

      // tabs state (per window)
      win.opts.tabs = Array.isArray(win.opts.tabs) ? win.opts.tabs : null;
      if (!win.opts.tabs) {
        const initial = win.opts?.url || 'win://home';
        win.opts.tabs = [{ tid: uid(), title: 'Домой', url: initial }];
        win.opts.activeTid = win.opts.tabs[0].tid;
      }

      function activeTab(){
        return win.opts.tabs.find(t => t.tid === win.opts.activeTid) || win.opts.tabs[0];
      }

      function setActive(tid){
        win.opts.activeTid = tid;
        renderTabs();
        renderView();
      }

      function newTab(url='win://home'){
        const t = { tid: uid(), title: 'Новая вкладка', url };
        win.opts.tabs.push(t);
        setActive(t.tid);
      }

      function closeTab(tid){
        if (win.opts.tabs.length <= 1) return;
        const idx = win.opts.tabs.findIndex(t => t.tid === tid);
        if (idx === -1) return;
        const wasActive = win.opts.activeTid === tid;
        win.opts.tabs.splice(idx,1);
        if (wasActive) {
          const next = win.opts.tabs[Math.max(0, idx-1)] || win.opts.tabs[0];
          win.opts.activeTid = next.tid;
        }
        renderTabs();
        renderView();
      }

      function setInnerContent(nodeOrHtml){
        inner.classList.remove('fade-swap');
        void inner.offsetHeight;
        inner.classList.add('fade-swap');
        inner.innerHTML = '';
        if (typeof nodeOrHtml === 'string') inner.innerHTML = nodeOrHtml;
        else inner.appendChild(nodeOrHtml);
        $$('[data-nav]', inner).forEach(b => b.addEventListener('click', () => navigate(b.getAttribute('data-nav'))));
      }

      function openExternal(url, note){
        window.open(url, '_blank', 'noopener');
        addNotification({ title:'Microsoft Edge', body: note || `Открыто: ${url}`, iconHtml: registry.edge.iconHtml, source:'Microsoft Edge' });
      }

      function yandexUrl(query){
        const q = encodeURIComponent(query.trim());
        return `https://yandex.ru/search/?text=${q}`;
      }

      function renderYandexInside(query){
        const url = yandexUrl(query);
        const box = h('div', { class:'p-4' }, [
          h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
            h('div', {}, [
              h('div', { class:'text-lg font-semibold' }, `Яндекс — ${query}`),
              h('div', { class:'text-xs text-white/70 mt-1' }, 'Внутренний просмотр — beta. Некоторые сайты могут блокировать показ в iframe.')
            ]),
            h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm', onclick: () => openExternal(url, `Поиск в Яндексе: ${query}`) }, 'Открыть во внешней вкладке')
          ]),
          h('div', { class:'mt-3 rounded-2xl border border-white/10 overflow-hidden bg-black/20', style:'height: 420px;' }, [
            h('iframe', {
              src: url,
              class: 'w-full h-full',
              sandbox: 'allow-forms allow-scripts allow-popups allow-top-navigation-by-user-activation',
              referrerpolicy: 'no-referrer'
            })
          ]),
          h('div', { class:'mt-3 text-xs text-white/60' }, `URL: ${url}`)
        ]);
        setInnerContent(box);
      }

      function renderWebInside(url){
        const box = h('div', { class:'p-4' }, [
          h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
            h('div', {}, [
              h('div', { class:'text-lg font-semibold' }, 'Веб-страница (beta)'),
              h('div', { class:'text-xs text-white/70 mt-1' }, 'Если сайт не отображается — используйте внешнюю вкладку.')
            ]),
            h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm', onclick: () => openExternal(url, `Открыто: ${url}`) }, 'Открыть во внешней вкладке')
          ]),
          h('div', { class:'mt-3 rounded-2xl border border-white/10 overflow-hidden bg-black/20', style:'height: 420px;' }, [
            h('iframe', {
              src: url,
              class: 'w-full h-full',
              sandbox: 'allow-forms allow-scripts allow-popups allow-top-navigation-by-user-activation',
              referrerpolicy: 'no-referrer'
            })
          ]),
          h('div', { class:'mt-3 text-xs text-white/60 break-all' }, `URL: ${url}`)
        ]);
        setInnerContent(box);
      }

      function setTitleForUrl(t){
        const u = t.url;
        if (u.startsWith('win://')) t.title = u.replace('win://','').toUpperCase();
        else if (u.startsWith('yandex:')) t.title = 'Яндекс';
        else if (!isProbablyUrl(u)) t.title = 'Яндекс';
        else {
          let x = u.replace(/^https?:\/\//i,'');
          if (x.length > 18) x = x.slice(0,18) + '…';
          t.title = x;
        }
      }

      function renderTabs(){
        tabStrip.innerHTML = '';
        if (!state.edgeTabsBeta) return;

        for (const t of win.opts.tabs) {
          setTitleForUrl(t);
          const active = (t.tid === win.opts.activeTid);
          const tab = h('div', { class:`flex items-center gap-2 px-3 py-2 rounded-2xl border ${active ? 'bg-white/10 border-white/15' : 'bg-white/5 border-white/10'} hover:bg-white/10 transition` });
          const title = h('button', { class:'text-xs font-semibold max-w-[160px] truncate' }, t.title);
          title.addEventListener('click', () => setActive(t.tid));
          const close = h('button', { class:'text-xs px-2 py-1 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10', title:'Закрыть' }, '×');
          close.addEventListener('click', (e) => { e.stopPropagation(); closeTab(t.tid); });
          tab.append(title, close);
          tabStrip.appendChild(tab);
        }

        const plus = h('button', { class:'px-3 py-2 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm', title:'Новая вкладка' }, '+');
        plus.addEventListener('click', () => newTab('win://home'));
        tabStrip.appendChild(plus);
      }

      function renderView(){
        const t = activeTab();
        address.value = t.url;

        const u = (t.url || '').trim();
        if (!u) { setInnerContent(pages['win://home']()); return; }

        // yandex pseudo scheme
        if (u.startsWith('yandex:')) {
          const q = u.slice('yandex:'.length);
          if (state.edgeTabsBeta && state.edgeOpenInsideBeta) renderYandexInside(q);
          else {
            openExternal(yandexUrl(q), `Поиск в Яндексе: ${q}`);
            setInnerContent(`<div class="p-4"><div class="text-xl font-semibold">Открыто во внешней вкладке</div><div class="text-white/70 mt-2">Запрос: <span class="kbd">${escapeHtml(q)}</span></div></div>`);
          }
          return;
        }

        if (u.startsWith('win://')) {
          setInnerContent(pages[u] ? pages[u]() : `<div class="p-4"><div class="text-xl font-semibold">Страница не найдена</div><div class="text-white/70 mt-2">Неизвестный адрес: <span class="kbd">${escapeHtml(u)}</span></div></div>`);
          return;
        }

        if (!isProbablyUrl(u)) {
          // treat as query
          const q = u;
          if (state.edgeTabsBeta && state.edgeOpenInsideBeta) renderYandexInside(q);
          else {
            openExternal(yandexUrl(q), `Поиск в Яндексе: ${q}`);
            setInnerContent(`<div class="p-4"><div class="text-xl font-semibold">Открыто во внешней вкладке</div><div class="text-white/70 mt-2">Запрос: <span class="kbd">${escapeHtml(q)}</span></div></div>`);
          }
          return;
        }

        let final = u;
        if (!/^https?:\/\//i.test(final)) final = 'https://' + final;

        if (state.edgeTabsBeta && state.edgeOpenInsideBeta) {
          renderWebInside(final);
        } else {
          openExternal(final, `Открыто: ${final}`);
          setInnerContent(`<div class="p-4"><div class="text-xl font-semibold">Открыто во внешней вкладке</div><div class="text-white/70 mt-2">URL: <span class="kbd">${escapeHtml(final)}</span></div></div>`);
        }
      }

      function navigate(url){
        const u = (url || '').trim();
        if (!u) return;
        const t = activeTab();
        t.url = u;
        renderTabs();
        renderView();
        addRecent({ kind: 'app', appId: 'edge', name: 'Microsoft Edge', ts: Date.now() });
      }

      btnGo.addEventListener('click', () => navigate(address.value));
      btnHome.addEventListener('click', () => navigate('win://home'));
      btnNew.addEventListener('click', () => {
        if (state.edgeTabsBeta) newTab('win://home');
        else openApp('edge', { url: 'win://home' });
      });
      address.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); navigate(address.value); }
      });

      // initial render
      renderTabs();
      renderView();

      wrap.append(bar);
      wrap.appendChild(tabStrip);
      wrap.appendChild(view);
      return wrap;
    }

    // Microsoft Store (fixed: no document query during build + install animation)
    function buildStore(win){
      win.opts = win.opts || {};
      win.opts._installing = win.opts._installing || {};

      const wrap = h('div', { class:'p-3' });

      const header = h('div', { class:'flex items-center gap-2' }, [
        h('div', { class:'w-6 h-6', html: registry.store.iconHtml }),
        h('div', { class:'text-lg font-semibold' }, 'Microsoft Store'),
        h('div', { class:'ml-auto text-xs text-white/60' }, 'Каталог (демо)')
      ]);

      const searchInput = h('input', {
        class:'flex-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60',
        placeholder:'Поиск в Store (Flappy Bird, VS Code, Word...)'
      });
      const btnReset = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Сброс');

      const top = h('div', { class:'mt-3 flex items-center gap-2' }, [
        searchInput,
        btnReset
      ]);

      const info = h('div', { class:'mt-3 p-4 rounded-2xl border border-white/10 bg-white/5 text-sm text-white/80 shimmer' }, [
        h('div', { class:'font-semibold' }, 'Важно'),
        h('div', { class:'text-xs text-white/70 mt-1' }, 'Доступна только Flappy Bird. Остальные — «Скоро». Установка/удаление — демо (localStorage).')
      ]);

      const grid = h('div', { class:'mt-3 grid sm:grid-cols-2 lg:grid-cols-3 gap-3' });

      function ensureDesktopIcon(appId){
        const app = registry[appId];
        if (!app) return;
        const exists = fs.desktop.some(x => x.type==='app' && x.appId===appId);
        if (exists) return;
        fs.desktop.unshift({ did: uid(), type:'app', appId, name: app.name, pos: findFreeDesktopSlot() });
        fsSave(fs);
        renderDesktopIcons();
      }

      function removeDesktopIcon(appId){
        const before = fs.desktop.length;
        fs.desktop = fs.desktop.filter(x => !(x.type==='app' && x.appId===appId));
        if (fs.desktop.length !== before) {
          fsSave(fs);
          renderDesktopIcons();
        }
      }

      function closeAllWindowsOfApp(appId){
        for (const w of Array.from(state.windows.values())) {
          if (w.appId === appId) closeWindow(w.id);
        }
      }

      function startInstall(appId){
        const meta = STORE_CATALOG.find(x => x.id === appId);
        if (!meta) return;
        if (meta.status !== 'available') {
          addNotification({ title:'Microsoft Store', body:`«${meta.name}» — скоро.`, iconHtml: registry.store.iconHtml, source:'Microsoft Store' });
          return;
        }
        if (win.opts._installing[appId]) return;

        const prog = { v: 0, timer: null };
        win.opts._installing[appId] = prog;

        const step = () => {
          prog.v = Math.min(100, prog.v + 10 + Math.random()*18);
          render();
          if (prog.v >= 100) {
            clearInterval(prog.timer);
            delete win.opts._installing[appId];
            state.installedApps.add(appId);
            persistUI();
            ensureDesktopIcon(appId);
            addNotification({ title:'Microsoft Store', body:`Установлено: ${meta.name}`, iconHtml: registry.store.iconHtml, source:'Microsoft Store' });
            render();
          }
        };
        step();
        prog.timer = setInterval(step, 220);
      }

      function uninstall(appId){
        const meta = STORE_CATALOG.find(x => x.id === appId);
        if (!meta) return;
        if (win.opts._installing[appId]) return;
        state.installedApps.delete(appId);
        persistUI();
        removeDesktopIcon(appId);
        closeAllWindowsOfApp(appId);
        addNotification({ title:'Microsoft Store', body:`Удалено: ${meta.name}`, iconHtml: registry.store.iconHtml, source:'Microsoft Store' });
        render();
      }

      function render(){
        grid.innerHTML = '';
        const q = (searchInput.value || '').trim().toLowerCase();
        const focusId = win.opts?.focusAppId;

        const list = STORE_CATALOG.filter(a => !q || a.name.toLowerCase().includes(q) || a.id.includes(q) || a.category.toLowerCase().includes(q));
        const groups = ['Игры','Продуктивность'];

        for (const g of groups) {
          const items = list.filter(x => x.category === g);
          if (!items.length) continue;
          grid.appendChild(h('div', { class:'sm:col-span-2 lg:col-span-3 text-sm font-semibold text-white/80 mt-2' }, g));

          for (const a of items) {
            const installed = isInstalled(a.id);
            const installing = win.opts._installing[a.id];

            const card = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5 transition ' + (focusId===a.id ? 'ring-2 ring-[rgb(var(--accent))]/50' : '') });
            const topRow = h('div', { class:'flex items-start gap-3' }, [
              h('div', { class:'w-10 h-10 flex items-center justify-center', html: a.iconHtml }),
              h('div', { class:'min-w-0 flex-1' }, [
                h('div', { class:'text-sm font-semibold truncate' }, a.name),
                h('div', { class:'text-xs text-white/60' }, a.desc)
              ]),
              h('div', { class:'text-[11px] text-white/60' }, a.status === 'available' ? 'Доступно' : 'Скоро')
            ]);

            const actions = h('div', { class:'mt-3 flex items-center gap-2 flex-wrap' });

            const btnOpen = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Открыть');
            btnOpen.disabled = !(installed && a.status === 'available');
            btnOpen.style.opacity = btnOpen.disabled ? '.5' : '1';
            btnOpen.addEventListener('click', () => openApp(a.id));

            const btnInstall = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' });
            const btnUninstall = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Удалить');

            if (installing) {
              btnInstall.textContent = `Установка… ${Math.floor(installing.v)}%`;
              btnInstall.disabled = true;
              btnInstall.style.opacity = '.8';

              btnUninstall.disabled = true;
              btnUninstall.style.opacity = '.45';

              const bar = h('div', { class:'w-full mt-2 h-2 rounded-full bg-white/10 overflow-hidden border border-white/10' }, [
                h('div', { class:'h-full', style:`width:${Math.floor(installing.v)}%; background: rgba(${(ui.accent||[99,102,241]).join(',')},.70); transition: width .22s ease;` })
              ]);
              card.appendChild(bar);
            } else if (installed) {
              btnInstall.textContent = 'Установлено';
              btnInstall.disabled = true;
              btnInstall.style.opacity = '.6';

              btnUninstall.disabled = false;
              btnUninstall.style.opacity = '1';
              btnUninstall.addEventListener('click', () => uninstall(a.id));
            } else if (a.status !== 'available') {
              btnInstall.textContent = 'Скоро';
              btnInstall.disabled = true;
              btnInstall.style.opacity = '.5';

              btnUninstall.disabled = true;
              btnUninstall.style.opacity = '.45';
            } else {
              btnInstall.textContent = 'Установить';
              btnInstall.style.background = `rgba(${(ui.accent||[99,102,241]).join(',')},.18)`;
              btnInstall.style.borderColor = `rgba(${(ui.accent||[99,102,241]).join(',')},.28)`;
              btnInstall.addEventListener('click', () => startInstall(a.id));

              btnUninstall.disabled = true;
              btnUninstall.style.opacity = '.45';
            }

            actions.append(btnOpen, btnInstall, btnUninstall);
            card.append(topRow, actions);
            grid.appendChild(card);
          }
        }
      }

      btnReset.addEventListener('click', () => {
        // cancel installs
        for (const k of Object.keys(win.opts._installing)) {
          const it = win.opts._installing[k];
          if (it?.timer) clearInterval(it.timer);
          delete win.opts._installing[k];
        }
        state.installedApps = new Set(['flappy']);
        persistUI();
        ensureDesktopIcon('flappy');
        for (const id of Array.from(OPTIONAL_APPS)) {
          if (id !== 'flappy') removeDesktopIcon(id);
        }
        addNotification({ title:'Microsoft Store', body:'Сброшены установки (оставлен Flappy Bird).', iconHtml: registry.store.iconHtml, source:'Microsoft Store' });
        render();
      });

      searchInput.addEventListener('input', () => render());

      if (win.opts?.focusAppId) {
        searchInput.value = String(win.opts.focusAppId);
      }

      render();
      wrap.append(header, top, info, grid);
      return wrap;
    }

    // Settings
    function buildSettings(win){
      const wrap = h('div', { class: 'p-3' });
      const header = h('div', { class: 'flex items-center gap-2' }, [
        h('div', { class:'w-6 h-6', html: registry.settings.iconHtml }),
        h('div', { class: 'text-lg font-semibold' }, 'Параметры'),
        h('div', { class: 'ml-auto text-xs text-white/60' }, 'Изменения сохраняются в localStorage')
      ]);

      const layout = h('div', { class: 'mt-3 grid grid-cols-[240px_1fr] gap-3' });
      const nav = h('div', { class: 'p-2 rounded-2xl border border-white/10 bg-white/5' });
      const main = h('div', { class: 'p-4 rounded-2xl border border-white/10 bg-white/5 min-h-[420px]' });

      const sections = [
        { id:'system', name:'Система', icon: Icons.settings('w-5 h-5') },
        { id:'personal', name:'Персонализация', icon: Icons.win('w-5 h-5') },
        { id:'network', name:'Сеть', icon: Icons.wifi('w-5 h-5') }
      ];

      const view = { id: win.opts?.section || 'personal' };

      function navBtn(sec){
        const b = h('button', { class: 'w-full text-left menu-item', 'data-sec': sec.id }, [
          h('div', { class:'w-8 h-8 flex items-center justify-center', html: sec.icon }),
          h('div', { class:'text-sm font-semibold' }, sec.name)
        ]);
        b.addEventListener('click', () => { view.id = sec.id; render(); });
        return b;
      }

      sections.forEach(s => nav.appendChild(navBtn(s)));

      function render(){
        $$('[data-sec]', nav).forEach(b => {
          const on = b.getAttribute('data-sec') === view.id;
          b.style.background = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.16)` : '';
          b.style.border = on ? `1px solid rgba(${(ui.accent||[99,102,241]).join(',')},.22)` : '1px solid transparent';
          b.style.borderRadius = '12px';
        });
        main.innerHTML = '';
        if (view.id === 'personal') main.appendChild(sectionPersonal());
        if (view.id === 'system') main.appendChild(sectionSystem());
        if (view.id === 'network') main.appendChild(sectionNetwork());
      }

      function sectionSystem(){
        const box = h('div', { class: 'space-y-3' });
        box.append(
          h('div', { class:'text-lg font-semibold' }, 'Система'),
          h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
            h('div', { class:'text-sm font-semibold' }, 'Звук'),
            h('div', { class:'text-xs text-white/70 mt-1' }, 'Громкость системы'),
            h('div', { class:'mt-3 flex items-center gap-3' }, [
              h('div', { class:'w-6 h-6', html: (state.volume===0?Icons.volumeMute('w-6 h-6'):Icons.volume('w-6 h-6')) }),
              (() => {
                const r = h('input', { type:'range', min:'0', max:'100', value:String(state.volume), class:'w-full' });
                r.addEventListener('input', () => {
                  state.volume = Number(r.value);
                  persistUI();
                  updateTaskbar();
                });
                r.addEventListener('change', () => addNotification({ title:'Звук', body:`Громкость: ${state.volume}%`, iconHtml: Icons.volume('w-6 h-6'), source:'Параметры' }));
                return r;
              })()
            ])
          ]),
          h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
            h('div', { class:'text-sm font-semibold' }, 'Уведомления'),
            h('div', { class:'text-xs text-white/70 mt-1' }, 'Всплывающие тосты отключены по умолчанию.'),
            (() => {
              const row = h('div', { class:'mt-3 flex items-center justify-between gap-3' });
              const left = h('div', { class:'text-sm text-white/80' }, 'Показывать всплывающие уведомления');
              const btn = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' });
              const renderBtn = () => {
                btn.textContent = state.showToasts ? 'Включено' : 'Выключено';
                btn.style.background = state.showToasts ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
                btn.style.borderColor = state.showToasts ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
              };
              btn.addEventListener('click', () => {
                state.showToasts = !state.showToasts;
                persistUI();
                renderBtn();
                addNotification({ title:'Параметры', body:`Тосты: ${state.showToasts ? 'включены' : 'выключены'}.`, iconHtml: registry.settings.iconHtml, source:'Параметры' });
              });
              renderBtn();
              row.append(left, btn);
              return row;
            })()
          ]),
          h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
            h('div', { class:'text-sm font-semibold' }, 'Полноэкранный режим (браузер)'),
            h('div', { class:'text-xs text-white/70 mt-1' }, 'Использует Fullscreen API. Браузер может запросить подтверждение.'),
            (() => {
              const row = h('div', { class:'mt-3 flex items-center justify-between gap-3' });
              const left = h('div', { class:'text-sm text-white/80' }, 'Открыть «Windows 12» во весь экран');
              const btn = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' });
              const paint = () => {
                const on = isBrowserFullscreen();
                btn.textContent = on ? 'Включено' : 'Выключено';
                btn.style.background = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
                btn.style.borderColor = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
              };
              btn.addEventListener('click', async () => {
                await setBrowserFullscreen(!isBrowserFullscreen());
                paint();
                addNotification({ title:'Параметры', body:`Полноэкранный режим: ${isBrowserFullscreen() ? 'включен' : 'выключен'}.`, iconHtml: registry.settings.iconHtml, source:'Параметры' });
              });
              paint();
              row.append(left, btn);
              return row;
            })()
          ]),
          h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
            h('div', { class:'text-sm font-semibold' }, 'О системе'),
            h('div', { class:'text-sm text-white/80 mt-2' }, 'Windows 12 (UI Simulation)'),
            h('div', { class:'text-xs text-white/70 mt-1' }, `Версия: ${W12_VERSION} • Build: ${W12_BUILD}`),
            h('div', { class:'text-xs text-white/70 mt-1' }, 'Создатель — Врискас'),
            h('div', { class:'text-xs text-white/60 mt-1' }, 'Это веб-симуляция интерфейса ОС. Не является настоящей операционной системой.')
          ])
        );
        return box;
      }

      function sectionNetwork(){
        const box = h('div', { class:'space-y-3' });
        const mkToggle = (key, title, desc) => {
          const row = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5 flex items-center justify-between gap-4' });
          const left = h('div', {}, [
            h('div', { class:'text-sm font-semibold' }, title),
            h('div', { class:'text-xs text-white/70 mt-1' }, desc)
          ]);
          const btn = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' });
          function renderBtn(){
            btn.textContent = state.toggles[key] ? 'Включено' : 'Выключено';
            btn.style.background = state.toggles[key] ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
            btn.style.borderColor = state.toggles[key] ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
          }
          btn.addEventListener('click', () => { setToggle(key, !state.toggles[key]); renderBtn(); });
          renderBtn();
          row.append(left, btn);
          return row;
        };

        box.append(
          h('div', { class:'text-lg font-semibold' }, 'Сеть'),
          mkToggle('wifi','Wi‑Fi','В этой симуляции влияет на иконку в трее'),
          mkToggle('bt','Bluetooth','Демо-переключатель'),
          mkToggle('night','Ночной свет','Реализовано отдельным оверлеем (не ломает панель задач)')
        );
        return box;
      }

      function sectionPersonal(){
        const box = h('div', { class: 'space-y-3' });
        box.appendChild(h('div', { class: 'text-lg font-semibold' }, 'Персонализация'));

        const accents = [
          { name:'Индиго', rgb:[99,102,241] },
          { name:'Синий', rgb:[59,130,246] },
          { name:'Бирюзовый', rgb:[34,211,238] },
          { name:'Зелёный', rgb:[34,197,94] },
          { name:'Розовый', rgb:[244,114,182] },
          { name:'Оранжевый', rgb:[249,115,22] }
        ];

        const accentCard = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Цвет акцента'),
          h('div', { class:'text-xs text-white/70 mt-1' }, 'Используется для подчёркивания активных элементов и Snap.'),
          h('div', { class:'mt-3 grid grid-cols-6 gap-2' }, accents.map(a => {
            const b = h('button', {
              class:'h-10 rounded-xl border border-white/10 hover:scale-[1.02] transition',
              title: a.name
            });
            b.style.background = `rgb(${a.rgb.join(',')})`;
            const isOn = (ui.accent||[]).join(',') === a.rgb.join(',');
            if (isOn) b.style.outline = '3px solid rgba(255,255,255,.35)';
            b.addEventListener('click', () => {
              ui.accent = a.rgb;
              persistUI();
              applyUI();
              addNotification({ title:'Персонализация', body:`Акцент: ${a.name}`, iconHtml: registry.settings.iconHtml, source:'Параметры' });
              refreshWindowContent(win.id);
              updateTaskbar();
            });
            return b;
          }))
        ]);

        const transCard = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Эффекты прозрачности'),
          h('div', { class:'text-xs text-white/70 mt-1' }, 'Выключите, если эффект «стекла» тормозит или мерцает на вашем устройстве.'),
          (() => {
            const row = h('div', { class:'mt-3 flex items-center justify-between gap-3' });
            const left = h('div', { class:'text-sm text-white/80' }, 'Прозрачность (Acrylic)');
            const btn = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' });
            const renderBtn = () => {
              btn.textContent = state.transparency ? 'Включено' : 'Выключено';
              btn.style.background = state.transparency ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
              btn.style.borderColor = state.transparency ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
            };
            btn.addEventListener('click', () => {
              state.transparency = !state.transparency;
              persistUI();
              applyUI();
              renderBtn();
              addNotification({ title:'Персонализация', body:`Прозрачность: ${state.transparency ? 'включена' : 'выключена'}.`, iconHtml: registry.settings.iconHtml, source:'Параметры' });
            });
            renderBtn();
            row.append(left, btn);
            return row;
          })()
        ]);

        const wpCard = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Фон рабочего стола'),
          h('div', { class:'text-xs text-white/70 mt-1' }, 'Выберите один из предустановленных градиентов.')
        ]);

        const wpGrid = h('div', { class:'mt-3 grid grid-cols-2 gap-2' });
        for (const [key, val] of Object.entries(Wallpapers)) {
          const b = h('button', { class:'p-3 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-left' });
          const thumb = h('div', { class:'h-16 rounded-xl border border-white/10', style:`background:${val};` });
          const title = h('div', { class:'mt-2 text-sm font-semibold' }, key);
          const sub = h('div', { class:'text-xs text-white/60' }, ui.wallpaper === key ? 'Выбрано' : '');
          b.append(thumb, title, sub);
          b.addEventListener('click', () => {
            ui.wallpaper = key;
            persistUI();
            applyUI();
            addNotification({ title:'Персонализация', body:`Фон: ${key}`, iconHtml: registry.settings.iconHtml, source:'Параметры' });
            refreshWindowContent(win.id);
          });
          wpGrid.appendChild(b);
        }
        wpCard.appendChild(wpGrid);

        box.append(accentCard, transCard, wpCard);
        return box;
      }

      render();
      layout.append(nav, main);
      wrap.append(header, layout);
      return wrap;
    }

    // ---------- Mini games (Flappy implemented) ----------
    function buildFlappy(win){
      const wrap = h('div', { class:'p-3' });
      const title = h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
        h('div', { class:'flex items-center gap-2' }, [
          h('div', { class:'w-6 h-6', html: registry.flappy.iconHtml }),
          h('div', { class:'text-lg font-semibold' }, 'Flappy Bird')
        ]),
        h('div', { class:'text-sm text-white/70' }, 'Управление: Space/Click')
      ]);

      const panel = h('div', { class:'mt-3 game-panel' });
      const top = h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
        h('div', { class:'text-sm font-semibold' }, 'Счёт: '),
        h('div', { class:'ml-auto flex gap-2' }, [
          h('button', { class:'btn text-sm', id:`flStart_${win.id}` }, 'Старт'),
          h('button', { class:'btn text-sm', id:`flReset_${win.id}` }, 'Сброс')
        ])
      ]);
      const scoreEl = h('span', { id:`flScore_${win.id}`, class:'text-sm font-semibold' }, '0');
      top.firstChild.appendChild(scoreEl);

      const canvas = h('canvas', { class:'mt-3 w-full rounded-2xl border border-white/10 bg-black/20', width:'460', height:'540', id:`flCanvas_${win.id}` });
      const hint = h('div', { class:'text-xs text-white/70 mt-3' }, 'Не касайтесь труб. Чем дальше — тем сложнее.' );

      panel.append(top, canvas, hint);
      wrap.append(title, panel);

      const ctx = canvas.getContext('2d');
      let bird, pipes, score, running, lastT, spawnT;

      function reset(){
        bird = { x: 120, y: canvas.height/2, vy: 0, r: 14 };
        pipes = [];
        score = 0;
        running = false;
        lastT = 0;
        spawnT = 0;
        scoreEl.textContent = '0';
        draw();
      }

      function spawnPipe(){
        const gap = 150;
        const minY = 90;
        const maxY = canvas.height - 90;
        const gapY = Math.floor(minY + Math.random() * (maxY - minY));
        pipes.push({ x: canvas.width + 20, gapY, gap, w: 70, passed: false });
      }

      function flap(){
        if (!running) {
          // удобство: Space/Click запускают игру
          reset();
          start();
          // сразу применяем взмах, чтобы старт был отзывчивым
          bird.vy = -6.8;
          return;
        }
        bird.vy = -6.8;
      }

      function start(){
        if (running) return;
        running = true;
        lastT = performance.now();
        spawnT = 0;
        pipes = [];
        spawnPipe();
        requestAnimationFrame(loop);
      }

      function gameOver(){
        running = false;
        draw();
        addNotification({ title:'Flappy Bird', body:`Игра окончена. Счёт: ${score}`, iconHtml: registry.flappy.iconHtml, source:'Игры' });
      }

      function draw(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        const g = ctx.createLinearGradient(0,0,0,canvas.height);
        g.addColorStop(0,'rgba(56,189,248,.25)');
        g.addColorStop(1,'rgba(99,102,241,.20)');
        ctx.fillStyle = g;
        ctx.fillRect(0,0,canvas.width,canvas.height);

        for (const p of pipes){
          const topH = p.gapY - p.gap/2;
          const botY = p.gapY + p.gap/2;
          ctx.fillStyle = 'rgba(34,197,94,.55)';
          ctx.fillRect(p.x, 0, p.w, topH);
          ctx.fillRect(p.x, botY, p.w, canvas.height - botY);
          ctx.fillStyle = 'rgba(255,255,255,.15)';
          ctx.fillRect(p.x+6, 0, 8, topH);
          ctx.fillRect(p.x+6, botY, 8, canvas.height-botY);
        }

        ctx.fillStyle = `rgba(${(ui.accent||[99,102,241]).join(',')},.95)`;
        ctx.beginPath();
        ctx.arc(bird.x, bird.y, bird.r, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,.9)';
        ctx.beginPath();
        ctx.arc(bird.x+5, bird.y-4, 3, 0, Math.PI*2);
        ctx.fill();

        ctx.fillStyle = 'rgba(255,255,255,.88)';
        ctx.font = 'bold 22px system-ui, sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText(String(score), 14, 30);

        if (!running){
          ctx.fillStyle = 'rgba(0,0,0,.35)';
          ctx.fillRect(0,0,canvas.width,canvas.height);
          ctx.fillStyle = 'rgba(255,255,255,.92)';
          ctx.font = 'bold 18px system-ui, sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('Нажмите «Старт»', canvas.width/2, canvas.height/2);
          ctx.font = '14px system-ui, sans-serif';
          ctx.fillStyle = 'rgba(255,255,255,.75)';
          ctx.fillText('Space/Click — взмах', canvas.width/2, canvas.height/2 + 28);
        }
      }

      function loop(t){
        if (!running) return;
        const dt = (t - lastT) / 16.666;
        lastT = t;
        spawnT += dt;
        if (spawnT > 90/16.666) { spawnT = 0; spawnPipe(); }

        bird.vy += 0.35 * dt;
        bird.y += bird.vy * 3.2 * dt;

        for (const p of pipes){
          p.x -= 2.8 * 3.2 * dt;
          if (!p.passed && p.x + p.w < bird.x) {
            p.passed = true;
            score++;
            scoreEl.textContent = String(score);
          }
        }
        pipes = pipes.filter(p => p.x + p.w > -20);

        if (bird.y - bird.r < 0 || bird.y + bird.r > canvas.height) { gameOver(); return; }
        for (const p of pipes){
          const topH = p.gapY - p.gap/2;
          const botY = p.gapY + p.gap/2;
          const inX = bird.x + bird.r > p.x && bird.x - bird.r < p.x + p.w;
          if (inX) {
            if (bird.y - bird.r < topH || bird.y + bird.r > botY) { gameOver(); return; }
          }
        }

        draw();
        requestAnimationFrame(loop);
      }

      reset();

      const keyHandler = (e) => {
        if (!state.windows.has(win.id)) return;
        if (e.key === ' ') { e.preventDefault(); flap(); }
      };
      document.addEventListener('keydown', keyHandler);
      registerOnClose(win.id, () => document.removeEventListener('keydown', keyHandler));

      canvas.addEventListener('pointerdown', () => flap());

      const startBtn = $(`#flStart_${win.id}`, wrap);
      const resetBtn = $(`#flReset_${win.id}`, wrap);
      startBtn?.addEventListener('click', () => { if (!running) { reset(); start(); } });
      resetBtn?.addEventListener('click', () => { reset(); start(); });

      return wrap;
    }

    // ---------- Power actions ----------
    let shutdownTimer = null;
    function powerAction(kind){
      if (kind === 'sleep') {
        hideAllPopovers();
        $('#sleepOverlay').style.display = 'flex';
        addNotification({ title:'Питание', body:'Сон включён.', iconHtml: Icons.moon('w-6 h-6'), source:'Система' });
        return;
      }
      if (kind === 'restart') {
        hideAllPopovers();
        showShutdown('Перезагрузка…', 1200, () => location.reload());
        return;
      }
      if (kind === 'shutdown') {
        hideAllPopovers();
        showShutdown('Сохраните работу. Симуляция вернётся после «выключения».', 1400, () => {
          $('#shutdownText').textContent = 'Компьютер выключен. Нажмите «Отмена», чтобы включить.';
        });
        return;
      }
    }

    function showShutdown(text, ms, onDone){
      $('#shutdownText').textContent = text;
      $('#shutdownOverlay').classList.remove('hidden');
      clearTimeout(shutdownTimer);
      shutdownTimer = setTimeout(() => onDone?.(), ms);
    }

    function hideShutdown(){
      clearTimeout(shutdownTimer);
      $('#shutdownOverlay').classList.add('hidden');
      $('#shutdownText').textContent = 'Пожалуйста, подождите…';
    }

    // ---------- Desktop selection rectangle ----------
    const selRect = $('#selRect');
    let selecting = null;
    function startSelection(e){
      selecting = { x: e.clientX, y: e.clientY, active: false };
      selRect.classList.add('hidden');
      selRect.style.left = selecting.x + 'px';
      selRect.style.top = selecting.y + 'px';
      selRect.style.width = '0px';
      selRect.style.height = '0px';
    }
    function updateSelection(e){
      if (!selecting) return;
      const dx = e.clientX - selecting.x;
      const dy = e.clientY - selecting.y;
      if (!selecting.active && Math.hypot(dx, dy) > 10) selecting.active = true;
      if (!selecting.active) return;

      const x1 = Math.min(selecting.x, e.clientX);
      const y1 = Math.min(selecting.y, e.clientY);
      const x2 = Math.max(selecting.x, e.clientX);
      const y2 = Math.max(selecting.y, e.clientY);
      selRect.classList.remove('hidden');
      selRect.style.left = x1 + 'px';
      selRect.style.top = y1 + 'px';
      selRect.style.width = (x2 - x1) + 'px';
      selRect.style.height = (y2 - y1) + 'px';

      const rect = { left:x1, top:y1, right:x2, bottom:y2 };
      const hits = [];
      $$('#desktopIcons .desktop-icon').forEach(icon => {
        const r = icon.getBoundingClientRect();
        const inter = !(r.right < rect.left || r.left > rect.right || r.bottom < rect.top || r.top > rect.bottom);
        if (inter) hits.push(icon.getAttribute('data-did'));
      });
      setSelection(hits);
    }
    function endSelection(){
      selecting = null;
      selRect.classList.add('hidden');
    }

    // ---------- Global click handling ----------
    function clickOutsideHandler(e){
      const isOnTaskbar = e.target.closest('#taskbar');
      const isOnStart = e.target.closest('#startMenu');
      const isOnSearch = e.target.closest('#searchFlyout');
      const isOnQS = e.target.closest('#quickSettings');
      const isOnNotif = e.target.closest('#notifCenter');
      const isOnCtx = e.target.closest('#ctxMenu');
      const isOnIconMenu = e.target.closest('#iconMenu');
      const isOnWidgets = e.target.closest('#widgetsFlyout');
      const isOnRun = e.target.closest('#runDialog');
      const isOnWindow = e.target.closest('[data-win]');
      const isOnIcon = e.target.closest('.desktop-icon');
      const isTaskCtx = taskCtx && e.target.closest('.z-[5000]');

      if (!isOnTaskbar && !isOnStart && !isOnSearch && !isOnQS && !isOnNotif && !isOnCtx && !isOnWindow && !isTaskCtx && !isOnIconMenu && !isOnWidgets && !isOnRun && !isOnIcon) {
        hideAllPopovers();
      }
    }

    // ---------- Keyboard shortcuts ----------
    function altTab(){
      const visible = state.order.filter(id => {
        const w = state.windows.get(id);
        return w && !w.minimized;
      });
      if (!visible.length) return;
      state.altTabIndex = (state.altTabIndex + 1) % visible.length;
      focusWindow(visible[state.altTabIndex]);
    }

    // ---------- Init icons on static elements ----------
    function initStaticIcons(){
      setIcon('icoStart', Icons.win('w-6 h-6'));
      setIcon('icoSearch', Icons.search('w-5 h-5'));
      setIcon('icoSearch2', Icons.search('w-5 h-5'));
      setIcon('icoSearch3', Icons.search('w-5 h-5'));
      setIcon('icoBell', Icons.bell('w-5 h-5'));
      setIcon('icoFolder', Icons.folder('w-5 h-5'));
      setIcon('icoNote', Icons.note('w-5 h-5'));
      setIcon('icoSettings', Icons.settings('w-5 h-5'));
      setIcon('icoRefresh', Icons.refresh('w-5 h-5'));
      setIcon('icoUser', Icons.user('w-6 h-6'));
      setIcon('icoPower', Icons.power('w-5 h-5'));
      setIcon('icoMoon', Icons.moon('w-5 h-5'));
      setIcon('icoRestart', Icons.restart('w-5 h-5'));
      setIcon('icoShutdown', Icons.shutdown('w-5 h-5'));
      setIcon('icoWifi', Icons.wifi('w-5 h-5'));
      setIcon('icoBt', Icons.bluetooth('w-5 h-5'));
      setIcon('icoNight', Icons.night('w-5 h-5'));
      setIcon('icoWin', Icons.win('w-10 h-10'));
      setIcon('icoLock', Icons.lock('w-10 h-10'));
      setIcon('icoWidgets', Icons.widgets('w-6 h-6'));
      setIcon('icoWidgets2', Icons.widgets('w-5 h-5'));
      setIcon('icoRun', Icons.run('w-6 h-6'));
    }

    // ---------- Widgets ----------
    const Tips = [
      'Ctrl/⌘ + клик по иконкам — мультивыделение. Затем перетащите — они поедут вместе.',
      'Проводник теперь синхронизирован с рабочим столом: создавайте папки в разделе «Рабочий стол».',
      'Разверните окно — панель задач будет автоскрываться.',
      'Edge: любой текст без URL считается запросом и ищется в Яндексе.',
      'Microsoft Store: пока реализован только Flappy Bird, остальные приложения — «Скоро».'
    ];
    let tipIdx = 0;

    function renderWidgets(){
      const mem = Math.round((performance?.memory?.usedJSHeapSize || 0) / 1024 / 1024);
      const now = new Date();
      const cpuFake = 8 + Math.round(Math.abs(Math.sin(Date.now()/1200)) * 42);
      $('#sysSummary').textContent = `Время: ${now.toLocaleTimeString('ru-RU')} • "CPU": ${cpuFake}% • Heap: ${mem ? mem+'MB' : '—'}`;

      $('#tipsBox').textContent = Tips[tipIdx % Tips.length];
      updateFocusUI();
    }

    function updateFocusUI(){
      const ms = state.focusTimer.remainingMs;
      const m = Math.floor(ms/60000);
      const s = Math.floor((ms%60000)/1000);
      $('#focusTime').textContent = `${fmt2(m)}:${fmt2(s)}`;
      $('#btnFocusStart').textContent = state.focusTimer.running ? 'Пауза' : 'Старт';
    }

    function focusStartPause(){
      const t = state.focusTimer;
      if (!t.running) {
        t.running = true;
        t.startedAt = Date.now();
        t.tickId = setInterval(() => {
          const dt = Date.now() - t.startedAt;
          t.startedAt = Date.now();
          t.remainingMs = Math.max(0, t.remainingMs - dt);
          updateFocusUI();
          if (t.remainingMs === 0) {
            clearInterval(t.tickId);
            t.tickId = null;
            t.running = false;
            addNotification({ title:'Фокус‑таймер', body:'Время вышло. Отличная работа!', iconHtml: Icons.widgets('w-6 h-6'), source:'Виджеты' });
          }
        }, 250);
      } else {
        t.running = false;
        clearInterval(t.tickId);
        t.tickId = null;
      }
      updateFocusUI();
    }

    function focusReset(){
      const t = state.focusTimer;
      t.running = false;
      clearInterval(t.tickId);
      t.tickId = null;
      t.remainingMs = 25*60*1000;
      updateFocusUI();
    }

    // ---------- Run dialog ----------
    function openRunDialog(){
      hideAllPopovers();
      const d = $('#runDialog');
      d.classList.remove('hidden');
      $('#runInput').value = '';
      setTimeout(() => $('#runInput').focus(), 50);
    }

    function runCommand(cmd){
      const c = (cmd||'').trim();
      if (!c) return;
      if (registry[c]) { openApp(c); hideAllPopovers(); return; }
      if (c.startsWith('win://')) { openApp('edge', { url: c }); hideAllPopovers(); return; }
      if (isProbablyUrl(c)) { openApp('edge', { url: c }); hideAllPopovers(); return; }
      openApp('edge', { url: 'yandex:' + c });
      hideAllPopovers();
    }

    // ---------- Boot ----------
    function boot(){
      initStaticIcons();
      fsMigrateAndEnsureDefaults();
      applyUI();
      renderDesktopIcons();
      updateTaskbar();
      tickClock();
      setInterval(tickClock, 1000);

      // Welcome notification (only in notification center)
      setTimeout(() => {
        addNotification({
          title: 'Windows 12',
          body: 'Симуляция готова: мультивыделение иконок, синхронизация Проводника с рабочим столом, Microsoft Store (Flappy Bird реализован).',
          iconHtml: Icons.win('w-6 h-6'),
          source: 'Система'
        });
      }, 400);

      // Fullscreen preference: requires user gesture in most browsers
      if (state.fullscreenPref && !isBrowserFullscreen()) {
        addNotification({
          title: 'Параметры',
          body: 'Включение полноэкранного режима требует действия пользователя. Кликните по экрану, чтобы включить.',
          iconHtml: registry.settings.iconHtml,
          source: 'Параметры'
        });
        const once = async () => {
          document.removeEventListener('pointerdown', once, true);
          await setBrowserFullscreen(true);
        };
        document.addEventListener('pointerdown', once, true);
      }

      // Bind UI events
      $('#btnStart').addEventListener('click', (e) => { e.stopPropagation(); toggleStart(); });
      $('#btnSearch').addEventListener('click', (e) => { e.stopPropagation(); toggleSearchFlyout(); });
      $('#btnTray').addEventListener('click', (e) => { e.stopPropagation(); toggleQuickSettings(); });
      $('#btnNotifs').addEventListener('click', (e) => { e.stopPropagation(); toggleNotifCenter(); });
      $('#btnWidgets').addEventListener('click', (e) => { e.stopPropagation(); toggleWidgets(); });
      $('#btnWidgetsClose').addEventListener('click', (e) => { e.stopPropagation(); hideAllPopovers(); });

      $('#btnSearchClose').addEventListener('click', (e) => { e.stopPropagation(); hideAllPopovers(); });

      $('#startSearch').addEventListener('input', (e) => renderStartSearch(e.target.value));
      $('#startSearch').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const q = e.target.value.trim().toLowerCase();
          const match = Object.values(registry).find(a => a.name.toLowerCase().includes(q) || a.id.includes(q));
          if (match) { openApp(match.id); hideAllPopovers(); }
        }
      });

      $('#globalSearch').addEventListener('input', (e) => renderGlobalSearch(e.target.value));
      $('#globalSearch').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const q = e.target.value.trim().toLowerCase();
          const matchApp = Object.values(registry).find(a => a.name.toLowerCase().includes(q) || a.id.includes(q));
          const matchFile = Object.values(fs.files).find(f => (f.name||'').toLowerCase().includes(q));
          if (matchApp) { openApp(matchApp.id); hideAllPopovers(); }
          else if (matchFile) { openNotepadWithFile(matchFile.id); hideAllPopovers(); }
        }
      });

      $('#btnStartAll').addEventListener('click', () => {
        openApp('explorer');
        addNotification({ title:'Пуск', body:'Открыт «Проводник» (демо вместо списка «Все приложения»).', iconHtml: Icons.win('w-6 h-6'), source:'Пуск' });
        hideAllPopovers();
      });

      $('#btnClearRecent').addEventListener('click', () => {
        state.recent = [];
        persistUI();
        renderRecommended();
        addNotification({ title:'Пуск', body:'Недавние элементы очищены.', iconHtml: Icons.win('w-6 h-6'), source:'Пуск' });
      });

      $('#btnPower').addEventListener('click', (e) => {
        e.stopPropagation();
        $('#powerMenu').classList.toggle('hidden');
      });

      $('#powerMenu').addEventListener('click', (e) => {
        const btn = e.target.closest('[data-power]');
        if (!btn) return;
        powerAction(btn.getAttribute('data-power'));
      });

      $('#btnOpenSettings').addEventListener('click', () => { openApp('settings', { section:'network' }); hideAllPopovers(); });

      $$('.qs-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
          const k = btn.getAttribute('data-toggle');
          setToggle(k, !state.toggles[k]);
          renderQuickSettings();
        });
      });

      $('#volSlider').value = String(state.volume);
      $('#volSlider').addEventListener('input', (e) => {
        state.volume = Number(e.target.value);
        persistUI();
        updateTaskbar();
      });

      $('#btnClearNotifs').addEventListener('click', () => {
        state.notifications = [];
        renderNotifCenter();
        updateTaskbar();
      });

      // Widgets handlers
      $('#btnBoost').addEventListener('click', () => {
        addNotification({ title:'Виджеты', body:'Оптимизация выполнена (демо).', iconHtml: Icons.widgets('w-6 h-6'), source:'Виджеты' });
        renderWidgets();
      });
      $('#btnTipNext').addEventListener('click', () => { tipIdx++; renderWidgets(); });
      $('#btnOpenRun').addEventListener('click', () => openRunDialog());
      $('#btnFocusStart').addEventListener('click', () => focusStartPause());
      $('#btnFocusReset').addEventListener('click', () => focusReset());

      // Run dialog
      $('#btnRunCancel').addEventListener('click', () => hideAllPopovers());
      $('#btnRunOk').addEventListener('click', () => runCommand($('#runInput').value));
      $('#runInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); runCommand($('#runInput').value); }
        if (e.key === 'Escape') { e.preventDefault(); hideAllPopovers(); }
      });

      // Desktop click deselect
      $('#desktop').addEventListener('click', () => {
        clearSelection();
      });

      document.addEventListener('pointerdown', clickOutsideHandler);

      // Desktop context menu
      $('#desktop').addEventListener('contextmenu', (e) => {
        if (e.target.closest('[data-win]') || e.target.closest('#taskbar') || e.target.closest('#startMenu') || e.target.closest('#searchFlyout') || e.target.closest('#quickSettings') || e.target.closest('#notifCenter') || e.target.closest('#widgetsFlyout') || e.target.closest('#runDialog') || e.target.closest('.desktop-icon')) {
          return;
        }
        e.preventDefault();
        showCtxMenu(e.clientX, e.clientY);
      });

      $('#ctxMenu').addEventListener('click', (e) => {
        const btn = e.target.closest('[data-action]');
        if (!btn) return;
        const act = btn.getAttribute('data-action');
        if (act === 'refresh') doRefresh();
        if (act === 'new-folder') createDesktopFolder();
        if (act === 'new-note') createDesktopNote();
        if (act === 'personalize') openApp('settings', { section:'personal' });
        hideAllPopovers();
      });

      // Sleep overlay wake
      function wake(){
        $('#sleepOverlay').style.display = 'none';
        addNotification({ title:'Питание', body:'Выход из сна.', iconHtml: Icons.power('w-6 h-6'), source:'Система' });
      }
      $('#sleepOverlay').addEventListener('click', wake);
      document.addEventListener('keydown', (e) => {
        if ($('#sleepOverlay').style.display === 'flex') {
          e.preventDefault();
          wake();
        }
      }, { capture: true });

      // Shutdown overlay cancel
      $('#btnShutdownCancel').addEventListener('click', hideShutdown);

      // Selection rectangle
      $('#desktop').addEventListener('pointerdown', (e) => {
        if (e.button !== 0) return;
        if (e.target.closest('#taskbar') || e.target.closest('[data-win]') || e.target.closest('#startMenu') || e.target.closest('#searchFlyout') || e.target.closest('#quickSettings') || e.target.closest('#notifCenter') || e.target.closest('#widgetsFlyout') || e.target.closest('#runDialog') || e.target.closest('.desktop-icon')) return;
        startSelection(e);
      });
      $('#desktop').addEventListener('pointermove', (e) => updateSelection(e));
      $('#desktop').addEventListener('pointerup', () => endSelection());

      // Taskbar reveal on bottom edge when autohide
      window.addEventListener('pointermove', (e) => {
        if (!document.body.classList.contains('tb-autohide')) return;
        const margin = 8;
        if (e.clientY > window.innerHeight - margin) revealTaskbar();
      });
      $('#taskbar').addEventListener('pointerenter', () => {
        if (document.body.classList.contains('tb-autohide')) document.body.classList.add('tb-reveal');
      });
      $('#taskbar').addEventListener('pointerleave', () => {
        if (document.body.classList.contains('tb-autohide')) {
          clearTimeout(tbHideTimer);
          tbHideTimer = setTimeout(() => document.body.classList.remove('tb-reveal'), 700);
        }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          hideAllPopovers();
          hideTaskContextMenu();
        }
        if (e.key === 'F5') {
          e.preventDefault();
          doRefresh();
        }

        if ((e.key === 'Meta' || e.key === 'OS') && !e.repeat) {
          e.preventDefault();
          toggleStart();
        }

        if (e.metaKey && e.key.toLowerCase() === 'r') {
          e.preventDefault();
          openRunDialog();
        }

        if (e.altKey && e.key === 'Tab') {
          e.preventDefault();
          altTab();
        }
      });

      // Fullscreen state sync
      document.addEventListener('fullscreenchange', () => {
        state.fullscreenPref = isBrowserFullscreen();
        persistUI();
      });

      // window resize
      window.addEventListener('resize', () => {
        for (const w of state.windows.values()) {
          if (w.maximized) {
            maximizeWindow(w.id, true);
          } else {
            const area = desktopWorkAreaRect();
            w.rect.x = clamp(w.rect.x, 0, area.w - w.rect.w);
            w.rect.y = clamp(w.rect.y, 0, area.h - w.rect.h);
            const el = document.querySelector(`[data-win="${w.id}"]`);
            if (el) applyRect(el, w.rect);
          }
        }
      });

      renderQuickSettings();
      renderNotifCenter();
      $('#volSlider').value = String(state.volume);
      updateTaskbar();

      // periodic widget refresh when opened
      setInterval(() => {
        if (!$('#widgetsFlyout').classList.contains('hidden')) renderWidgets();
      }, 1500);
    }

    boot();
  </script>
</body>
</html>
