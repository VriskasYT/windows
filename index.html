<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Windows 12 (UI Simulation)</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    :root{
      --accent: 99 102 241; /* indigo-500 */
      --fg: 255 255 255;
      --fg-muted: 229 231 235;
      --panel: 17 24 39;
      --panel-2: 15 23 42;
      --glass: 255 255 255;
      --glass-alpha: .08;
      --border: 255 255 255;
      --border-alpha: .14;
      --shadow: 0 24px 60px rgba(0,0,0,.45);
      --wallpaper: radial-gradient(1200px 700px at 10% 10%, rgba(99,102,241,.55), transparent 60%),
                   radial-gradient(900px 600px at 80% 25%, rgba(56,189,248,.45), transparent 55%),
                   radial-gradient(900px 700px at 55% 85%, rgba(244,114,182,.35), transparent 60%),
                   linear-gradient(180deg, #070B16, #060915);

      /* Taskbar customization */
      --taskbar-h: 56px;
      --taskbar-radius: 18px;
      --taskbar-alpha: .08;
      --taskbar-blur: 18px;

      /* Icons styling */
      --icon-filter: none;

      /* Animation settings */
      --anim-open-ms: 160;
      --anim-close-ms: 140;
      --anim-min-ms: 160;
      --anim-ui-ms: 160;

      /* Animation easing presets */
      --ease-open: cubic-bezier(.16, .9, .2, 1);
      --ease-close: cubic-bezier(.3, 0, .7, .2);
      --ease-ui: cubic-bezier(.16, .9, .2, 1);

      /* Font (can be overridden by JS) */
      --ui-font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";

      /* Liquid Glass pointer highlight (updated by JS in liquid mode) */
      --pointer-xp: 50%;
      --pointer-yp: 35%;

      --radius: 16px;
    }

    /* Light scheme (theme) */
    html[data-scheme="light"]{
      --fg: 15 23 42;
      --fg-muted: 51 65 85;
      --glass: 255 255 255;
      --glass-alpha: .60;
      --border: 0 0 0;
      --border-alpha: .12;
      --shadow: 0 18px 50px rgba(0,0,0,.18);
    }
    html[data-scheme="light"] .win-surface{
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.70));
      border-color: rgba(0,0,0,.10);
      box-shadow: 0 26px 70px rgba(0,0,0,.16);
    }
    html[data-scheme="light"] .titlebar{
      background: linear-gradient(180deg, rgba(0,0,0,.045), rgba(0,0,0,.02));
      border-bottom-color: rgba(0,0,0,.10);
    }
    html[data-scheme="light"] .taskbtn,
    html[data-scheme="light"] .btn{
      background: rgba(0,0,0,.04);
      border-color: rgba(0,0,0,.10);
    }
    html[data-scheme="light"] .taskbtn:hover,
    html[data-scheme="light"] .btn:hover{ background: rgba(0,0,0,.06); }

    /* Light scheme: make Tailwind text-white/* utilities readable */
    html[data-scheme="light"] .text-white{ color: rgba(15,23,42,.92) !important; }
    html[data-scheme="light"] [class*="text-white/"]{ color: rgba(15,23,42,.78) !important; }
    html[data-scheme="light"] [class*="text-white/90"]{ color: rgba(15,23,42,.90) !important; }
    html[data-scheme="light"] [class*="text-white/85"]{ color: rgba(15,23,42,.85) !important; }
    html[data-scheme="light"] [class*="text-white/80"]{ color: rgba(15,23,42,.80) !important; }
    html[data-scheme="light"] [class*="text-white/70"]{ color: rgba(15,23,42,.70) !important; }
    html[data-scheme="light"] [class*="text-white/60"]{ color: rgba(15,23,42,.60) !important; }
    html[data-scheme="light"] [class*="text-white/50"]{ color: rgba(15,23,42,.50) !important; }

    html[data-scheme="light"] .desktop-icon{ color: rgba(15,23,42,.92); }
    html[data-scheme="light"] .desktop-icon:hover{ background: rgba(0,0,0,.05); }
    html[data-scheme="light"] .desktop-icon.selected{ background: rgba(var(--accent), .18); outline: 1px solid rgba(var(--accent), .35); }

    html[data-scheme="light"] .menu-item:hover{ background: rgba(0,0,0,.05); }
    html[data-scheme="light"] .thin-sep{ background: rgba(0,0,0,.10); }
    html[data-scheme="light"] .kbd{ color: rgba(15,23,42,.65); border-color: rgba(0,0,0,.14); background: rgba(0,0,0,.04); }
    html[data-scheme="light"] .scrollbar::-webkit-scrollbar-thumb{ background: rgba(0,0,0,.16); }

    /* Liquid Glass mode (theme) */
    html[data-glassmode="liquid"] .glass{
      background:
        radial-gradient(220px 140px at var(--pointer-xp) var(--pointer-yp), rgba(255,255,255,.22), transparent 60%),
        rgba(var(--glass), .045);
      border-color: rgba(255,255,255,.18);
      backdrop-filter: blur(28px) saturate(1.7);
      -webkit-backdrop-filter: blur(28px) saturate(1.7);
      box-shadow: 0 28px 85px rgba(0,0,0,.35);
    }
    html[data-glassmode="liquid"] .win-surface{
      background:
        radial-gradient(300px 220px at var(--pointer-xp) var(--pointer-yp), rgba(255,255,255,.14), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05));
      border-color: rgba(255,255,255,.20);
      box-shadow: 0 34px 95px rgba(0,0,0,.48);
    }
    html[data-glassmode="liquid"] .titlebar{
      background:
        radial-gradient(220px 140px at var(--pointer-xp) var(--pointer-yp), rgba(255,255,255,.12), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.04));
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      color: rgb(var(--fg));
      background: #000;
      overflow: hidden;
      font-family: var(--ui-font);
      user-select: none;
    }

    .wallpaper{ background: var(--wallpaper); background-size: cover; background-position: center; }

    .glass{
      background: rgba(var(--glass), var(--glass-alpha));
      border: 1px solid rgba(var(--border), var(--border-alpha));
      backdrop-filter: blur(18px) saturate(1.2);
      -webkit-backdrop-filter: blur(18px) saturate(1.2);
      box-shadow: var(--shadow);
    }

    .glass-weak{
      background: rgba(var(--glass), .06);
      border: 1px solid rgba(var(--border), .10);
      backdrop-filter: blur(14px) saturate(1.2);
      -webkit-backdrop-filter: blur(14px) saturate(1.2);
    }

    .win-surface{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(20px) saturate(1.2);
      -webkit-backdrop-filter: blur(20px) saturate(1.2);
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      border-radius: var(--radius);
      overflow: hidden;
    }

    /* Transparency off mode */
    html[data-transparency="0"] .glass,
    html[data-transparency="0"] .glass-weak,
    html[data-transparency="0"] .win-surface{
      background: rgba(10, 14, 24, .96) !important;
      border-color: rgba(255,255,255,.14) !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      box-shadow: 0 28px 70px rgba(0,0,0,.55);
    }

    .titlebar{
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 10px;
      gap: 10px;
      cursor: default;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-bottom: 1px solid rgba(255,255,255,.12);
    }

    html[data-transparency="0"] .titlebar{ background: rgba(255,255,255,.06); }
    .titlebar.dragging{ cursor: grabbing; }

    .titletext{ display:flex; align-items:center; gap:10px; min-width: 0; flex: 1; }

    .titletext .name{
      font-weight: 600;
      letter-spacing: .2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: .95;
    }

    .window-controls button{
      width: 34px;
      height: 28px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.05);
      transition: background .12s ease, border-color .12s ease, transform .12s ease;
    }
    .window-controls button:hover{ background: rgba(255,255,255,.10); transform: translateY(-.5px); }
    .window-controls button.danger:hover{ background: rgba(239,68,68,.35); border-color: rgba(239,68,68,.35); }

    .window-content{ height: calc(100% - 42px); overflow: auto; }

    .resize-handle{
      position: absolute;
      right: 2px;
      bottom: 2px;
      width: 16px;
      height: 16px;
      cursor: nwse-resize;
      opacity: .6;
    }
    .resize-handle:before{
      content: "";
      position:absolute;
      right: 2px;
      bottom: 2px;
      width: 10px;
      height: 10px;
      border-right: 2px solid rgba(255,255,255,.35);
      border-bottom: 2px solid rgba(255,255,255,.35);
      border-bottom-right-radius: 3px;
    }

    /* Window open animation */
    .win-in{ animation: winIn calc(var(--anim-open-ms)*1ms) var(--ease-open); }
    @keyframes winIn{
      from{ transform: translateY(8px) scale(.985); opacity: 0; }
      to{ transform: translateY(0) scale(1); opacity: 1; }
    }

    .desktop-icon{
      width: 92px;
      padding: 8px 6px;
      border-radius: 14px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 8px;
      text-align:center;
      color: rgba(255,255,255,.92);
      font-size: 12px;
      line-height: 1.2;
      position: absolute;
      touch-action: none;
      transition: background .12s ease, transform .12s ease, outline-color .12s ease;
    }
    .desktop-icon:hover{ background: rgba(255,255,255,.08); }
    .desktop-icon.selected{ background: rgba(var(--accent), .20); outline: 1px solid rgba(var(--accent), .35); }
    .desktop-icon.dragging{ background: rgba(255,255,255,.10); outline: 1px solid rgba(255,255,255,.25); cursor: grabbing; transform: scale(1.02); }

    .taskbar{ height: var(--taskbar-h); transition: transform calc(var(--anim-ui-ms)*1ms) ease, opacity calc(var(--anim-ui-ms)*1ms) ease; }

    /* Taskbar customization (overrides glass defaults) */
    #taskbar{
      height: var(--taskbar-h);
      border-radius: var(--taskbar-radius) !important;
      background: rgba(var(--glass), var(--taskbar-alpha)) !important;
      backdrop-filter: blur(var(--taskbar-blur)) saturate(1.2);
      -webkit-backdrop-filter: blur(var(--taskbar-blur)) saturate(1.2);
    }

    /* Taskbar style presets (controlled by JS via body[data-tbstyle]) */
    body[data-tbstyle="win11"] #taskbar{ /* default: floating */ }

    body[data-tbstyle="win10"] #taskbar{
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      border-radius: 0 !important;
      background: rgba(var(--glass), .10) !important;
      backdrop-filter: blur(14px) saturate(1.15);
      -webkit-backdrop-filter: blur(14px) saturate(1.15);
    }

    body[data-tbstyle="classic"] #taskbar{
      border-radius: 10px !important;
      background: rgba(var(--glass), .06) !important;
      backdrop-filter: blur(10px) saturate(1.0);
      -webkit-backdrop-filter: blur(10px) saturate(1.0);
    }

    body[data-tbstyle="compact"] #taskbar{
      border-radius: 14px !important;
    }
    body[data-tbstyle="compact"] .taskbtn{ height: 36px; border-radius: 12px; }

    /* Icon filter (desktop + taskbar) */
    .desktop-icon svg,
    #taskbar svg{ filter: var(--icon-filter); }

    /* Taskbar autohide when active window maximized */
    body.tb-autohide #taskbar{
      transform: translateY(calc(var(--taskbar-h) + 18px));
      opacity: 0;
      pointer-events: none;
    }
    body.tb-autohide.tb-reveal #taskbar{
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    .taskbtn{
      height: 40px;
      min-width: 44px;
      padding: 0 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      position: relative;
      transition: background .12s ease, transform .12s ease;
    }
    .taskbtn:hover{ background: rgba(255,255,255,.10); transform: translateY(-.5px); }

    /* Windows 11-like underline */
    .taskbtn.running::after{
      content: "";
      position: absolute;
      bottom: 6px;
      width: 18px;
      height: 3px;
      border-radius: 999px;
      background: rgba(255,255,255,.35);
      opacity: .9;
      transition: width .12s ease, height .12s ease, background .12s ease;
    }
    .taskbtn.active::after{
      width: 26px;
      height: 4px;
      background: rgba(var(--accent), .95);
      opacity: 1;
    }

    .menu-item{ display:flex; align-items:center; gap:10px; padding: 10px 10px; border-radius: 12px; transition: background .12s ease; }
    .menu-item:hover{ background: rgba(255,255,255,.08); }

    .kbd{ font-size: 12px; color: rgba(255,255,255,.65); border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); padding: 2px 6px; border-radius: 8px; }

    .toast{ animation: toastIn .22s ease-out; }
    @keyframes toastIn{
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .scrollbar::-webkit-scrollbar{ width: 10px; height: 10px; }
    .scrollbar::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.12); border-radius: 999px; border: 2px solid transparent; background-clip: content-box; }
    .scrollbar::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,.18); border: 2px solid transparent; background-clip: content-box; }

    .thin-sep{ height: 1px; background: rgba(255,255,255,.10); }

    .snap-hint{
      position:absolute;
      inset: 10px;
      border-radius: 18px;
      border: 2px dashed rgba(var(--accent), .45);
      background: rgba(var(--accent), .08);
      pointer-events:none;
      display:none;
      animation: snapPulse .6s ease-in-out infinite alternate;
    }
    @keyframes snapPulse{
      from{ opacity: .7; }
      to{ opacity: 1; }
    }

    .sleep-overlay{
      position: fixed;
      inset: 0;
      background: radial-gradient(800px 500px at 50% 40%, rgba(255,255,255,.05), transparent 60%), rgba(0,0,0,.75);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 9999;
    }

    .lock-overlay{
      position: fixed;
      inset: 0;
      background: radial-gradient(900px 520px at 50% 35%, rgba(255,255,255,.08), transparent 60%), rgba(0,0,0,.86);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 99990;
    }

    /* Night light overlay (doesn't break fixed elements) */
    #nightOverlay{
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 2500;
      display: none;
      background:
        radial-gradient(900px 520px at 50% 20%, rgba(255, 153, 102, .12), transparent 60%),
        radial-gradient(900px 700px at 40% 80%, rgba(255, 170, 120, .08), transparent 65%),
        rgba(255, 120, 70, .07);
      mix-blend-mode: multiply;
      animation: nightFade .18s ease-out;
    }
    @keyframes nightFade{ from{ opacity: 0; } to{ opacity: 1; } }

    /* Desktop stacking (ensures overlays never hide tray/taskbar) */
    #desktop{ z-index: 50; }

    /* IMPORTANT: allow clicking desktop icons through the window layer.
       The layer itself should not capture pointer events, but actual windows must. */
    #windowLayer{ pointer-events: none; }
    #windowLayer > [data-win]{ pointer-events: auto; }

    /* New Year mode (kept behind desktop/taskbar to avoid tray issues) */
    #nySnow{
      position: fixed;
      inset: 0;
      z-index: 5;
      display: none;
    }

    /* Fireworks overlay: above windows, below taskbar/tray */
    #nyFireworks{
      position: fixed;
      inset: 0;
      z-index: 2200;
      display: none;
    }

    #nyGarland{
      position: fixed;
      left: 0; right: 0; top: 0;
      height: 54px;
      z-index: 6;
      display: none;
      background:
        radial-gradient(16px 10px at 10% 60%, rgba(255,80,80,.85), transparent 60%),
        radial-gradient(16px 10px at 20% 50%, rgba(255,230,80,.85), transparent 60%),
        radial-gradient(16px 10px at 30% 62%, rgba(80,220,120,.85), transparent 60%),
        radial-gradient(16px 10px at 40% 52%, rgba(100,180,255,.85), transparent 60%),
        radial-gradient(16px 10px at 50% 64%, rgba(244,114,182,.85), transparent 60%),
        radial-gradient(16px 10px at 60% 50%, rgba(255,230,80,.85), transparent 60%),
        radial-gradient(16px 10px at 70% 62%, rgba(80,220,120,.85), transparent 60%),
        radial-gradient(16px 10px at 80% 52%, rgba(100,180,255,.85), transparent 60%),
        radial-gradient(16px 10px at 90% 62%, rgba(255,80,80,.85), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,0));
      filter: drop-shadow(0 8px 18px rgba(0,0,0,.35));
      animation: garlandTwinkle 1.8s ease-in-out infinite alternate;
      opacity: .9;
    }
    @keyframes garlandTwinkle{
      from{ filter: drop-shadow(0 8px 18px rgba(0,0,0,.35)) brightness(1); opacity: .85; }
      to{ filter: drop-shadow(0 10px 24px rgba(0,0,0,.45)) brightness(1.08); opacity: 1; }
    }

    /* Small helper */
    .btn{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      transition: background .12s ease, transform .12s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.10); transform: translateY(-.5px); }

    /* Mini games */
    .game-canvas{
      width: 100%;
      max-width: 520px;
      aspect-ratio: 1 / 1;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      display:block;
    }
    .game-panel{
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }

    /* Flyouts animation */
    .flyout{ animation: flyIn calc(var(--anim-ui-ms)*1ms) var(--ease-ui); transform-origin: bottom left; }
    @keyframes flyIn{ from{ transform: translateY(8px) scale(.985); opacity: 0; } to{ transform: translateY(0) scale(1); opacity: 1; } }

    /* Extra animations / micro-interactions */
    .taskbtn:active, .btn:active, .menu-item:active{ transform: scale(.985); }
    .desktop-icon:active{ transform: scale(.99); }

    .win-out{ animation: winOut calc(var(--anim-close-ms)*1ms) var(--ease-close) forwards; }
    @keyframes winOut{
      from{ transform: translateY(0) scale(1); opacity: 1; }
      to{ transform: translateY(10px) scale(.985); opacity: 0; }
    }

    .win-min{ animation: winMin calc(var(--anim-min-ms)*1ms) var(--ease-close) forwards; }
    @keyframes winMin{
      from{ transform: translateY(0) scale(1); opacity: 1; }
      to{ transform: translateY(14px) scale(.96); opacity: 0; }
    }

    .fade-swap{ animation: fadeSwap .14s ease-out; }
    @keyframes fadeSwap{ from{ opacity: .2; transform: translateY(4px); } to{ opacity: 1; transform: translateY(0); } }

    .shimmer{
      position: relative;
      overflow: hidden;
    }
    .shimmer:after{
      content:"";
      position:absolute;
      inset:-40px;
      background: linear-gradient(110deg, transparent 30%, rgba(255,255,255,.16) 45%, transparent 60%);
      transform: translateX(-40%);
      animation: shimmer 1.15s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes shimmer{
      from{ transform: translateX(-55%); }
      to{ transform: translateX(55%); }
    }

    /* Boot overlay (5s) */
    #bootOverlay{
      position: fixed;
      inset: 0;
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(900px 520px at 50% 35%, rgba(255,255,255,.08), transparent 60%), rgba(0,0,0,.82);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    #bootOverlay.hidden{ display:none; }
    #bootOverlay.boot-out{ animation: bootOut .26s ease-in forwards; }
    @keyframes bootOut{ from{ opacity:1 } to{ opacity:0 } }

    .boot-card{
      width: min(520px, 92vw);
      text-align: center;
    }
    .boot-logo{
      width: 56px;
      height: 56px;
      margin: 0 auto;
      filter: drop-shadow(0 14px 34px rgba(0,0,0,.45));
    }
    .boot-spinner{
      width: 42px;
      height: 42px;
      border-radius: 999px;
      border: 3px solid rgba(255,255,255,.20);
      border-top-color: rgba(var(--accent), .95);
      animation: spin 1s linear infinite;
      margin: 18px auto 0;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .boot-bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      overflow: hidden;
    }
    .boot-bar > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(var(--accent), .35), rgba(var(--accent), .85));
      animation: bootBar 5s linear forwards;
    }
    @keyframes bootBar{ from{ width:0% } to{ width:100% } }
  </style>
</head>
<body>
  <div id="root" class="relative w-screen h-screen wallpaper">
    <!-- Boot overlay (5s) -->
    <div id="bootOverlay">
      <div class="boot-card">
        <div class="boot-logo" id="bootLogo"></div>
        <div class="mt-4 text-lg font-semibold text-white/90">Windows 12</div>
        <div class="mt-1 text-xs text-white/60">Загрузка системы…</div>
        <div class="boot-spinner"></div>
        <div class="mt-6 boot-bar"><div></div></div>
        <div class="mt-3 text-[11px] text-white/50">Подготовка интерфейса • 5 секунд</div>
      </div>
    </div>

    <!-- Night light overlay -->
    <div id="nightOverlay"></div>

    <!-- New Year overlay (snow + lights) -->
    <canvas id="nySnow" class="pointer-events-none"></canvas>
    <!-- Fireworks overlay (shown automatically at Jan 1 00:00 and via Dev menu) -->
    <canvas id="nyFireworks" class="pointer-events-none"></canvas>
    <div id="nyGarland" class="pointer-events-none"></div>

    <!-- Desktop -->
    <div id="desktop" class="absolute inset-0">
      <div class="absolute inset-0 pointer-events-none"></div>

      <!-- Icons layer -->
      <div id="desktopIcons" class="absolute inset-0"></div>

      <!-- Window layer -->
      <div id="windowLayer" class="absolute inset-0"></div>

      <!-- Snap hint overlay -->
      <div id="snapHint" class="snap-hint"></div>

      <!-- Selection rectangle -->
      <div id="selRect" class="absolute hidden border border-white/30 bg-white/10 rounded-md"></div>

      <!-- Desktop context menu -->
      <div id="ctxMenu" class="hidden absolute z-[5000] w-64 win-surface p-2 flyout">
        <div class="text-xs px-2 py-2 text-white/70">Рабочий стол</div>
        <button data-action="refresh" class="w-full text-left menu-item">
          <span class="w-5 h-5" id="icoRefresh"></span>
          <span>Обновить</span>
          <span class="ml-auto kbd">F5</span>
        </button>
        <div class="thin-sep my-1"></div>
        <div class="px-1">
          <div class="text-xs px-2 py-1 text-white/60">Создать</div>
          <button data-action="new-folder" class="w-full text-left menu-item">
            <span class="w-5 h-5" id="icoFolder"></span>
            <span>Папку</span>
          </button>
          <button data-action="new-note" class="w-full text-left menu-item">
            <span class="w-5 h-5" id="icoNote"></span>
            <span>Текстовый документ</span>
          </button>
        </div>
        <div class="thin-sep my-1"></div>
        <button data-action="personalize" class="w-full text-left menu-item">
          <span class="w-5 h-5" id="icoSettings"></span>
          <span>Персонализация</span>
        </button>
      </div>

      <!-- Icon context menu -->
      <div id="iconMenu" class="hidden absolute z-[5001] w-64 win-surface p-2 flyout"></div>

      <!-- Start menu -->
      <div id="startMenu" class="hidden absolute left-3 bottom-[calc(var(--taskbar-h)+10px)] w-[420px] max-w-[92vw] z-[4000] win-surface flyout">
        <div class="p-3">
          <div class="flex items-center gap-2">
            <div class="flex items-center gap-2 flex-1 min-w-0">
              <span class="w-5 h-5" id="icoSearch"></span>
              <input id="startSearch" class="w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60" placeholder="Поиск приложений, файлов и настроек" />
            </div>
            <button id="btnStartAll" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Все</button>
          </div>

          <div class="mt-3">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">Закреплённые</div>
              <div class="text-xs text-white/60">Подсказка: двойной клик по иконке на рабочем столе</div>
            </div>
            <div id="pinnedGrid" class="mt-2 grid grid-cols-5 gap-2"></div>
          </div>

          <div class="mt-3">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">Рекомендуемое</div>
              <button id="btnClearRecent" class="text-xs text-white/70 hover:text-white">Очистить</button>
            </div>
            <div id="recommended" class="mt-2 space-y-1"></div>
          </div>
        </div>
        <div class="border-t border-white/10 p-3 flex items-center justify-between">
          <button id="btnUser" class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10">
            <span class="w-6 h-6" id="icoUser"></span>
            <span class="text-sm">Локальный пользователь</span>
          </button>
          <div class="flex items-center gap-2">
            <button id="btnDev" style="display:none" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 flex items-center gap-2" title="Меню разработчика">
              <span class="w-5 h-5" id="icoDev"></span>
              <span class="text-sm">Dev</span>
            </button>
            <button id="btnPower" class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 flex items-center gap-2">
              <span class="w-5 h-5" id="icoPower"></span>
              <span class="text-sm">Питание</span>
            </button>
          </div>
        </div>

        <!-- Power menu -->
        <div id="powerMenu" class="hidden absolute right-3 bottom-16 w-56 win-surface p-2 flyout">
          <button data-power="sleep" class="w-full text-left menu-item">
            <span class="w-5 h-5" id="icoMoon"></span><span>Сон</span>
          </button>
          <button data-power="restart" class="w-full text-left menu-item">
            <span class="w-5 h-5" id="icoRestart"></span><span>Перезагрузка</span>
          </button>
          <button data-power="shutdown" class="w-full text-left menu-item">
            <span class="w-5 h-5" id="icoShutdown"></span><span>Выключение</span>
          </button>
        </div>

        <!-- Developer menu (visible only in dev mode) -->
        <div id="devMenu" class="hidden absolute right-3 bottom-16 w-[320px] max-w-[92vw] win-surface p-3 flyout">
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold">Меню разработчика</div>
            <button id="btnDevClose" class="text-xs text-white/70 hover:text-white">Закрыть</button>
          </div>
          <div class="mt-2 text-xs text-white/70">Доступно только для аккаунта разработчика. Инструменты для тестов и пасхалок.</div>
          <div class="thin-sep my-2"></div>

          <div class="grid grid-cols-2 gap-2">
            <button id="btnDevFireworks" class="px-3 py-3 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-left">
              <div class="text-sm font-semibold">Фейерверк</div>
              <div class="text-xs text-white/60 mt-1">Тест анимации</div>
            </button>
            <button id="btnDevToggleNY" class="px-3 py-3 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-left">
              <div class="text-sm font-semibold">Новый год</div>
              <div class="text-xs text-white/60 mt-1">Снег/гирлянда</div>
            </button>
            <button id="btnDevToggleLiquid" class="px-3 py-3 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-left">
              <div class="text-sm font-semibold">Liquid Glass</div>
              <div class="text-xs text-white/60 mt-1">Вкл/выкл</div>
            </button>
            <button id="btnDevToastTest" class="px-3 py-3 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-left">
              <div class="text-sm font-semibold">Тост</div>
              <div class="text-xs text-white/60 mt-1">Тест уведомления</div>
            </button>
          </div>

          <div class="mt-2 text-[11px] text-white/50">Подсказка: фейерверк автоматически запускается 1 января в 00:00.</div>
        </div>
      </div>

      <!-- Search flyout (taskbar) -->
      <div id="searchFlyout" class="hidden absolute left-3 bottom-[calc(var(--taskbar-h)+10px)] w-[560px] max-w-[92vw] z-[4000] win-surface flyout">
        <div class="p-3">
          <div class="flex items-center gap-2">
            <span class="w-5 h-5" id="icoSearch2"></span>
            <input id="globalSearch" class="w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60" placeholder="Поиск" />
            <button id="btnSearchClose" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10">Закрыть</button>
          </div>
          <div class="mt-3 grid grid-cols-2 gap-3">
            <div>
              <div class="text-sm font-semibold">Приложения</div>
              <div id="searchApps" class="mt-2 space-y-1"></div>
            </div>
            <div>
              <div class="text-sm font-semibold">Файлы</div>
              <div id="searchFiles" class="mt-2 space-y-1"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick settings -->
      <div id="quickSettings" class="hidden absolute right-3 bottom-[calc(var(--taskbar-h)+10px)] w-[360px] max-w-[92vw] z-[4000] win-surface flyout">
        <div class="p-3">
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold">Быстрые настройки</div>
            <button id="btnOpenSettings" class="text-xs text-white/70 hover:text-white">Открыть параметры</button>
          </div>
          <div class="mt-3 grid grid-cols-3 gap-2">
            <button data-toggle="wifi" class="qs-toggle p-3 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10">
              <div class="flex items-center gap-2">
                <span class="w-5 h-5" id="icoWifi"></span>
                <div class="text-left">
                  <div class="text-sm font-semibold">Wi‑Fi</div>
                  <div class="text-xs text-white/60" data-sub="wifi">Вкл</div>
                </div>
              </div>
            </button>
            <button data-toggle="bt" class="qs-toggle p-3 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10">
              <div class="flex items-center gap-2">
                <span class="w-5 h-5" id="icoBt"></span>
                <div class="text-left">
                  <div class="text-sm font-semibold">Bluetooth</div>
                  <div class="text-xs text-white/60" data-sub="bt">Выкл</div>
                </div>
              </div>
            </button>
            <button data-toggle="night" class="qs-toggle p-3 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10">
              <div class="flex items-center gap-2">
                <span class="w-5 h-5" id="icoNight"></span>
                <div class="text-left">
                  <div class="text-sm font-semibold">Ночной свет</div>
                  <div class="text-xs text-white/60" data-sub="night">Выкл</div>
                </div>
              </div>
            </button>
          </div>
          <div class="mt-3">
            <div class="text-xs text-white/60 mb-2">Громкость</div>
            <input id="volSlider" type="range" min="0" max="100" class="w-full" />
          </div>
        </div>
      </div>

      <!-- Widgets flyout -->
      <div id="widgetsFlyout" class="hidden absolute left-3 bottom-[calc(var(--taskbar-h)+10px)] w-[520px] max-w-[92vw] z-[4000] win-surface flyout">
        <div class="p-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="w-6 h-6" id="icoWidgets"></span>
              <div class="text-sm font-semibold">Виджеты</div>
            </div>
            <button id="btnWidgetsClose" class="text-xs text-white/70 hover:text-white">Закрыть</button>
          </div>
          <div class="mt-3 grid grid-cols-2 gap-3">
            <div class="p-4 rounded-2xl border border-white/10 bg-white/5">
              <div class="text-sm font-semibold">Сводка системы</div>
              <div class="text-xs text-white/70 mt-2" id="sysSummary">—</div>
              <button id="btnBoost" class="mt-3 px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Ускорить (демо)</button>
            </div>
            <div class="p-4 rounded-2xl border border-white/10 bg-white/5">
              <div class="text-sm font-semibold">Фокус‑таймер</div>
              <div class="text-xs text-white/70 mt-2">Помодоро 25:00 — уведомит по завершению</div>
              <div class="mt-3 flex items-center justify-between">
                <div class="text-2xl font-semibold" id="focusTime">25:00</div>
                <div class="flex gap-2">
                  <button id="btnFocusStart" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Старт</button>
                  <button id="btnFocusReset" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Сброс</button>
                </div>
              </div>
            </div>
            <div class="p-4 rounded-2xl border border-white/10 bg-white/5 col-span-2">
              <div class="text-sm font-semibold">Советы</div>
              <div class="text-xs text-white/70 mt-2" id="tipsBox">—</div>
              <div class="mt-3 flex flex-wrap gap-2">
                <button class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm" id="btnTipNext">Следующий совет</button>
                <button class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm" id="btnOpenRun">Win+R: «Выполнить»</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Notification center -->
      <div id="notifCenter" class="hidden absolute right-3 bottom-[calc(var(--taskbar-h)+10px)] w-[380px] max-w-[92vw] z-[4000] win-surface flyout">
        <div class="p-3 flex items-center justify-between">
          <div>
            <div class="text-sm font-semibold">Уведомления</div>
            <div id="notifMeta" class="text-xs text-white/60">—</div>
          </div>
          <button id="btnClearNotifs" class="text-xs text-white/70 hover:text-white">Очистить</button>
        </div>
        <div class="thin-sep"></div>
        <div id="notifList" class="p-2 max-h-[420px] overflow-auto scrollbar"></div>
      </div>

      <!-- Calendar flyout (date/time click) -->
      <div id="calendarFlyout" class="hidden absolute right-3 bottom-[calc(var(--taskbar-h)+10px)] w-[360px] max-w-[92vw] z-[4000] win-surface flyout">
        <div class="p-3 flex items-center justify-between">
          <div>
            <div class="text-sm font-semibold">Календарь</div>
            <div id="calSubtitle" class="text-xs text-white/60">—</div>
          </div>
          <button id="btnCalToday" class="text-xs text-white/70 hover:text-white">Сегодня</button>
        </div>
        <div class="thin-sep"></div>
        <div class="p-3">
          <div class="flex items-center justify-between">
            <button id="btnCalPrev" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10">‹</button>
            <div id="calTitle" class="text-sm font-semibold">—</div>
            <button id="btnCalNext" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10">›</button>
          </div>
          <div class="mt-3 grid grid-cols-7 gap-1 text-center text-[11px] text-white/60">
            <div>Пн</div><div>Вт</div><div>Ср</div><div>Чт</div><div>Пт</div><div>Сб</div><div>Вс</div>
          </div>
          <div id="calGrid" class="mt-2 grid grid-cols-7 gap-1"></div>
          <div class="mt-3 text-xs text-white/60">Нажмите на дату, чтобы выделить (демо).</div>
        </div>
      </div>

      <!-- Toasts (disabled by default, can be enabled in Settings) -->
      <div id="toasts" class="absolute right-3 bottom-[calc(var(--taskbar-h)+10px)] z-[4500] flex flex-col gap-2"></div>

      <!-- Run dialog -->
      <div id="runDialog" class="hidden absolute left-1/2 top-[18%] -translate-x-1/2 z-[7000] win-surface w-[520px] max-w-[92vw] flyout">
        <div class="p-4">
          <div class="flex items-center gap-2">
            <span class="w-6 h-6" id="icoRun"></span>
            <div class="text-sm font-semibold">Выполнить</div>
            <div class="ml-auto text-xs text-white/60">Win+R</div>
          </div>
          <div class="mt-3 text-xs text-white/70">Введите имя приложения (например: <span class="kbd">notepad</span>, <span class="kbd">store</span>) или URL/поиск.</div>
          <div class="mt-3 flex gap-2">
            <input id="runInput" class="flex-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60" placeholder="Команда" />
            <button id="btnRunOk" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10">ОК</button>
            <button id="btnRunCancel" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10">Отмена</button>
          </div>
          <div class="mt-3 text-xs text-white/60">Поддерживается: запуск приложений, <span class="kbd">win://</span> страницы Edge, и поиск через Яндекс.</div>
        </div>
      </div>

      <!-- Shutdown overlay -->
      <div id="shutdownOverlay" class="hidden absolute inset-0 z-[9998] bg-black/80 backdrop-blur-md flex items-center justify-center">
        <div class="win-surface p-6 w-[520px] max-w-[92vw] text-center">
          <div class="mx-auto w-10 h-10" id="icoWin"></div>
          <div id="shutdownTitle" class="mt-3 text-xl font-semibold">Завершение работы</div>
          <div id="shutdownText" class="mt-2 text-white/70">Пожалуйста, подождите…</div>
          <div class="mt-4 flex items-center justify-center gap-2">
            <button id="btnShutdownCancel" class="px-4 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10">Отмена</button>
          </div>
        </div>
      </div>

      <!-- Sleep overlay -->
      <div id="sleepOverlay" class="sleep-overlay">
        <div class="win-surface p-6 w-[520px] max-w-[92vw] text-center">
          <div class="mx-auto w-10 h-10" id="icoLock"></div>
          <div class="mt-3 text-xl font-semibold">Сон</div>
          <div class="mt-2 text-white/70">Нажмите или нажмите любую клавишу, чтобы продолжить</div>
        </div>
      </div>

      <!-- Lock / login overlay (shown only if password exists) -->
      <div id="lockOverlay" class="lock-overlay">
        <div class="win-surface p-6 w-[520px] max-w-[92vw]">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10" id="icoWinLogin"></div>
            <div class="min-w-0">
              <div class="text-lg font-semibold">Вход</div>
              <div class="text-xs text-white/60" id="lockUserName">—</div>
            </div>
          </div>
          <div class="mt-4 text-xs text-white/70">Введите пароль, чтобы продолжить.</div>
          <div class="mt-3 flex gap-2">
            <input id="lockPass" type="password" class="flex-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60" placeholder="Пароль" />
            <button id="btnUnlock" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10">Войти</button>
          </div>
          <div id="lockError" class="mt-2 text-xs text-red-200/80 hidden">Неверный пароль</div>
          <div class="mt-4 text-[11px] text-white/50">Подсказка: пароль задаётся в Параметры → Система → Аккаунт.</div>
        </div>
      </div>

      <!-- Taskbar -->
      <div id="taskbar" class="taskbar fixed left-2 right-2 bottom-2 z-[3000] glass rounded-[18px] flex items-center justify-between px-2">
        <div class="flex items-center gap-2">
          <button id="btnStart" class="taskbtn">
            <span class="w-6 h-6" id="icoStart"></span>
          </button>
          <button id="btnSearch" class="taskbtn">
            <span class="w-5 h-5" id="icoSearch3"></span>
            <span class="text-sm text-white/80 hidden sm:block">Поиск</span>
          </button>
          <button id="btnWidgets" class="taskbtn" title="Виджеты">
            <span class="w-5 h-5" id="icoWidgets2"></span>
            <span class="text-sm text-white/80 hidden sm:block">Виджеты</span>
          </button>
          <div id="taskApps" class="flex items-center gap-2"></div>
        </div>

        <div class="flex items-center gap-2">
          <button id="btnNotifs" class="taskbtn" title="Уведомления">
            <span class="w-5 h-5" id="icoBell"></span>
            <span id="notifDot" class="hidden absolute -top-1 -right-1 w-2.5 h-2.5 rounded-full bg-[rgb(var(--accent))]"></span>
          </button>
          <button id="btnTray" class="taskbtn" title="Быстрые настройки">
            <div class="flex items-center gap-2">
              <span class="w-5 h-5" id="icoTrayNet"></span>
              <span class="w-5 h-5" id="icoTrayVol"></span>
              <span class="w-5 h-5" id="icoTrayBat"></span>
              <div class="text-right">
                <div id="clock" class="text-sm font-semibold leading-4">--:--</div>
                <div id="date" class="text-[11px] text-white/70 leading-4">--.--.----</div>
              </div>
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Utilities ----------
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const clamp = (v, a, b) => Math.min(b, Math.max(a, v));
    const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
    const fmt2 = (n) => String(n).padStart(2,'0');

    // App versioning (starting from v1)
    const W12_VERSION = '1.1.0';
    const W12_BUILD = 1;

    function h(tag, attrs={}, children=[]) {
      const el = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)) {
        if (k === 'class') el.className = v;
        else if (k.startsWith('on') && typeof v === 'function') el.addEventListener(k.slice(2), v);
        else if (k === 'html') el.innerHTML = v;
        else el.setAttribute(k, v);
      }
      for (const ch of (Array.isArray(children) ? children : [children])) {
        if (ch == null) continue;
        if (typeof ch === 'string') el.appendChild(document.createTextNode(ch));
        else el.appendChild(ch);
      }
      return el;
    }

    function downloadText(filename, text) {
      const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 500);
    }

    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result ?? ''));
        r.onerror = () => reject(r.error);
        r.readAsText(file);
      });
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function isProbablyUrl(v){
      const s = (v||'').trim();
      if (!s) return false;
      if (s.startsWith('win://')) return true;
      if (/^https?:\/\//i.test(s)) return true;
      if (s.includes(' ') || s.includes('\n') || s.includes('\t')) return false;
      return /\.[a-z]{2,}$/i.test(s) || s.includes(':');
    }

    // ---------- Simple inline icons ----------
    const Icons = {
      win: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 5.2 10.4 4v7H3V5.2Z" fill="rgba(255,255,255,.92)"/>
          <path d="M11.6 3.9 21 2.5V11h-9.4V3.9Z" fill="rgba(255,255,255,.82)"/>
          <path d="M3 12.2h7.4v7L3 18V12.2Z" fill="rgba(255,255,255,.82)"/>
          <path d="M11.6 12.2H21v8.5l-9.4-1.4v-7.1Z" fill="rgba(255,255,255,.92)"/>
        </svg>` ,
      store: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 8h16l-1.2 12.5a2 2 0 0 1-2 1.8H7.2a2 2 0 0 1-2-1.8L4 8Z" fill="rgba(56,189,248,.18)" stroke="rgba(255,255,255,.45)"/>
          <path d="M8 10v11M16 10v11" stroke="rgba(255,255,255,.18)"/>
          <path d="M9 8a3 3 0 0 1 6 0" stroke="rgba(255,255,255,.65)" stroke-width="2" stroke-linecap="round"/>
          <path d="M8 12h8" stroke="rgba(255,255,255,.25)"/>
          <path d="M11 15h2" stroke="rgba(99,102,241,.85)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      search: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="rgba(255,255,255,.85)" stroke-width="2"/>
          <path d="M16.6 16.6 21 21" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      folder: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3.5 7.5c0-1.1.9-2 2-2h4l2 2H18.5c1.1 0 2 .9 2 2v7.5c0 1.1-.9 2-2 2h-13c-1.1 0-2-.9-2-2V7.5Z" fill="rgba(255,255,255,.14)" stroke="rgba(255,255,255,.45)"/>
          <path d="M3.8 9h16.4" stroke="rgba(255,255,255,.35)"/>
        </svg>` ,
      note: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M7 3h8l4 4v14H7V3Z" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.45)"/>
          <path d="M15 3v5h5" stroke="rgba(255,255,255,.45)"/>
          <path d="M9 12h9M9 15h9M9 18h7" stroke="rgba(255,255,255,.35)" stroke-linecap="round"/>
        </svg>` ,
      calc: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="6" y="3" width="12" height="18" rx="3" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.45)"/>
          <rect x="8" y="6" width="8" height="3" rx="1" fill="rgba(255,255,255,.18)"/>
          <path d="M9 12h2M13 12h2M9 15h2M13 15h2M9 18h2M13 18h2" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      settings: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 15.2a3.2 3.2 0 1 0 0-6.4 3.2 3.2 0 0 0 0 6.4Z" stroke="rgba(255,255,255,.75)" stroke-width="2"/>
          <path d="M19.4 13a7.9 7.9 0 0 0 0-2l2-1.5-2-3.4-2.3 1a8 8 0 0 0-1.7-1l-.3-2.5H11l-.3 2.5c-.6.2-1.1.6-1.7 1L6.7 6.1l-2 3.4 2 1.5a8 8 0 0 0 0 2l-2 1.5 2 3.4 2.3-1c.5.4 1.1.7 1.7 1l.3 2.5h4l.3-2.5c.6-.2 1.1-.6 1.7-1l2.3 1 2-3.4-2-1.5Z" stroke="rgba(255,255,255,.55)" stroke-width="1.4" stroke-linejoin="round"/>
        </svg>` ,
      edge: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M20.5 12.6c0 5-4.2 8.9-9 8.9-3.8 0-7-2.2-8.3-5.5 2.2 1.4 5.2 1.2 7.1-.6 1.3-1.2 2-3 1.9-4.7-.2-2.6-2.3-4.8-5.1-5.1 1.4-1.7 3.6-2.8 6.1-2.8 4.8 0 7.3 3.6 7.3 7.9Z" fill="rgba(56,189,248,.65)"/>
          <path d="M3.2 16c.6-2.7 3-4.7 5.9-4.7 1.8 0 3.3.7 4.3 1.9-1 .4-1.8.9-2.5 1.6-1.6 1.6-2 3.9-1 5.7-2.6-.4-5-2.2-6.7-4.5Z" fill="rgba(99,102,241,.55)"/>
        </svg>` ,
      bell: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 22a2.2 2.2 0 0 0 2.1-1.5H9.9A2.2 2.2 0 0 0 12 22Z" fill="rgba(255,255,255,.8)"/>
          <path d="M6 9a6 6 0 0 1 12 0c0 6 2 6.5 2 8H4c0-1.5 2-2 2-8Z" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linejoin="round"/>
        </svg>` ,
      wifi: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M2.8 8.6C8.5 3.4 15.5 3.4 21.2 8.6" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
          <path d="M6 12c4.1-3.7 7.9-3.7 12 0" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
          <path d="M9.6 15.5c2.1-1.9 2.7-1.9 4.8 0" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
          <path d="M12 19.5h0" stroke="rgba(255,255,255,.75)" stroke-width="4" stroke-linecap="round"/>
        </svg>` ,
      wifiOff: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M2.8 8.6C6 5.7 9.6 4.5 13.3 4.9" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
          <path d="M21.2 8.6c-.9-.9-1.9-1.7-3-2.3" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
          <path d="M6 12c2-1.8 3.9-2.7 6-2.7" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
          <path d="M12 19.5h0" stroke="rgba(255,255,255,.55)" stroke-width="4" stroke-linecap="round"/>
          <path d="M4 4l16 16" stroke="rgba(239,68,68,.9)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      volume: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 10v4h3l5 4V6L7 10H4Z" fill="rgba(255,255,255,.75)"/>
          <path d="M16 9c1.3 1.3 1.3 4.7 0 6" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
          <path d="M18.5 7c2.6 2.6 2.6 7.4 0 10" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      volumeMute: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 10v4h3l5 4V6L7 10H4Z" fill="rgba(255,255,255,.65)"/>
          <path d="M16 10l5 5M21 10l-5 5" stroke="rgba(239,68,68,.9)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      battery: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="7" width="16" height="10" rx="2" stroke="rgba(255,255,255,.75)" stroke-width="2"/>
          <path d="M21 10v4" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
          <rect x="5" y="9" width="10" height="6" rx="1.5" fill="rgba(34,197,94,.65)"/>
        </svg>` ,
      user: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 12a4.2 4.2 0 1 0 0-8.4A4.2 4.2 0 0 0 12 12Z" fill="rgba(255,255,255,.75)"/>
          <path d="M4 20.2c1.7-4.1 14.3-4.1 16 0" stroke="rgba(255,255,255,.65)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      power: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3v10" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
          <path d="M7 5.2a8 8 0 1 0 10 0" stroke="rgba(255,255,255,.65)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      moon: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M21 14.7A7.6 7.6 0 0 1 9.3 3a6.5 6.5 0 1 0 11.7 11.7Z" fill="rgba(255,255,255,.75)"/>
        </svg>` ,
      restart: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M20 12a8 8 0 1 1-2.3-5.7" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
          <path d="M20 4v6h-6" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      shutdown: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3v10" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
          <path d="M6.5 6.5a8 8 0 1 0 11 0" stroke="rgba(239,68,68,.85)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      lock: (cls='w-10 h-10') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="6" y="11" width="12" height="10" rx="2.5" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.45)"/>
          <path d="M8 11V8.5a4 4 0 0 1 8 0V11" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      dots: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 12h0M12 12h0M18 12h0" stroke="rgba(255,255,255,.8)" stroke-width="4" stroke-linecap="round"/>
        </svg>` ,
      minimize: (cls='w-4 h-4') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 18h12" stroke="rgba(255,255,255,.8)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      maximize: (cls='w-4 h-4') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="7" y="7" width="10" height="10" rx="2" stroke="rgba(255,255,255,.8)" stroke-width="2"/>
        </svg>` ,
      restore: (cls='w-4 h-4') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="8" y="7" width="10" height="10" rx="2" stroke="rgba(255,255,255,.8)" stroke-width="2"/>
          <path d="M7 10V9a2 2 0 0 1 2-2h1" stroke="rgba(255,255,255,.8)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      close: (cls='w-4 h-4') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M7 7l10 10M17 7 7 17" stroke="rgba(255,255,255,.88)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      refresh: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M20 12a8 8 0 1 1-2.3-5.7" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
          <path d="M20 4v6h-6" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/>
        </svg>` ,
      bluetooth: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3v18l6-6-6-6 6-6-6 6-6-6" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>` ,
      night: (cls='w-5 h-5') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M21 14.7A7.6 7.6 0 0 1 9.3 3a6.5 6.5 0 1 0 11.7 11.7Z" stroke="rgba(255,255,255,.75)" stroke-width="2" fill="rgba(255,255,255,.10)"/>
        </svg>`,
      game: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M8 9.5 6.2 7.2A3.2 3.2 0 0 0 3.7 6H3.2C2 6 1 7 1.1 8.2l.6 6.3A3.8 3.8 0 0 0 5.5 18h1.7l2.2-2.2a3 3 0 0 1 4.2 0L15.8 18h1.7a3.8 3.8 0 0 0 3.8-3.5l.6-6.3C22 7 21 6 19.8 6h-.5c-1 0-1.9.5-2.5 1.2L16 9.5" stroke="rgba(255,255,255,.75)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M7.2 12h2.6M8.5 10.7v2.6" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
          <path d="M15.7 11.2h0" stroke="rgba(56,189,248,.9)" stroke-width="4" stroke-linecap="round"/>
          <path d="M18 12.8h0" stroke="rgba(99,102,241,.9)" stroke-width="4" stroke-linecap="round"/>
        </svg>`,
      widgets: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="3" width="8" height="8" rx="2" fill="rgba(56,189,248,.35)" stroke="rgba(255,255,255,.35)"/>
          <rect x="13" y="3" width="8" height="8" rx="2" fill="rgba(99,102,241,.28)" stroke="rgba(255,255,255,.30)"/>
          <rect x="3" y="13" width="8" height="8" rx="2" fill="rgba(244,114,182,.22)" stroke="rgba(255,255,255,.28)"/>
          <rect x="13" y="13" width="8" height="8" rx="2" fill="rgba(34,197,94,.18)" stroke="rgba(255,255,255,.28)"/>
        </svg>`,
      run: (cls='w-6 h-6') => `
        <svg class="${cls}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 7.5A3.5 3.5 0 0 1 7.5 4h9A3.5 3.5 0 0 1 20 7.5v9A3.5 3.5 0 0 1 16.5 20h-9A3.5 3.5 0 0 1 4 16.5v-9Z" stroke="rgba(255,255,255,.65)" stroke-width="2"/>
          <path d="M8 12h8" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
          <path d="M13 9l3 3-3 3" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`
    };

    function setIcon(id, svgHtml) {
      const el = document.getElementById(id);
      if (el) el.innerHTML = svgHtml;
    }

    // ---------- Virtual FS ----------
    const FS_KEY = 'w12_fs_v3';
    function fsLoad() {
      try {
        const raw = localStorage.getItem(FS_KEY);
        if (raw) return JSON.parse(raw);
      } catch {}
      return {
        desktop: [
          { type: 'app', appId: 'explorer', name: 'Проводник' },
          { type: 'app', appId: 'edge', name: 'Microsoft Edge' },
          { type: 'app', appId: 'notepad', name: 'Блокнот' },
          { type: 'app', appId: 'calculator', name: 'Калькулятор' },
          { type: 'app', appId: 'store', name: 'Microsoft Store' },
          { type: 'app', appId: 'settings', name: 'Параметры' },
          { type: 'file', fileId: 'readme', name: 'Добро пожаловать.txt', ext: 'txt' }
        ],
        files: {
          readme: {
            id: 'readme',
            name: 'Добро пожаловать.txt',
            ext: 'txt',
            updatedAt: Date.now(),
            content: 'Это демонстрационный интерфейс «Windows 12» в одном HTML.\n\n— Окна: перетаскивание, изменение размера, Snap, сворачивание/разворачивание.\n— Рабочий стол: мультивыделение, рамка выделения, перетаскивание иконок.\n— «Пуск», поиск, быстрые настройки, центр уведомлений.\n— Приложения: Проводник, Блокнот, Калькулятор, Edge (симуляция), Store, Настройки.\n\nMicrosoft Store:\n• Flappy Bird — реализовано.\n• VS Code / Змейка / Обои / Темы / инструменты — реализовано (демо).\n\nПодсказки:\n• Win — открыть/закрыть «Пуск»\n• Win+R — «Выполнить»\n• Esc — закрыть меню/панели\n• Alt+Tab — переключение окон\n• F5 — обновить рабочий стол\n'
          }
        },
        blobs: {
          // fileId -> { mime, dataUrl }
        }
      };
    }
    function fsSave(fs) {
      localStorage.setItem(FS_KEY, JSON.stringify(fs));
    }

    // ---------- Settings persistence ----------
    const UI_KEY = 'w12_ui_v3';
    function uiLoad() {
      try {
        const raw = localStorage.getItem(UI_KEY);
        if (raw) return JSON.parse(raw);
      } catch {}
      return {
        accent: [99,102,241],
        wallpaper: 'aurora',
        wallpaperCustom: null,
        dark: true,
        volume: 46,
        toggles: { wifi: true, bt: false, night: false },
        recent: [],
        showToasts: false,
        transparency: true,
        installedApps: ['flappy','paint','photos','musicPlayer'],
        edgeTabsBeta: false,
        edgeOpenInsideBeta: false,
        fullscreenPref: false,
        newYear: false,

        // sound + account
        soundsEnabled: true,
        account: { username: 'Локальный пользователь', password: null },

        // theme packs
        scheme: 'dark',
        glassMode: 'default',

        // customization packs
        taskbar: { h: 56, radius: 18, alpha: .08, blur: 18, style: 'win11' },
        iconFilter: 'none',
        anim: { open: 160, close: 140, min: 160, ui: 160 },
        animStyle: 'default',
        font: { preset: 'system', custom: null }
      };
    }
    function uiSave(ui) {
      localStorage.setItem(UI_KEY, JSON.stringify(ui));
    }

    // ---------- Wallpapers ----------
    const Wallpapers = {
      aurora: `radial-gradient(1200px 700px at 10% 10%, rgba(99,102,241,.55), transparent 60%),
              radial-gradient(900px 600px at 80% 25%, rgba(56,189,248,.45), transparent 55%),
              radial-gradient(900px 700px at 55% 85%, rgba(244,114,182,.35), transparent 60%),
              linear-gradient(180deg, #070B16, #060915)`,
      dunes: `radial-gradient(1000px 700px at 15% 10%, rgba(245,158,11,.30), transparent 60%),
             radial-gradient(900px 650px at 75% 25%, rgba(236,72,153,.22), transparent 60%),
             linear-gradient(180deg, #0b1020, #070b16)`,
      ocean: `radial-gradient(900px 650px at 15% 20%, rgba(34,211,238,.35), transparent 60%),
             radial-gradient(900px 650px at 80% 70%, rgba(59,130,246,.35), transparent 60%),
             linear-gradient(180deg, #051023, #040a18)`,
      graphite: `radial-gradient(1200px 800px at 50% 30%, rgba(255,255,255,.08), transparent 55%),
                linear-gradient(180deg, #0a0a0f, #07070c)`,
      blossom: `radial-gradient(900px 650px at 20% 25%, rgba(244,114,182,.38), transparent 60%),
               radial-gradient(900px 650px at 75% 35%, rgba(99,102,241,.32), transparent 60%),
               linear-gradient(180deg, #0b0b16, #060612)`
    };

    // ---------- App registry ----------
    const ComingSoon = (title, body='Скоро будет доступно в Microsoft Store.') => {
      const wrap = h('div', { class:'p-4' }, [
        h('div', { class:'text-xl font-semibold' }, title),
        h('div', { class:'text-white/70 mt-2' }, body),
        h('div', { class:'mt-4 p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Статус'),
          h('div', { class:'text-xs text-white/70 mt-1' }, 'Скоро (coming soon)')
        ])
      ]);
      return wrap;
    };

    const registry = {
      explorer: {
        id: 'explorer',
        name: 'Проводник',
        iconHtml: Icons.folder('w-6 h-6'),
        defaultSize: {w: 820, h: 520},
        build: (win) => buildExplorer(win)
      },
      notepad: {
        id: 'notepad',
        name: 'Блокнот',
        iconHtml: Icons.note('w-6 h-6'),
        defaultSize: {w: 760, h: 520},
        build: (win) => buildNotepad(win)
      },
      calculator: {
        id: 'calculator',
        name: 'Калькулятор',
        iconHtml: Icons.calc('w-6 h-6'),
        defaultSize: {w: 360, h: 520},
        build: (win) => buildCalculator(win)
      },
      edge: {
        id: 'edge',
        name: 'Microsoft Edge',
        iconHtml: Icons.edge('w-6 h-6'),
        defaultSize: {w: 920, h: 560},
        build: (win) => buildEdge(win)
      },
      store: {
        id: 'store',
        name: 'Microsoft Store',
        iconHtml: Icons.store('w-6 h-6'),
        defaultSize: {w: 980, h: 640},
        build: (win) => buildStore(win)
      },
      settings: {
        id: 'settings',
        name: 'Параметры',
        iconHtml: Icons.settings('w-6 h-6'),
        defaultSize: {w: 920, h: 600},
        build: (win) => buildSettings(win)
      },
      clock: {
        id: 'clock',
        name: 'Часы',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="8" stroke="rgba(255,255,255,.75)" stroke-width="2"/><path d="M12 7v5l3 2" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 2v2M12 20v2M2 12h2M20 12h2" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linecap="round"/></svg>`,
        defaultSize: {w: 520, h: 560},
        build: (win) => buildClockApp(win)
      },

      // Apps that are in Store (only Flappy is implemented now)
      flappy: {
        id: 'flappy',
        name: 'Flappy Bird',
        iconHtml: Icons.game('w-6 h-6'),
        defaultSize: {w: 560, h: 720},
        build: (win) => buildFlappy(win)
      },
      snake: {
        id: 'snake',
        name: 'Змейка',
        iconHtml: Icons.game('w-6 h-6'),
        defaultSize: {w: 560, h: 660},
        build: (win) => buildSnake(win)
      },
      tetris: {
        id: 'tetris',
        name: 'Тетрис',
        iconHtml: Icons.game('w-6 h-6'),
        defaultSize: {w: 560, h: 640},
        build: (win) => buildTetris(win)
      },
      vscode: {
        id: 'vscode',
        name: 'Visual Studio Code',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 3.5 22 5.7v12.6l-4.5 2.2-7.5-6.9 7.5-6.1Z" fill="rgba(56,189,248,.55)"/><path d="M9.9 6.2 6.5 9 3 7.5 2 9l3.2 3-3.2 3 1 1.5L6.5 15l3.4 2.8" stroke="rgba(255,255,255,.7)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
        defaultSize: {w: 1040, h: 680},
        build: (win) => buildVSCode(win)
      },
      word: {
        id: 'word',
        name: 'Microsoft Word',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="4" width="16" height="16" rx="3" fill="rgba(59,130,246,.35)" stroke="rgba(255,255,255,.35)"/><path d="M8 8h3l1 5 1-5h3" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
        defaultSize: {w: 980, h: 680},
        build: (win) => buildWord(win)
      },
      excel: {
        id: 'excel',
        name: 'Microsoft Excel',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="4" width="16" height="16" rx="3" fill="rgba(34,197,94,.25)" stroke="rgba(255,255,255,.35)"/><path d="M8 8h8M8 12h8M8 16h8M12 8v8" stroke="rgba(255,255,255,.7)"/></svg>`,
        defaultSize: {w: 1040, h: 680},
        build: (win) => buildExcel(win)
      },
      wallpapers: {
        id: 'wallpapers',
        name: 'Обои',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3.5" y="4" width="17" height="16" rx="3" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.45)"/><path d="M6.5 16.5 10.2 12.8a1.4 1.4 0 0 1 2 0l1.7 1.7 2.1-2.1a1.4 1.4 0 0 1 2 0l.5.5V19H5.8l.7-2.5Z" fill="rgba(99,102,241,.28)"/><circle cx="9" cy="9" r="1.4" fill="rgba(56,189,248,.85)"/></svg>`,
        defaultSize: {w: 980, h: 640},
        build: (win) => buildWallpapersApp(win)
      },

      taskbarTweaks: {
        id: 'taskbarTweaks',
        name: 'Кастомизация панели задач',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="16" width="18" height="5" rx="2.5" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.45)"/><path d="M6 18.5h3M11 18.5h3M16 18.5h2" stroke="rgba(99,102,241,.85)" stroke-width="2" stroke-linecap="round"/></svg>`,
        defaultSize: {w: 820, h: 560},
        build: (win) => buildTaskbarTweaks(win)
      },
      fontManager: {
        id: 'fontManager',
        name: 'Шрифт‑менеджер',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 20h12" stroke="rgba(255,255,255,.55)" stroke-width="2" stroke-linecap="round"/><path d="M9 20 12 4l3 16" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9.9 14h4.2" stroke="rgba(99,102,241,.85)" stroke-width="2" stroke-linecap="round"/></svg>`,
        defaultSize: {w: 860, h: 600},
        build: (win) => buildFontManager(win)
      },
      animStudio: {
        id: 'animStudio',
        name: 'Настройка анимаций',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 16c3-8 5 0 8-8s5 8 8 0" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/><path d="M4 19h16" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linecap="round"/></svg>`,
        defaultSize: {w: 860, h: 620},
        build: (win) => buildAnimationStudio(win)
      },
      paint: {
        id: 'paint',
        name: 'Paint',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 13c-2.5-2.6-3.2-5.4-1.6-7 2-2 6.5-.8 10 2.7 3.6 3.6 4.7 8 2.7 10-1.6 1.6-4.4.9-7-1.6" stroke="rgba(255,255,255,.65)" stroke-width="2" stroke-linecap="round"/><path d="M7 17l-2 4" stroke="rgba(244,114,182,.85)" stroke-width="2" stroke-linecap="round"/><path d="M14.5 9.5h0" stroke="rgba(56,189,248,.9)" stroke-width="5" stroke-linecap="round"/></svg>`,
        defaultSize: {w: 980, h: 680},
        build: (win) => buildPaint(win)
      },
      iconDesigner: {
        id: 'iconDesigner',
        name: 'Дизайнер иконок',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="4" width="16" height="16" rx="4" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.45)"/><path d="M8 16l8-8" stroke="rgba(99,102,241,.85)" stroke-width="2" stroke-linecap="round"/><path d="M9 8h0" stroke="rgba(56,189,248,.9)" stroke-width="4" stroke-linecap="round"/><path d="M15 16h0" stroke="rgba(244,114,182,.9)" stroke-width="4" stroke-linecap="round"/></svg>`,
        defaultSize: {w: 980, h: 680},
        build: (win) => buildIconDesigner(win)
      },
      nyCountdown: {
        id: 'nyCountdown',
        name: 'До Нового года',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 21h12" stroke="rgba(255,255,255,.35)" stroke-width="2" stroke-linecap="round"/><path d="M8 21V10a4 4 0 0 1 8 0v11" stroke="rgba(255,255,255,.65)" stroke-width="2" stroke-linecap="round"/><path d="M12 3v3" stroke="rgba(244,114,182,.9)" stroke-width="2" stroke-linecap="round"/><path d="M9 6h6" stroke="rgba(56,189,248,.85)" stroke-width="2" stroke-linecap="round"/></svg>`,
        defaultSize: {w: 700, h: 560},
        build: (win) => buildNewYearCountdown(win)
      },
      themeManager: {
        id: 'themeManager',
        name: 'Менеджер тем',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3a9 9 0 1 0 9 9c0-.7-.1-1.4-.2-2" stroke="rgba(255,255,255,.65)" stroke-width="2" stroke-linecap="round"/><path d="M21 7c-3.5 0-6 2.5-6 6 0 3.5 2.5 6 6 6" stroke="rgba(99,102,241,.85)" stroke-width="2" stroke-linecap="round"/></svg>`,
        defaultSize: {w: 1040, h: 680},
        build: (win) => buildThemeManager(win)
      },

      terminal: {
        id: 'terminal',
        name: 'Terminal',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="5" width="18" height="14" rx="3" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.45)"/><path d="M7 10l3 2-3 2" stroke="rgba(56,189,248,.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M11.5 14H17" stroke="rgba(255,255,255,.75)" stroke-width="2" stroke-linecap="round"/></svg>`,
        defaultSize: {w: 860, h: 560},
        build: (win) => buildTerminal(win)
      },
      todo: {
        id: 'todo',
        name: 'Список дел',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="4" width="14" height="16" rx="3" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.45)"/><path d="M8 9h8M8 13h8M8 17h6" stroke="rgba(255,255,255,.65)" stroke-width="2" stroke-linecap="round"/><path d="M7.5 9.2l.8.8 1.7-1.9" stroke="rgba(34,197,94,.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
        defaultSize: {w: 520, h: 620},
        build: (win) => buildTodo(win)
      },

      photos: {
        id: 'photos',
        name: 'Фото',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="5" width="16" height="14" rx="3" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.45)"/><path d="M7 16l3-3a1.2 1.2 0 0 1 1.7 0l1.3 1.3 2-2a1.2 1.2 0 0 1 1.7 0l.3.3V17H6.2L7 16Z" fill="rgba(99,102,241,.28)"/><circle cx="9" cy="10" r="1.2" fill="rgba(56,189,248,.85)"/></svg>`,
        defaultSize: {w: 980, h: 640},
        build: (win) => buildPhotos(win)
      },
      musicPlayer: {
        id: 'musicPlayer',
        name: 'Музыка',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 4v12.2a2.8 2.8 0 1 1-1.8-2.6V7.2l8-2V14.2a2.8 2.8 0 1 1-1.8-2.6V4l-8 2Z" fill="rgba(56,189,248,.35)" stroke="rgba(255,255,255,.45)"/></svg>`,
        defaultSize: {w: 920, h: 620},
        build: (win) => buildMusic(win)
      },
      stickyNotes: {
        id: 'stickyNotes',
        name: 'Заметки',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 4h10l2 2v14H6V4Z" fill="rgba(245,158,11,.18)" stroke="rgba(255,255,255,.45)"/><path d="M16 4v4h4" stroke="rgba(255,255,255,.45)"/><path d="M8 11h8M8 14h8M8 17h6" stroke="rgba(255,255,255,.35)" stroke-linecap="round"/></svg>`,
        defaultSize: {w: 560, h: 640},
        build: (win) => buildStickyNotes(win)
      },
      archiver: {
        id: 'archiver',
        name: 'Архиватор',
        iconHtml: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="3" width="12" height="18" rx="3" fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.45)"/><path d="M10 3v18" stroke="rgba(255,255,255,.25)"/><path d="M12 7h2M12 10h2M12 13h2" stroke="rgba(244,114,182,.85)" stroke-width="2" stroke-linecap="round"/></svg>`,
        defaultSize: {w: 920, h: 640},
        build: (win) => buildArchiver(win)
      }
    };

    const STORE_CATALOG = [
      { id:'flappy', name:'Flappy Bird', category:'Игры', status:'available', iconHtml: registry.flappy.iconHtml, desc:'Реализовано. Управление: Space/Click.' },
      { id:'snake', name:'Змейка', category:'Игры', status:'available', iconHtml: registry.snake.iconHtml, desc:'Реализовано. Управление: стрелки / WASD, пауза: Space.' },
      { id:'tetris', name:'Тетрис', category:'Игры', status:'available', iconHtml: registry.tetris.iconHtml, desc:'Реализовано. Управление: ← → ↓, поворот: ↑, пауза: P, сброс: R.' },

      { id:'vscode', name:'Visual Studio Code', category:'Продуктивность', status:'available', iconHtml: registry.vscode.iconHtml, desc:'Реализовано (демо-редактор кода с автосохранением).' },
      { id:'word', name:'Microsoft Word', category:'Продуктивность', status:'available', iconHtml: registry.word.iconHtml, desc:'Реализовано (демо): документ + форматирование + экспорт.' },
      { id:'excel', name:'Microsoft Excel', category:'Продуктивность', status:'available', iconHtml: registry.excel.iconHtml, desc:'Реализовано (демо): таблица 10×20 + формулы.' },

      { id:'wallpapers', name:'Обои', category:'Персонализация', status:'available', iconHtml: registry.wallpapers.iconHtml, desc:'Неофициальное приложение с коллекцией из 100 обоев (градиенты).' },
      { id:'taskbarTweaks', name:'Кастомизация панели задач', category:'Персонализация', status:'available', iconHtml: registry.taskbarTweaks.iconHtml, desc:'Изменение размера/прозрачности/blur панели задач (демо, влияет на систему).' },
      { id:'fontManager', name:'Шрифт‑менеджер', category:'Персонализация', status:'available', iconHtml: registry.fontManager.iconHtml, desc:'Выбор системного шрифта (демо). Применяется ко всему интерфейсу.' },
      { id:'animStudio', name:'Настройка анимаций', category:'Персонализация', status:'available', iconHtml: registry.animStudio.iconHtml, desc:'Тонкая настройка длительностей анимаций UI (демо) + пресеты.' },
      { id:'paint', name:'Paint', category:'Персонализация', status:'available', iconHtml: registry.paint.iconHtml, desc:'Простой редактор рисунков: кисть/ластик/фигуры/сохранение PNG.' },
      { id:'iconDesigner', name:'Дизайнер иконок', category:'Персонализация', status:'available', iconHtml: registry.iconDesigner.iconHtml, desc:'Соберите SVG‑иконку из фигур и скачайте (SVG/PNG).' },
      { id:'nyCountdown', name:'До Нового года', category:'Персонализация', status:'available', iconHtml: registry.nyCountdown.iconHtml, desc:'Счётчик дней/часов/минут до 1 января.' },
      { id:'themeManager', name:'Менеджер тем', category:'Персонализация', status:'available', iconHtml: registry.themeManager.iconHtml, desc:'Пакеты тем (обои/акцент/иконки/анимации). Быстрое применение.' },

      { id:'terminal', name:'Terminal', category:'Утилиты', status:'available', iconHtml: registry.terminal.iconHtml, desc:'Мини‑терминал (демо): help, ls, cat, open, date, clear.' },
      { id:'todo', name:'Список дел', category:'Продуктивность', status:'available', iconHtml: registry.todo.iconHtml, desc:'Задачи с сохранением: добавление, выполнение, фильтры.' },

      { id:'photos', name:'Фото', category:'Мультимедиа', status:'available', iconHtml: registry.photos.iconHtml, desc:'Просмотр изображений (PNG/JPG/WebP) из виртуальной FS + импорт.' },
      { id:'musicPlayer', name:'Музыка', category:'Мультимедиа', status:'available', iconHtml: registry.musicPlayer.iconHtml, desc:'Мини‑плеер (демо): импорт аудио, плейлист, воспроизведение.' },
      { id:'stickyNotes', name:'Заметки', category:'Продуктивность', status:'available', iconHtml: registry.stickyNotes.iconHtml, desc:'Sticky Notes с сохранением: несколько заметок, цвета, поиск.' },
      { id:'archiver', name:'Архиватор', category:'Утилиты', status:'available', iconHtml: registry.archiver.iconHtml, desc:'ZIP‑демо: создать архив из файлов FS, открыть и извлечь.' }
    ];

    const OPTIONAL_APPS = new Set(['flappy','snake','tetris','vscode','word','excel','wallpapers','taskbarTweaks','fontManager','animStudio','paint','iconDesigner','nyCountdown','themeManager','terminal','todo','photos','musicPlayer','stickyNotes','archiver']);

    // ---------- Global state ----------
    const ui = uiLoad();
    const fs = fsLoad();

    const state = {
      windows: new Map(),
      order: [],
      activeWinId: null,
      z: 20,
      dragging: null,
      resizing: null,
      altTabIndex: 0,
      volume: clamp(ui.volume ?? 46, 0, 100),
      toggles: { ...{wifi:true, bt:false, night:false}, ...(ui.toggles || {}) },
      recent: Array.isArray(ui.recent) ? ui.recent : [],
      showToasts: !!ui.showToasts,
      transparency: (ui.transparency ?? true),
      notifications: [],
      focusTimer: { running:false, remainingMs: 25*60*1000, startedAt: null, tickId: null },
      installedApps: new Set(Array.isArray(ui.installedApps) ? ui.installedApps : []),
      edgeTabsBeta: !!ui.edgeTabsBeta,
      edgeOpenInsideBeta: !!ui.edgeOpenInsideBeta,
      fullscreenPref: !!ui.fullscreenPref,
      newYear: !!ui.newYear,

      soundsEnabled: (ui.soundsEnabled ?? true),
      account: ui.account || { username: 'Локальный пользователь', password: null },

      // Developer mode (enabled only for specific credentials on login)
      devMode: false
    };

    function isInstalled(appId){
      if (!OPTIONAL_APPS.has(appId)) return true;
      return state.installedApps.has(appId);
    }

    // ---------- FS migration + defaults ----------
    function desktopWorkAreaRect() {
      const tb = $('#taskbar');
      const tbRect = tb.getBoundingClientRect();
      return {
        x: 0,
        y: 0,
        w: window.innerWidth,
        h: Math.max(200, window.innerHeight - (tbRect.height + 12))
      };
    }

    function findFreeDesktopSlot(){
      const startX = 16, startY = 16;
      const colW = 104, rowH = 104;
      const area = desktopWorkAreaRect();
      const used = new Set();
      for (const it of fs.desktop || []) {
        if (it.pos && Number.isFinite(it.pos.x) && Number.isFinite(it.pos.y)) {
          used.add(`${Math.round(it.pos.x)}:${Math.round(it.pos.y)}`);
        }
      }
      const maxCols = Math.max(1, Math.floor((area.w - startX) / colW));
      let col = 0, row = 0;
      for (let tries=0; tries<5000; tries++) {
        const x = startX + col*colW;
        const y = startY + row*rowH;
        const key = `${x}:${y}`;
        if (!used.has(key) && x < area.w - 96 && y < area.h - 96) return {x,y};
        col++;
        if (col >= maxCols) { col = 0; row++; }
      }
      return { x: 16, y: 16 };
    }

    function fsMigrateAndEnsureDefaults(){
      fs.desktop = Array.isArray(fs.desktop) ? fs.desktop : [];
      fs.files = fs.files || {};
      fs.blobs = fs.blobs || {};

      for (const it of fs.desktop) {
        // Normalize old saved items (older builds could miss `type`)
        if (!it.type) {
          if (it.appId) it.type = 'app';
          else if (it.fileId) it.type = 'file';
          else if (it.folderId) it.type = 'folder';
        }
        if (!it.did) it.did = uid();
        // Fill display name when possible
        if (!it.name) {
          if (it.type === 'app' && it.appId && registry[it.appId]) it.name = registry[it.appId].name;
          if (it.type === 'file' && it.fileId && fs.files && fs.files[it.fileId]) it.name = fs.files[it.fileId].name;
          if (it.type === 'folder') it.name = it.name || 'Папка';
        }
      }

      const ensureApp = (appId, name) => {
        const exists = fs.desktop.some(x => x.type === 'app' && x.appId === appId);
        if (!exists) fs.desktop.push({ did: uid(), type:'app', appId, name });
      };
      ensureApp('explorer','Проводник');
      ensureApp('edge','Microsoft Edge');
      ensureApp('notepad','Блокнот');
      ensureApp('calculator','Калькулятор');
      ensureApp('store','Microsoft Store');
      ensureApp('settings','Параметры');
      ensureApp('clock','Часы');
      // Paint is preinstalled but still available in Store
      ensureApp('paint','Paint');

      if (!fs.files.readme) {
        fs.files.readme = {
          id:'readme', name:'Добро пожаловать.txt', ext:'txt', updatedAt: Date.now(),
          content:'Добро пожаловать!\n'
        };
        fs.desktop.push({ did: uid(), type:'file', fileId:'readme', name: 'Добро пожаловать.txt', ext:'txt' });
      }

      // Assign default positions if missing
      const used = new Set();
      for (const it of fs.desktop) {
        if (it.pos && Number.isFinite(it.pos.x) && Number.isFinite(it.pos.y)) {
          used.add(`${Math.round(it.pos.x)}:${Math.round(it.pos.y)}`);
        }
      }
      const startX = 16, startY = 16;
      const colW = 104, rowH = 104;
      let col = 0, row = 0;
      const area = desktopWorkAreaRect();
      const maxCols = Math.max(1, Math.floor((area.w - startX) / colW));

      let changed = false;
      for (const it of fs.desktop) {
        if (it.pos && Number.isFinite(it.pos.x) && Number.isFinite(it.pos.y)) continue;
        let tries = 0;
        while (tries < 5000) {
          const x = startX + col * colW;
          const y = startY + row * rowH;
          const key = `${x}:${y}`;
          if (!used.has(key) && x < area.w - 96 && y < area.h - 96) {
            it.pos = { x, y };
            used.add(key);
            changed = true;
            break;
          }
          col++;
          if (col >= maxCols) { col = 0; row++; }
          tries++;
        }
      }

      if (changed) fsSave(fs);
    }

    // ---------- Apply UI settings ----------
    function applyUI() {
      const a = ui.accent || [99,102,241];
      document.documentElement.style.setProperty('--accent', `${a[0]} ${a[1]} ${a[2]}`);
      const wp = ui.wallpaperCustom || Wallpapers[ui.wallpaper] || Wallpapers.aurora;
      document.documentElement.style.setProperty('--wallpaper', wp);
      document.documentElement.setAttribute('data-transparency', state.transparency ? '1' : '0');

      // Apply theme scheme + glass mode
      document.documentElement.setAttribute('data-scheme', ui.scheme || 'dark');
      document.documentElement.setAttribute('data-glassmode', ui.glassMode || 'default');

      // Apply taskbar customization
      const tb = ui.taskbar || { h:56, radius:18, alpha:.08, blur:18, style:'win11' };
      document.documentElement.style.setProperty('--taskbar-h', (tb.h ?? 56) + 'px');
      document.documentElement.style.setProperty('--taskbar-radius', (tb.radius ?? 18) + 'px');
      document.documentElement.style.setProperty('--taskbar-alpha', String(tb.alpha ?? .08));
      document.documentElement.style.setProperty('--taskbar-blur', (tb.blur ?? 18) + 'px');
      document.body.dataset.tbstyle = tb.style || 'win11';

      // Apply icon filter
      const ift = ui.iconFilter ?? 'none';
      document.documentElement.style.setProperty('--icon-filter', ift);

      // Apply animation settings
      const an = ui.anim || { open:160, close:140, min:160, ui:160 };
      document.documentElement.style.setProperty('--anim-open-ms', String(an.open ?? 160));
      document.documentElement.style.setProperty('--anim-close-ms', String(an.close ?? 140));
      document.documentElement.style.setProperty('--anim-min-ms', String(an.min ?? 160));
      document.documentElement.style.setProperty('--anim-ui-ms', String(an.ui ?? 160));

      // Apply font
      const font = ui.font || { preset:'system', custom:null };
      const presetMap = {
        system: 'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"',
        segoe: '"Segoe UI", ui-sans-serif, system-ui, -apple-system, Roboto, Helvetica, Arial',
        inter: 'Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial',
        roboto: 'Roboto, ui-sans-serif, system-ui, -apple-system, Segoe UI, Helvetica, Arial',
        monospace: 'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace'
      };
      const fontCss = font.preset === 'custom' ? (font.custom || presetMap.system) : (presetMap[font.preset] || presetMap.system);
      document.documentElement.style.setProperty('--ui-font', fontCss);

      const nightOn = !!state.toggles.night;
      $('#nightOverlay').style.display = nightOn ? 'block' : 'none';

      const nyOn = !!state.newYear;
      $('#nyGarland').style.display = nyOn ? 'block' : 'none';
      $('#nySnow').style.display = nyOn ? 'block' : 'none';
      if (nyOn) startNewYearSnow();
      else stopNewYearSnow();
    }

    function persistUI() {
      ui.accent = ui.accent || [99,102,241];
      ui.wallpaper = ui.wallpaper || 'aurora';
      ui.wallpaperCustom = ui.wallpaperCustom ?? null;
      ui.dark = true;
      ui.volume = state.volume;
      ui.toggles = { ...state.toggles };
      ui.recent = state.recent.slice(0, 12);
      ui.showToasts = !!state.showToasts;
      ui.transparency = !!state.transparency;
      ui.installedApps = Array.from(state.installedApps);
      ui.edgeTabsBeta = !!state.edgeTabsBeta;
      ui.edgeOpenInsideBeta = !!state.edgeOpenInsideBeta;
      ui.fullscreenPref = !!state.fullscreenPref;
      ui.newYear = !!state.newYear;
      ui.soundsEnabled = !!state.soundsEnabled;
      ui.account = state.account || { username: 'Локальный пользователь', password: null };

      // persist theme packs
      ui.scheme = ui.scheme || 'dark';
      ui.glassMode = ui.glassMode || 'default';

      // persist customization packs
      ui.taskbar = ui.taskbar || { h:56, radius:18, alpha:.08, blur:18, style:'win11' };
      ui.taskbar.style = ui.taskbar.style || 'win11';
      ui.iconFilter = ui.iconFilter ?? 'none';
      ui.anim = ui.anim || { open:160, close:140, min:160, ui:160 };
      ui.animStyle = ui.animStyle || 'default';
      ui.font = ui.font || { preset:'system', custom:null };

      uiSave(ui);
    }

    // ---------- New Year snow (canvas) ----------
    const ny = { running:false, raf: null, flakes: [], last: 0 };

    // ---------- New Year fireworks (canvas) ----------
    const fw = { running:false, raf:null, last:0, rockets:[], sparks:[], endAt:0 };

    function resizeFireworksCanvas(){
      const c = $('#nyFireworks');
      if (!c) return;
      const dpr = Math.min(2, window.devicePixelRatio || 1);
      c.width = Math.floor(window.innerWidth * dpr);
      c.height = Math.floor(window.innerHeight * dpr);
      c.style.width = window.innerWidth + 'px';
      c.style.height = window.innerHeight + 'px';
      const ctx = c.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }

    function spawnRocket(){
      const x = 80 + Math.random()*(window.innerWidth - 160);
      const y = window.innerHeight + 20;
      const tx = x + (-80 + Math.random()*160);
      const ty = 120 + Math.random()*(window.innerHeight*0.45);
      fw.rockets.push({ x, y, vx: (tx-x)/40, vy: (ty-y)/40, t:0, ttl: 40 + Math.random()*10, hue: Math.random()*360 });
    }

    function explode(x,y,hue){
      const count = 70 + Math.floor(Math.random()*80);
      for (let i=0;i<count;i++){
        const a = Math.random()*Math.PI*2;
        const sp = 1.6 + Math.random()*4.6;
        fw.sparks.push({
          x, y,
          vx: Math.cos(a)*sp,
          vy: Math.sin(a)*sp,
          life: 90 + Math.random()*40,
          t: 0,
          hue: (hue + (-30+Math.random()*60) + 360)%360,
          size: 1 + Math.random()*2.2
        });
      }
    }

    function drawFireworks(t){
      if (!fw.running) return;
      const c = $('#nyFireworks');
      if (!c) return;
      const ctx = c.getContext('2d');
      const dt = Math.min(0.05, (t - (fw.last||t))/1000);
      fw.last = t;

      // fade trail
      ctx.fillStyle = 'rgba(0,0,0,0.16)';
      ctx.fillRect(0,0,window.innerWidth,window.innerHeight);

      // spawn rockets occasionally
      if (fw.rockets.length < 6 && Math.random() < 0.08) spawnRocket();

      // rockets
      for (let i=fw.rockets.length-1; i>=0; i--){
        const r = fw.rockets[i];
        r.t += dt*60;
        r.x += r.vx * dt*60;
        r.y += r.vy * dt*60;
        r.vy += 0.01 * dt*60; // gravity

        ctx.strokeStyle = `hsla(${r.hue}, 95%, 70%, .9)`;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(r.x, r.y);
        ctx.lineTo(r.x - r.vx*2.4, r.y - r.vy*2.4);
        ctx.stroke();

        if (r.t > r.ttl || r.y < 80){
          explode(r.x, r.y, r.hue);
          fw.rockets.splice(i,1);
        }
      }

      // sparks
      for (let i=fw.sparks.length-1; i>=0; i--){
        const s = fw.sparks[i];
        s.t += dt*60;
        s.x += s.vx * dt*60;
        s.y += s.vy * dt*60;
        s.vy += 0.03 * dt*60;
        s.vx *= 0.992;
        s.vy *= 0.992;
        const a = Math.max(0, 1 - s.t / s.life);

        ctx.fillStyle = `hsla(${s.hue}, 95%, 70%, ${a})`;
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.size, 0, Math.PI*2);
        ctx.fill();

        if (s.t > s.life || a <= 0.01) fw.sparks.splice(i,1);
      }

      // auto-stop
      if (Date.now() > fw.endAt && fw.rockets.length === 0 && fw.sparks.length === 0) {
        stopFireworks();
        return;
      }

      fw.raf = requestAnimationFrame(drawFireworks);
    }

    function startFireworks({durationMs=12000}={}){
      const c = $('#nyFireworks');
      if (!c) return;
      resizeFireworksCanvas();
      fw.running = true;
      fw.last = performance.now();
      fw.rockets = [];
      fw.sparks = [];
      fw.endAt = Date.now() + durationMs;
      c.style.display = 'block';
      // clear to transparent with slight vignette
      const ctx = c.getContext('2d');
      ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
      fw.raf = requestAnimationFrame(drawFireworks);
    }

    function stopFireworks(){
      fw.running = false;
      if (fw.raf) cancelAnimationFrame(fw.raf);
      fw.raf = null;
      const c = $('#nyFireworks');
      if (c) {
        const ctx = c.getContext('2d');
        ctx && ctx.clearRect(0,0,c.width,c.height);
        c.style.display = 'none';
      }
    }

    function isNewYearMoment(d=new Date()){
      // exactly Jan 1 00:00 local time (we'll tolerate first ~60s)
      return d.getMonth()===0 && d.getDate()===1 && d.getHours()===0 && d.getMinutes()===0;
    }

    function scheduleNewYearFireworks(){
      // check every second; trigger once per day
      let lastDayKey = null;
      setInterval(() => {
        const d = new Date();
        const dayKey = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
        if (isNewYearMoment(d) && lastDayKey !== dayKey) {
          lastDayKey = dayKey;
          startFireworks({ durationMs: 15000 });
          addNotification({
            title: 'С Новым годом!',
            body: 'Запуск фейерверков (демо).',
            iconHtml: Icons.win('w-6 h-6'),
            source: 'Система'
          });
        }
      }, 1000);

      window.addEventListener('resize', () => {
        if (fw.running) resizeFireworksCanvas();
      });
    }

    function resizeNyCanvas(){
      const c = $('#nySnow');
      if (!c) return;
      const dpr = Math.min(2, window.devicePixelRatio || 1);
      c.width = Math.floor(window.innerWidth * dpr);
      c.height = Math.floor(window.innerHeight * dpr);
      c.style.width = window.innerWidth + 'px';
      c.style.height = window.innerHeight + 'px';
      const ctx = c.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }

    function seedNyFlakes(){
      ny.flakes = [];
      const count = clamp(Math.floor(window.innerWidth / 18), 40, 140);
      for (let i=0; i<count; i++) {
        ny.flakes.push({
          x: Math.random()*window.innerWidth,
          y: Math.random()*window.innerHeight,
          r: 1 + Math.random()*2.4,
          vy: 26 + Math.random()*58,
          vx: -10 + Math.random()*20,
          a: 0.35 + Math.random()*0.55,
          wob: Math.random()*Math.PI*2
        });
      }
    }

    function drawNySnow(t){
      if (!ny.running) return;
      const c = $('#nySnow');
      if (!c) return;
      const ctx = c.getContext('2d');
      const dt = Math.min(0.05, (t - (ny.last || t))/1000);
      ny.last = t;

      ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
      // subtle vignette
      const g = ctx.createRadialGradient(window.innerWidth/2, window.innerHeight*0.2, 120, window.innerWidth/2, window.innerHeight*0.2, Math.max(window.innerWidth, window.innerHeight));
      g.addColorStop(0, 'rgba(255,255,255,.06)');
      g.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = g;
      ctx.fillRect(0,0,window.innerWidth,window.innerHeight);

      for (const f of ny.flakes) {
        f.wob += dt * (0.8 + f.r*0.45);
        f.x += (f.vx + Math.sin(f.wob)*12) * dt;
        f.y += f.vy * dt;
        if (f.y > window.innerHeight + 10) { f.y = -10; f.x = Math.random()*window.innerWidth; }
        if (f.x < -20) f.x = window.innerWidth + 20;
        if (f.x > window.innerWidth + 20) f.x = -20;
        ctx.fillStyle = `rgba(255,255,255,${f.a})`;
        ctx.beginPath();
        ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
        ctx.fill();
      }

      ny.raf = requestAnimationFrame(drawNySnow);
    }

    function startNewYearSnow(){
      if (ny.running) return;
      ny.running = true;
      resizeNyCanvas();
      seedNyFlakes();
      ny.last = performance.now();
      ny.raf = requestAnimationFrame(drawNySnow);
    }

    function stopNewYearSnow(){
      ny.running = false;
      if (ny.raf) cancelAnimationFrame(ny.raf);
      ny.raf = null;
      const c = $('#nySnow');
      if (c) {
        const ctx = c.getContext('2d');
        ctx && ctx.clearRect(0,0,c.width,c.height);
      }
    }

    // ---------- Fullscreen (browser) ----------
    function isBrowserFullscreen(){
      return !!document.fullscreenElement;
    }

    async function setBrowserFullscreen(yes){
      const want = !!yes;
      try {
        if (want) {
          const el = document.documentElement;
          if (!el.requestFullscreen) throw new Error('Fullscreen API not supported');
          await el.requestFullscreen();
        } else {
          if (document.exitFullscreen) await document.exitFullscreen();
        }
      } catch (err) {
        // Some browsers block fullscreen unless initiated by user gesture.
        addNotification({
          title: 'Параметры',
          body: 'Не удалось переключить полноэкранный режим. Браузер мог заблокировать Fullscreen API. Попробуйте ещё раз и разрешите полноэкранный режим.',
          iconHtml: registry.settings.iconHtml,
          source: 'Параметры'
        });
      }
      state.fullscreenPref = isBrowserFullscreen();
      persistUI();
    }

    // ---------- Desktop icons ----------
    // Desktop selection enabled (single click selects, double click opens)
    const DESKTOP_SELECTION_ENABLED = true;
    let selectedDids = new Set();
    // fallback for browsers where native dblclick can be swallowed by pointer capture/drag
    let lastDeskClick = { did:null, at:0, x:0, y:0 };
    // prevent double-open when both fallback and native dblclick fire
    let lastDeskOpen = { did:null, at:0 };

    function openDesktopItemDebounced(item){
      const did = item?.did;
      const now = Date.now();
      if (did && lastDeskOpen.did === did && (now - lastDeskOpen.at) < 500) return;
      lastDeskOpen = { did, at: now };
      openDesktopItem(item);
    }


    function iconForItem(item) {
      if (item.type === 'app') return registry[item.appId]?.iconHtml || Icons.win('w-8 h-8');
      if (item.type === 'folder') return Icons.folder('w-8 h-8');
      if (item.type === 'file') return Icons.note('w-8 h-8');
      return Icons.win('w-8 h-8');
    }

    function applySelectionClasses(){
      if (!DESKTOP_SELECTION_ENABLED) return;
      $$('#desktopIcons .desktop-icon').forEach(el => {
        const did = el.getAttribute('data-did');
        el.classList.toggle('selected', selectedDids.has(did));
      });
    }

    function clearSelection(){
      if (!DESKTOP_SELECTION_ENABLED) return;
      selectedDids = new Set();
      applySelectionClasses();
    }

    function selectOnly(did){
      if (!DESKTOP_SELECTION_ENABLED) return;
      selectedDids = new Set([did]);
      applySelectionClasses();
    }

    function toggleSelect(did){
      if (!DESKTOP_SELECTION_ENABLED) return;
      if (selectedDids.has(did)) selectedDids.delete(did);
      else selectedDids.add(did);
      applySelectionClasses();
    }

    function setSelection(dids){
      if (!DESKTOP_SELECTION_ENABLED) return;
      selectedDids = new Set(dids);
      applySelectionClasses();
    }

    function renderDesktopIcons() {
      const wrap = $('#desktopIcons');
      wrap.innerHTML = '';

      for (const item of fs.desktop) {
        const did = item.did;
        const pos = item.pos || (item.pos = findFreeDesktopSlot());

        const el = h('button', {
          class: `desktop-icon`,
          'data-did': did,
          title: item.name,
          style: `left:${pos.x}px; top:${pos.y}px;`
        }, [
          h('div', { class: 'w-10 h-10 flex items-center justify-center', html: iconForItem(item)}),
          h('div', { class: 'px-1' }, item.name)
        ]);

        // click: select. double click: open.
        let justDragged = false;

        el.addEventListener('click', (e) => {
          e.stopPropagation();
          if (justDragged) { justDragged = false; return; }

          if (DESKTOP_SELECTION_ENABLED && e.detail === 1) {
            if (e.ctrlKey || e.metaKey) toggleSelect(did);
            else selectOnly(did);
          }

          // reliable open on double click via click detail
          if (e.detail === 2) {
            openDesktopItemDebounced(item);
          }
        });

        el.addEventListener('dblclick', (e) => {
          e.preventDefault();
          e.stopPropagation();
          openDesktopItemDebounced(item);
        });

        // context menu on icon (Open must be first)
        el.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          e.stopPropagation();
          showIconMenu(e.clientX, e.clientY, item);
        });

        // drag (single icon only)
        let drag = null;
        el.addEventListener('pointerdown', (e) => {
          if (e.button !== 0) return;
          e.stopPropagation();
          drag = {
            pointerId: e.pointerId,
            startX: e.clientX,
            startY: e.clientY,
            orig: { x: item.pos?.x ?? pos.x, y: item.pos?.y ?? pos.y },
            active: false,
            captured: false
          };
        });

        el.addEventListener('pointermove', (e) => {
          if (!drag || drag.pointerId !== e.pointerId) return;
          const dx = e.clientX - drag.startX;
          const dy = e.clientY - drag.startY;

          const isCoarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
          const threshold = isCoarse ? 10 : 6;

          if (!drag.active && Math.hypot(dx, dy) > threshold) {
            drag.active = true;
            if (!drag.captured) {
              try { el.setPointerCapture(e.pointerId); drag.captured = true; } catch {}
            }
            el.classList.add('dragging');
          }
          if (!drag.active) return;

          const area = desktopWorkAreaRect();
          const nx = clamp(drag.orig.x + dx, 0, area.w - 96);
          const ny = clamp(drag.orig.y + dy, 0, area.h - 96);
          el.style.left = nx + 'px';
          el.style.top = ny + 'px';
        });

        el.addEventListener('pointerup', (e) => {
          if (!drag || drag.pointerId !== e.pointerId) return;
          if (drag.captured) {
            try { el.releasePointerCapture(e.pointerId); } catch {}
          }

          justDragged = !!drag.active;

          if (drag.active) {
            const left = parseFloat(el.style.left) || 0;
            const top = parseFloat(el.style.top) || 0;
            item.pos = { x: left, y: top };
            fsSave(fs);
          } else {
            // fallback double click (pointerup-based)
            const now = Date.now();
            const dist = Math.hypot((e.clientX - lastDeskClick.x), (e.clientY - lastDeskClick.y));
            const isCoarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
            const maxDelay = isCoarse ? 460 : 360;
            const maxDist = isCoarse ? 22 : 14;

            if (lastDeskClick.did === did && (now - lastDeskClick.at) < maxDelay && dist < maxDist) {
              openDesktopItemDebounced(item);
              lastDeskClick = { did:null, at:0, x:0, y:0 };
            } else {
              lastDeskClick = { did, at: now, x: e.clientX, y: e.clientY };
            }
          }

          el.classList.remove('dragging');
          drag = null;
        });

        wrap.appendChild(el);
      }

      // keep selection (if enabled)
      if (DESKTOP_SELECTION_ENABLED) applySelectionClasses();
      else selectedDids = new Set();
    }

    function openDesktopItem(item) {
      try {
        // Be tolerant to old saved structures
        const type = item.type || (item.appId ? 'app' : item.fileId ? 'file' : item.folderId ? 'folder' : null);
        if (type === 'app') {
          openApp(item.appId);
          return;
        }
        if (type === 'file') {
          openFileById(item.fileId);
          return;
        }
        if (type === 'folder') {
          openApp('explorer', { path: 'desktop' });
          return;
        }

        // If we still couldn't infer anything, show a soft error
        addNotification({
          title: 'Рабочий стол',
          body: 'Не удалось определить тип элемента рабочего стола (повреждённые данные). Попробуйте обновить (F5) или сбросить localStorage.',
          iconHtml: Icons.win('w-6 h-6'),
          source: 'Система'
        });
      } catch (err) {
        addNotification({
          title: 'Рабочий стол',
          body: 'Не удалось открыть элемент. Проверьте консоль (F12) для деталей.',
          iconHtml: Icons.win('w-6 h-6'),
          source: 'Система'
        });
        console.error('openDesktopItem failed', err, item);
      }
    }

    // ---------- Window manager ----------
    function openApp(appId, opts={}) {
      const app = registry[appId];
      if (!app) {
        addNotification({ title: 'Система', body: `Приложение не найдено: ${appId}`, iconHtml: Icons.win('w-6 h-6'), source: 'Система' });
        return;
      }

      // block uninstalled optional apps
      if (!isInstalled(appId) && appId !== 'store') {
        addNotification({
          title: 'Microsoft Store',
          body: `Приложение «${app.name}» не установлено. Откройте Store.`,
          iconHtml: registry.store.iconHtml,
          source: 'Microsoft Store'
        });
        openApp('store', { focusAppId: appId });
        return;
      }

      // Settings single instance
      if (appId === 'settings') {
        const existing = Array.from(state.windows.values()).find(w => w.appId === 'settings');
        if (existing) { restoreWindow(existing.id); focusWindow(existing.id); return; }
      }

      const id = uid();
      const area = desktopWorkAreaRect();
      const ds = app.defaultSize || {w: 720, h: 520};
      const w = clamp(ds.w, 320, area.w - 20);
      const h = clamp(ds.h, 240, area.h - 20);
      const left = clamp(Math.round(area.w/2 - w/2 + (state.order.length*16)%120), 10, area.w - w - 10);
      const top = clamp(Math.round(area.h/2 - h/2 + (state.order.length*14)%90), 10, area.h - h - 10);

      const win = {
        id,
        appId,
        title: app.name,
        iconHtml: app.iconHtml,
        minimized: false,
        maximized: false,
        rect: { x: left, y: top, w, h },
        prevRect: null,
        createdAt: Date.now(),
        opts
      };

      state.windows.set(id, win);
      state.order.push(id);

      try {
        createWindowElement(win);
        focusWindow(id);
        updateTaskbar();
        SFX.open();
      } catch (err) {
        console.error('openApp/createWindowElement failed', err, { appId, win });
        // rollback inconsistent state
        state.windows.delete(id);
        state.order = state.order.filter(x => x !== id);
        if (state.activeWinId === id) state.activeWinId = null;
        updateTaskbar();
        updateTaskbarAutoHide();
        addNotification({
          title: 'Система',
          body: `Приложение «${app.name}» не удалось открыть (ошибка UI). Проверьте консоль (F12).`,
          iconHtml: app.iconHtml,
          source: 'Система'
        });
        return;
      }

      addRecent({ kind: 'app', appId, name: app.name, ts: Date.now() });
      return id;
    }

    function createWindowElement(win) {
      const layer = $('#windowLayer');
      const el = h('div', {
        class: 'absolute win-surface win-in',
        'data-win': win.id,
        style: `left:${win.rect.x}px; top:${win.rect.y}px; width:${win.rect.w}px; height:${win.rect.h}px; z-index:${++state.z};`
      });
      setTimeout(() => el.classList.remove('win-in'), 220);

      const titlebar = h('div', { class: 'titlebar', 'data-titlebar': '1' });
      const titleLeft = h('div', { class: 'titletext' }, [
        h('div', { class: 'w-5 h-5 flex items-center justify-center', html: win.iconHtml }),
        h('div', { class: 'name' }, win.title)
      ]);

      const controls = h('div', { class: 'window-controls flex items-center gap-1' });

      // Snap menu (on hover of maximize)
      const snapMenu = h('div', { class: 'hidden absolute right-14 top-9 w-56 win-surface p-2 z-[6000] flyout', 'data-snap': '1' }, [
        h('div', { class: 'text-xs px-2 py-2 text-white/60' }, 'Размещение (Snap)'),
        h('div', { class: 'grid grid-cols-2 gap-2 px-1 pb-1' }, [
          snapBtn('left', 'Слева'),
          snapBtn('right', 'Справа'),
          snapBtn('top', 'Сверху'),
          snapBtn('bottom', 'Снизу'),
        ]),
        h('div', { class: 'thin-sep my-1' }),
        h('button', { class: 'w-full text-left menu-item', onclick: () => { maximizeWindow(win.id, true); hideAllPopovers(); } }, [
          h('div', { class: 'w-5 h-5', html: Icons.maximize('w-5 h-5') }),
          h('div', {}, 'Развернуть')
        ])
      ]);

      function snapBtn(where, label){
        return h('button', {
          class: 'px-3 py-3 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 text-left',
          onclick: () => { snapWindow(win.id, where); hideAllPopovers(); }
        }, [
          h('div', { class: 'text-sm font-semibold' }, label),
          h('div', { class: 'text-xs text-white/60' }, snapLabel(where))
        ]);
      }
      function snapLabel(where){
        return ({left:'1/2 экрана', right:'1/2 экрана', top:'верхняя половина', bottom:'нижняя половина'})[where] || '';
      }

      const btnMin = h('button', { title: 'Свернуть', onclick: (e) => { e.stopPropagation(); minimizeWindow(win.id); } });
      btnMin.innerHTML = Icons.minimize('w-4 h-4');

      const btnMax = h('button', { title: 'Развернуть / восстановить' });
      btnMax.innerHTML = Icons.maximize('w-4 h-4');

      const btnClose = h('button', { title: 'Закрыть', class: 'danger', onclick: (e) => { e.stopPropagation(); closeWindow(win.id); } });
      btnClose.innerHTML = Icons.close('w-4 h-4');

      controls.append(btnMin, btnMax, btnClose);
      titlebar.append(titleLeft, controls);
      el.append(titlebar);

      const content = h('div', { class: 'window-content scrollbar', 'data-content': '1' });
      el.append(content);

      const resizer = h('div', { class: 'resize-handle', 'data-resize': '1' });
      el.append(resizer);

      // Build app UI
      const app = registry[win.appId];
      try {
        content.appendChild(app.build(win));
      } catch (err) {
        console.error('App build failed', win.appId, err);
        content.appendChild(h('div', { class:'p-4' }, [
          h('div', { class:'text-xl font-semibold' }, 'Ошибка приложения'),
          h('div', { class:'text-white/70 mt-2' }, `Не удалось построить UI приложения «${app?.name || win.appId}».`),
          h('div', { class:'text-xs text-white/60 mt-2' }, 'Откройте консоль (F12), чтобы увидеть детали ошибки.'),
          h('div', { class:'mt-4 flex gap-2' }, [
            h('button', { class:'btn text-sm', onclick: () => { try{ refreshWindowContent(win.id); }catch{} } }, 'Повторить'),
            h('button', { class:'btn text-sm', onclick: () => closeWindow(win.id) }, 'Закрыть')
          ])
        ]));
      }

      // Focus on click
      el.addEventListener('pointerdown', () => focusWindow(win.id));

      // Drag logic
      titlebar.addEventListener('pointerdown', (e) => {
        if (e.button !== 0) return;
        if (win.maximized) return;

        // IMPORTANT: don't start dragging when clicking window controls (min/max/close)
        const target = (e.target instanceof Element) ? e.target : e.target?.parentElement;
        if (target && target.closest('.window-controls')) return;

        // Prevent accidental text selection / gestures
        e.preventDefault();

        focusWindow(win.id);
        state.dragging = {
          winId: win.id,
          startX: e.clientX,
          startY: e.clientY,
          orig: { ...win.rect },
          pointerId: e.pointerId
        };
        titlebar.classList.add('dragging');
        try { titlebar.setPointerCapture(e.pointerId); } catch {}
      });

      titlebar.addEventListener('pointermove', (e) => {
        if (!state.dragging || state.dragging.winId !== win.id) return;
        const dx = e.clientX - state.dragging.startX;
        const dy = e.clientY - state.dragging.startY;
        const area = desktopWorkAreaRect();
        win.rect.x = clamp(state.dragging.orig.x + dx, 0, area.w - win.rect.w);
        win.rect.y = clamp(state.dragging.orig.y + dy, 0, area.h - win.rect.h);
        applyRect(el, win.rect);

        // Snap preview
        const margin = 18;
        const atLeft = e.clientX < margin;
        const atRight = e.clientX > (window.innerWidth - margin);
        const atTop = e.clientY < margin;
        const atBottom = e.clientY > (window.innerHeight - (margin + 56));
        const hint = $('#snapHint');
        if (atLeft || atRight || atTop || atBottom) hint.style.display = 'block';
        else hint.style.display = 'none';
      });

      function endWindowDrag(e){
        if (!state.dragging || state.dragging.winId !== win.id) return;
        titlebar.classList.remove('dragging');
        try { titlebar.releasePointerCapture(e.pointerId); } catch {}

        const margin = 18;
        const atLeft = e.clientX < margin;
        const atRight = e.clientX > (window.innerWidth - margin);
        const atTop = e.clientY < margin;
        const atBottom = e.clientY > (window.innerHeight - (margin + 56));
        $('#snapHint').style.display = 'none';

        if (atLeft) snapWindow(win.id, 'left');
        else if (atRight) snapWindow(win.id, 'right');
        else if (atTop) maximizeWindow(win.id, true);
        else if (atBottom) minimizeWindow(win.id);

        state.dragging = null;
        updateTaskbar();
      }

      titlebar.addEventListener('pointerup', endWindowDrag);
      titlebar.addEventListener('pointercancel', (e) => {
        if (!state.dragging || state.dragging.winId !== win.id) return;
        $('#snapHint').style.display = 'none';
        titlebar.classList.remove('dragging');
        try { titlebar.releasePointerCapture(e.pointerId); } catch {}
        state.dragging = null;
        updateTaskbar();
      });

      // Resize
      resizer.addEventListener('pointerdown', (e) => {
        if (e.button !== 0) return;
        focusWindow(win.id);
        state.resizing = {
          winId: win.id,
          startX: e.clientX,
          startY: e.clientY,
          orig: { ...win.rect }
        };
        resizer.setPointerCapture(e.pointerId);
      });

      resizer.addEventListener('pointermove', (e) => {
        if (!state.resizing || state.resizing.winId !== win.id) return;
        const dx = e.clientX - state.resizing.startX;
        const dy = e.clientY - state.resizing.startY;
        const area = desktopWorkAreaRect();
        win.rect.w = clamp(state.resizing.orig.w + dx, 320, area.w - win.rect.x - 4);
        win.rect.h = clamp(state.resizing.orig.h + dy, 240, area.h - win.rect.y - 4);
        applyRect(el, win.rect);
      });

      resizer.addEventListener('pointerup', (e) => {
        if (!state.resizing || state.resizing.winId !== win.id) return;
        try { resizer.releasePointerCapture(e.pointerId); } catch {}
        state.resizing = null;
        updateTaskbar();
      });

      // Control buttons
      btnMax.addEventListener('click', (e) => {
        e.stopPropagation();
        if (win.maximized) maximizeWindow(win.id, false);
        else maximizeWindow(win.id, true);
        hideAllPopovers();
      });

      // Snap menu on hover
      let snapTimer = null;
      btnMax.addEventListener('pointerenter', () => {
        clearTimeout(snapTimer);
        snapTimer = setTimeout(() => {
          if (!state.windows.has(win.id)) return;
          hideAllPopovers();
          snapMenu.classList.remove('hidden');
        }, 220);
      });
      btnMax.addEventListener('pointerleave', () => {
        clearTimeout(snapTimer);
        snapTimer = setTimeout(() => snapMenu.classList.add('hidden'), 320);
      });
      snapMenu.addEventListener('pointerenter', () => clearTimeout(snapTimer));
      snapMenu.addEventListener('pointerleave', () => {
        clearTimeout(snapTimer);
        snapTimer = setTimeout(() => snapMenu.classList.add('hidden'), 220);
      });

      // Titlebar double-click
      titlebar.addEventListener('dblclick', () => {
        if (win.maximized) maximizeWindow(win.id, false);
        else maximizeWindow(win.id, true);
      });

      el.appendChild(snapMenu);
      layer.appendChild(el);
      updateWindowControls(el, win);
    }

    function updateWindowControls(winEl, win){
      const btns = $$('.window-controls button', winEl);
      const btnMax = btns[1];
      if (btnMax) btnMax.innerHTML = win.maximized ? Icons.restore('w-4 h-4') : Icons.maximize('w-4 h-4');
      const res = $('[data-resize]', winEl);
      if (res) res.style.display = win.maximized ? 'none' : 'block';
    }

    function applyRect(winEl, rect){
      winEl.style.left = rect.x + 'px';
      winEl.style.top = rect.y + 'px';
      winEl.style.width = rect.w + 'px';
      winEl.style.height = rect.h + 'px';
    }

    function focusWindow(winId){
      const win = state.windows.get(winId);
      if (!win) return;
      win.minimized = false;
      state.activeWinId = winId;
      const el = document.querySelector(`[data-win="${winId}"]`);
      if (el) el.style.zIndex = String(++state.z);
      $$('#windowLayer > [data-win]').forEach(wel => {
        wel.style.outline = 'none';
      });
      if (el) el.style.outline = '2px solid rgba(' + (ui.accent||[99,102,241]).join(',') + ',.45)';
      updateTaskbar();
      updateTaskbarAutoHide();
    }

    function minimizeWindow(winId){
      const win = state.windows.get(winId);
      if (!win) return;
      win.minimized = true;
      if (state.activeWinId === winId) {
        const next = state.order.slice().reverse().find(id => {
          const w = state.windows.get(id);
          return w && !w.minimized;
        });
        state.activeWinId = next || null;
      }
      const el = document.querySelector(`[data-win="${winId}"]`);
      if (el) {
        el.classList.remove('win-in','win-out');
        el.classList.add('win-min');
        setTimeout(() => {
          // may already be closed
          if (!state.windows.has(winId)) return;
          const el2 = document.querySelector(`[data-win="${winId}"]`);
          if (el2) {
            el2.style.display = 'none';
            el2.classList.remove('win-min');
          }
        }, 170);
      }
      updateTaskbar();
      updateTaskbarAutoHide();
    }

    function restoreWindow(winId){
      const win = state.windows.get(winId);
      if (!win) return;
      win.minimized = false;
      const el = document.querySelector(`[data-win="${winId}"]`);
      if (el) el.style.display = 'block';
      focusWindow(winId);
      updateTaskbarAutoHide();
    }

    // before-close handlers
    const beforeClose = new Map();
    const onClose = new Map();
    function registerBeforeClose(winId, fn){ beforeClose.set(winId, fn); }
    function registerOnClose(winId, fn){
      const prev = onClose.get(winId);
      if (!prev) onClose.set(winId, fn);
      else onClose.set(winId, () => { try{ prev(); }catch{} try{ fn(); }catch{} });
    }

    function closeWindow(winId){
      const guard = beforeClose.get(winId);
      if (guard) {
        try {
          const ok = guard();
          if (!ok) return;
        } catch {}
        beforeClose.delete(winId);
      }

      const win = state.windows.get(winId);
      if (!win) return;
      const el = document.querySelector(`[data-win="${winId}"]`);

      const finalize = () => {
        const cleanup = onClose.get(winId);
        if (cleanup) {
          try { cleanup(); } catch {}
          onClose.delete(winId);
        }
        const el2 = document.querySelector(`[data-win="${winId}"]`);
        if (el2) el2.remove();
        state.windows.delete(winId);
        state.order = state.order.filter(x => x !== winId);
        if (state.activeWinId === winId) state.activeWinId = null;
        const last = state.order.slice().reverse().find(id => {
          const w = state.windows.get(id);
          return w && !w.minimized;
        });
        if (last) focusWindow(last);
        updateTaskbar();
        updateTaskbarAutoHide();
      };

      if (el) {
        el.classList.remove('win-in','win-min');
        el.classList.add('win-out');
        SFX.close();
        setTimeout(finalize, 150);
      } else {
        SFX.close();
        finalize();
      }
    }

    function maximizeWindow(winId, yes){
      const win = state.windows.get(winId);
      if (!win) return;
      const el = document.querySelector(`[data-win="${winId}"]`);
      if (!el) return;
      if (yes && !win.maximized) {
        win.prevRect = { ...win.rect };
        const area = desktopWorkAreaRect();
        win.rect = { x: 8, y: 8, w: area.w - 16, h: area.h - 16 };
        win.maximized = true;
      } else if (!yes && win.maximized) {
        if (win.prevRect) win.rect = { ...win.prevRect };
        win.prevRect = null;
        win.maximized = false;
      }
      applyRect(el, win.rect);
      updateWindowControls(el, win);
      focusWindow(winId);
      updateTaskbarAutoHide();
    }

    function snapWindow(winId, where){
      const win = state.windows.get(winId);
      if (!win) return;
      const el = document.querySelector(`[data-win="${winId}"]`);
      if (!el) return;
      const area = desktopWorkAreaRect();
      if (!win.maximized) win.prevRect = win.prevRect || { ...win.rect };
      win.maximized = false;
      const pad = 10;
      if (where === 'left') win.rect = { x: pad, y: pad, w: Math.floor((area.w - 3*pad)/2), h: area.h - 2*pad };
      if (where === 'right') win.rect = { x: Math.floor(area.w/2) + pad/2, y: pad, w: Math.floor((area.w - 3*pad)/2), h: area.h - 2*pad };
      if (where === 'top') win.rect = { x: pad, y: pad, w: area.w - 2*pad, h: Math.floor((area.h - 3*pad)/2) };
      if (where === 'bottom') win.rect = { x: pad, y: Math.floor(area.h/2) + pad/2, w: area.w - 2*pad, h: Math.floor((area.h - 3*pad)/2) };
      applyRect(el, win.rect);
      updateWindowControls(el, win);
      focusWindow(winId);
      updateTaskbarAutoHide();
    }

    // ---------- Taskbar autohide ----------
    let tbHideTimer = null;
    function updateTaskbarAutoHide(){
      const w = state.activeWinId ? state.windows.get(state.activeWinId) : null;
      const shouldHide = !!(w && !w.minimized && w.maximized);
      document.body.classList.toggle('tb-autohide', shouldHide);
      if (!shouldHide) {
        document.body.classList.remove('tb-reveal');
        clearTimeout(tbHideTimer);
        tbHideTimer = null;
      }
    }
    function revealTaskbar(){
      if (!document.body.classList.contains('tb-autohide')) return;
      document.body.classList.add('tb-reveal');
      clearTimeout(tbHideTimer);
      tbHideTimer = setTimeout(() => {
        document.body.classList.remove('tb-reveal');
      }, 1200);
    }

    // ---------- Taskbar ----------
    function updateTaskbar(){
      const wrap = $('#taskApps');
      wrap.innerHTML = '';
      const wins = state.order.map(id => state.windows.get(id)).filter(Boolean);
      for (const w of wins) {
        const isActive = (w.id === state.activeWinId && !w.minimized);
        const isVisible = !w.minimized;
        const btn = h('button', {
          // Underline only when window is not minimized; active window is accented
          class: `taskbtn ${isActive ? 'active' : ''} ${isVisible ? 'running' : ''}`.trim(),
          title: w.title
        }, [
          h('span', { class: 'w-5 h-5', html: registry[w.appId]?.iconHtml || w.iconHtml })
        ]);
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (w.minimized) restoreWindow(w.id);
          else if (state.activeWinId === w.id) minimizeWindow(w.id);
          else focusWindow(w.id);
        });
        btn.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          e.stopPropagation();
          showTaskContextMenu(e.clientX, e.clientY, w.id);
        });
        wrap.appendChild(btn);
      }

      $('#icoTrayNet').innerHTML = state.toggles.wifi ? Icons.wifi('w-5 h-5') : Icons.wifiOff('w-5 h-5');
      $('#icoTrayVol').innerHTML = (state.volume === 0) ? Icons.volumeMute('w-5 h-5') : Icons.volume('w-5 h-5');
      $('#icoTrayBat').innerHTML = Icons.battery('w-5 h-5');

      const unseen = state.notifications.some(n => !n.seen);
      $('#notifDot').classList.toggle('hidden', !unseen);

      updateTaskbarAutoHide();
    }

    // Task context menu
    let taskCtx = null;

    // Explorer item context menu
    let explorerCtx = null;
    function hideExplorerContextMenu(){
      if (explorerCtx) explorerCtx.remove();
      explorerCtx = null;
    }

    function fsRenameFileEverywhere(fileId, newName){
      if (fs.files[fileId]) {
        fs.files[fileId].name = newName;
        fs.files[fileId].updatedAt = Date.now();
      }
      // Update references in arrays (desktop, documents, downloads, ...)
      for (const [k, v] of Object.entries(fs)) {
        if (!Array.isArray(v)) continue;
        for (const it of v) {
          if (it && it.type === 'file' && it.fileId === fileId) it.name = newName;
        }
      }
    }

    function fsDeleteFileEverywhere(fileId){
      delete fs.files[fileId];
      for (const [k, v] of Object.entries(fs)) {
        if (!Array.isArray(v)) continue;
        fs[k] = v.filter(it => !(it && it.type === 'file' && it.fileId === fileId));
      }
    }

    function showExplorerItemMenu(x, y, it, winId, path){
      hideExplorerContextMenu();
      explorerCtx = h('div', { class:'absolute z-[6000] w-64 win-surface p-2 flyout', style:`left:${x}px; top:${y}px;` });

      const openBtn = h('button', { class:'w-full text-left menu-item' }, [
        h('div', { class:'w-5 h-5', html: iconForItem(it) }),
        h('div', {}, 'Открыть')
      ]);
      openBtn.addEventListener('click', () => {
        hideExplorerContextMenu();
        // emulate Explorer double-click action
        const win = state.windows.get(winId);
        if (!win) return;
        // Desktop folder items
        if (it.__go) { win.opts.path = it.__go; refreshWindowContent(winId); return; }
        if (it.type === 'app') {
          if (!isInstalled(it.appId) && it.appId !== 'store') {
            openApp('store', { focusAppId: it.appId, searchQuery: it.appId });
            return;
          }
          openApp(it.appId);
          return;
        }
        if (it.type === 'file') { openFileById(it.fileId); return; }
        if (it.type === 'folder') {
          if (path === 'programFiles' && (it._pfFolder || it.folderId === 'windowsApps')) {
            addNotification({ title:'Program Files', body:'Это демонстрационная папка.', iconHtml: Icons.folder('w-6 h-6'), source:'Проводник' });
            return;
          }
          addNotification({ title:'Проводник', body:`Открытие папки «${it.name}» (демо)`, iconHtml: Icons.folder('w-6 h-6'), source:'Проводник' });
          return;
        }
      });

      explorerCtx.appendChild(openBtn);

      // Open in VS Code (only for files and if installed)
      if (it.type === 'file' && isInstalled('vscode')) {
        const vsBtn = h('button', { class:'w-full text-left menu-item' }, [
          h('div', { class:'w-5 h-5', html: registry.vscode.iconHtml }),
          h('div', {}, 'Открыть в VS Code')
        ]);
        vsBtn.addEventListener('click', () => {
          hideExplorerContextMenu();
          openApp('vscode', { openFileId: it.fileId });
        });
        explorerCtx.appendChild(vsBtn);
      }

      const renameBtn = h('button', { class:'w-full text-left menu-item' }, [
        h('div', { class:'w-5 h-5', html: Icons.dots('w-5 h-5') }),
        h('div', {}, 'Переименовать')
      ]);
      renameBtn.addEventListener('click', () => {
        const name = prompt('Новое имя:', it.name);
        if (!name) return;
        if (it.type === 'file' && it.fileId) {
          fsRenameFileEverywhere(it.fileId, name);
        } else {
          it.name = name;
        }
        fsSave(fs);
        hideExplorerContextMenu();
        refreshWindowContent(winId);
        renderDesktopIcons();
      });

      const delBtn = h('button', { class:'w-full text-left menu-item' }, [
        h('div', { class:'w-5 h-5', html: Icons.close('w-5 h-5') }),
        h('div', {}, 'Удалить')
      ]);
      delBtn.addEventListener('click', () => {
        if (!confirm(`Удалить «${it.name}»?`)) return;
        if (it.type === 'file' && it.fileId) {
          fsDeleteFileEverywhere(it.fileId);
        } else {
          // remove from current location
          if (path === 'desktop') fs.desktop = fs.desktop.filter(x => x !== it);
          else if (Array.isArray(fs[path])) fs[path] = fs[path].filter(x => x !== it);
        }
        fsSave(fs);
        hideExplorerContextMenu();
        refreshWindowContent(winId);
        renderDesktopIcons();
      });

      explorerCtx.append(renameBtn, h('div', { class:'thin-sep my-1' }), delBtn);

      $('#desktop').appendChild(explorerCtx);
      requestAnimationFrame(() => {
        const r = explorerCtx.getBoundingClientRect();
        const nx = clamp(r.left, 8, window.innerWidth - r.width - 8);
        const ny = clamp(r.top, 8, window.innerHeight - r.height - 8);
        explorerCtx.style.left = nx + 'px';
        explorerCtx.style.top = ny + 'px';
      });
    }

    function showTaskContextMenu(x, y, winId){
      hideTaskContextMenu();
      const win = state.windows.get(winId);
      if (!win) return;
      taskCtx = h('div', { class: 'absolute z-[5000] w-56 win-surface p-2 flyout', style: `left:${x}px; top:${y}px;` }, [
        h('div', { class: 'text-xs px-2 py-2 text-white/60' }, win.title),
        h('button', { class: 'w-full text-left menu-item', onclick: () => { restoreWindow(winId); hideTaskContextMenu(); } }, [
          h('div', { class: 'w-5 h-5', html: registry[win.appId]?.iconHtml || win.iconHtml }),
          h('div', {}, 'Открыть')
        ]),
        h('button', { class: 'w-full text-left menu-item', onclick: () => { minimizeWindow(winId); hideTaskContextMenu(); } }, [
          h('div', { class: 'w-5 h-5', html: Icons.minimize('w-5 h-5') }),
          h('div', {}, 'Свернуть')
        ]),
        h('button', { class: 'w-full text-left menu-item', onclick: () => { maximizeWindow(winId, !state.windows.get(winId)?.maximized); hideTaskContextMenu(); } }, [
          h('div', { class: 'w-5 h-5', html: Icons.maximize('w-5 h-5') }),
          h('div', {}, 'Развернуть/восстановить')
        ]),
        h('div', { class: 'thin-sep my-1' }),
        h('button', { class: 'w-full text-left menu-item', onclick: () => { closeWindow(winId); hideTaskContextMenu(); } }, [
          h('div', { class: 'w-5 h-5', html: Icons.close('w-5 h-5') }),
          h('div', {}, 'Закрыть')
        ])
      ]);
      $('#desktop').appendChild(taskCtx);
      requestAnimationFrame(() => {
        const r = taskCtx.getBoundingClientRect();
        const nx = clamp(r.left, 8, window.innerWidth - r.width - 8);
        const ny = clamp(r.top, 8, window.innerHeight - r.height - 8);
        taskCtx.style.left = nx + 'px';
        taskCtx.style.top = ny + 'px';
      });
    }
    function hideTaskContextMenu(){
      if (taskCtx) taskCtx.remove();
      taskCtx = null;
    }

    // ---------- Sounds (tiny system SFX) ----------
    const SFX = (() => {
      let ctx = null;
      function ensure(){
        if (!ctx) {
          const AC = window.AudioContext || window.webkitAudioContext;
          if (!AC) return null;
          ctx = new AC();
        }
        return ctx;
      }
      function beep({freq=520, dur=0.06, type='sine', gain=0.035}={}){
        if (!state.soundsEnabled) return;
        const c = ensure();
        if (!c) return;
        try {
          // Some browsers require user gesture; resume if suspended
          if (c.state === 'suspended') c.resume().catch(()=>{});
          const o = c.createOscillator();
          const g = c.createGain();
          o.type = type;
          o.frequency.value = freq;
          g.gain.value = 0;
          o.connect(g);
          g.connect(c.destination);
          const t = c.currentTime;
          g.gain.setValueAtTime(0, t);
          g.gain.linearRampToValueAtTime(gain, t + 0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
          o.start(t);
          o.stop(t + dur + 0.02);
        } catch {}
      }
      return {
        click(){ beep({freq: 640, dur: 0.03, gain:0.03, type:'triangle'}); },
        open(){ beep({freq: 740, dur: 0.05, gain:0.03, type:'sine'}); },
        close(){ beep({freq: 320, dur: 0.05, gain:0.03, type:'sine'}); },
        notify(){ beep({freq: 880, dur: 0.06, gain:0.035, type:'triangle'}); },
        // Soft clock "tick" (used in Clock app)
        tick(){ beep({freq: 1200, dur: 0.012, gain:0.012, type:'square'}); },
        error(){ beep({freq: 220, dur: 0.08, gain:0.05, type:'sawtooth'}); }
      };
    })();

    // ---------- Notifications ----------
    function addNotification({title, body, iconHtml, source='Система'}){
      const n = { id: uid(), title, body, source, iconHtml, ts: Date.now(), seen: false };
      state.notifications.unshift(n);
      renderNotifCenter();
      updateTaskbar();
      // by default: no toasts
      if (state.showToasts) showToast(n);
      // subtle SFX
      SFX.notify();
    }

    function showToast(n){
      const wrap = $('#toasts');
      const el = h('div', { class: 'toast win-surface p-3 w-[340px] max-w-[92vw]' }, [
        h('div', { class: 'flex items-start gap-3' }, [
          h('div', { class: 'w-8 h-8 flex items-center justify-center', html: n.iconHtml || Icons.bell('w-6 h-6') }),
          h('div', { class: 'min-w-0 flex-1' }, [
            h('div', { class: 'text-sm font-semibold' }, n.title),
            h('div', { class: 'text-xs text-white/70 mt-0.5 break-words' }, n.body)
          ]),
          h('button', { class: 'px-2 py-1 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 text-xs', onclick: () => el.remove() }, '×')
        ])
      ]);
      wrap.appendChild(el);
      setTimeout(() => { el.remove(); }, 5200);
    }

    function renderNotifCenter(){
      const meta = $('#notifMeta');
      const list = $('#notifList');
      const count = state.notifications.length;
      const unseen = state.notifications.filter(n => !n.seen).length;
      meta.textContent = count ? `${count} шт. • непрочитано: ${unseen}` : 'Нет уведомлений';

      list.innerHTML = '';
      if (!count) {
        list.appendChild(h('div', { class: 'p-6 text-center text-white/60' }, 'Здесь пока пусто'));
        return;
      }
      for (const n of state.notifications) {
        const card = h('button', { class: `w-full text-left p-3 rounded-2xl border border-white/10 ${n.seen ? 'bg-white/5' : 'bg-white/8'} hover:bg-white/10` }, [
          h('div', { class: 'flex gap-3 items-start' }, [
            h('div', { class: 'w-8 h-8 flex items-center justify-center', html: n.iconHtml || Icons.bell('w-6 h-6') }),
            h('div', { class: 'min-w-0 flex-1' }, [
              h('div', { class: 'flex items-center justify-between gap-2' }, [
                h('div', { class: 'text-sm font-semibold truncate' }, n.title),
                h('div', { class: 'text-[11px] text-white/60 whitespace-nowrap' }, fmtTime(n.ts))
              ]),
              h('div', { class: 'text-xs text-white/70 mt-0.5 break-words' }, n.body),
              h('div', { class: 'text-[11px] text-white/50 mt-1' }, n.source)
            ])
          ])
        ]);
        card.addEventListener('click', () => {
          n.seen = true;
          renderNotifCenter();
          updateTaskbar();
        });
        list.appendChild(card);
      }
    }

    function fmtTime(ts){
      const d = new Date(ts);
      return `${fmt2(d.getHours())}:${fmt2(d.getMinutes())}`;
    }

    // ---------- Popovers / menus ----------
    function hideAllPopovers(){
      $('#startMenu').classList.add('hidden');
      $('#searchFlyout').classList.add('hidden');
      $('#quickSettings').classList.add('hidden');
      $('#notifCenter').classList.add('hidden');
      $('#calendarFlyout').classList.add('hidden');
      $('#powerMenu').classList.add('hidden');
      $('#ctxMenu').classList.add('hidden');
      $('#widgetsFlyout').classList.add('hidden');
      $('#runDialog').classList.add('hidden');
      $('#iconMenu').classList.add('hidden');
      $('#devMenu').classList.add('hidden');
      hideTaskContextMenu();
    }

    function toggleStart(){
      const m = $('#startMenu');
      const showing = !m.classList.contains('hidden');
      hideAllPopovers();
      if (!showing) {
        m.classList.remove('hidden');
        $('#startSearch').value = '';
        renderStart();
        $('#startSearch').focus();
      }
    }

    function toggleSearchFlyout(){
      const f = $('#searchFlyout');
      const showing = !f.classList.contains('hidden');
      hideAllPopovers();
      if (!showing) {
        f.classList.remove('hidden');
        $('#globalSearch').value = '';
        renderGlobalSearch('');
        $('#globalSearch').focus();
      }
    }

    function toggleQuickSettings(){
      const q = $('#quickSettings');
      const showing = !q.classList.contains('hidden');
      hideAllPopovers();
      if (!showing) {
        q.classList.remove('hidden');
        $('#volSlider').value = String(state.volume);
        renderQuickSettings();
      }
    }

    function toggleNotifCenter(){
      const n = $('#notifCenter');
      const showing = !n.classList.contains('hidden');
      hideAllPopovers();
      if (!showing) {
        n.classList.remove('hidden');
        renderNotifCenter();
      }
    }

    function toggleWidgets(){
      const w = $('#widgetsFlyout');
      const showing = !w.classList.contains('hidden');
      hideAllPopovers();
      if (!showing) {
        w.classList.remove('hidden');
        renderWidgets();
      }
    }

    // ---------- Calendar flyout ----------
    const calState = { y: new Date().getFullYear(), m: new Date().getMonth(), selected: null };

    function toggleCalendar(){
      const c = $('#calendarFlyout');
      const showing = !c.classList.contains('hidden');
      hideAllPopovers();
      if (!showing) {
        c.classList.remove('hidden');
        renderCalendar();
      }
    }

    function renderCalendar(){
      const now = new Date();
      $('#calSubtitle').textContent = now.toLocaleDateString('ru-RU', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

      const title = new Date(calState.y, calState.m, 1).toLocaleDateString('ru-RU', { month:'long', year:'numeric' });
      $('#calTitle').textContent = title;

      // Ensure navigation always works (even if some handlers were lost)
      const prevBtn = $('#btnCalPrev');
      const nextBtn = $('#btnCalNext');
      const todayBtn = $('#btnCalToday');
      if (prevBtn) prevBtn.onclick = (e) => {
        e?.stopPropagation?.();
        calState.m -= 1;
        if (calState.m < 0) { calState.m = 11; calState.y -= 1; }
        renderCalendar();
      };
      if (nextBtn) nextBtn.onclick = (e) => {
        e?.stopPropagation?.();
        calState.m += 1;
        if (calState.m > 11) { calState.m = 0; calState.y += 1; }
        renderCalendar();
      };
      if (todayBtn) todayBtn.onclick = (e) => {
        e?.stopPropagation?.();
        const d = new Date();
        calState.y = d.getFullYear();
        calState.m = d.getMonth();
        calState.selected = `${calState.y}-${calState.m}-${d.getDate()}`;
        renderCalendar();
      };

      // compute grid Monday-first
      const first = new Date(calState.y, calState.m, 1);
      const startDow = (first.getDay() + 6) % 7; // Monday=0
      const daysInMonth = new Date(calState.y, calState.m+1, 0).getDate();
      const prevDays = new Date(calState.y, calState.m, 0).getDate();

      const grid = $('#calGrid');
      grid.innerHTML = '';
      const total = 42;
      for (let i=0;i<total;i++){
        const dayNum = i - startDow + 1;
        let y = calState.y, m = calState.m, d = dayNum;
        let outside = false;
        if (dayNum <= 0) { outside = true; d = prevDays + dayNum; m = calState.m-1; if (m<0){m=11;y--;} }
        if (dayNum > daysInMonth) { outside = true; d = dayNum - daysInMonth; m = calState.m+1; if (m>11){m=0;y++;} }

        const key = `${y}-${m}-${d}`;
        const isToday = (y===now.getFullYear() && m===now.getMonth() && d===now.getDate());
        const isSel = calState.selected === key;

        const cell = h('button', { class:'h-9 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm transition' }, String(d));
        cell.style.opacity = outside ? '.45' : '1';
        if (isToday) {
          cell.style.borderColor = `rgba(${(ui.accent||[99,102,241]).join(',')},.35)`;
          cell.style.background = `rgba(${(ui.accent||[99,102,241]).join(',')},.16)`;
        }
        if (isSel) {
          cell.style.outline = `2px solid rgba(${(ui.accent||[99,102,241]).join(',')},.55)`;
        }
        cell.addEventListener('click', () => {
          calState.selected = key;
          renderCalendar();
        });
        grid.appendChild(cell);
      }
    }

    // ---------- Start menu ----------
    function renderStart(){
      const pinned = $('#pinnedGrid');
      pinned.innerHTML = '';
      const pinnedApps = ['edge','explorer','notepad','calculator','store','settings'];
      for (const id of pinnedApps) {
        const app = registry[id];
        if (!app) continue;
        const tile = h('button', { class: 'p-3 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 flex flex-col items-center gap-2', title: app.name }, [
          h('div', { class: 'w-8 h-8', html: app.iconHtml }),
          h('div', { class: 'text-[12px] text-white/80 text-center leading-4' }, app.name)
        ]);
        tile.addEventListener('click', () => { openApp(id); hideAllPopovers(); });
        pinned.appendChild(tile);
      }

      renderRecommended();
      renderStartSearch('');
    }

    function addRecent(item){
      const key = item.kind + ':' + (item.appId || item.fileId || item.name);
      state.recent = state.recent.filter(r => (r.kind + ':' + (r.appId || r.fileId || r.name)) !== key);
      state.recent.unshift(item);
      state.recent = state.recent.slice(0, 12);
      persistUI();
      renderRecommended();
    }

    function renderRecommended(){
      const rec = $('#recommended');
      rec.innerHTML = '';
      const items = state.recent.slice(0, 6);
      if (!items.length) {
        rec.appendChild(h('div', { class: 'p-3 rounded-2xl border border-white/10 bg-white/5 text-white/60 text-sm' }, 'Пока нет недавних элементов'));
        return;
      }
      for (const it of items) {
        const icon = it.kind === 'app' ? registry[it.appId]?.iconHtml : Icons.note('w-6 h-6');
        const row = h('button', { class: 'w-full text-left menu-item' }, [
          h('div', { class: 'w-8 h-8 flex items-center justify-center', html: icon }),
          h('div', { class: 'min-w-0 flex-1' }, [
            h('div', { class: 'text-sm font-semibold truncate' }, it.name),
            h('div', { class: 'text-xs text-white/60' }, new Date(it.ts).toLocaleString('ru-RU'))
          ])
        ]);
        row.addEventListener('click', () => {
          if (it.kind === 'app') openApp(it.appId);
          if (it.kind === 'file') openNotepadWithFile(it.fileId);
          hideAllPopovers();
        });
        rec.appendChild(row);
      }
    }

    function renderStartSearch(q){
      const query = q.trim().toLowerCase();
      const apps = Object.values(registry).filter(a => a.name.toLowerCase().includes(query) || a.id.includes(query));
      let box = $('#startSearchResults');
      if (!box) {
        box = h('div', { id: 'startSearchResults', class: 'mt-3 hidden' });
        $('#startMenu .p-3').appendChild(box);
      }

      if (!query) {
        box.classList.add('hidden');
        return;
      }

      box.classList.remove('hidden');
      box.innerHTML = '';
      box.appendChild(h('div', { class: 'text-sm font-semibold mb-2' }, 'Результаты'));
      if (!apps.length) {
        box.appendChild(h('div', { class: 'p-3 rounded-2xl border border-white/10 bg-white/5 text-white/60 text-sm' }, 'Ничего не найдено'));
        return;
      }
      for (const a of apps.slice(0, 7)) {
        const row = h('button', { class: 'w-full text-left menu-item' }, [
          h('div', { class: 'w-8 h-8 flex items-center justify-center', html: a.iconHtml }),
          h('div', { class: 'min-w-0 flex-1' }, [
            h('div', { class: 'text-sm font-semibold truncate' }, a.name),
            h('div', { class: 'text-xs text-white/60' }, 'Приложение')
          ])
        ]);
        row.addEventListener('click', () => { openApp(a.id); hideAllPopovers(); });
        box.appendChild(row);
      }
    }

    // Global search
    function renderGlobalSearch(q){
      const query = q.trim().toLowerCase();
      const appsWrap = $('#searchApps');
      const filesWrap = $('#searchFiles');
      appsWrap.innerHTML = '';
      filesWrap.innerHTML = '';

      const apps = Object.values(registry).filter(a => a.name.toLowerCase().includes(query) || a.id.includes(query));
      const files = Object.values(fs.files).filter(f => (f.name||'').toLowerCase().includes(query) || (f.content||'').toLowerCase().includes(query));

      const renderRow = (iconHtml, title, subtitle, onClick) => {
        const row = h('button', { class: 'w-full text-left menu-item' }, [
          h('div', { class: 'w-8 h-8 flex items-center justify-center', html: iconHtml }),
          h('div', { class: 'min-w-0 flex-1' }, [
            h('div', { class: 'text-sm font-semibold truncate' }, title),
            h('div', { class: 'text-xs text-white/60 truncate' }, subtitle)
          ])
        ]);
        row.addEventListener('click', () => { onClick(); hideAllPopovers(); });
        return row;
      };

      if (!apps.length && query) appsWrap.appendChild(h('div', { class: 'p-3 rounded-2xl border border-white/10 bg-white/5 text-white/60 text-sm' }, 'Нет совпадений'));
      if (!files.length && query) filesWrap.appendChild(h('div', { class: 'p-3 rounded-2xl border border-white/10 bg-white/5 text-white/60 text-sm' }, 'Нет совпадений'));

      for (const a of apps.slice(0, 9)) {
        appsWrap.appendChild(renderRow(a.iconHtml, a.name, 'Приложение', () => openApp(a.id)));
      }
      for (const f of files.slice(0, 9)) {
        filesWrap.appendChild(renderRow(Icons.note('w-6 h-6'), f.name, 'Файл', () => openNotepadWithFile(f.id)));
      }

      if (!query) {
        appsWrap.appendChild(h('div', { class: 'p-3 rounded-2xl border border-white/10 bg-white/5 text-white/60 text-sm' }, 'Начните ввод для поиска приложений'));
        filesWrap.appendChild(h('div', { class: 'p-3 rounded-2xl border border-white/10 bg-white/5 text-white/60 text-sm' }, 'Начните ввод для поиска файлов'));
      }
    }

    // ---------- Desktop context menus ----------
    function showCtxMenu(x, y){
      hideAllPopovers();
      const m = $('#ctxMenu');
      m.classList.remove('hidden');
      m.style.left = x + 'px';
      m.style.top = y + 'px';
      requestAnimationFrame(() => {
        const r = m.getBoundingClientRect();
        m.style.left = clamp(r.left, 8, window.innerWidth - r.width - 8) + 'px';
        m.style.top = clamp(r.top, 8, window.innerHeight - r.height - 8) + 'px';
      });
    }

    function showIconMenu(x, y, item){
      const m = $('#iconMenu');
      m.innerHTML = '';
      m.classList.remove('hidden');
      m.style.left = x + 'px';
      m.style.top = y + 'px';

      // IMPORTANT: first item is "Open"
      const openBtn = h('button', { class:'w-full text-left menu-item' }, [
        h('div', { class:'w-5 h-5', html: iconForItem(item) }),
        h('div', {}, 'Открыть')
      ]);
      openBtn.addEventListener('click', () => { openDesktopItem(item); hideAllPopovers(); });

      const renameBtn = h('button', { class:'w-full text-left menu-item' }, [
        h('div', { class:'w-5 h-5', html: Icons.dots('w-5 h-5') }),
        h('div', {}, 'Переименовать')
      ]);
      renameBtn.addEventListener('click', () => {
        const name = prompt('Новое имя:', item.name);
        if (!name) return;
        item.name = name;
        if (item.type === 'file' && item.fileId && fs.files[item.fileId]) {
          fs.files[item.fileId].name = name;
          fs.files[item.fileId].updatedAt = Date.now();
        }
        fsSave(fs);
        renderDesktopIcons();
        hideAllPopovers();
        addNotification({ title:'Рабочий стол', body:`Переименовано: ${name}`, iconHtml: Icons.win('w-6 h-6'), source:'Система' });
      });

      const delBtn = h('button', { class:'w-full text-left menu-item' }, [
        h('div', { class:'w-5 h-5', html: Icons.close('w-5 h-5') }),
        h('div', {}, 'Удалить')
      ]);
      delBtn.addEventListener('click', () => {
        if (!confirm(`Удалить «${item.name}»?`)) return;
        fs.desktop = fs.desktop.filter(x => x !== item);
        if (item.type === 'file' && item.fileId) delete fs.files[item.fileId];
        fsSave(fs);
        renderDesktopIcons();
        hideAllPopovers();
        addNotification({ title:'Рабочий стол', body:`Удалено: ${item.name}`, iconHtml: Icons.win('w-6 h-6'), source:'Система' });
      });

      m.append(openBtn, renameBtn, h('div', { class:'thin-sep my-1' }), delBtn);

      requestAnimationFrame(() => {
        const r = m.getBoundingClientRect();
        m.style.left = clamp(r.left, 8, window.innerWidth - r.width - 8) + 'px';
        m.style.top = clamp(r.top, 8, window.innerHeight - r.height - 8) + 'px';
      });
    }

    function doRefresh(){
      const root = $('#root');
      root.animate([
        { filter: 'none' },
        { filter: 'blur(1.2px)' },
        { filter: 'none' }
      ], { duration: 260, easing: 'ease-out' });
      addNotification({
        title: 'Рабочий стол',
        body: 'Обновление завершено.',
        iconHtml: Icons.refresh('w-6 h-6'),
        source: 'Система'
      });
    }

    function createDesktopFolder(nameOverride=null){
      const name = nameOverride ?? prompt('Имя новой папки:', 'Новая папка');
      if (!name) return;
      fs.desktop.unshift({ did: uid(), type: 'folder', folderId: uid(), name, pos: findFreeDesktopSlot() });
      fsSave(fs);
      renderDesktopIcons();
      addNotification({ title: 'Создание', body: `Папка «${name}» создана на рабочем столе.`, iconHtml: Icons.folder('w-6 h-6'), source: 'Проводник' });
    }

    function createDesktopNote(nameOverride=null){
      const name = nameOverride ?? prompt('Имя файла:', 'Новый документ');
      if (!name) return;
      const id = uid();
      const filename = name.endsWith('.txt') ? name : (name + '.txt');
      fs.files[id] = { id, name: filename, ext: 'txt', updatedAt: Date.now(), content: '' };
      fs.desktop.unshift({ did: uid(), type: 'file', fileId: id, name: filename, ext: 'txt', pos: findFreeDesktopSlot() });
      fsSave(fs);
      renderDesktopIcons();
      addRecent({ kind: 'file', fileId: id, name: filename, ts: Date.now() });
      openNotepadWithFile(id);
    }

    // ---------- Quick settings ----------
    function renderQuickSettings(){
      for (const key of ['wifi','bt','night']) {
        const sub = document.querySelector(`[data-sub="${key}"]`);
        if (sub) sub.textContent = state.toggles[key] ? 'Вкл' : 'Выкл';
      }
      $$('.qs-toggle').forEach(btn => {
        const k = btn.getAttribute('data-toggle');
        const on = !!state.toggles[k];
        btn.style.background = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
        btn.style.borderColor = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
      });
      updateTaskbar();
    }

    function setToggle(key, val){
      const before = !!state.toggles[key];
      state.toggles[key] = !!val;
      applyUI();
      persistUI();
      renderQuickSettings();
      updateTaskbar();

      if (before !== !!val) {
        const label = ({wifi:'Wi‑Fi', bt:'Bluetooth', night:'Ночной свет'})[key] || key;
        addNotification({
          title: 'Быстрые настройки',
          body: `${label}: ${val ? 'включено' : 'выключено'}.`,
          iconHtml: key === 'wifi' ? (val ? Icons.wifi('w-6 h-6') : Icons.wifiOff('w-6 h-6')) : Icons.settings('w-6 h-6'),
          source: 'Система'
        });
      }
    }

    // ---------- Clock ----------
    function tickClock(){
      const d = new Date();
      $('#clock').textContent = `${fmt2(d.getHours())}:${fmt2(d.getMinutes())}`;
      $('#date').textContent = d.toLocaleDateString('ru-RU');
    }

    // ---------- Apps ----------

    // Clock app
    function buildClockApp(win){
      const wrap = h('div', { class:'p-3' });
      const header = h('div', { class:'flex items-center gap-2' }, [
        h('div', { class:'w-6 h-6', html: registry.clock.iconHtml }),
        h('div', { class:'text-lg font-semibold' }, 'Часы'),
        h('div', { class:'ml-auto text-xs text-white/60' }, 'Демо')
      ]);

      const nav = h('div', { class:'mt-3 flex items-center gap-2' });
      const main = h('div', { class:'mt-3 p-4 rounded-2xl border border-white/10 bg-white/5 min-h-[420px]' });

      const view = { tab: win.opts?.tab || 'time' };
      const tabs = [
        { id:'time', name:'Время' },
        { id:'stopwatch', name:'Секундомер' },
        { id:'timer', name:'Таймер' }
      ];

      function tabBtn(t){
        const b = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, t.name);
        const paint = () => {
          const on = view.tab === t.id;
          b.style.background = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
          b.style.borderColor = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
        };
        b.addEventListener('click', () => {
          cleanupTabTimers();
          view.tab = t.id;
          win.opts.tab = t.id;
          render();
        });
        b._paint = paint;
        paint();
        return b;
      }

      const tabButtons = tabs.map(tabBtn);
      nav.append(...tabButtons);

      // Stopwatch state (per-window)
      win.opts._sw = win.opts._sw || { running:false, startedAt: null, elapsedMs: 0, tick: null, laps: [] };
      // Timer state
      win.opts._tm = win.opts._tm || { running:false, endsAt: null, remainingMs: 5*60*1000, tick:null };

      // Cleanup timers when switching tabs (prevents background tick sounds / leaks)
      function cleanupTabTimers(){
        if (win.opts._clockTimeInt) {
          try { clearInterval(win.opts._clockTimeInt); } catch {}
          win.opts._clockTimeInt = null;
        }
        if (win.opts._sw?.tick) {
          try { clearInterval(win.opts._sw.tick); } catch {}
          win.opts._sw.tick = null;
        }
        if (win.opts._tm?.tick) {
          try { clearInterval(win.opts._tm.tick); } catch {}
          win.opts._tm.tick = null;
        }
      }

      function fmtMs(ms){
        const t = Math.max(0, Math.floor(ms));
        const m = Math.floor(t/60000);
        const s = Math.floor((t%60000)/1000);
        const cs = Math.floor((t%1000)/10);
        return `${fmt2(m)}:${fmt2(s)}.${fmt2(cs)}`;
      }

      function renderTime(){
        const box = h('div', { class:'grid md:grid-cols-2 gap-4 items-start' });
        const tickMode = { on: !!(win.opts._tickOn ?? false) };
        const now = new Date();
        const big = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Текущее время'),
          h('div', { class:'mt-2 text-4xl font-semibold tracking-tight', id:`clkBig_${win.id}` }, now.toLocaleTimeString('ru-RU')),
          h('div', { class:'mt-1 text-sm text-white/70' }, now.toLocaleDateString('ru-RU', { weekday:'long', year:'numeric', month:'long', day:'numeric' }))
        ]);

        const analog = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5 flex items-center justify-center' });
        const dial = h('div', { class:'relative w-52 h-52 rounded-full border border-white/15 bg-white/5' });
        // marks
        for (let i=0;i<12;i++){
          const m = h('div', { class:'absolute left-1/2 top-1/2 w-1 h-3 rounded-full bg-white/35', style:`transform: translate(-50%,-50%) rotate(${i*30}deg) translateY(-92px);` });
          dial.appendChild(m);
        }

        // Hands: positioned at center, rotate around bottom (like real clock hands)
        const handH = h('div', { class:'absolute left-1/2 top-1/2 w-1.5 h-14 rounded-full bg-white/80', id:`hH_${win.id}` });
        const handM = h('div', { class:'absolute left-1/2 top-1/2 w-1 h-18 rounded-full bg-white/70', id:`hM_${win.id}` });
        const handS = h('div', { class:'absolute left-1/2 top-1/2 w-[2px] h-22 rounded-full bg-[rgb(var(--accent))]', id:`hS_${win.id}` });

        // Explicit inline styles for correct transform origin and placement
        const setHandBase = (el, lenPx) => {
          el.style.height = lenPx + 'px';
          el.style.transformOrigin = '50% 100%';
          el.style.transform = 'translate(-50%, -100%) rotate(0deg)';
        };
        setHandBase(handH, 64);
        setHandBase(handM, 82);
        setHandBase(handS, 94);

        const pin = h('div', { class:'absolute left-1/2 top-1/2 w-3 h-3 -translate-x-1/2 -translate-y-1/2 rounded-full bg-white/80 border border-white/20' });
        dial.append(handH, handM, handS, pin);
        analog.appendChild(dial);

        const note = h('div', { class:'md:col-span-2 text-xs text-white/60' }, 'Часы обновляются каждую секунду.');

        // Tick sound toggle
        const tickCard = h('div', { class:'md:col-span-2 p-3 rounded-2xl border border-white/10 bg-white/5 flex items-center justify-between gap-3' }, [
          h('div', {}, [
            h('div', { class:'text-sm font-semibold' }, 'Звук тиканья'),
            h('div', { class:'text-xs text-white/60 mt-0.5' }, 'Работает только если включены системные звуки.')
          ]),
          (() => {
            const btn = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' });
            const paint = () => {
              btn.textContent = tickMode.on ? 'Включено' : 'Выключено';
              btn.style.background = tickMode.on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
              btn.style.borderColor = tickMode.on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
            };
            btn.addEventListener('click', () => {
              tickMode.on = !tickMode.on;
              win.opts._tickOn = tickMode.on;
              paint();
            });
            paint();
            return btn;
          })()
        ]);

        box.append(big, analog, tickCard, note);

        const tick = () => {
          if (!state.windows.has(win.id)) return;
          const d = new Date();

          // Tick sound once per second (aligned to second boundary)
          if (tickMode.on && state.soundsEnabled) {
            try { SFX.tick(); } catch {}
          }
          const el = document.getElementById(`clkBig_${win.id}`);
          if (el) el.textContent = d.toLocaleTimeString('ru-RU');
          const sec = d.getSeconds() + d.getMilliseconds()/1000;
          const min = d.getMinutes() + sec/60;
          const hr = (d.getHours()%12) + min/60;
          const hh = document.getElementById(`hH_${win.id}`);
          const hm = document.getElementById(`hM_${win.id}`);
          const hs = document.getElementById(`hS_${win.id}`);
          if (hh) hh.style.transform = `translate(-50%, -100%) rotate(${hr*30}deg)`;
          if (hm) hm.style.transform = `translate(-50%, -100%) rotate(${min*6}deg)`;
          if (hs) hs.style.transform = `translate(-50%, -100%) rotate(${sec*6}deg)`;
        };
        tick();
        cleanupTabTimers();
        const id = setInterval(tick, 1000);
        win.opts._clockTimeInt = id;
        registerOnClose(win.id, () => {
          try { clearInterval(id); } catch {}
          if (win.opts._clockTimeInt === id) win.opts._clockTimeInt = null;
        });
        return box;
      }

      function renderStopwatch(){
        const sw = win.opts._sw;
        const box = h('div', { class:'space-y-3' });
        const readout = h('div', { class:'text-4xl font-semibold tracking-tight', id:`swRead_${win.id}` }, fmtMs(sw.elapsedMs));

        const controls = h('div', { class:'flex gap-2 flex-wrap' });
        const btnStart = h('button', { class:'btn text-sm' }, sw.running ? 'Пауза' : 'Старт');
        const btnLap = h('button', { class:'btn text-sm' }, 'Круг');
        const btnReset = h('button', { class:'btn text-sm' }, 'Сброс');
        controls.append(btnStart, btnLap, btnReset);

        const laps = h('div', { class:'mt-2 p-3 rounded-2xl border border-white/10 bg-white/5 max-h-[260px] overflow-auto scrollbar' });

        const renderLaps = () => {
          laps.innerHTML = '';
          if (!sw.laps.length) {
            laps.appendChild(h('div', { class:'text-sm text-white/60' }, 'Кругов пока нет.'));
            return;
          }
          sw.laps.slice().reverse().forEach((ms, idx) => {
            laps.appendChild(h('div', { class:'flex items-center justify-between py-1 text-sm' }, [
              h('div', { class:'text-white/70' }, `Круг ${sw.laps.length - idx}`),
              h('div', { class:'font-semibold' }, fmtMs(ms))
            ]));
          });
        };

        const tick = () => {
          const el = document.getElementById(`swRead_${win.id}`);
          if (!el) return;
          let ms = sw.elapsedMs;
          if (sw.running && sw.startedAt) ms += (Date.now() - sw.startedAt);
          el.textContent = fmtMs(ms);
        };

        const ensureTicking = () => {
          if (sw.tick) clearInterval(sw.tick);
          sw.tick = setInterval(() => {
            if (!state.windows.has(win.id)) return;
            tick();
          }, 33);
        };
        ensureTicking();
        registerOnClose(win.id, () => sw.tick && clearInterval(sw.tick));

        btnStart.addEventListener('click', () => {
          if (!sw.running) {
            sw.running = true;
            sw.startedAt = Date.now();
          } else {
            sw.running = false;
            sw.elapsedMs += Date.now() - (sw.startedAt || Date.now());
            sw.startedAt = null;
          }
          btnStart.textContent = sw.running ? 'Пауза' : 'Старт';
          tick();
        });

        btnLap.addEventListener('click', () => {
          let ms = sw.elapsedMs;
          if (sw.running && sw.startedAt) ms += (Date.now() - sw.startedAt);
          sw.laps.push(ms);
          renderLaps();
        });

        btnReset.addEventListener('click', () => {
          sw.running = false;
          sw.startedAt = null;
          sw.elapsedMs = 0;
          sw.laps = [];
          btnStart.textContent = 'Старт';
          tick();
          renderLaps();
        });

        tick();
        renderLaps();
        box.append(h('div', { class:'text-sm font-semibold' }, 'Секундомер'), readout, controls, laps);
        return box;
      }

      function renderTimer(){
        const tm = win.opts._tm;
        const box = h('div', { class:'space-y-3' });
        const readout = h('div', { class:'text-4xl font-semibold tracking-tight', id:`tmRead_${win.id}` }, fmtMs(tm.remainingMs).slice(0,5));

        const inputs = h('div', { class:'flex items-center gap-2 flex-wrap' });
        const inMin = h('input', { type:'number', min:'0', max:'999', value:String(Math.floor(tm.remainingMs/60000)), class:'w-24 bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60' });
        const inSec = h('input', { type:'number', min:'0', max:'59', value:String(Math.floor((tm.remainingMs%60000)/1000)), class:'w-24 bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60' });
        inputs.append(h('div', { class:'text-sm text-white/70' }, 'Мин:'), inMin, h('div', { class:'text-sm text-white/70' }, 'Сек:'), inSec);

        const controls = h('div', { class:'flex gap-2 flex-wrap' });
        const btnStart = h('button', { class:'btn text-sm' }, tm.running ? 'Пауза' : 'Старт');
        const btnReset = h('button', { class:'btn text-sm' }, 'Сброс');
        controls.append(btnStart, btnReset);

        const tick = () => {
          if (!state.windows.has(win.id)) return;
          if (tm.running && tm.endsAt) {
            tm.remainingMs = Math.max(0, tm.endsAt - Date.now());
            if (tm.remainingMs === 0) {
              tm.running = false;
              tm.endsAt = null;
              btnStart.textContent = 'Старт';
              addNotification({ title:'Часы', body:'Таймер завершён.', iconHtml: registry.clock.iconHtml, source:'Часы' });
            }
          }
          const el = document.getElementById(`tmRead_${win.id}`);
          if (el) el.textContent = fmtMs(tm.remainingMs).slice(0,5);
        };

        const ensureTicking = () => {
          if (tm.tick) clearInterval(tm.tick);
          tm.tick = setInterval(tick, 200);
        };
        ensureTicking();
        registerOnClose(win.id, () => tm.tick && clearInterval(tm.tick));

        btnStart.addEventListener('click', () => {
          if (!tm.running) {
            // sync from inputs
            const mm = clamp(Number(inMin.value||0), 0, 999);
            const ss = clamp(Number(inSec.value||0), 0, 59);
            tm.remainingMs = (mm*60 + ss) * 1000;
            tm.running = true;
            tm.endsAt = Date.now() + tm.remainingMs;
          } else {
            tm.running = false;
            tm.endsAt = null;
          }
          btnStart.textContent = tm.running ? 'Пауза' : 'Старт';
          tick();
        });

        btnReset.addEventListener('click', () => {
          tm.running = false;
          tm.endsAt = null;
          const mm = clamp(Number(inMin.value||0), 0, 999);
          const ss = clamp(Number(inSec.value||0), 0, 59);
          tm.remainingMs = (mm*60 + ss) * 1000;
          btnStart.textContent = 'Старт';
          tick();
        });

        inMin.addEventListener('change', () => { if (!tm.running) btnReset.click(); });
        inSec.addEventListener('change', () => { if (!tm.running) btnReset.click(); });

        tick();
        box.append(h('div', { class:'text-sm font-semibold' }, 'Таймер'), readout, inputs, controls);
        return box;
      }

      function render(){
        tabButtons.forEach(b => b._paint && b._paint());
        main.innerHTML = '';
        if (view.tab === 'time') main.appendChild(renderTime());
        if (view.tab === 'stopwatch') main.appendChild(renderStopwatch());
        if (view.tab === 'timer') main.appendChild(renderTimer());
      }

      render();
      wrap.append(header, nav, main);
      return wrap;
    }

    function buildExplorer(win){
      const container = h('div', { class: 'p-3' });
      win.opts = win.opts || {};

      // Explorer locations (virtual)
      const locations = {
        thispc: { id:'thispc', name:'Этот компьютер', icon: Icons.win('w-5 h-5') },
        desktop: { id:'desktop', name:'Рабочий стол', icon: Icons.win('w-5 h-5') },
        documents: { id:'documents', name:'Документы', icon: Icons.note('w-5 h-5') },
        downloads: { id:'downloads', name:'Загрузки', icon: Icons.folder('w-5 h-5') },
        pictures: { id:'pictures', name:'Изображения', icon: Icons.folder('w-5 h-5') },
        music: { id:'music', name:'Музыка', icon: Icons.folder('w-5 h-5') },
        videos: { id:'videos', name:'Видео', icon: Icons.folder('w-5 h-5') },
        programFiles: { id:'programFiles', name:'Program Files', icon: Icons.folder('w-5 h-5') }
      };

      // init per-location arrays
      for (const key of ['documents','downloads','pictures','music','videos','programFiles']) {
        fs[key] = Array.isArray(fs[key]) ? fs[key] : [];
      }

      // navigation state
      win.opts.path = win.opts.path || 'thispc';
      win.opts._hist = win.opts._hist || { back: [], forward: [] };

      function goTo(path, pushHist=true){
        if (!locations[path]) path = 'thispc';
        if (pushHist && win.opts.path !== path) {
          win.opts._hist.back.push(win.opts.path);
          win.opts._hist.forward = [];
        }
        win.opts.path = path;
        render();
      }

      function goBack(){
        const hst = win.opts._hist;
        if (!hst.back.length) return;
        const prev = hst.back.pop();
        hst.forward.push(win.opts.path);
        win.opts.path = prev;
        render();
      }

      function goForward(){
        const hst = win.opts._hist;
        if (!hst.forward.length) return;
        const next = hst.forward.pop();
        hst.back.push(win.opts.path);
        win.opts.path = next;
        render();
      }

      const topbar = h('div', { class: 'flex items-center gap-2 flex-wrap' }, [
        h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm', title:'Назад', onclick: () => goBack() }, '‹'),
        h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm', title:'Вперёд', onclick: () => goForward() }, '›'),
        h('div', { class: 'flex items-center gap-2 flex-1 min-w-0' }, [
          h('div', { class: 'w-5 h-5', html: Icons.folder('w-5 h-5') }),
          h('div', { class: 'text-sm font-semibold' }, 'Проводник'),
          h('input', { id:`path_${win.id}`, class:'ml-2 flex-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none text-xs focus:ring-2 focus:ring-[rgb(var(--accent))]/60', value:'' })
        ]),
        h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm', onclick: () => explorerCreateFolder(win.id) }, 'Новая папка'),
        h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm', onclick: () => explorerCreateText(win.id) }, 'Новый файл')
      ]);

      const body = h('div', { class: 'mt-3 grid grid-cols-[240px_1fr] gap-3' });
      const sidebar = h('div', { class: 'p-2 rounded-2xl border border-white/10 bg-white/5' });
      const main = h('div', { class: 'p-2 rounded-2xl border border-white/10 bg-white/5 min-h-[360px]' });

      const sidebarGroups = [
        {
          title: 'Навигация',
          items: ['thispc','desktop','documents','downloads','pictures','music','videos','programFiles']
        }
      ];

      for (const g of sidebarGroups) {
        sidebar.appendChild(h('div', { class:'text-xs px-2 py-2 text-white/60' }, g.title));
        for (const id of g.items) {
          const p = locations[id];
          const b = h('button', { class: 'w-full text-left menu-item', 'data-place': p.id }, [
            h('div', { class: 'w-8 h-8 flex items-center justify-center', html: p.icon }),
            h('div', { class: 'text-sm font-semibold' }, p.name)
          ]);
          b.addEventListener('click', () => goTo(p.id));
          sidebar.appendChild(b);
        }
        sidebar.appendChild(h('div', { class:'thin-sep my-2' }));
      }

      function breadcrumbFor(path){
        if (path === 'thispc') return 'Этот компьютер';
        const p = locations[path];
        return `Этот компьютер > ${p ? p.name : path}`;
      }

      function itemsFor(path){
        if (path === 'thispc') {
          // This PC shows the folders as items
          return [
            { type:'folder', folderId:'desktop', name:'Рабочий стол', __go:'desktop' },
            { type:'folder', folderId:'documents', name:'Документы', __go:'documents' },
            { type:'folder', folderId:'downloads', name:'Загрузки', __go:'downloads' },
            { type:'folder', folderId:'pictures', name:'Изображения', __go:'pictures' },
            { type:'folder', folderId:'music', name:'Музыка', __go:'music' },
            { type:'folder', folderId:'videos', name:'Видео', __go:'videos' },
            { type:'folder', folderId:'programFiles', name:'Program Files', __go:'programFiles' }
          ];
        }
        if (path === 'desktop') return fs.desktop;

        // Program Files is special: shows installed apps as "program shortcuts"
        if (path === 'programFiles') {
          const items = [];
          const installedIds = Array.from(state.installedApps);
          // include built-in apps as well
          const builtins = ['explorer','edge','notepad','calculator','store','settings','clock','paint'];
          const all = Array.from(new Set([...builtins, ...installedIds]));
          all.sort((a,b) => (registry[a]?.name||a).localeCompare((registry[b]?.name||b),'ru'));
          for (const id of all) {
            const app = registry[id];
            if (!app) continue;
            items.push({ type:'app', appId:id, name: app.name, _pf:true });
          }

          // Optional: show "Установщик" placeholder
          items.unshift({ type:'folder', folderId:'windowsApps', name:'WindowsApps (демо)', _pfFolder:true });
          return items;
        }

        return fs[path] || [];
      }

      function openItem(it){
        // navigation folders inside Explorer
        if (it.__go) { goTo(it.__go); return; }

        if (it.type === 'app') {
          // Program Files: installed apps open, not installed goes to Store
          if (!isInstalled(it.appId) && it.appId !== 'store') {
            addNotification({ title:'Проводник', body:`«${registry[it.appId]?.name || it.appId}» не установлено. Открываем Store.`, iconHtml: registry.store.iconHtml, source:'Проводник' });
            openApp('store', { focusAppId: it.appId, searchQuery: it.appId });
            return;
          }
          openApp(it.appId);
          return;
        }
        if (it.type === 'file') { openFileById(it.fileId); return; }
        if (it.type === 'folder') {
          // Program Files special folders
          if (win.opts.path === 'programFiles' && (it._pfFolder || it.folderId === 'windowsApps')) {
            addNotification({ title:'Program Files', body:'Это демонстрационная папка. Здесь обычно хранятся пакеты приложений.', iconHtml: Icons.folder('w-6 h-6'), source:'Проводник' });
            return;
          }
          // In this demo: folders inside user libraries open as empty folder (local view)
          addNotification({ title:'Проводник', body:`Открытие папки «${it.name}» (демо)`, iconHtml: Icons.folder('w-6 h-6'), source:'Проводник' });
        }
      }

      function render(){
        const path = win.opts.path;

        // sidebar highlight
        $$('[data-place]', sidebar).forEach(b => {
          const on = b.getAttribute('data-place') === path;
          b.style.background = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.16)` : '';
          b.style.border = on ? `1px solid rgba(${(ui.accent||[99,102,241]).join(',')},.22)` : '1px solid transparent';
          b.style.borderRadius = '12px';
        });

        // address/breadcrumb
        const addr = document.getElementById(`path_${win.id}`);
        if (addr) addr.value = breadcrumbFor(path);

        main.innerHTML = '';
        main.appendChild(h('div', { class:'flex items-center justify-between px-2 py-2' }, [
          h('div', { class:'text-sm font-semibold' }, (locations[path]?.name || 'Папка')),
          h('div', { class:'text-xs text-white/60' }, 'Двойной клик — открыть')
        ]));
        main.appendChild(h('div', { class:'thin-sep my-1' }));

        const list = h('div', { class:'grid grid-cols-1 gap-1' });
        const items = itemsFor(path);

        if (!items.length) {
          list.appendChild(h('div', { class:'p-6 text-center text-white/60' }, 'Папка пуста'));
        }

        for (const it of items) {
          const kind = it.type === 'file' ? 'Файл' : it.type === 'folder' ? 'Папка' : it.type === 'app' ? 'Приложение' : '';
          const date = it.type === 'file' ? (new Date(fs.files[it.fileId]?.updatedAt || Date.now()).toLocaleDateString('ru-RU')) : '';

          const row = h('button', { class:'w-full text-left px-3 py-2 rounded-xl hover:bg-white/8 flex items-center gap-3' }, [
            h('div', { class:'w-8 h-8 flex items-center justify-center', html: it.__go ? Icons.folder('w-6 h-6') : iconForItem(it) }),
            h('div', { class:'min-w-0 flex-1' }, [
              h('div', { class:'text-sm font-semibold truncate' }, it.name),
              h('div', { class:'text-xs text-white/60' }, it.__go ? 'Папка' : kind)
            ]),
            h('div', { class:'text-[11px] text-white/50' }, date)
          ]);

          row.addEventListener('dblclick', () => openItem(it));
          row.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            e.stopPropagation();
            showExplorerItemMenu(e.clientX, e.clientY, it, win.id, path);
          });
          list.appendChild(row);
        }

        main.appendChild(list);
      }

      // address bar manual navigation
      const addr = topbar.querySelector(`#path_${win.id}`);
      addr.addEventListener('keydown', (e) => {
        if (e.key !== 'Enter') return;
        const v = (addr.value || '').toLowerCase();
        const match = Object.values(locations).find(p => p.name.toLowerCase() === v || p.id.toLowerCase() === v);
        if (match) goTo(match.id);
        else goTo('thispc');
      });

      // initial
      if (!locations[win.opts.path]) win.opts.path = 'thispc';
      render();

      body.append(sidebar, main);
      container.append(topbar, body);
      return container;
    }

    function explorerCurrentPath(winId){
      const win = state.windows.get(winId);
      return win?.opts?.path || 'thispc';
    }

    // SYNC: create folder/file in currently selected location (including Desktop)
    function explorerCreateFolder(winId){
      const path = explorerCurrentPath(winId);
      if (path === 'thispc') {
        addNotification({ title:'Проводник', body:'Выберите папку (например «Документы»), чтобы создать элемент.', iconHtml: Icons.folder('w-6 h-6'), source:'Проводник' });
        return;
      }

      const name = prompt('Имя новой папки:', 'Новая папка');
      if (!name) return;

      if (path === 'desktop') {
        createDesktopFolder(name);
        refreshWindowContent(winId);
        return;
      }

      fs[path] = Array.isArray(fs[path]) ? fs[path] : [];
      fs[path].unshift({ type: 'folder', folderId: uid(), name });
      fsSave(fs);
      addNotification({ title:'Проводник', body:`Папка «${name}» создана в «${path}».`, iconHtml: Icons.folder('w-6 h-6'), source:'Проводник' });
      refreshWindowContent(winId);
    }

    function explorerCreateText(winId){
      const path = explorerCurrentPath(winId);
      if (path === 'thispc') {
        addNotification({ title:'Проводник', body:'Выберите папку (например «Документы»), чтобы создать файл.', iconHtml: Icons.note('w-6 h-6'), source:'Проводник' });
        return;
      }

      const name = prompt('Имя файла:', 'Новый документ');
      if (!name) return;

      const id = uid();
      const filename = name.endsWith('.txt') ? name : (name + '.txt');
      fs.files[id] = { id, name: filename, ext: 'txt', updatedAt: Date.now(), content: '' };

      if (path === 'desktop') {
        fs.desktop.unshift({ did: uid(), type: 'file', fileId: id, name: filename, ext: 'txt', pos: findFreeDesktopSlot() });
        fsSave(fs);
        renderDesktopIcons();
        addRecent({ kind: 'file', fileId: id, name: filename, ts: Date.now() });
        addNotification({ title:'Проводник', body:`Файл «${filename}» создан на рабочем столе.`, iconHtml: Icons.note('w-6 h-6'), source:'Проводник' });
        refreshWindowContent(winId);
        openNotepadWithFile(id);
        return;
      }

      fs[path] = Array.isArray(fs[path]) ? fs[path] : [];
      fs[path].unshift({ type: 'file', fileId: id, name: filename, ext: 'txt' });
      fsSave(fs);
      addRecent({ kind: 'file', fileId: id, name: filename, ts: Date.now() });
      addNotification({ title:'Проводник', body:`Файл «${filename}» создан в «${path}».`, iconHtml: Icons.note('w-6 h-6'), source:'Проводник' });
      refreshWindowContent(winId);
      openNotepadWithFile(id);
    }

    function refreshWindowContent(winId){
      const win = state.windows.get(winId);
      if (!win) return;
      const el = document.querySelector(`[data-win="${winId}"]`);
      if (!el) return;
      const content = $('[data-content]', el);
      if (!content) return;
      content.innerHTML = '';
      content.appendChild(registry[win.appId].build(win));
    }

    // Notepad
    function openNotepadWithFile(fileId){
      const id = openApp('notepad', { fileId });
      const win = state.windows.get(id);
      if (win) win.opts.fileId = fileId;
      refreshWindowContent(id);
      addRecent({ kind: 'file', fileId, name: fs.files[fileId]?.name || 'Файл', ts: Date.now() });
    }

    function buildNotepad(win){
      const fileId = win.opts?.fileId || null;
      const file = fileId ? fs.files[fileId] : null;
      const defaultName = file ? file.name : 'Безымянный.txt';

      const wrap = h('div', { class: 'p-3' });
      const bar = h('div', { class: 'flex flex-wrap items-center gap-2' });

      const nameBox = h('div', { class: 'text-sm font-semibold mr-auto' }, defaultName);

      const btnNew = h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Новый');
      const btnOpen = h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Открыть');
      const btnSave = h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Сохранить');
      const btnSaveAs = h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Сохранить как');
      const btnFind = h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Найти');

      bar.append(nameBox, btnNew, btnOpen, btnSave, btnSaveAs, btnFind);

      const textarea = h('textarea', {
        class: 'mt-3 w-full h-[380px] sm:h-[420px] resize-none bg-white/5 border border-white/10 rounded-2xl p-3 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60 scrollbar',
        spellcheck: 'false',
        style: 'user-select:text;'
      });

      let dirty = false;
      textarea.value = file ? (file.content || '') : '';
      textarea.addEventListener('input', () => { dirty = true; });

      function setTitle(title){
        const winEl = document.querySelector(`[data-win="${win.id}"]`);
        if (winEl) {
          const nm = $('.titletext .name', winEl);
          if (nm) nm.textContent = title;
        }
      }

      async function doOpen(){
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.txt,text/plain';
        input.onchange = async () => {
          const f = input.files?.[0];
          if (!f) return;
          const text = await readFileAsText(f);
          textarea.value = text;
          dirty = true;
          nameBox.textContent = f.name;
          setTitle('Блокнот — ' + f.name);
          addNotification({ title: 'Блокнот', body: `Открыт файл: ${f.name}`, iconHtml: registry.notepad.iconHtml, source: 'Блокнот' });
        };
        input.click();
      }

      function doSave(){
        if (fileId && fs.files[fileId]) {
          fs.files[fileId].content = textarea.value;
          fs.files[fileId].updatedAt = Date.now();
          fsSave(fs);
          dirty = false;
          addNotification({ title: 'Блокнот', body: `Сохранено: ${fs.files[fileId].name}`, iconHtml: registry.notepad.iconHtml, source: 'Блокнот' });
          addRecent({ kind: 'file', fileId, name: fs.files[fileId].name, ts: Date.now() });
          return;
        }
        doSaveAs();
      }

      function doSaveAs(){
        const filename = prompt('Сохранить как…', nameBox.textContent || 'Безымянный.txt');
        if (!filename) return;
        const finalName = filename.endsWith('.txt') ? filename : (filename + '.txt');
        downloadText(finalName, textarea.value);
        dirty = false;
        addNotification({ title: 'Блокнот', body: `Файл скачан: ${finalName}`, iconHtml: registry.notepad.iconHtml, source: 'Блокнот' });
      }

      function doNew(){
        if (dirty && !confirm('Есть несохранённые изменения. Создать новый документ?')) return;
        textarea.value = '';
        dirty = false;
        nameBox.textContent = 'Безымянный.txt';
        setTitle('Блокнот');
      }

      function doFind(){
        const q = prompt('Найти:', '');
        if (!q) return;
        const text = textarea.value;
        const idx = text.toLowerCase().indexOf(q.toLowerCase());
        if (idx === -1) {
          addNotification({ title:'Блокнот', body:`«${q}» не найдено.`, iconHtml: registry.notepad.iconHtml, source:'Блокнот' });
          return;
        }
        textarea.focus();
        textarea.setSelectionRange(idx, idx + q.length);
        addNotification({ title:'Блокнот', body:`Найдено: «${q}»`, iconHtml: registry.notepad.iconHtml, source:'Блокнот' });
      }

      btnOpen.addEventListener('click', doOpen);
      btnSave.addEventListener('click', doSave);
      btnSaveAs.addEventListener('click', doSaveAs);
      btnNew.addEventListener('click', doNew);
      btnFind.addEventListener('click', doFind);

      wrap.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
          e.preventDefault();
          doSave();
        }
      });

      registerBeforeClose(win.id, () => {
        if (!dirty) return true;
        const wantSave = confirm('Есть несохранённые изменения. Сохранить перед закрытием?');
        if (wantSave) { doSave(); return true; }
        return confirm('Закрыть без сохранения?');
      });

      wrap.append(bar, textarea);
      setTitle(file ? ('Блокнот — ' + file.name) : 'Блокнот');
      return wrap;
    }

    // Calculator
    function buildCalculator(win){
      const wrap = h('div', { class: 'p-3' });
      const display = h('div', { class: 'p-4 rounded-2xl border border-white/10 bg-white/5 text-right' }, [
        h('div', { id: `calcExpr_${win.id}`, class: 'text-xs text-white/60 truncate' }, ' '),
        h('div', { id: `calcDisp_${win.id}`, class: 'text-3xl font-semibold tracking-tight' }, '0')
      ]);

      const keys = [
        ['C','CE','%','/'],
        ['7','8','9','*'],
        ['4','5','6','-'],
        ['1','2','3','+'],
        ['±','0','.','=']
      ];

      let expr = '';
      let curr = '0';
      let justEval = false;

      const exprEl = () => document.getElementById(`calcExpr_${win.id}`);
      const dispEl = () => document.getElementById(`calcDisp_${win.id}`);

      function setDisp(v){ curr = v; if (dispEl()) dispEl().textContent = curr; }
      function setExpr(v){ expr = v; if (exprEl()) exprEl().textContent = expr || ' '; }

      function press(k){
        if ('0123456789'.includes(k)) {
          if (justEval) { setExpr(''); justEval = false; setDisp('0'); }
          setDisp(curr === '0' ? k : (curr + k));
          return;
        }
        if (k === '.') {
          if (justEval) { setExpr(''); justEval = false; setDisp('0'); }
          if (!curr.includes('.')) setDisp(curr + '.');
          return;
        }
        if (k === 'C') { setExpr(''); setDisp('0'); justEval = false; return; }
        if (k === 'CE') { setDisp('0'); justEval = false; return; }
        if (k === '±') {
          if (curr === '0') return;
          setDisp(curr.startsWith('-') ? curr.slice(1) : ('-' + curr));
          return;
        }
        if (k === '%') {
          const v = Number(curr);
          if (!Number.isFinite(v)) return;
          setDisp(String(v/100));
          return;
        }
        if (['+','-','*','/'].includes(k)) {
          if (justEval) { justEval = false; }
          const token = curr;
          if (!expr) {
            setExpr(token + ' ' + k);
          } else {
            if (/[+\-*/]$/.test(expr.trim())) setExpr(expr.replace(/[+\-*/]\s*$/, k));
            else setExpr(expr + ' ' + token + ' ' + k);
          }
          setDisp('0');
          return;
        }
        if (k === '=') {
          let e = expr.trim();
          if (!e) return;
          if (/[+\-*/]$/.test(e)) e = e + ' ' + curr;
          else e = e + ' ' + curr;
          if (!/^[0-9+\-*/.\s]+$/.test(e)) return;
          try {
            const result = Function('"use strict"; return (' + e + ');')();
            if (!Number.isFinite(result)) throw new Error('NaN');
            setExpr(e + ' =');
            setDisp(String(Number(result.toFixed(10))));
            justEval = true;
            addNotification({ title:'Калькулятор', body:`Результат: ${curr}`, iconHtml: registry.calculator.iconHtml, source:'Калькулятор' });
          } catch {
            setExpr('Ошибка');
            setDisp('0');
            justEval = false;
            addNotification({ title:'Калькулятор', body:'Ошибка вычисления.', iconHtml: registry.calculator.iconHtml, source:'Калькулятор' });
          }
          return;
        }
      }

      const grid = h('div', { class: 'mt-3 grid grid-cols-4 gap-2' });
      keys.flat().forEach(k => {
        const isOp = ['+','-','*','/','='].includes(k);
        const btn = h('button', {
          class: `px-3 py-4 rounded-2xl border border-white/10 ${isOp ? 'bg-white/10' : 'bg-white/5'} hover:bg-white/15 text-lg font-semibold`,
          onclick: () => press(k)
        }, k);
        if (k === '=') {
          btn.style.background = `rgba(${(ui.accent||[99,102,241]).join(',')},.28)`;
          btn.style.borderColor = `rgba(${(ui.accent||[99,102,241]).join(',')},.35)`;
        }
        grid.appendChild(btn);
      });

      wrap.append(display, grid);
      wrap.tabIndex = 0;
      wrap.addEventListener('keydown', (e) => {
        const map = { 'Enter':'=', 'Escape':'C' };
        if (map[e.key]) { e.preventDefault(); press(map[e.key]); return; }
        if ('0123456789.+-*/'.includes(e.key)) {
          e.preventDefault();
          press(e.key);
        }
      });
      setTimeout(() => wrap.focus(), 50);
      return wrap;
    }

    // Edge (simulation + Yandex search + Tabs beta)
    function buildEdge(win){
      win.opts = win.opts || {};

      const pages = {
        'win://home': () => `
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-xl font-semibold">Edge (симуляция)</div>
              <div class="text-white/70 mt-1">Внутренние страницы: <span class="kbd">win://home</span>, <span class="kbd">win://news</span>, <span class="kbd">win://tips</span>.</div>
              <div class="text-white/70 mt-1">Любая строка без URL — будет искаться в <b>Яндексе</b>.</div>
            </div>
            <div class="w-12 h-12">${Icons.edge('w-12 h-12')}</div>
          </div>
          <div class="mt-4 p-4 rounded-2xl border border-white/10 bg-white/5">
            <div class="text-sm font-semibold">Поиск (Яндекс)</div>
            <div class="text-xs text-white/70 mt-1">Режим вкладок: <span class="kbd">Beta</span> — может открывать Яндекс внутри окна (если сайт позволит iframe).</div>
          </div>
          <div class="mt-4 grid sm:grid-cols-3 gap-3">
            <button data-nav="win://news" class="p-4 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-left">
              <div class="text-sm font-semibold">Новости</div>
              <div class="text-xs text-white/70 mt-1">Локальная лента</div>
            </button>
            <button data-nav="win://tips" class="p-4 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-left">
              <div class="text-sm font-semibold">Подсказки</div>
              <div class="text-xs text-white/70 mt-1">Горячие клавиши</div>
            </button>
            <button data-nav="yandex:Windows 12 UI" class="p-4 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-left">
              <div class="text-sm font-semibold">Поиск: Windows 12 UI</div>
              <div class="text-xs text-white/70 mt-1">Яндекс</div>
            </button>
          </div>
        `,
        'win://news': () => `
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xl font-semibold">Лента новостей</div>
              <div class="text-white/70 mt-1">Демо-контент для реалистичного окна браузера.</div>
            </div>
            <button data-nav="win://home" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Назад</button>
          </div>
          <div class="mt-4 grid gap-3">
            ${[1,2,3,4].map(i => `
              <div class="p-4 rounded-2xl border border-white/10 bg-white/5">
                <div class="text-sm font-semibold">Обновления интерфейса #${i}</div>
                <div class="text-xs text-white/70 mt-1">Store, мультивыделение и синхронизация рабочего стола с проводником.</div>
              </div>
            `).join('')}
          </div>
        `,
        'win://tips': () => `
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xl font-semibold">Подсказки</div>
              <div class="text-white/70 mt-1">Управление в этой симуляции:</div>
            </div>
            <button data-nav="win://home" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Домой</button>
          </div>
          <div class="mt-4 grid gap-3">
            <div class="p-4 rounded-2xl border border-white/10 bg-white/5">
              <div class="text-sm font-semibold">Рабочий стол</div>
              <div class="text-sm text-white/80 mt-2 space-y-1">
                <div>Одиночный клик — выделение</div>
                <div>Ctrl/⌘ + клик — мультивыделение</div>
                <div>Рамка выделения — выделить несколько</div>
                <div>Перетащите выделенные — двигаются вместе</div>
              </div>
            </div>
            <div class="p-4 rounded-2xl border border-white/10 bg-white/5">
              <div class="text-sm font-semibold">Клавиатура</div>
              <div class="text-sm text-white/80 mt-2 space-y-1">
                <div><span class="kbd">Win</span> — «Пуск»</div>
                <div><span class="kbd">Win</span>+<span class="kbd">R</span> — «Выполнить»</div>
                <div><span class="kbd">Esc</span> — закрыть меню/панели</div>
                <div><span class="kbd">Alt</span>+<span class="kbd">Tab</span> — переключение окон</div>
                <div><span class="kbd">F5</span> — обновить рабочий стол</div>
              </div>
            </div>
          </div>
        `
      };

      const wrap = h('div', { class: 'p-3' });

      // Beta toggles
      const betaPill = (label, get, set) => {
        const b = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-xs flex items-center gap-2' }, [
          h('span', { class:'kbd' }, 'beta'),
          h('span', {}, label)
        ]);
        const paint = () => {
          const on = !!get();
          b.style.background = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
          b.style.borderColor = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
        };
        b.addEventListener('click', () => { set(!get()); paint(); });
        paint();
        return b;
      };

      const btnTabs = betaPill('Вкладки', () => state.edgeTabsBeta, (v) => { state.edgeTabsBeta = !!v; persistUI(); });
      const btnInside = betaPill('Открывать Яндекс внутри', () => state.edgeOpenInsideBeta, (v) => { state.edgeOpenInsideBeta = !!v; persistUI(); });

      const address = h('input', {
        class: 'flex-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60',
        placeholder: 'Адрес / запрос (Яндекс)'
      });

      const btnGo = h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Перейти');
      const btnHome = h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Домой');
      const btnNew = h('button', { class: 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Новая вкладка');

      const bar = h('div', { class: 'flex items-center gap-2 flex-wrap' }, [
        h('div', { class:'w-6 h-6', html: registry.edge.iconHtml }),
        address, btnGo, btnHome, btnNew, btnTabs, btnInside
      ]);

      const tabStrip = h('div', { class:'mt-3 flex items-center gap-2 overflow-auto scrollbar' });

      const view = h('div', { class: 'mt-3 p-0 rounded-2xl border border-white/10 bg-white/5 overflow-hidden min-h-[420px]' });
      const inner = h('div', { class: 'p-4 fade-swap' });
      view.appendChild(inner);

      // tabs state (per window)
      win.opts.tabs = Array.isArray(win.opts.tabs) ? win.opts.tabs : null;
      if (!win.opts.tabs) {
        const initial = win.opts?.url || 'win://home';
        win.opts.tabs = [{ tid: uid(), title: 'Домой', url: initial }];
        win.opts.activeTid = win.opts.tabs[0].tid;
      }

      function activeTab(){
        return win.opts.tabs.find(t => t.tid === win.opts.activeTid) || win.opts.tabs[0];
      }

      function setActive(tid){
        win.opts.activeTid = tid;
        renderTabs();
        renderView();
      }

      function newTab(url='win://home'){
        const t = { tid: uid(), title: 'Новая вкладка', url };
        win.opts.tabs.push(t);
        setActive(t.tid);
      }

      function closeTab(tid){
        if (win.opts.tabs.length <= 1) return;
        const idx = win.opts.tabs.findIndex(t => t.tid === tid);
        if (idx === -1) return;
        const wasActive = win.opts.activeTid === tid;
        win.opts.tabs.splice(idx,1);
        if (wasActive) {
          const next = win.opts.tabs[Math.max(0, idx-1)] || win.opts.tabs[0];
          win.opts.activeTid = next.tid;
        }
        renderTabs();
        renderView();
      }

      function setInnerContent(nodeOrHtml){
        inner.classList.remove('fade-swap');
        void inner.offsetHeight;
        inner.classList.add('fade-swap');
        inner.innerHTML = '';
        if (typeof nodeOrHtml === 'string') inner.innerHTML = nodeOrHtml;
        else inner.appendChild(nodeOrHtml);
        $$('[data-nav]', inner).forEach(b => b.addEventListener('click', () => navigate(b.getAttribute('data-nav'))));
      }

      function openExternal(url, note){
        window.open(url, '_blank', 'noopener');
        addNotification({ title:'Microsoft Edge', body: note || `Открыто: ${url}`, iconHtml: registry.edge.iconHtml, source:'Microsoft Edge' });
      }

      function showBlockedHint(url){
        const box = h('div', { class:'p-4' }, [
          h('div', { class:'text-xl font-semibold' }, 'Страница может блокировать встроенный просмотр'),
          h('div', { class:'text-white/70 mt-2' }, 'Некоторые сайты (включая поисковые) запрещают показ внутри iframe. В этом случае используйте внешнюю вкладку.'),
          h('div', { class:'mt-3 text-xs text-white/60 break-all' }, `URL: ${url}`),
          h('div', { class:'mt-3 flex gap-2 flex-wrap' }, [
            h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm', onclick: () => openExternal(url, `Открыто: ${url}`) }, 'Открыть во внешней вкладке'),
            h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm', onclick: () => navigate('win://home') }, 'Домой')
          ])
        ]);
        setInnerContent(box);
      }

      function yandexUrl(query){
        const q = encodeURIComponent(query.trim());
        return `https://yandex.ru/search/?text=${q}`;
      }

      function renderYandexInside(query){
        const url = yandexUrl(query);
        const iframe = h('iframe', {
          src: url,
          class: 'w-full h-full',
          sandbox: 'allow-forms allow-scripts allow-popups allow-top-navigation-by-user-activation',
          referrerpolicy: 'no-referrer'
        });

        const frameWrap = h('div', { class:'mt-3 rounded-2xl border border-white/10 overflow-hidden bg-black/20 relative', style:'height: 420px;' }, [
          iframe
        ]);

        const box = h('div', { class:'p-4' }, [
          h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
            h('div', {}, [
              h('div', { class:'text-lg font-semibold' }, `Яндекс — ${query}`),
              h('div', { class:'text-xs text-white/70 mt-1' }, 'Внутренний просмотр — beta. Некоторые сайты могут блокировать показ в iframe.')
            ]),
            h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm', onclick: () => openExternal(url, `Поиск в Яндексе: ${query}`) }, 'Открыть во внешней вкладке')
          ]),
          frameWrap,
          h('div', { class:'mt-3 text-xs text-white/60 break-all' }, `URL: ${url}`)
        ]);

        setInnerContent(box);

        // If blocked by X-Frame-Options/CSP, the iframe often won't load correctly.
        let loaded = false;
        const t = setTimeout(() => {
          if (!loaded) showBlockedHint(url);
        }, 1400);
        iframe.addEventListener('load', () => {
          loaded = true;
          clearTimeout(t);
        }, { once:true });
      }

      function renderWebInside(url){
        const iframe = h('iframe', {
          src: url,
          class: 'w-full h-full',
          sandbox: 'allow-forms allow-scripts allow-popups allow-top-navigation-by-user-activation',
          referrerpolicy: 'no-referrer'
        });

        const frameWrap = h('div', { class:'mt-3 rounded-2xl border border-white/10 overflow-hidden bg-black/20 relative', style:'height: 420px;' }, [
          iframe
        ]);

        const box = h('div', { class:'p-4' }, [
          h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
            h('div', {}, [
              h('div', { class:'text-lg font-semibold' }, 'Веб-страница (beta)'),
              h('div', { class:'text-xs text-white/70 mt-1' }, 'Если сайт не отображается — используйте внешнюю вкладку.')
            ]),
            h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm', onclick: () => openExternal(url, `Открыто: ${url}`) }, 'Открыть во внешней вкладке')
          ]),
          frameWrap,
          h('div', { class:'mt-3 text-xs text-white/60 break-all' }, `URL: ${url}`)
        ]);

        setInnerContent(box);

        let loaded = false;
        const t = setTimeout(() => {
          if (!loaded) showBlockedHint(url);
        }, 1400);
        iframe.addEventListener('load', () => {
          loaded = true;
          clearTimeout(t);
        }, { once:true });
      }

      function setTitleForUrl(t){
        const u = t.url;
        if (u.startsWith('win://')) t.title = u.replace('win://','').toUpperCase();
        else if (u.startsWith('yandex:')) t.title = 'Яндекс';
        else if (!isProbablyUrl(u)) t.title = 'Яндекс';
        else {
          let x = u.replace(/^https?:\/\//i,'');
          if (x.length > 18) x = x.slice(0,18) + '…';
          t.title = x;
        }
      }

      function renderTabs(){
        tabStrip.innerHTML = '';
        if (!state.edgeTabsBeta) return;

        for (const t of win.opts.tabs) {
          setTitleForUrl(t);
          const active = (t.tid === win.opts.activeTid);
          const tab = h('div', { class:`flex items-center gap-2 px-3 py-2 rounded-2xl border ${active ? 'bg-white/10 border-white/15' : 'bg-white/5 border-white/10'} hover:bg-white/10 transition` });
          const title = h('button', { class:'text-xs font-semibold max-w-[160px] truncate' }, t.title);
          title.addEventListener('click', () => setActive(t.tid));
          const close = h('button', { class:'text-xs px-2 py-1 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10', title:'Закрыть' }, '×');
          close.addEventListener('click', (e) => { e.stopPropagation(); closeTab(t.tid); });
          tab.append(title, close);
          tabStrip.appendChild(tab);
        }

        const plus = h('button', { class:'px-3 py-2 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm', title:'Новая вкладка' }, '+');
        plus.addEventListener('click', () => newTab('win://home'));
        tabStrip.appendChild(plus);
      }

      function renderView(){
        const t = activeTab();
        address.value = t.url;

        const u = (t.url || '').trim();
        if (!u) { setInnerContent(pages['win://home']()); return; }

        // yandex pseudo scheme
        if (u.startsWith('yandex:')) {
          const q = u.slice('yandex:'.length);
          if (state.edgeOpenInsideBeta) renderYandexInside(q);
          else {
            openExternal(yandexUrl(q), `Поиск в Яндексе: ${q}`);
            setInnerContent(`<div class="p-4"><div class="text-xl font-semibold">Открыто во внешней вкладке</div><div class="text-white/70 mt-2">Запрос: <span class="kbd">${escapeHtml(q)}</span></div></div>`);
          }
          return;
        }

        if (u.startsWith('win://')) {
          setInnerContent(pages[u] ? pages[u]() : `<div class="p-4"><div class="text-xl font-semibold">Страница не найдена</div><div class="text-white/70 mt-2">Неизвестный адрес: <span class="kbd">${escapeHtml(u)}</span></div></div>`);
          return;
        }

        if (!isProbablyUrl(u)) {
          // treat as query
          const q = u;
          if (state.edgeOpenInsideBeta) renderYandexInside(q);
          else {
            openExternal(yandexUrl(q), `Поиск в Яндексе: ${q}`);
            setInnerContent(`<div class="p-4"><div class="text-xl font-semibold">Открыто во внешней вкладке</div><div class="text-white/70 mt-2">Запрос: <span class="kbd">${escapeHtml(q)}</span></div></div>`);
          }
          return;
        }

        let final = u;
        if (!/^https?:\/\//i.test(final)) final = 'https://' + final;

        if (state.edgeTabsBeta && state.edgeOpenInsideBeta) {
          renderWebInside(final);
        } else {
          openExternal(final, `Открыто: ${final}`);
          setInnerContent(`<div class="p-4"><div class="text-xl font-semibold">Открыто во внешней вкладке</div><div class="text-white/70 mt-2">URL: <span class="kbd">${escapeHtml(final)}</span></div></div>`);
        }
      }

      function navigate(url){
        const u = (url || '').trim();
        if (!u) return;
        const t = activeTab();
        t.url = u;
        renderTabs();
        renderView();
        addRecent({ kind: 'app', appId: 'edge', name: 'Microsoft Edge', ts: Date.now() });
      }

      btnGo.addEventListener('click', () => navigate(address.value));
      btnHome.addEventListener('click', () => navigate('win://home'));
      btnNew.addEventListener('click', () => {
        if (state.edgeTabsBeta) newTab('win://home');
        else openApp('edge', { url: 'win://home' });
      });
      address.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); navigate(address.value); }
      });

      // initial render
      renderTabs();
      renderView();

      wrap.append(bar);
      wrap.appendChild(tabStrip);
      wrap.appendChild(view);
      return wrap;
    }

    // Microsoft Store (fixed: no document query during build + install animation)
    function buildStore(win){
      win.opts = win.opts || {};
      win.opts._installing = win.opts._installing || {};
      win.opts._bootedAt = win.opts._bootedAt || Date.now();

      const wrap = h('div', { class:'p-3' });

      const header = h('div', { class:'flex items-center gap-2' }, [
        h('div', { class:'w-6 h-6', html: registry.store.iconHtml }),
        h('div', { class:'text-lg font-semibold' }, 'Microsoft Store'),
        h('div', { class:'ml-auto text-xs text-white/60' }, 'Каталог (демо)')
      ]);

      const searchInput = h('input', {
        class:'flex-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60',
        placeholder:'Поиск в Store (Flappy Bird, VS Code, Word...)'
      });
      const btnReset = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Сброс');

      const top = h('div', { class:'mt-3 flex items-center gap-2' }, [
        searchInput,
        btnReset
      ]);

      const info = h('div', { class:'mt-3 p-4 rounded-2xl border border-white/10 bg-white/5 text-sm text-white/80 shimmer' }, [
        h('div', { class:'font-semibold' }, 'Важно'),
        h('div', { class:'text-xs text-white/70 mt-1' }, 'Приложения в этом Store реально работают (демо). Установка/удаление — демо (localStorage).')
      ]);

      const grid = h('div', { class:'mt-3 grid sm:grid-cols-2 lg:grid-cols-3 gap-3' });

      // Win11-like loading skeleton on open
      const bootMs = 1200;
      const loading = (Date.now() - (win.opts._bootedAt||0)) < bootMs;
      if (loading) {
        const skTop = h('div', { class:'mt-4 p-4 rounded-2xl border border-white/10 bg-white/5 shimmer' }, [
          h('div', { class:'flex items-center gap-3' }, [
            h('div', { class:'boot-spinner', style:'width:26px;height:26px;border-width:3px;margin:0;' }),
            h('div', {}, [
              h('div', { class:'text-sm font-semibold' }, 'Загрузка Microsoft Store…'),
              h('div', { class:'text-xs text-white/60 mt-1' }, 'Подготовка каталога и служб…')
            ])
          ])
        ]);

        const skGrid = h('div', { class:'mt-3 grid sm:grid-cols-2 lg:grid-cols-3 gap-3' });
        for (let i=0;i<9;i++){
          skGrid.appendChild(h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5 shimmer' }, [
            h('div', { class:'h-10 w-10 rounded-xl bg-white/10 border border-white/10' }),
            h('div', { class:'mt-3 h-4 w-2/3 rounded-lg bg-white/10 border border-white/10' }),
            h('div', { class:'mt-2 h-3 w-full rounded-lg bg-white/8 border border-white/10' }),
            h('div', { class:'mt-4 h-9 w-full rounded-xl bg-white/10 border border-white/10' })
          ]));
        }

        wrap.append(header, top, skTop, skGrid);
        // refresh once when loading ends
        setTimeout(() => {
          if (state.windows.has(win.id)) refreshWindowContent(win.id);
        }, bootMs + 10);
        return wrap;
      }

      function ensureDesktopIcon(appId){
        const app = registry[appId];
        if (!app) return;
        const exists = fs.desktop.some(x => x.type==='app' && x.appId===appId);
        if (exists) return;
        fs.desktop.unshift({ did: uid(), type:'app', appId, name: app.name, pos: findFreeDesktopSlot() });
        fsSave(fs);
        renderDesktopIcons();
      }

      function removeDesktopIcon(appId){
        const before = fs.desktop.length;
        fs.desktop = fs.desktop.filter(x => !(x.type==='app' && x.appId===appId));
        if (fs.desktop.length !== before) {
          fsSave(fs);
          renderDesktopIcons();
        }
      }

      function closeAllWindowsOfApp(appId){
        for (const w of Array.from(state.windows.values())) {
          if (w.appId === appId) closeWindow(w.id);
        }
      }

      function startInstall(appId){
        const meta = STORE_CATALOG.find(x => x.id === appId);
        if (!meta) return;
        if (meta.status !== 'available') {
          addNotification({ title:'Microsoft Store', body:`«${meta.name}» — скоро.`, iconHtml: registry.store.iconHtml, source:'Microsoft Store' });
          return;
        }
        if (win.opts._installing[appId]) return;

        const prog = { v: 0, timer: null };
        win.opts._installing[appId] = prog;

        const step = () => {
          prog.v = Math.min(100, prog.v + 10 + Math.random()*18);
          render();
          if (prog.v >= 100) {
            clearInterval(prog.timer);
            delete win.opts._installing[appId];
            state.installedApps.add(appId);
            persistUI();
            ensureDesktopIcon(appId);
            addNotification({ title:'Microsoft Store', body:`Установлено: ${meta.name}`, iconHtml: registry.store.iconHtml, source:'Microsoft Store' });
            render();
          }
        };
        step();
        prog.timer = setInterval(step, 220);
      }

      function uninstall(appId){
        const meta = STORE_CATALOG.find(x => x.id === appId);
        if (!meta) return;
        if (win.opts._installing[appId]) return;
        state.installedApps.delete(appId);
        persistUI();
        removeDesktopIcon(appId);
        closeAllWindowsOfApp(appId);
        addNotification({ title:'Microsoft Store', body:`Удалено: ${meta.name}`, iconHtml: registry.store.iconHtml, source:'Microsoft Store' });
        render();
      }

      function render(){
        grid.innerHTML = '';
        const q = (searchInput.value || '').trim().toLowerCase();
        const focusId = win.opts?.focusAppId;

        const list = STORE_CATALOG.filter(a => !q || a.name.toLowerCase().includes(q) || a.id.includes(q) || a.category.toLowerCase().includes(q));
        const groups = Array.from(new Set(list.map(x => x.category))).sort((a,b) => a.localeCompare(b,'ru'));

        for (const g of groups) {
          const items = list.filter(x => x.category === g);
          if (!items.length) continue;
          grid.appendChild(h('div', { class:'sm:col-span-2 lg:col-span-3 text-sm font-semibold text-white/80 mt-2' }, g));

          for (const a of items) {
            const installed = isInstalled(a.id);
            const installing = win.opts._installing[a.id];

            const card = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5 transition ' + (focusId===a.id ? 'ring-2 ring-[rgb(var(--accent))]/50' : '') });
            const topRow = h('div', { class:'flex items-start gap-3' }, [
              h('div', { class:'w-10 h-10 flex items-center justify-center', html: a.iconHtml }),
              h('div', { class:'min-w-0 flex-1' }, [
                h('div', { class:'text-sm font-semibold truncate' }, a.name),
                h('div', { class:'text-xs text-white/60' }, a.desc)
              ]),
              h('div', { class:'text-[11px] text-white/60' }, a.status === 'available' ? 'Доступно' : 'Скоро')
            ]);

            const actions = h('div', { class:'mt-3 flex items-center gap-2 flex-wrap' });

            const btnOpen = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Открыть');
            btnOpen.disabled = !(installed && a.status === 'available');
            btnOpen.style.opacity = btnOpen.disabled ? '.5' : '1';
            btnOpen.addEventListener('click', () => openApp(a.id));

            const btnInstall = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' });
            const btnUninstall = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Удалить');

            if (installing) {
              btnInstall.textContent = `Установка… ${Math.floor(installing.v)}%`;
              btnInstall.disabled = true;
              btnInstall.style.opacity = '.8';

              btnUninstall.disabled = true;
              btnUninstall.style.opacity = '.45';

              const bar = h('div', { class:'w-full mt-2 h-2 rounded-full bg-white/10 overflow-hidden border border-white/10' }, [
                h('div', { class:'h-full', style:`width:${Math.floor(installing.v)}%; background: rgba(${(ui.accent||[99,102,241]).join(',')},.70); transition: width .22s ease;` })
              ]);
              card.appendChild(bar);
            } else if (installed) {
              btnInstall.textContent = 'Установлено';
              btnInstall.disabled = true;
              btnInstall.style.opacity = '.6';

              btnUninstall.disabled = false;
              btnUninstall.style.opacity = '1';
              btnUninstall.addEventListener('click', () => uninstall(a.id));
            } else if (a.status !== 'available') {
              btnInstall.textContent = 'Скоро';
              btnInstall.disabled = true;
              btnInstall.style.opacity = '.5';

              btnUninstall.disabled = true;
              btnUninstall.style.opacity = '.45';
            } else {
              btnInstall.textContent = 'Установить';
              btnInstall.style.background = `rgba(${(ui.accent||[99,102,241]).join(',')},.18)`;
              btnInstall.style.borderColor = `rgba(${(ui.accent||[99,102,241]).join(',')},.28)`;
              btnInstall.addEventListener('click', () => startInstall(a.id));

              btnUninstall.disabled = true;
              btnUninstall.style.opacity = '.45';
            }

            actions.append(btnOpen, btnInstall, btnUninstall);
            card.append(topRow, actions);
            grid.appendChild(card);
          }
        }
      }

      btnReset.addEventListener('click', () => {
        // cancel installs
        for (const k of Object.keys(win.opts._installing)) {
          const it = win.opts._installing[k];
          if (it?.timer) clearInterval(it.timer);
          delete win.opts._installing[k];
        }
        state.installedApps = new Set(['flappy','paint','photos','musicPlayer','stickyNotes']);
        persistUI();
        ensureDesktopIcon('flappy');
        ensureDesktopIcon('paint');
        for (const id of Array.from(OPTIONAL_APPS)) {
          if (id !== 'flappy' && id !== 'paint') removeDesktopIcon(id);
        }
        addNotification({ title:'Microsoft Store', body:'Сброшены установки (оставлены Flappy Bird, Paint, Фото, Музыка и Заметки).', iconHtml: registry.store.iconHtml, source:'Microsoft Store' });
        render();
      });

      searchInput.addEventListener('input', () => render());

      if (win.opts?.focusAppId) {
        searchInput.value = String(win.opts.focusAppId);
      }
      if (win.opts?.searchQuery) {
        searchInput.value = String(win.opts.searchQuery);
      }

      render();
      wrap.append(header, top, info, grid);
      return wrap;
    }

    // Settings
    function buildSettings(win){
      const wrap = h('div', { class: 'p-3' });
      const header = h('div', { class: 'flex items-center gap-2' }, [
        h('div', { class:'w-6 h-6', html: registry.settings.iconHtml }),
        h('div', { class: 'text-lg font-semibold' }, 'Параметры'),
        h('div', { class: 'ml-auto text-xs text-white/60' }, 'Изменения сохраняются в localStorage')
      ]);

      const layout = h('div', { class: 'mt-3 grid grid-cols-[240px_1fr] gap-3' });
      const nav = h('div', { class: 'p-2 rounded-2xl border border-white/10 bg-white/5' });
      const main = h('div', { class: 'p-4 rounded-2xl border border-white/10 bg-white/5 min-h-[420px]' });

      const sections = [
        { id:'system', name:'Система', icon: Icons.settings('w-5 h-5') },
        { id:'personal', name:'Персонализация', icon: Icons.win('w-5 h-5') },
        { id:'appearance', name:'Внешний вид', icon: Icons.win('w-5 h-5') },
        { id:'apps', name:'Приложения', icon: registry.store.iconHtml },
        { id:'storage', name:'Хранилище', icon: Icons.folder('w-5 h-5') },
        { id:'network', name:'Сеть', icon: Icons.wifi('w-5 h-5') }
      ];

      const view = { id: win.opts?.section || 'personal' };

      function navBtn(sec){
        const b = h('button', { class: 'w-full text-left menu-item', 'data-sec': sec.id }, [
          h('div', { class:'w-8 h-8 flex items-center justify-center', html: sec.icon }),
          h('div', { class:'text-sm font-semibold' }, sec.name)
        ]);
        b.addEventListener('click', () => { view.id = sec.id; render(); });
        return b;
      }

      sections.forEach(s => nav.appendChild(navBtn(s)));

      function render(){
        $$('[data-sec]', nav).forEach(b => {
          const on = b.getAttribute('data-sec') === view.id;
          b.style.background = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.16)` : '';
          b.style.border = on ? `1px solid rgba(${(ui.accent||[99,102,241]).join(',')},.22)` : '1px solid transparent';
          b.style.borderRadius = '12px';
        });
        main.innerHTML = '';
        if (view.id === 'personal') main.appendChild(sectionPersonal());
        if (view.id === 'appearance') main.appendChild(sectionAppearance());
        if (view.id === 'apps') main.appendChild(sectionApps());
        if (view.id === 'storage') main.appendChild(sectionStorage());
        if (view.id === 'system') main.appendChild(sectionSystem());
        if (view.id === 'network') main.appendChild(sectionNetwork());
      }

      function sectionAppearance(){
        const box = h('div', { class:'space-y-3' });
        box.appendChild(h('div', { class:'text-lg font-semibold' }, 'Внешний вид'));

        // scheme toggle
        const schemeCard = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Схема'),
          h('div', { class:'text-xs text-white/70 mt-1' }, 'Светлая/тёмная схема интерфейса. Сохраняется.'),
        ]);
        const schemeRow = h('div', { class:'mt-3 flex gap-2 flex-wrap' });
        const btnDark = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Тёмная');
        const btnLight = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Светлая');
        const paintScheme = () => {
          const s = ui.scheme || 'dark';
          const onDark = s !== 'light';
          btnDark.style.background = onDark ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
          btnDark.style.borderColor = onDark ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
          btnLight.style.background = !onDark ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
          btnLight.style.borderColor = !onDark ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
        };
        btnDark.addEventListener('click', () => { ui.scheme = 'dark'; persistUI(); applyUI(); paintScheme(); addNotification({ title:'Параметры', body:'Схема: тёмная.', iconHtml: registry.settings.iconHtml, source:'Параметры' }); });
        btnLight.addEventListener('click', () => { ui.scheme = 'light'; persistUI(); applyUI(); paintScheme(); addNotification({ title:'Параметры', body:'Схема: светлая.', iconHtml: registry.settings.iconHtml, source:'Параметры' }); });
        schemeRow.append(btnDark, btnLight);
        schemeCard.appendChild(schemeRow);

        // glass mode
        const glassCard = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Стекло'),
          h('div', { class:'text-xs text-white/70 mt-1' }, 'Liquid Glass включает динамические блики (beta).')
        ]);
        const glassRow = h('div', { class:'mt-3 flex gap-2 flex-wrap' });
        const btnGlassDefault = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Default');
        const btnGlassLiquid = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm flex items-center gap-2' }, [
          h('span', { class:'kbd' }, 'beta'),
          h('span', {}, 'Liquid Glass')
        ]);
        const paintGlass = () => {
          const g = ui.glassMode || 'default';
          const onL = g === 'liquid';
          btnGlassDefault.style.background = !onL ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
          btnGlassDefault.style.borderColor = !onL ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
          btnGlassLiquid.style.background = onL ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
          btnGlassLiquid.style.borderColor = onL ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
        };
        btnGlassDefault.addEventListener('click', () => { ui.glassMode = 'default'; persistUI(); applyUI(); paintGlass(); addNotification({ title:'Параметры', body:'Стекло: Default.', iconHtml: registry.settings.iconHtml, source:'Параметры' }); });
        btnGlassLiquid.addEventListener('click', () => { ui.glassMode = 'liquid'; persistUI(); applyUI(); paintGlass(); addNotification({ title:'Параметры', body:'Стекло: Liquid Glass (beta).', iconHtml: registry.settings.iconHtml, source:'Параметры' }); });
        glassRow.append(btnGlassDefault, btnGlassLiquid);
        glassCard.appendChild(glassRow);

        // icon filter quick
        const iconCard = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Иконки'),
          h('div', { class:'text-xs text-white/70 mt-1' }, 'Быстрый фильтр для иконок рабочего стола и панели задач.')
        ]);
        const iconRow = h('div', { class:'mt-3 flex gap-2 flex-wrap' });
        const presets = [
          { id:'none', name:'Без фильтра', css:'none' },
          { id:'mono', name:'Моно', css:'grayscale(1) contrast(1.08)' },
          { id:'pop', name:'Насыщенные', css:'saturate(1.2) contrast(1.05)' },
          { id:'soft', name:'Мягкие', css:'saturate(0.9) brightness(1.05)' }
        ];
        const buttons = [];
        for (const p of presets) {
          const b = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, p.name);
          b.addEventListener('click', () => {
            ui.iconFilter = p.css;
            persistUI();
            applyUI();
            buttons.forEach(x => x._paint && x._paint());
          });
          b._paint = () => {
            const on = (ui.iconFilter ?? 'none') === p.css;
            b.style.background = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
            b.style.borderColor = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
          };
          buttons.push(b);
          iconRow.appendChild(b);
        }
        buttons.forEach(x => x._paint && x._paint());
        iconCard.appendChild(iconRow);

        const links = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Больше настроек'),
          h('div', { class:'text-xs text-white/70 mt-1' }, 'Расширенная кастомизация доступна в Microsoft Store (Персонализация).'),
          (() => {
            const btn = h('button', { class:'mt-3 w-full btn text-sm' }, 'Открыть Store → Персонализация');
            btn.addEventListener('click', () => openApp('store', { searchQuery: 'Персонализация' }));
            return btn;
          })()
        ]);

        paintScheme();
        paintGlass();
        box.append(schemeCard, glassCard, iconCard, links);
        return box;
      }

      function sectionApps(){
        const box = h('div', { class:'space-y-3' });
        box.appendChild(h('div', { class:'text-lg font-semibold' }, 'Приложения'));

        const installedList = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Установленные'),
          h('div', { class:'text-xs text-white/70 mt-1' }, 'Список приложений, установленных из Microsoft Store (демо).')
        ]);

        const list = h('div', { class:'mt-3 space-y-1' });
        const ids = Array.from(state.installedApps).slice().sort((a,b) => (registry[a]?.name||a).localeCompare((registry[b]?.name||b),'ru'));
        if (!ids.length) list.appendChild(h('div', { class:'text-sm text-white/60' }, 'Нет установленных приложений.'));
        for (const id of ids) {
          const app = registry[id];
          if (!app) continue;
          const row = h('div', { class:'flex items-center gap-3 p-3 rounded-2xl border border-white/10 bg-white/5' }, [
            h('div', { class:'w-8 h-8 flex items-center justify-center', html: app.iconHtml }),
            h('div', { class:'min-w-0 flex-1' }, [
              h('div', { class:'text-sm font-semibold truncate' }, app.name),
              h('div', { class:'text-xs text-white/60' }, `appId: ${id}`)
            ]),
            (() => {
              const btn = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Открыть');
              btn.addEventListener('click', () => openApp(id));
              return btn;
            })(),
            (() => {
              const btn = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'В Store');
              btn.addEventListener('click', () => openApp('store', { focusAppId: id, searchQuery: id }));
              return btn;
            })()
          ]);
          list.appendChild(row);
        }

        installedList.appendChild(list);

        const recommend = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Рекомендуем'),
          h('div', { class:'text-xs text-white/70 mt-1' }, 'Фото и Музыка — хорошие первые приложения для теста виртуальной FS.'),
          (() => {
            const btn = h('button', { class:'mt-3 w-full btn text-sm' }, 'Открыть Store → Мультимедиа');
            btn.addEventListener('click', () => openApp('store', { searchQuery:'Мультимедиа' }));
            return btn;
          })()
        ]);

        box.append(installedList, recommend);
        return box;
      }

      function sectionStorage(){
        const box = h('div', { class:'space-y-3' });
        box.appendChild(h('div', { class:'text-lg font-semibold' }, 'Хранилище'));

        const files = Object.values(fs.files||{});
        const totalFiles = files.length;
        const blobs = fs.blobs ? Object.keys(fs.blobs).length : 0;
        const textFiles = files.filter(f => !(f.kind==='blob')).length;

        const summary = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Сводка'),
          h('div', { class:'text-xs text-white/70 mt-1' }, `Файлов: ${totalFiles} • Текстовых: ${textFiles} • Бинарных (blobs): ${blobs}`),
          h('div', { class:'text-xs text-white/60 mt-1' }, 'Демо-хранилище использует localStorage. Большие файлы могут не поместиться в браузерный лимит.')
        ]);

        const actions = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Очистка'),
          h('div', { class:'text-xs text-white/70 mt-1' }, 'Удалите медиаданные (изображения/аудио) из виртуальной FS.')
        ]);

        const btnClearMedia = h('button', { class:'mt-3 w-full btn text-sm' }, 'Очистить медиабиблиотеку (Фото/Музыка)');
        btnClearMedia.addEventListener('click', () => {
          if (!confirm('Удалить все изображения и аудио из виртуальной FS?')) return;
          const imgExts = new Set(['png','jpg','jpeg','webp','gif']);
          const audExts = new Set(['mp3','wav','ogg','m4a','aac']);
          for (const f of Object.values(fs.files||{})) {
            const ext = (f.ext || fileExt(f.name)).toLowerCase();
            if (!(imgExts.has(ext) || audExts.has(ext))) continue;
            if (fs.blobs?.[f.id]) delete fs.blobs[f.id];
            delete fs.files[f.id];
          }
          for (const k of Object.keys(fs)) {
            if (!Array.isArray(fs[k])) continue;
            fs[k] = fs[k].filter(it => {
              if (it?.type !== 'file') return true;
              const ff = fs.files?.[it.fileId];
              if (!ff) return false;
              const ext = (ff.ext || fileExt(ff.name)).toLowerCase();
              return !(imgExts.has(ext) || audExts.has(ext));
            });
          }
          fsSave(fs);
          addNotification({ title:'Хранилище', body:'Медиабиблиотека очищена.', iconHtml: registry.settings.iconHtml, source:'Параметры' });
          refreshWindowContent(win.id);
        });
        actions.appendChild(btnClearMedia);

        const btnOpenExplorer = h('button', { class:'mt-2 w-full btn text-sm' }, 'Открыть Проводник');
        btnOpenExplorer.addEventListener('click', () => openApp('explorer'));
        actions.appendChild(btnOpenExplorer);

        const resetCard = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Сброс'),
          h('div', { class:'text-xs text-white/70 mt-1' }, 'Сброс до заводских настроек: очистит локальные данные (файлы, настройки, приложения) и перезагрузит симуляцию.')
        ]);
        const btnFactory = h('button', { class:'mt-3 w-full btn text-sm' }, 'Сброс до заводских настроек');
        btnFactory.addEventListener('click', () => {
          if (!confirm('Сбросить симуляцию до заводских настроек? Будут удалены все файлы и настройки.')) return;
          try {
            const keys = [FS_KEY, UI_KEY, VSC_KEY, TODO_KEY, MUSIC_KEY, NOTES_KEY, 'w12_phone_warned_v1'];
            keys.forEach(k => { try{ localStorage.removeItem(k); }catch{} });
          } catch {}
          location.reload();
        });
        resetCard.appendChild(btnFactory);

        box.append(summary, actions, resetCard);
        return box;
      }

      function sectionSystem(){
        const box = h('div', { class: 'space-y-3' });
        box.append(
          h('div', { class:'text-lg font-semibold' }, 'Система'),

          // Sounds
          h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
            h('div', { class:'text-sm font-semibold' }, 'Звуки'),
            h('div', { class:'text-xs text-white/70 mt-1' }, 'Системные звуки (демо).'),
            (() => {
              const row = h('div', { class:'mt-3 flex items-center justify-between gap-3' });
              const left = h('div', { class:'text-sm text-white/80' }, 'Включить звуки');
              const btn = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' });
              const paint = () => {
                btn.textContent = state.soundsEnabled ? 'Включено' : 'Выключено';
                btn.style.background = state.soundsEnabled ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
                btn.style.borderColor = state.soundsEnabled ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
              };
              btn.addEventListener('click', () => {
                state.soundsEnabled = !state.soundsEnabled;
                persistUI();
                paint();
                addNotification({ title:'Параметры', body:`Звуки: ${state.soundsEnabled ? 'включены' : 'выключены'}.`, iconHtml: registry.settings.iconHtml, source:'Параметры' });
                // tiny test click
                SFX.click();
              });
              paint();
              row.append(left, btn);
              return row;
            })(),
            h('div', { class:'mt-3 text-xs text-white/60' }, 'Подсказка: браузер может блокировать звук до первого клика по странице.')
          ]),

          // Volume
          h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
            h('div', { class:'text-sm font-semibold' }, 'Громкость'),
            h('div', { class:'text-xs text-white/70 mt-1' }, 'Громкость системы (визуально влияет на трей).'),
            h('div', { class:'mt-3 flex items-center gap-3' }, [
              h('div', { class:'w-6 h-6', html: (state.volume===0?Icons.volumeMute('w-6 h-6'):Icons.volume('w-6 h-6')) }),
              (() => {
                const r = h('input', { type:'range', min:'0', max:'100', value:String(state.volume), class:'w-full' });
                r.addEventListener('input', () => {
                  state.volume = Number(r.value);
                  persistUI();
                  updateTaskbar();
                });
                r.addEventListener('change', () => addNotification({ title:'Звук', body:`Громкость: ${state.volume}%`, iconHtml: Icons.volume('w-6 h-6'), source:'Параметры' }));
                return r;
              })()
            ])
          ]),

          // Account
          h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
            h('div', { class:'text-sm font-semibold' }, 'Аккаунт'),
            h('div', { class:'text-xs text-white/70 mt-1' }, 'Имя пользователя и пароль входа. Если пароль задан — при запуске будет экран входа.'),
            (() => {
              const row = h('div', { class:'mt-3 grid sm:grid-cols-2 gap-2' });
              const inName = h('input', { class:'bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60', placeholder:'Имя пользователя', value: state.account?.username || 'Локальный пользователь' });
              const inPass = h('input', { type:'password', class:'bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60', placeholder:'Новый пароль (пусто = без пароля)' });
              row.append(inName, inPass);

              const actions = h('div', { class:'mt-3 flex gap-2 flex-wrap' });
              const btnSaveAcc = h('button', { class:'btn text-sm' }, 'Сохранить');
              const btnClearPass = h('button', { class:'btn text-sm' }, 'Убрать пароль');

              btnSaveAcc.addEventListener('click', () => {
                const nm = (inName.value || '').trim() || 'Локальный пользователь';
                const pw = (inPass.value || '').trim();
                state.account = state.account || { username:'Локальный пользователь', password:null };
                state.account.username = nm;
                if (pw) state.account.password = pw;
                persistUI();
                // Update UI bits
                $('#btnUser') && ($('#btnUser').querySelector('span.text-sm') ? ($('#btnUser').querySelector('span.text-sm').textContent = nm) : null);
                $('#lockUserName') && ($('#lockUserName').textContent = nm);
                addNotification({ title:'Параметры', body:'Аккаунт сохранён.', iconHtml: registry.settings.iconHtml, source:'Параметры' });
                inPass.value = '';
              });

              btnClearPass.addEventListener('click', () => {
                if (!confirm('Убрать пароль входа?')) return;
                state.account = state.account || { username:'Локальный пользователь', password:null };
                state.account.password = null;
                persistUI();
                addNotification({ title:'Параметры', body:'Пароль убран. При следующем запуске вход не потребуется.', iconHtml: registry.settings.iconHtml, source:'Параметры' });
              });

              return h('div', {}, [row, actions.append(btnSaveAcc, btnClearPass) || actions]);
            })()
          ]),

          // Notifications
          h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
            h('div', { class:'text-sm font-semibold' }, 'Уведомления'),
            h('div', { class:'text-xs text-white/70 mt-1' }, 'Всплывающие тосты отключены по умолчанию.'),
            (() => {
              const row = h('div', { class:'mt-3 flex items-center justify-between gap-3' });
              const left = h('div', { class:'text-sm text-white/80' }, 'Показывать всплывающие уведомления');
              const btn = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' });
              const renderBtn = () => {
                btn.textContent = state.showToasts ? 'Включено' : 'Выключено';
                btn.style.background = state.showToasts ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
                btn.style.borderColor = state.showToasts ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
              };
              btn.addEventListener('click', () => {
                state.showToasts = !state.showToasts;
                persistUI();
                renderBtn();
                addNotification({ title:'Параметры', body:`Тосты: ${state.showToasts ? 'включены' : 'выключены'}.`, iconHtml: registry.settings.iconHtml, source:'Параметры' });
              });
              renderBtn();
              row.append(left, btn);
              return row;
            })()
          ]),

          // Fullscreen
          h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
            h('div', { class:'text-sm font-semibold' }, 'Полноэкранный режим (браузер)'),
            h('div', { class:'text-xs text-white/70 mt-1' }, 'Использует Fullscreen API. Браузер может запросить подтверждение.'),
            (() => {
              const row = h('div', { class:'mt-3 flex items-center justify-between gap-3' });
              const left = h('div', { class:'text-sm text-white/80' }, 'Открыть «Windows 12» во весь экран');
              const btn = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' });
              const paint = () => {
                const on = isBrowserFullscreen();
                btn.textContent = on ? 'Включено' : 'Выключено';
                btn.style.background = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
                btn.style.borderColor = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
              };
              btn.addEventListener('click', async () => {
                await setBrowserFullscreen(!isBrowserFullscreen());
                paint();
                addNotification({ title:'Параметры', body:`Полноэкранный режим: ${isBrowserFullscreen() ? 'включен' : 'выключен'}.`, iconHtml: registry.settings.iconHtml, source:'Параметры' });
              });
              paint();
              row.append(left, btn);
              return row;
            })()
          ]),

          // About
          h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
            h('div', { class:'text-sm font-semibold' }, 'О системе'),
            h('div', { class:'text-sm text-white/80 mt-2' }, 'Windows 12 (UI Simulation)'),
            h('div', { class:'text-xs text-white/70 mt-1' }, `Версия: ${W12_VERSION} • Build: ${W12_BUILD}`),
            h('div', { class:'text-xs text-white/70 mt-1' , html: 'Создатель - <a href="https://t.me/Vriskas_official" target="_blank" rel="noopener" class="underline hover:opacity-90">тык</a>' }),
            h('div', { class:'text-xs text-white/60 mt-1' }, 'Это веб-симуляция интерфейса ОС. Не является настоящей операционной системой.')
          ])
        );
        return box;
      }

      function sectionNetwork(){
        const box = h('div', { class:'space-y-3' });
        const mkToggle = (key, title, desc) => {
          const row = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5 flex items-center justify-between gap-4' });
          const left = h('div', {}, [
            h('div', { class:'text-sm font-semibold' }, title),
            h('div', { class:'text-xs text-white/70 mt-1' }, desc)
          ]);
          const btn = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' });
          function renderBtn(){
            btn.textContent = state.toggles[key] ? 'Включено' : 'Выключено';
            btn.style.background = state.toggles[key] ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
            btn.style.borderColor = state.toggles[key] ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
          }
          btn.addEventListener('click', () => { setToggle(key, !state.toggles[key]); renderBtn(); });
          renderBtn();
          row.append(left, btn);
          return row;
        };

        box.append(
          h('div', { class:'text-lg font-semibold' }, 'Сеть'),
          mkToggle('wifi','Wi‑Fi','В этой симуляции влияет на иконку в трее'),
          mkToggle('bt','Bluetooth','Демо-переключатель'),
          mkToggle('night','Ночной свет','Реализовано отдельным оверлеем (не ломает панель задач)')
        );
        return box;
      }

      function sectionPersonal(){
        const box = h('div', { class: 'space-y-3' });
        box.appendChild(h('div', { class: 'text-lg font-semibold' }, 'Персонализация'));

        const accents = [
          { name:'Индиго', rgb:[99,102,241] },
          { name:'Синий', rgb:[59,130,246] },
          { name:'Бирюзовый', rgb:[34,211,238] },
          { name:'Зелёный', rgb:[34,197,94] },
          { name:'Розовый', rgb:[244,114,182] },
          { name:'Оранжевый', rgb:[249,115,22] }
        ];

        const accentCard = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Цвет акцента'),
          h('div', { class:'text-xs text-white/70 mt-1' }, 'Используется для подчёркивания активных элементов и Snap.'),
          h('div', { class:'mt-3 grid grid-cols-6 gap-2' }, accents.map(a => {
            const b = h('button', {
              class:'h-10 rounded-xl border border-white/10 hover:scale-[1.02] transition',
              title: a.name
            });
            b.style.background = `rgb(${a.rgb.join(',')})`;
            const isOn = (ui.accent||[]).join(',') === a.rgb.join(',');
            if (isOn) b.style.outline = '3px solid rgba(255,255,255,.35)';
            b.addEventListener('click', () => {
              ui.accent = a.rgb;
              persistUI();
              applyUI();
              addNotification({ title:'Персонализация', body:`Акцент: ${a.name}`, iconHtml: registry.settings.iconHtml, source:'Параметры' });
              refreshWindowContent(win.id);
              updateTaskbar();
            });
            return b;
          }))
        ]);

        const transCard = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Эффекты прозрачности'),
          h('div', { class:'text-xs text-white/70 mt-1' }, 'Выключите, если эффект «стекла» тормозит или мерцает на вашем устройстве.'),
          (() => {
            const row = h('div', { class:'mt-3 flex items-center justify-between gap-3' });
            const left = h('div', { class:'text-sm text-white/80' }, 'Прозрачность (Acrylic)');
            const btn = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' });
            const renderBtn = () => {
              btn.textContent = state.transparency ? 'Включено' : 'Выключено';
              btn.style.background = state.transparency ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
              btn.style.borderColor = state.transparency ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
            };
            btn.addEventListener('click', () => {
              state.transparency = !state.transparency;
              persistUI();
              applyUI();
              renderBtn();
              addNotification({ title:'Персонализация', body:`Прозрачность: ${state.transparency ? 'включена' : 'выключена'}.`, iconHtml: registry.settings.iconHtml, source:'Параметры' });
            });
            renderBtn();
            row.append(left, btn);
            return row;
          })()
        ]);

        const wpCard = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Фон рабочего стола'),
          h('div', { class:'text-xs text-white/70 mt-1' }, 'Выберите один из предустановленных градиентов.')
        ]);

        const wpGrid = h('div', { class:'mt-3 grid grid-cols-2 gap-2' });
        for (const [key, val] of Object.entries(Wallpapers)) {
          const b = h('button', { class:'p-3 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-left' });
          const thumb = h('div', { class:'h-16 rounded-xl border border-white/10', style:`background:${val};` });
          const title = h('div', { class:'mt-2 text-sm font-semibold' }, key);
          const sub = h('div', { class:'text-xs text-white/60' }, ui.wallpaper === key ? 'Выбрано' : '');
          b.append(thumb, title, sub);
          b.addEventListener('click', () => {
            ui.wallpaper = key;
            persistUI();
            applyUI();
            addNotification({ title:'Персонализация', body:`Фон: ${key}`, iconHtml: registry.settings.iconHtml, source:'Параметры' });
            refreshWindowContent(win.id);
          });
          wpGrid.appendChild(b);
        }
        wpCard.appendChild(wpGrid);

        const nyCard = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Новый год'),
          h('div', { class:'text-xs text-white/70 mt-1' }, 'Снег и гирлянда поверх рабочего стола (демо-эффект).'),
          (() => {
            const row = h('div', { class:'mt-3 flex items-center justify-between gap-3' });
            const left = h('div', { class:'text-sm text-white/80' }, 'Новогодние эффекты');
            const btn = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' });
            const paint = () => {
              btn.textContent = state.newYear ? 'Включено' : 'Выключено';
              btn.style.background = state.newYear ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
              btn.style.borderColor = state.newYear ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
            };
            btn.addEventListener('click', () => {
              state.newYear = !state.newYear;
              persistUI();
              applyUI();
              paint();
              addNotification({ title:'Персонализация', body:`Новый год: ${state.newYear ? 'включено' : 'выключено'}.`, iconHtml: registry.settings.iconHtml, source:'Параметры' });
            });
            paint();
            row.append(left, btn);
            return row;
          })()
        ]);

        const moreCard = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
          h('div', { class:'text-sm font-semibold' }, 'Больше персонализации'),
          h('div', { class:'text-xs text-white/70 mt-1' }, 'Больше обоев, тем и других возможностей — в приложении Microsoft Store.'),
          (() => {
            const btn = h('button', { class:'mt-3 px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm w-full' }, 'Открыть Microsoft Store → Персонализация');
            btn.addEventListener('click', () => {
              openApp('store', { searchQuery: 'Персонализация' });
            });
            return btn;
          })()
        ]);

        box.append(accentCard, transCard, nyCard, wpCard, moreCard);
        return box;
      }

      render();
      layout.append(nav, main);
      wrap.append(header, layout);
      return wrap;
    }

    // ---------- VS Code (demo) ----------
    const VSC_KEY = 'w12_vscode_v1';
    function vscLoad(){
      try { const raw = localStorage.getItem(VSC_KEY); if (raw) return JSON.parse(raw); } catch {}
      return {
        tabs: [
          { tid: uid(), name:'main.js', lang:'js', content:`// VS Code (demo)\n// Автосохранение работает через localStorage\n\nfunction hello(){\n  console.log('Hello, Windows 12 UI');\n}\n\nhello();\n` }
        ],
        activeTid: null
      };
    }
    function vscSave(v){ localStorage.setItem(VSC_KEY, JSON.stringify(v)); }

    function buildVSCode(win){
      win.opts = win.opts || {};
      win.opts.vsc = win.opts.vsc || vscLoad();
      const model = win.opts.vsc;
      if (!model.activeTid) model.activeTid = model.tabs[0]?.tid;

      const wrap = h('div', { class:'p-0 h-full flex flex-col' });

      const top = h('div', { class:'p-3 border-b border-white/10 bg-white/5 flex items-center gap-2 flex-wrap' }, [
        h('div', { class:'w-6 h-6', html: registry.vscode.iconHtml }),
        h('div', { class:'text-sm font-semibold' }, 'Visual Studio Code (демо)'),
        h('div', { class:'ml-auto flex items-center gap-2 flex-wrap' })
      ]);

      const btnNew = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Новый');
      const btnOpen = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Открыть файл');
      const btnSave = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Сохранить');
      const btnExport = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Экспорт');
      const btnFormat = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Формат');
      const right = top.lastChild;
      right.append(btnNew, btnOpen, btnSave, btnExport, btnFormat);

      const body = h('div', { class:'flex-1 grid grid-cols-[260px_1fr] min-h-0' });
      const sidebar = h('div', { class:'border-r border-white/10 bg-white/3 p-2 overflow-auto scrollbar' });
      const main = h('div', { class:'min-h-0 flex flex-col' });

      const tabStrip = h('div', { class:'p-2 flex items-center gap-2 overflow-auto scrollbar border-b border-white/10 bg-white/3' });

      const editorWrap = h('div', { class:'flex-1 min-h-0 relative' });
      const editor = h('textarea', {
        class:'absolute inset-0 w-full h-full bg-black/25 border-0 outline-none p-4 font-mono text-sm text-white/90 resize-none scrollbar',
        style:'user-select:text;'
      });
      editorWrap.appendChild(editor);

      const status = h('div', { class:'px-3 py-2 border-t border-white/10 bg-white/5 text-xs text-white/70 flex items-center justify-between' }, [
        h('div', { id:`vscStatus_${win.id}` }, 'Готово'),
        h('div', { id:`vscMeta_${win.id}` }, '')
      ]);

      // Find (Ctrl+F)
      const findRow = h('div', { class:'hidden px-2 py-2 border-b border-white/10 bg-white/3 flex items-center gap-2' });
      const findInp = h('input', { class:'flex-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60 font-mono text-sm', placeholder:'Найти…' });
      const btnFindNext = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Далее');
      const btnFindClose = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Закрыть');
      findRow.append(findInp, btnFindNext, btnFindClose);

      main.append(tabStrip, findRow, editorWrap, status);
      body.append(sidebar, main);

      // Sidebar: files from virtual FS
      sidebar.appendChild(h('div', { class:'text-xs px-2 py-2 text-white/60' }, 'Файлы (виртуальная FS)'));
      const fileList = h('div', { class:'space-y-1' });
      sidebar.appendChild(fileList);

      function activeTab(){ return model.tabs.find(t => t.tid === model.activeTid) || model.tabs[0]; }

      function setStatus(msg){
        const el = document.getElementById(`vscStatus_${win.id}`);
        if (el) el.textContent = msg;
      }

      function setMeta(){
        const t = activeTab();
        const el = document.getElementById(`vscMeta_${win.id}`);
        if (!el || !t) return;
        el.textContent = `${t.lang.toUpperCase()} • Автосохранение`;
      }

      function guessLang(name){
        const n = (name||'').toLowerCase();
        if (n.endsWith('.js')) return 'js';
        if (n.endsWith('.html')) return 'html';
        if (n.endsWith('.css')) return 'css';
        if (n.endsWith('.json')) return 'json';
        if (n.endsWith('.md')) return 'md';
        return 'txt';
      }

      function renderTabs(){
        tabStrip.innerHTML = '';
        for (const t of model.tabs) {
          const on = t.tid === model.activeTid;
          const tab = h('div', { class:`flex items-center gap-2 px-3 py-2 rounded-2xl border ${on ? 'bg-white/10 border-white/15' : 'bg-white/5 border-white/10'} hover:bg-white/10 transition` });
          const label = (t.dirty ? '● ' : '') + t.name;
          const name = h('button', { class:'text-xs font-semibold max-w-[180px] truncate' }, label);
          name.addEventListener('click', () => { model.activeTid = t.tid; renderTabs(); renderEditor(); });
          const close = h('button', { class:'text-xs px-2 py-1 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10', title:'Закрыть' }, '×');
          close.addEventListener('click', (e) => {
            e.stopPropagation();
            if (model.tabs.length <= 1) return;
            const idx = model.tabs.findIndex(x => x.tid === t.tid);
            model.tabs.splice(idx,1);
            if (model.activeTid === t.tid) model.activeTid = model.tabs[Math.max(0, idx-1)].tid;
            vscSave(model);
            renderTabs();
            renderEditor();
          });
          tab.append(name, close);
          tabStrip.appendChild(tab);
        }
        const plus = h('button', { class:'px-3 py-2 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, '+');
        plus.addEventListener('click', () => newTab());
        tabStrip.appendChild(plus);
      }

      function renderFiles(){
        fileList.innerHTML = '';
        const files = Object.values(fs.files || {}).slice().sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
        if (!files.length) fileList.appendChild(h('div', { class:'text-sm text-white/60 px-2 py-2' }, 'Файлов нет'));
        for (const f of files.slice(0, 40)) {
          const row = h('button', { class:'w-full text-left menu-item' }, [
            h('div', { class:'w-8 h-8 flex items-center justify-center', html: Icons.note('w-6 h-6') }),
            h('div', { class:'min-w-0 flex-1' }, [
              h('div', { class:'text-sm font-semibold truncate' }, f.name),
              h('div', { class:'text-xs text-white/60 truncate' }, new Date(f.updatedAt||Date.now()).toLocaleString('ru-RU'))
            ])
          ]);
          row.addEventListener('click', () => {
            // open as tab
            const existing = model.tabs.find(t => t.fileId === f.id);
            if (existing) { model.activeTid = existing.tid; renderTabs(); renderEditor(); return; }
            const t = { tid: uid(), name: f.name, lang: guessLang(f.name), content: String(f.content||''), fileId: f.id };
            model.tabs.push(t);
            model.activeTid = t.tid;
            vscSave(model);
            renderTabs();
            renderEditor();
            setStatus('Открыт файл из FS');
          });
          fileList.appendChild(row);
        }
      }

      function renderEditor(){
        const t = activeTab();
        if (!t) return;
        editor.value = t.content || '';
        setMeta();
      }

      function newTab(){
        const name = prompt('Имя файла:', 'untitled.js');
        if (!name) return;
        const t = { tid: uid(), name, lang: guessLang(name), content: '' };
        model.tabs.push(t);
        model.activeTid = t.tid;
        vscSave(model);
        renderTabs();
        renderEditor();
      }

      async function openLocalFile(){
        const input = document.createElement('input');
        input.type = 'file';
        input.onchange = async () => {
          const f = input.files?.[0];
          if (!f) return;
          const text = await readFileAsText(f);
          const t = { tid: uid(), name: f.name, lang: guessLang(f.name), content: text };
          model.tabs.push(t);
          model.activeTid = t.tid;
          vscSave(model);
          renderTabs();
          renderEditor();
          setStatus('Открыт локальный файл');
        };
        input.click();
      }

      function saveToFSOrCreate(){
        const t = activeTab();
        if (!t) return;
        // if bound to FS file
        if (t.fileId && fs.files[t.fileId]) {
          fs.files[t.fileId].content = editor.value;
          fs.files[t.fileId].updatedAt = Date.now();
          fsSave(fs);
          setStatus('Сохранено в виртуальную FS');
          addNotification({ title:'VS Code', body:`Сохранено: ${fs.files[t.fileId].name}`, iconHtml: registry.vscode.iconHtml, source:'VS Code' });
          renderFiles();
          return;
        }
        // create new FS file
        const id = uid();
        fs.files[id] = { id, name: t.name, ext: (t.name.split('.').pop()||'txt'), updatedAt: Date.now(), content: editor.value };
        fs.desktop.unshift({ did: uid(), type:'file', fileId: id, name: t.name, ext: 'txt', pos: findFreeDesktopSlot() });
        fsSave(fs);
        renderDesktopIcons();
        t.fileId = id;
        setStatus('Создан и сохранён файл в FS');
        addNotification({ title:'VS Code', body:`Создан файл: ${t.name}`, iconHtml: registry.vscode.iconHtml, source:'VS Code' });
        renderFiles();
      }

      function exportFile(){
        const t = activeTab();
        if (!t) return;
        downloadText(t.name, editor.value);
        setStatus('Экспортировано');
      }

      function formatSimple(){
        const text = editor.value;
        // very simple formatter: trim trailing spaces + normalize blank lines
        const out = text.split('\n').map(l => l.replace(/\s+$/,'')).join('\n').replace(/\n{4,}/g,'\n\n\n');
        editor.value = out;
        editor.dispatchEvent(new Event('input'));
        setStatus('Форматирование (простое)');
      }

      // events
      editor.addEventListener('input', () => {
        const t = activeTab();
        if (!t) return;
        t.content = editor.value;
        t.dirty = true;
        vscSave(model);
        renderTabs();
        setStatus('Изменения сохранены');
        // debounce status
        clearTimeout(win.opts._vscStatusTimer);
        win.opts._vscStatusTimer = setTimeout(() => setStatus('Готово'), 900);
      });

      btnNew.addEventListener('click', newTab);
      btnOpen.addEventListener('click', openLocalFile);
      btnSave.addEventListener('click', () => { saveToFSOrCreate(); const t = activeTab(); if (t) { t.dirty = false; vscSave(model); renderTabs(); } });
      btnExport.addEventListener('click', exportFile);
      btnFormat.addEventListener('click', formatSimple);

      // Find handlers
      function doFindNext(){
        const q = (findInp.value || '').trim();
        if (!q) return;
        const text = editor.value;
        const start = editor.selectionEnd ?? 0;
        const idx = text.toLowerCase().indexOf(q.toLowerCase(), start);
        const idx2 = idx === -1 ? text.toLowerCase().indexOf(q.toLowerCase(), 0) : idx;
        if (idx2 === -1) { setStatus('Не найдено'); return; }
        editor.focus();
        editor.setSelectionRange(idx2, idx2 + q.length);
        setStatus('Найдено');
      }
      btnFindNext.addEventListener('click', doFindNext);
      findInp.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); doFindNext(); }
        if (e.key === 'Escape') { e.preventDefault(); findRow.classList.add('hidden'); editor.focus(); }
      });
      btnFindClose.addEventListener('click', () => { findRow.classList.add('hidden'); editor.focus(); });

      wrap.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') { e.preventDefault(); btnSave.click(); }
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'o') { e.preventDefault(); openLocalFile(); }
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
          e.preventDefault();
          findRow.classList.remove('hidden');
          findInp.focus();
          findInp.select();
        }
        if (e.key === 'Escape' && !findRow.classList.contains('hidden')) {
          e.preventDefault();
          findRow.classList.add('hidden');
          editor.focus();
        }
      });

      // Auto-open file if requested (for Explorer → "Open in VS")
      if (win.opts.openFileId && fs.files[win.opts.openFileId]) {
        const f = fs.files[win.opts.openFileId];
        const existing = model.tabs.find(t => t.fileId === f.id);
        if (existing) {
          model.activeTid = existing.tid;
        } else {
          const t = { tid: uid(), name: f.name, lang: guessLang(f.name), content: String(f.content||''), fileId: f.id, dirty: false };
          model.tabs.push(t);
          model.activeTid = t.tid;
        }
        win.opts.openFileId = null;
        vscSave(model);
      }

      renderTabs();
      renderFiles();
      renderEditor();
      setMeta();

      wrap.appendChild(top);
      wrap.appendChild(body);
      return wrap;
    }

    // ---------- Wallpapers app (100 demo wallpapers) ----------
    const WLP100 = (() => {
      const arr = [];
      for (let i=0;i<100;i++){
        const a = (i*37)%360;
        const b = (a+120+(i%7)*9)%360;
        const c = (a+240+(i%11)*7)%360;
        const s1 = 62 + (i%8)*3;
        const s2 = 54 + (i%6)*4;
        const l1 = 26 + (i%10);
        const l2 = 18 + (i%9);
        const l3 = 22 + (i%7);
        const g = `radial-gradient(900px 650px at 15% 20%, hsla(${a}, ${s1}%, ${l1}%, .55), transparent 60%),
                   radial-gradient(900px 650px at 80% 70%, hsla(${b}, ${s2}%, ${l2}%, .45), transparent 62%),
                   radial-gradient(900px 650px at 55% 85%, hsla(${c}, 70%, ${l3}%, .35), transparent 60%),
                   linear-gradient(180deg, #070B16, #060915)`;
        arr.push({ id:i, name:`WLP-${String(i+1).padStart(3,'0')}`, css:g });
      }
      return arr;
    })();

    function buildWallpapersApp(win){
      win.opts = win.opts || {};
      win.opts.sel = win.opts.sel ?? 0;

      const wrap = h('div', { class:'p-3' });
      const header = h('div', { class:'flex items-center gap-2 flex-wrap' }, [
        h('div', { class:'w-6 h-6', html: registry.wallpapers.iconHtml }),
        h('div', { class:'text-lg font-semibold' }, 'Обои'),
        h('div', { class:'ml-auto text-xs text-white/60' }, 'Неофициально • 100 шт.')
      ]);

      const desc = h('div', { class:'mt-2 text-xs text-white/70' }, 'Выберите обои и нажмите «Применить». Они сохранятся и будут использоваться как фон рабочего стола.');

      const layout = h('div', { class:'mt-3 grid grid-cols-1 lg:grid-cols-[1fr_320px] gap-3 items-start' });
      const grid = h('div', { class:'grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 max-h-[520px] overflow-auto scrollbar pr-1' });
      const side = h('div', { class:'p-3 rounded-2xl border border-white/10 bg-white/5' });

      const preview = h('div', { class:'h-44 rounded-2xl border border-white/10', style:`background:${WLP100[win.opts.sel]?.css || Wallpapers.aurora};` });
      const name = h('div', { class:'mt-3 text-sm font-semibold' }, WLP100[win.opts.sel]?.name || '—');
      const sub = h('div', { class:'text-xs text-white/60 mt-1' }, 'Формат: градиент (CSS)');

      const btnApply = h('button', { class:'mt-3 w-full px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Применить');
      btnApply.style.background = `rgba(${(ui.accent||[99,102,241]).join(',')},.18)`;
      btnApply.style.borderColor = `rgba(${(ui.accent||[99,102,241]).join(',')},.28)`;

      const btnReset = h('button', { class:'mt-2 w-full px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Сбросить на системные');
      const btnCopy = h('button', { class:'mt-2 w-full px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Скопировать CSS');

      function paintSel(){
        const w = WLP100[win.opts.sel];
        preview.style.background = w?.css || Wallpapers.aurora;
        name.textContent = w?.name || '—';
      }

      btnApply.addEventListener('click', () => {
        const w = WLP100[win.opts.sel];
        if (!w) return;
        ui.wallpaperCustom = w.css;
        persistUI();
        applyUI();
        addNotification({ title:'Обои', body:`Применено: ${w.name}`, iconHtml: registry.wallpapers.iconHtml, source:'Обои' });
      });

      btnReset.addEventListener('click', () => {
        ui.wallpaperCustom = null;
        persistUI();
        applyUI();
        addNotification({ title:'Обои', body:'Сброшено на системные обои.', iconHtml: registry.wallpapers.iconHtml, source:'Обои' });
      });

      btnCopy.addEventListener('click', async () => {
        const w = WLP100[win.opts.sel];
        if (!w) return;
        try {
          await navigator.clipboard.writeText(w.css);
          addNotification({ title:'Обои', body:'CSS скопирован в буфер обмена.', iconHtml: registry.wallpapers.iconHtml, source:'Обои' });
        } catch {
          downloadText(`${w.name}.css.txt`, w.css);
          addNotification({ title:'Обои', body:'Не удалось скопировать. CSS скачан как файл.', iconHtml: registry.wallpapers.iconHtml, source:'Обои' });
        }
      });

      // build grid
      WLP100.forEach((w, idx) => {
        const b = h('button', { class:'p-2 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-left transition' });
        const th = h('div', { class:'h-16 rounded-xl border border-white/10', style:`background:${w.css};` });
        const t = h('div', { class:'mt-2 text-[12px] text-white/80' }, w.name);
        b.append(th, t);
        const paint = () => {
          const on = win.opts.sel === idx;
          b.style.outline = on ? `2px solid rgba(${(ui.accent||[99,102,241]).join(',')},.55)` : 'none';
        };
        paint();
        b.addEventListener('click', () => {
          win.opts.sel = idx;
          paintSel();
          // repaint outlines cheaply
          Array.from(grid.children).forEach(ch => ch.style.outline = 'none');
          paint();
        });
        grid.appendChild(b);
      });

      paintSel();
      side.append(preview, name, sub, btnApply, btnReset, btnCopy);
      layout.append(grid, side);
      wrap.append(header, desc, layout);
      return wrap;
    }

    // ---------- Mini games ----------

    function buildSnake(win){
      const wrap = h('div', { class:'p-3' });

      const title = h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
        h('div', { class:'flex items-center gap-2' }, [
          h('div', { class:'w-6 h-6', html: registry.snake.iconHtml }),
          h('div', { class:'text-lg font-semibold' }, 'Змейка')
        ]),
        h('div', { class:'text-sm text-white/70' }, 'Управление: стрелки / WASD • Space — пауза')
      ]);

      const panel = h('div', { class:'mt-3 game-panel' });
      const top = h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
        h('div', { class:'text-sm font-semibold' }, 'Счёт: '),
        h('div', { class:'ml-auto flex gap-2 flex-wrap items-center' })
      ]);
      const scoreEl = h('span', { class:'text-sm font-semibold' }, '0');
      top.firstChild.appendChild(scoreEl);

      const speedSel = h('select', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, [
        h('option', { value:'1' }, 'Скорость: Низкая'),
        h('option', { value:'2', selected:'selected' }, 'Скорость: Средняя'),
        h('option', { value:'3' }, 'Скорость: Высокая')
      ]);

      const btnStart = h('button', { class:'btn text-sm' }, 'Старт');
      const btnReset = h('button', { class:'btn text-sm' }, 'Сброс');
      top.lastChild.append(speedSel, btnStart, btnReset);

      const canvas = h('canvas', { class:'mt-3 w-full rounded-2xl border border-white/10 bg-black/20', width:'520', height:'520' });
      const hint = h('div', { class:'text-xs text-white/70 mt-3' }, 'Съедайте яблоки. Нельзя врезаться в себя или стены.' );

      panel.append(top, canvas, hint);
      wrap.append(title, panel);

      const ctx = canvas.getContext('2d');
      const cell = 20;
      const cols = Math.floor(canvas.width / cell);
      const rows = Math.floor(canvas.height / cell);

      let snake, dir, nextDir, apple, score, running, paused, tickId;

      const speeds = {
        1: 145,
        2: 105,
        3: 75
      };

      function randApple(){
        let p;
        const occ = new Set(snake.map(s => s.x + ',' + s.y));
        for (let tries=0; tries<2000; tries++){
          p = { x: Math.floor(Math.random()*cols), y: Math.floor(Math.random()*rows) };
          if (!occ.has(p.x + ',' + p.y)) return p;
        }
        return { x: 2, y: 2 };
      }

      function setScore(v){
        score = v;
        scoreEl.textContent = String(score);
      }

      function reset(){
        snake = [
          { x: Math.floor(cols/2), y: Math.floor(rows/2) },
          { x: Math.floor(cols/2)-1, y: Math.floor(rows/2) },
          { x: Math.floor(cols/2)-2, y: Math.floor(rows/2) }
        ];
        dir = { x: 1, y: 0 };
        nextDir = { x: 1, y: 0 };
        apple = randApple();
        setScore(0);
        running = false;
        paused = false;
        draw(true);
      }

      function start(){
        if (running) return;
        running = true;
        paused = false;
        btnStart.textContent = 'Пауза';
        scheduleTick();
      }

      function stop(){
        running = false;
        paused = false;
        btnStart.textContent = 'Старт';
        if (tickId) clearInterval(tickId);
        tickId = null;
      }

      function togglePause(){
        if (!running) { start(); return; }
        paused = !paused;
        btnStart.textContent = paused ? 'Продолжить' : 'Пауза';
        draw();
      }

      function scheduleTick(){
        if (tickId) clearInterval(tickId);
        const sp = clamp(Number(speedSel.value||2), 1, 3);
        tickId = setInterval(() => {
          if (!state.windows.has(win.id)) return;
          if (!running || paused) return;
          step();
        }, speeds[sp] || speeds[2]);
        registerOnClose(win.id, () => { if (tickId) clearInterval(tickId); });
      }

      function step(){
        // apply buffered direction
        dir = nextDir;

        const head = snake[0];
        const nx = head.x + dir.x;
        const ny = head.y + dir.y;

        // wall collision
        if (nx < 0 || ny < 0 || nx >= cols || ny >= rows) {
          gameOver();
          return;
        }

        // self collision
        for (const s of snake) {
          if (s.x === nx && s.y === ny) {
            gameOver();
            return;
          }
        }

        const newHead = { x: nx, y: ny };
        snake.unshift(newHead);

        // eat
        if (nx === apple.x && ny === apple.y) {
          setScore(score + 1);
          apple = randApple();
        } else {
          snake.pop();
        }

        draw();
      }

      function gameOver(){
        stop();
        draw(true);
        addNotification({ title:'Змейка', body:`Игра окончена. Счёт: ${score}`, iconHtml: registry.snake.iconHtml, source:'Игры' });
      }

      function draw(showOverlay=false){
        ctx.clearRect(0,0,canvas.width,canvas.height);

        // background grid
        ctx.fillStyle = 'rgba(255,255,255,.03)';
        for (let x=0;x<cols;x++){
          for (let y=0;y<rows;y++){
            if ((x+y)%2===0) ctx.fillRect(x*cell, y*cell, cell, cell);
          }
        }

        // apple
        ctx.fillStyle = 'rgba(239,68,68,.9)';
        ctx.beginPath();
        ctx.arc(apple.x*cell + cell/2, apple.y*cell + cell/2, cell*0.33, 0, Math.PI*2);
        ctx.fill();

        // snake
        for (let i=0;i<snake.length;i++){
          const s = snake[i];
          const isHead = i===0;
          ctx.fillStyle = isHead ? `rgba(${(ui.accent||[99,102,241]).join(',')},.95)` : 'rgba(34,197,94,.65)';
          ctx.fillRect(s.x*cell+2, s.y*cell+2, cell-4, cell-4);
        }

        // score
        ctx.fillStyle = 'rgba(255,255,255,.88)';
        ctx.font = 'bold 18px system-ui, sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText(String(score), 12, 24);

        if (!running || paused || showOverlay){
          ctx.fillStyle = 'rgba(0,0,0,.35)';
          ctx.fillRect(0,0,canvas.width,canvas.height);
          ctx.fillStyle = 'rgba(255,255,255,.92)';
          ctx.font = 'bold 18px system-ui, sans-serif';
          ctx.textAlign = 'center';

          if (!running) {
            ctx.fillText('Нажмите «Старт»', canvas.width/2, canvas.height/2);
            ctx.font = '14px system-ui, sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,.75)';
            ctx.fillText('Стрелки/WASD — движение • Space — пауза', canvas.width/2, canvas.height/2 + 28);
          } else if (paused) {
            ctx.fillText('Пауза', canvas.width/2, canvas.height/2);
            ctx.font = '14px system-ui, sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,.75)';
            ctx.fillText('Space — продолжить', canvas.width/2, canvas.height/2 + 28);
          }
        }
      }

      function setDir(dx, dy){
        // prevent instant reverse
        if (dx === -dir.x && dy === -dir.y) return;
        nextDir = { x: dx, y: dy };
      }

      function keyToDir(e){
        const k = e.key;
        if (k === 'ArrowUp' || k.toLowerCase() === 'w') return {x:0,y:-1};
        if (k === 'ArrowDown' || k.toLowerCase() === 's') return {x:0,y:1};
        if (k === 'ArrowLeft' || k.toLowerCase() === 'a') return {x:-1,y:0};
        if (k === 'ArrowRight' || k.toLowerCase() === 'd') return {x:1,y:0};
        return null;
      }

      const keyHandler = (e) => {
        if (!state.windows.has(win.id)) return;
        if (e.key === ' ') {
          e.preventDefault();
          togglePause();
          return;
        }
        const d = keyToDir(e);
        if (d) {
          e.preventDefault();
          setDir(d.x, d.y);
        }
      };
      document.addEventListener('keydown', keyHandler);
      registerOnClose(win.id, () => document.removeEventListener('keydown', keyHandler));

      btnStart.addEventListener('click', () => {
        if (!running) start();
        else togglePause();
      });
      btnReset.addEventListener('click', () => {
        reset();
        start();
      });
      speedSel.addEventListener('change', () => {
        if (running) scheduleTick();
      });

      canvas.addEventListener('pointerdown', () => {
        // click to start/pause for convenience
        if (!running) start();
        else togglePause();
      });

      reset();
      return wrap;
    }

    function buildFlappy(win){
      const wrap = h('div', { class:'p-3' });
      const title = h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
        h('div', { class:'flex items-center gap-2' }, [
          h('div', { class:'w-6 h-6', html: registry.flappy.iconHtml }),
          h('div', { class:'text-lg font-semibold' }, 'Flappy Bird')
        ]),
        h('div', { class:'text-sm text-white/70' }, 'Управление: Space/Click')
      ]);

      const panel = h('div', { class:'mt-3 game-panel' });
      const top = h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
        h('div', { class:'text-sm font-semibold' }, 'Счёт: '),
        h('div', { class:'ml-auto flex gap-2' }, [
          h('button', { class:'btn text-sm', id:`flStart_${win.id}` }, 'Старт'),
          h('button', { class:'btn text-sm', id:`flReset_${win.id}` }, 'Сброс')
        ])
      ]);
      const scoreEl = h('span', { id:`flScore_${win.id}`, class:'text-sm font-semibold' }, '0');
      top.firstChild.appendChild(scoreEl);

      const canvas = h('canvas', { class:'mt-3 w-full rounded-2xl border border-white/10 bg-black/20', width:'460', height:'540', id:`flCanvas_${win.id}` });
      const hint = h('div', { class:'text-xs text-white/70 mt-3' }, 'Не касайтесь труб. Чем дальше — тем сложнее.' );

      panel.append(top, canvas, hint);
      wrap.append(title, panel);

      const ctx = canvas.getContext('2d');
      let bird, pipes, score, running, lastT, spawnT;

      function reset(){
        bird = { x: 120, y: canvas.height/2, vy: 0, r: 14 };
        pipes = [];
        score = 0;
        running = false;
        lastT = 0;
        spawnT = 0;
        scoreEl.textContent = '0';
        draw();
      }

      function spawnPipe(){
        const gap = 150;
        const minY = 90;
        const maxY = canvas.height - 90;
        const gapY = Math.floor(minY + Math.random() * (maxY - minY));
        pipes.push({ x: canvas.width + 20, gapY, gap, w: 70, passed: false });
      }

      function flap(){
        if (!running) {
          reset();
          start();
          bird.vy = -6.8;
          return;
        }
        bird.vy = -6.8;
      }

      function start(){
        if (running) return;
        running = true;
        lastT = performance.now();
        spawnT = 0;
        pipes = [];
        spawnPipe();
        requestAnimationFrame(loop);
      }

      function gameOver(){
        running = false;
        draw();
        addNotification({ title:'Flappy Bird', body:`Игра окончена. Счёт: ${score}`, iconHtml: registry.flappy.iconHtml, source:'Игры' });
      }

      function draw(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        const g = ctx.createLinearGradient(0,0,0,canvas.height);
        g.addColorStop(0,'rgba(56,189,248,.25)');
        g.addColorStop(1,'rgba(99,102,241,.20)');
        ctx.fillStyle = g;
        ctx.fillRect(0,0,canvas.width,canvas.height);

        for (const p of pipes){
          const topH = p.gapY - p.gap/2;
          const botY = p.gapY + p.gap/2;
          ctx.fillStyle = 'rgba(34,197,94,.55)';
          ctx.fillRect(p.x, 0, p.w, topH);
          ctx.fillRect(p.x, botY, p.w, canvas.height - botY);
          ctx.fillStyle = 'rgba(255,255,255,.15)';
          ctx.fillRect(p.x+6, 0, 8, topH);
          ctx.fillRect(p.x+6, botY, 8, canvas.height-botY);
        }

        ctx.fillStyle = `rgba(${(ui.accent||[99,102,241]).join(',')},.95)`;
        ctx.beginPath();
        ctx.arc(bird.x, bird.y, bird.r, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,.9)';
        ctx.beginPath();
        ctx.arc(bird.x+5, bird.y-4, 3, 0, Math.PI*2);
        ctx.fill();

        ctx.fillStyle = 'rgba(255,255,255,.88)';
        ctx.font = 'bold 22px system-ui, sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText(String(score), 14, 30);

        if (!running){
          ctx.fillStyle = 'rgba(0,0,0,.35)';
          ctx.fillRect(0,0,canvas.width,canvas.height);
          ctx.fillStyle = 'rgba(255,255,255,.92)';
          ctx.font = 'bold 18px system-ui, sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('Нажмите «Старт»', canvas.width/2, canvas.height/2);
          ctx.font = '14px system-ui, sans-serif';
          ctx.fillStyle = 'rgba(255,255,255,.75)';
          ctx.fillText('Space/Click — взмах', canvas.width/2, canvas.height/2 + 28);
        }
      }

      function loop(t){
        if (!running) return;
        const dt = (t - lastT) / 16.666;
        lastT = t;
        spawnT += dt;
        if (spawnT > 90/16.666) { spawnT = 0; spawnPipe(); }

        bird.vy += 0.35 * dt;
        bird.y += bird.vy * 3.2 * dt;

        for (const p of pipes){
          p.x -= 2.8 * 3.2 * dt;
          if (!p.passed && p.x + p.w < bird.x) {
            p.passed = true;
            score++;
            scoreEl.textContent = String(score);
          }
        }
        pipes = pipes.filter(p => p.x + p.w > -20);

        if (bird.y - bird.r < 0 || bird.y + bird.r > canvas.height) { gameOver(); return; }
        for (const p of pipes){
          const topH = p.gapY - p.gap/2;
          const botY = p.gapY + p.gap/2;
          const inX = bird.x + bird.r > p.x && bird.x - bird.r < p.x + p.w;
          if (inX) {
            if (bird.y - bird.r < topH || bird.y + bird.r > botY) { gameOver(); return; }
          }
        }

        draw();
        requestAnimationFrame(loop);
      }

      reset();

      const keyHandler = (e) => {
        if (!state.windows.has(win.id)) return;
        if (e.key === ' ') { e.preventDefault(); flap(); }
      };
      document.addEventListener('keydown', keyHandler);
      registerOnClose(win.id, () => document.removeEventListener('keydown', keyHandler));

      canvas.addEventListener('pointerdown', () => flap());

      const startBtn = $(`#flStart_${win.id}`, wrap);
      const resetBtn = $(`#flReset_${win.id}`, wrap);
      startBtn?.addEventListener('click', () => { if (!running) { reset(); start(); } });
      resetBtn?.addEventListener('click', () => { reset(); start(); });

      return wrap;
    }

    // ---------- Tetris (implemented) ----------
    function buildTetris(win){
      const wrap = h('div', { class:'p-3' });
      const header = h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
        h('div', { class:'flex items-center gap-2' }, [
          h('div', { class:'w-6 h-6', html: registry.tetris.iconHtml }),
          h('div', { class:'text-lg font-semibold' }, 'Тетрис')
        ]),
        h('div', { class:'text-xs text-white/70' }, '← → ↓ • ↑ поворот • Space: hard drop • P: пауза • R: сброс')
      ]);

      const panel = h('div', { class:'mt-3 game-panel' });
      const top = h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
        h('div', { class:'text-sm font-semibold' }, 'Счёт: '),
        h('div', { class:'ml-auto flex gap-2 flex-wrap items-center' })
      ]);
      const scoreEl = h('span', { class:'text-sm font-semibold' }, '0');
      top.firstChild.appendChild(scoreEl);
      const btnStart = h('button', { class:'btn text-sm' }, 'Старт');
      const btnReset = h('button', { class:'btn text-sm' }, 'Сброс');
      top.lastChild.append(btnStart, btnReset);

      const canvas = h('canvas', { class:'mt-3 w-full rounded-2xl border border-white/10 bg-black/20', width:'420', height:'520' });
      const hint = h('div', { class:'text-xs text-white/70 mt-3' }, 'Линии дают очки. Ускорение — ↓.' );
      panel.append(top, canvas, hint);
      wrap.append(header, panel);

      const ctx = canvas.getContext('2d');
      const COLS = 10, ROWS = 20;
      const cell = Math.floor(Math.min(canvas.width / COLS, canvas.height / ROWS));
      const ox = Math.floor((canvas.width - COLS*cell)/2);
      const oy = Math.floor((canvas.height - ROWS*cell)/2);

      const colors = {
        I: 'rgba(56,189,248,.85)',
        O: 'rgba(245,158,11,.85)',
        T: 'rgba(99,102,241,.85)',
        S: 'rgba(34,197,94,.85)',
        Z: 'rgba(239,68,68,.85)',
        J: 'rgba(59,130,246,.85)',
        L: 'rgba(244,114,182,.85)'
      };

      const shapes = {
        I: [[1,1,1,1]],
        O: [[1,1],[1,1]],
        T: [[0,1,0],[1,1,1]],
        S: [[0,1,1],[1,1,0]],
        Z: [[1,1,0],[0,1,1]],
        J: [[1,0,0],[1,1,1]],
        L: [[0,0,1],[1,1,1]]
      };

      const bag = ['I','O','T','S','Z','J','L'];
      const rndPiece = () => bag[Math.floor(Math.random()*bag.length)];

      let grid, piece, next, score, running, paused, dropMs, lastDrop;
      function reset(){
        grid = Array.from({length: ROWS}, () => Array(COLS).fill(null));
        piece = null;
        next = rndPiece();
        score = 0;
        running = false;
        paused = false;
        dropMs = 600;
        lastDrop = performance.now();
        scoreEl.textContent = '0';
        spawn();
        draw(true);
      }

      function rotate(mat){
        const h = mat.length, w = mat[0].length;
        const out = Array.from({length: w}, () => Array(h).fill(0));
        for (let y=0;y<h;y++) for (let x=0;x<w;x++) out[x][h-1-y] = mat[y][x];
        return out;
      }

      function spawn(){
        const type = next;
        next = rndPiece();
        piece = {
          type,
          mat: shapes[type].map(r => r.slice()),
          x: Math.floor(COLS/2) - 1,
          y: -1
        };
        // Game over check
        if (collides(piece.x, piece.y, piece.mat)) {
          running = false;
          paused = false;
          addNotification({ title:'Тетрис', body:`Игра окончена. Счёт: ${score}`, iconHtml: registry.tetris.iconHtml, source:'Игры' });
        }
      }

      function collides(px, py, mat){
        for (let y=0;y<mat.length;y++){
          for (let x=0;x<mat[0].length;x++){
            if (!mat[y][x]) continue;
            const gx = px + x;
            const gy = py + y;
            if (gx < 0 || gx >= COLS || gy >= ROWS) return true;
            if (gy >= 0 && grid[gy][gx]) return true;
          }
        }
        return false;
      }

      function merge(){
        for (let y=0;y<piece.mat.length;y++){
          for (let x=0;x<piece.mat[0].length;x++){
            if (!piece.mat[y][x]) continue;
            const gx = piece.x + x;
            const gy = piece.y + y;
            if (gy >= 0 && gy < ROWS && gx >= 0 && gx < COLS) grid[gy][gx] = piece.type;
          }
        }
      }

      function clearLines(){
        let cleared = 0;
        for (let y=ROWS-1; y>=0; y--){
          if (grid[y].every(Boolean)) {
            grid.splice(y,1);
            grid.unshift(Array(COLS).fill(null));
            cleared++;
            y++;
          }
        }
        if (cleared){
          const add = [0, 100, 300, 500, 800][cleared] || (cleared*250);
          score += add;
          scoreEl.textContent = String(score);
          dropMs = Math.max(120, dropMs - cleared*25);
        }
      }

      function stepDown(){
        if (!piece) return;
        if (!collides(piece.x, piece.y+1, piece.mat)) {
          piece.y++;
        } else {
          merge();
          clearLines();
          spawn();
        }
      }

      function hardDrop(){
        if (!piece) return;
        while (!collides(piece.x, piece.y+1, piece.mat)) piece.y++;
        stepDown();
      }

      function move(dx){
        if (!piece) return;
        if (!collides(piece.x+dx, piece.y, piece.mat)) piece.x += dx;
      }

      function doRotate(){
        if (!piece) return;
        const r = rotate(piece.mat);
        if (!collides(piece.x, piece.y, r)) piece.mat = r;
      }

      function draw(overlay=false){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        // field background
        ctx.fillStyle = 'rgba(255,255,255,.03)';
        ctx.fillRect(ox, oy, COLS*cell, ROWS*cell);

        // grid cells
        for (let y=0;y<ROWS;y++){
          for (let x=0;x<COLS;x++){
            const t = grid[y][x];
            if (!t) continue;
            ctx.fillStyle = colors[t] || 'rgba(255,255,255,.6)';
            ctx.fillRect(ox + x*cell + 2, oy + y*cell + 2, cell-4, cell-4);
          }
        }

        // current piece
        if (piece){
          ctx.fillStyle = colors[piece.type] || 'rgba(255,255,255,.7)';
          for (let y=0;y<piece.mat.length;y++){
            for (let x=0;x<piece.mat[0].length;x++){
              if (!piece.mat[y][x]) continue;
              const gx = piece.x + x;
              const gy = piece.y + y;
              if (gy < 0) continue;
              ctx.fillRect(ox + gx*cell + 2, oy + gy*cell + 2, cell-4, cell-4);
            }
          }
        }

        // outline
        ctx.strokeStyle = 'rgba(255,255,255,.12)';
        ctx.strokeRect(ox, oy, COLS*cell, ROWS*cell);

        if (!running || paused || overlay){
          ctx.fillStyle = 'rgba(0,0,0,.35)';
          ctx.fillRect(0,0,canvas.width,canvas.height);
          ctx.fillStyle = 'rgba(255,255,255,.92)';
          ctx.font = 'bold 18px system-ui, sans-serif';
          ctx.textAlign = 'center';
          const msg = (!running) ? 'Нажмите «Старт»' : 'Пауза';
          ctx.fillText(msg, canvas.width/2, canvas.height/2);
          ctx.font = '14px system-ui, sans-serif';
          ctx.fillStyle = 'rgba(255,255,255,.75)';
          ctx.fillText('R — сброс • P — пауза', canvas.width/2, canvas.height/2 + 28);
        }
      }

      function loop(t){
        if (!running) return;
        if (!paused && (t - lastDrop) > dropMs){
          lastDrop = t;
          stepDown();
        }
        draw();
        requestAnimationFrame(loop);
      }

      function start(){
        if (!running) {
          running = true;
          paused = false;
          btnStart.textContent = 'Пауза';
          lastDrop = performance.now();
          requestAnimationFrame(loop);
        } else {
          paused = !paused;
          btnStart.textContent = paused ? 'Продолжить' : 'Пауза';
          draw();
        }
      }

      btnStart.addEventListener('click', start);
      btnReset.addEventListener('click', () => { reset(); running = true; paused = false; btnStart.textContent = 'Пауза'; requestAnimationFrame(loop); });

      const keyHandler = (e) => {
        if (!state.windows.has(win.id)) return;
        if (e.key.toLowerCase() === 'p') { e.preventDefault(); if (running) { paused = !paused; btnStart.textContent = paused ? 'Продолжить' : 'Пауза'; draw(); } return; }
        if (e.key.toLowerCase() === 'r') { e.preventDefault(); reset(); running = true; paused = false; btnStart.textContent = 'Пауза'; requestAnimationFrame(loop); return; }
        if (!running || paused) {
          // allow start with arrows/space
          if (['ArrowLeft','ArrowRight','ArrowDown','ArrowUp',' '].includes(e.key)) { e.preventDefault(); start(); }
        }
        if (!running || paused) return;
        if (e.key === 'ArrowLeft') { e.preventDefault(); move(-1); }
        if (e.key === 'ArrowRight') { e.preventDefault(); move(1); }
        if (e.key === 'ArrowDown') { e.preventDefault(); stepDown(); score = Math.max(0, score + 1); scoreEl.textContent = String(score); }
        if (e.key === 'ArrowUp') { e.preventDefault(); doRotate(); }
        if (e.key === ' ') { e.preventDefault(); hardDrop(); }
      };
      document.addEventListener('keydown', keyHandler);
      registerOnClose(win.id, () => document.removeEventListener('keydown', keyHandler));

      canvas.addEventListener('pointerdown', () => { if (!running) start(); else if (paused) start(); });

      reset();
      return wrap;
    }

    // ---------- Word (implemented) ----------
    function buildWord(win){
      win.opts = win.opts || {};
      win.opts.word = win.opts.word || { title:'Документ', content:'', bold:false, italic:false, underline:false, fontSize:16, align:'left' };
      const m = win.opts.word;

      const wrap = h('div', { class:'p-3 h-full' });
      const header = h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
        h('div', { class:'flex items-center gap-2' }, [
          h('div', { class:'w-6 h-6', html: registry.word.iconHtml }),
          h('div', { class:'text-lg font-semibold' }, 'Microsoft Word (демо)')
        ]),
        h('div', { class:'flex items-center gap-2 flex-wrap' })
      ]);

      const btnNew = h('button', { class:'btn text-sm' }, 'Новый');
      const btnOpen = h('button', { class:'btn text-sm' }, 'Открыть');
      const btnSave = h('button', { class:'btn text-sm' }, 'Сохранить в FS');
      const btnExport = h('button', { class:'btn text-sm' }, 'Экспорт .txt');
      header.lastChild.append(btnNew, btnOpen, btnSave, btnExport);

      const bar = h('div', { class:'mt-3 flex items-center gap-2 flex-wrap' });
      const inTitle = h('input', { class:'flex-1 min-w-[180px] bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60', value:m.title, placeholder:'Название документа' });
      const selSize = h('select', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, [12,14,16,18,20,24,28,32].map(s => h('option', { value:String(s), selected: m.fontSize===s ? 'selected':null }, `${s}px`)));
      const btnB = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm font-bold' }, 'B');
      const btnI = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm italic' }, 'I');
      const btnU = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm underline' }, 'U');
      const align = (id,label) => {
        const b = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, label);
        b.addEventListener('click', () => { m.align = id; paint(); });
        b._paint = () => {
          const on = m.align === id;
          b.style.background = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
          b.style.borderColor = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
        };
        b._paint();
        return b;
      };
      const aL = align('left','⟸');
      const aC = align('center','≡');
      const aR = align('right','⟹');
      bar.append(inTitle, selSize, btnB, btnI, btnU, aL, aC, aR);

      const editor = h('div', { class:'mt-3 rounded-2xl border border-white/10 bg-white/5 p-3 min-h-[420px] overflow-auto scrollbar', contenteditable:'true', style:'user-select:text; outline:none;' });

      function paint(){
        inTitle.value = m.title;
        editor.style.fontSize = m.fontSize + 'px';
        editor.style.fontWeight = m.bold ? '700' : '400';
        editor.style.fontStyle = m.italic ? 'italic' : 'normal';
        editor.style.textDecoration = m.underline ? 'underline' : 'none';
        editor.style.textAlign = m.align;
        btnB.style.background = m.bold ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
        btnI.style.background = m.italic ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
        btnU.style.background = m.underline ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
        [aL,aC,aR].forEach(b => b._paint && b._paint());
      }

      editor.innerText = m.content || 'Начните печатать…';
      paint();

      inTitle.addEventListener('input', () => { m.title = inTitle.value; });
      selSize.addEventListener('change', () => { m.fontSize = Number(selSize.value)||16; paint(); });
      btnB.addEventListener('click', () => { m.bold = !m.bold; paint(); });
      btnI.addEventListener('click', () => { m.italic = !m.italic; paint(); });
      btnU.addEventListener('click', () => { m.underline = !m.underline; paint(); });

      editor.addEventListener('input', () => {
        m.content = editor.innerText;
      });

      btnNew.addEventListener('click', () => {
        if (!confirm('Создать новый документ? Текущий будет очищен (демо).')) return;
        m.title = 'Документ';
        m.content = '';
        m.bold = m.italic = m.underline = false;
        m.fontSize = 16;
        m.align = 'left';
        editor.innerText = '';
        paint();
      });

      btnOpen.addEventListener('click', () => {
        const files = Object.values(fs.files||{}).filter(f => (f.ext || fileExt(f.name)).toLowerCase() === 'txt');
        const names = files.slice(0, 40).map(f => f.name).join('\n');
        const want = prompt('Введите имя txt-файла из виртуальной FS для открытия:\n\n' + (names || '(нет txt файлов)'), m.title + '.txt');
        if (!want) return;
        const f = files.find(x => (x.name||'').toLowerCase() === want.toLowerCase());
        if (!f) { addNotification({ title:'Word', body:'Файл не найден в FS.', iconHtml: registry.word.iconHtml, source:'Word' }); return; }
        m.title = f.name.replace(/\.txt$/i,'');
        m.content = String(f.content||'');
        editor.innerText = m.content;
        paint();
      });

      btnSave.addEventListener('click', () => {
        const id = uid();
        const name = (m.title || 'Документ') + '.txt';
        fs.files[id] = { id, name, ext:'txt', updatedAt: Date.now(), content: String(m.content||'') };
        fs.documents = Array.isArray(fs.documents) ? fs.documents : [];
        fs.documents.unshift({ type:'file', fileId:id, name, ext:'txt' });
        fsSave(fs);
        addNotification({ title:'Word', body:`Сохранено в Документы: ${name}`, iconHtml: registry.word.iconHtml, source:'Word' });
      });

      btnExport.addEventListener('click', () => {
        const name = (m.title || 'Документ') + '.txt';
        downloadText(name, String(m.content||''));
        addNotification({ title:'Word', body:`Экспорт: ${name}`, iconHtml: registry.word.iconHtml, source:'Word' });
      });

      wrap.append(header, bar, editor);
      return wrap;
    }

    // ---------- Excel (implemented) ----------
    function buildExcel(win){
      win.opts = win.opts || {};
      win.opts.excel = win.opts.excel || { rows: 20, cols: 10, cells: {}, sel: 'A1', name:'Таблица' };
      const m = win.opts.excel;

      const wrap = h('div', { class:'p-3' });
      const header = h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
        h('div', { class:'flex items-center gap-2' }, [
          h('div', { class:'w-6 h-6', html: registry.excel.iconHtml }),
          h('div', { class:'text-lg font-semibold' }, 'Microsoft Excel (демо)')
        ]),
        h('div', { class:'flex items-center gap-2 flex-wrap' })
      ]);

      const btnNew = h('button', { class:'btn text-sm' }, 'Новая');
      const btnExport = h('button', { class:'btn text-sm' }, 'Экспорт CSV');
      const btnFill = h('button', { class:'btn text-sm' }, 'Демо‑данные');
      header.lastChild.append(btnNew, btnFill, btnExport);

      const formula = h('input', { class:'mt-3 w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60 font-mono text-sm', placeholder:'Формула или значение (например: =SUM(A1:A3))' });

      const tableWrap = h('div', { class:'mt-3 rounded-2xl border border-white/10 bg-white/5 overflow-auto scrollbar', style:'max-height: 460px;' });
      const table = h('div', { class:'min-w-[760px]' });
      tableWrap.appendChild(table);

      const colName = (i) => String.fromCharCode('A'.charCodeAt(0) + i);
      const keyOf = (c,r) => `${colName(c)}${r+1}`;

      function getCell(k){
        return m.cells[k] || { v:'', f:'' };
      }

      function setCell(k, val){
        m.cells[k] = m.cells[k] || { v:'', f:'' };
        if (String(val||'').startsWith('=')) {
          m.cells[k].f = String(val);
        } else {
          m.cells[k].f = '';
          m.cells[k].v = String(val);
        }
      }

      function evalCell(k, stack=new Set()){
        const c = getCell(k);
        if (!c) return '';
        if (!c.f) return c.v;
        if (stack.has(k)) return '#CYCLE';
        stack.add(k);
        const expr = c.f.slice(1).trim();

        // SUM(A1:A3)
        const mSum = expr.match(/^SUM\(([^)]+)\)$/i);
        if (mSum){
          const range = mSum[1].trim();
          const mRange = range.match(/^([A-Z]+\d+):([A-Z]+\d+)$/i);
          if (mRange){
            const [a,b] = [mRange[1].toUpperCase(), mRange[2].toUpperCase()];
            const parse = (ref) => {
              const mm = ref.match(/^([A-Z]+)(\d+)$/);
              if (!mm) return null;
              const col = mm[1].charCodeAt(0) - 'A'.charCodeAt(0);
              const row = Number(mm[2])-1;
              return {col,row};
            };
            const p1 = parse(a), p2 = parse(b);
            if (!p1 || !p2) return '#REF';
            const c0 = Math.min(p1.col,p2.col), c1 = Math.max(p1.col,p2.col);
            const r0 = Math.min(p1.row,p2.row), r1 = Math.max(p1.row,p2.row);
            let sum = 0;
            for (let r=r0;r<=r1;r++){
              for (let c=c0;c<=c1;c++){
                const kk = keyOf(c,r);
                const vv = Number(evalCell(kk, stack));
                if (Number.isFinite(vv)) sum += vv;
              }
            }
            stack.delete(k);
            return String(sum);
          }
        }

        // simple arithmetic with refs A1
        let e2 = expr.replace(/[A-Z]+\d+/g, (ref) => {
          const v = evalCell(ref.toUpperCase(), stack);
          const n = Number(v);
          return Number.isFinite(n) ? String(n) : '0';
        });
        if (!/^[0-9+\-*/().\s]+$/.test(e2)) { stack.delete(k); return '#ERR'; }
        try {
          const r = Function('"use strict"; return (' + e2 + ');')();
          stack.delete(k);
          return String(Number.isFinite(r) ? Number(r.toFixed(10)) : '#ERR');
        } catch {
          stack.delete(k);
          return '#ERR';
        }
      }

      function paint(){
        table.innerHTML = '';

        const headerRow = h('div', { class:'grid', style:`grid-template-columns: 56px repeat(${m.cols}, minmax(90px, 1fr));` });
        headerRow.appendChild(h('div', { class:'p-2 text-[11px] text-white/60 border-b border-white/10' }, ''));
        for (let c=0;c<m.cols;c++){
          headerRow.appendChild(h('div', { class:'p-2 text-[11px] text-white/60 border-b border-white/10 border-l border-white/10 text-center font-semibold' }, colName(c)));
        }
        table.appendChild(headerRow);

        for (let r=0;r<m.rows;r++){
          const row = h('div', { class:'grid', style:`grid-template-columns: 56px repeat(${m.cols}, minmax(90px, 1fr));` });
          row.appendChild(h('div', { class:'p-2 text-[11px] text-white/60 border-b border-white/10 text-center' }, String(r+1)));
          for (let c=0;c<m.cols;c++){
            const k = keyOf(c,r);
            const isSel = m.sel === k;
            const raw = getCell(k);
            const val = evalCell(k);

            const cell = h('div', { class:'p-0 text-sm border-b border-white/10 border-l border-white/10 text-left font-mono hover:bg-white/8', style:`background:${isSel?`rgba(${(ui.accent||[99,102,241]).join(',')},.14)`:'transparent'};` });
            const btn = h('button', { class:'w-full p-2 text-left font-mono', style:'user-select:text;' }, val);
            cell.appendChild(btn);

            const beginEdit = () => {
              // create editor input inside cell
              const inp = h('input', { class:'w-full px-2 py-2 bg-white/10 border border-white/10 rounded-lg outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60 font-mono text-sm', value: raw.f || raw.v || '' });
              cell.innerHTML = '';
              cell.appendChild(inp);
              inp.focus();
              inp.select();

              const commit = () => {
                const v = inp.value;
                setCell(k, v);
                // keep selection + formula bar in sync
                m.sel = k;
                const raw2 = getCell(k);
                formula.value = raw2.f || raw2.v || '';
                paint();
              };

              inp.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); commit(); }
                if (e.key === 'Escape') { e.preventDefault(); paint(); }
              });
              inp.addEventListener('blur', () => commit(), { once:true });
            };

            btn.addEventListener('click', () => {
              m.sel = k;
              const raw2 = getCell(k);
              formula.value = raw2.f || raw2.v || '';
              paint();
            });
            btn.addEventListener('dblclick', (e) => { e.preventDefault(); e.stopPropagation(); beginEdit(); });

            row.appendChild(cell);
          }
          table.appendChild(row);
        }
      }

      function exportCsv(){
        const rows = [];
        const header = [];
        for (let c=0;c<m.cols;c++) header.push(colName(c));
        rows.push(header.join(','));
        for (let r=0;r<m.rows;r++){
          const line = [];
          for (let c=0;c<m.cols;c++){
            const k = keyOf(c,r);
            const v = String(evalCell(k)).replace(/"/g,'""');
            line.push('"' + v + '"');
          }
          rows.push(line.join(','));
        }
        downloadText((m.name||'table') + '.csv', rows.join('\n'));
        addNotification({ title:'Excel', body:'CSV экспортирован.', iconHtml: registry.excel.iconHtml, source:'Excel' });
      }

      formula.addEventListener('keydown', (e) => {
        if (e.key !== 'Enter') return;
        e.preventDefault();
        const k = m.sel || 'A1';
        setCell(k, formula.value);
        paint();
      });

      btnNew.addEventListener('click', () => {
        if (!confirm('Создать новую таблицу? (демо)')) return;
        m.cells = {};
        m.sel = 'A1';
        formula.value = '';
        paint();
      });

      btnFill.addEventListener('click', () => {
        setCell('A1','10');
        setCell('A2','20');
        setCell('A3','30');
        setCell('B1','=SUM(A1:A3)');
        setCell('B2','=A1+A2');
        setCell('C1','Hello');
        paint();
      });

      btnExport.addEventListener('click', exportCsv);

      // initial
      paint();
      formula.value = getCell(m.sel).f || getCell(m.sel).v || '';

      wrap.append(header, formula, tableWrap);
      return wrap;
    }

    // ---------- Personalization apps (Store) ----------

    function buildTaskbarTweaks(win){
      const wrap = h('div', { class:'p-4 space-y-3' });
      wrap.append(
        h('div', { class:'flex items-center justify-between gap-2' }, [
          h('div', {}, [
            h('div', { class:'text-xl font-semibold' }, 'Кастомизация панели задач'),
            h('div', { class:'text-xs text-white/70 mt-1' }, 'Изменения применяются сразу и сохраняются. Демо-уровень, как “tweak tool”.')
          ]),
          h('div', { class:'w-10 h-10', html: registry.taskbarTweaks.iconHtml })
        ])
      );

      ui.taskbar = ui.taskbar || { h:56, radius:18, alpha:.08, blur:18 };

      const mkRange = (label, min, max, step, get, set, fmt=(v)=>String(v)) => {
        const card = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' });
        const head = h('div', { class:'flex items-center justify-between gap-2' }, [
          h('div', { class:'text-sm font-semibold' }, label),
          h('div', { class:'text-xs text-white/60', 'data-val':'1' }, fmt(get()))
        ]);
        const input = h('input', { type:'range', min:String(min), max:String(max), step:String(step), value:String(get()), class:'w-full mt-3' });
        input.addEventListener('input', () => {
          const v = Number(input.value);
          set(v);
          head.querySelector('[data-val]').textContent = fmt(v);
          persistUI();
          applyUI();
        });
        card.append(head, input);
        return card;
      };

      // Styles presets
      const styleCard = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' }, [
        h('div', { class:'text-sm font-semibold' }, 'Стили панели задач'),
        h('div', { class:'text-xs text-white/70 mt-1' }, 'Быстрые пресеты внешнего вида (демо).'),
      ]);
      const styles = [
        { id:'win11', name:'Windows 11 (floating)' },
        { id:'win10', name:'Windows 10 (full width)' },
        { id:'classic', name:'Classic' },
        { id:'compact', name:'Compact' }
      ];
      const styleGrid = h('div', { class:'mt-3 grid sm:grid-cols-2 gap-2' });
      const paintStyleBtns = [];
      for (const st of styles) {
        const b = h('button', { class:'px-3 py-3 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-left' }, [
          h('div', { class:'text-sm font-semibold' }, st.name),
          h('div', { class:'text-xs text-white/60 mt-0.5' }, st.id)
        ]);
        b.addEventListener('click', () => {
          ui.taskbar.style = st.id;
          persistUI();
          applyUI();
          // repaint
          paintStyleBtns.forEach(x => x._paint && x._paint());
        });
        b._paint = () => {
          const on = (ui.taskbar.style || 'win11') === st.id;
          b.style.outline = on ? `2px solid rgba(${(ui.accent||[99,102,241]).join(',')},.55)` : 'none';
        };
        paintStyleBtns.push(b);
        styleGrid.appendChild(b);
      }
      styleCard.appendChild(styleGrid);
      paintStyleBtns.forEach(x => x._paint && x._paint());

      wrap.append(
        styleCard,
        mkRange('Высота панели', 44, 80, 1, () => ui.taskbar.h, v => ui.taskbar.h = v, v => `${v}px`),
        mkRange('Скругление', 8, 26, 1, () => ui.taskbar.radius, v => ui.taskbar.radius = v, v => `${v}px`),
        mkRange('Прозрачность (alpha)', 0.02, 0.22, 0.01, () => ui.taskbar.alpha, v => ui.taskbar.alpha = v, v => v.toFixed(2)),
        mkRange('Blur', 0, 28, 1, () => ui.taskbar.blur, v => ui.taskbar.blur = v, v => `${v}px`)
      );

      const reset = h('button', { class:'btn text-sm w-full' }, 'Сбросить панель задач');
      reset.addEventListener('click', () => {
        ui.taskbar = { h:56, radius:18, alpha:.08, blur:18 };
        persistUI();
        applyUI();
        refreshWindowContent(win.id);
      });
      wrap.append(reset);

      return wrap;
    }

    function buildFontManager(win){
      const wrap = h('div', { class:'p-4 space-y-3' });
      wrap.append(
        h('div', { class:'flex items-center justify-between' }, [
          h('div', {}, [
            h('div', { class:'text-xl font-semibold' }, 'Шрифт‑менеджер'),
            h('div', { class:'text-xs text-white/70 mt-1' }, 'Меняет шрифт всего интерфейса (через CSS).')
          ]),
          h('div', { class:'w-10 h-10', html: registry.fontManager.iconHtml })
        ])
      );

      ui.font = ui.font || { preset:'system', custom:null };
      const presets = [
        { id:'system', name:'Системный' },
        { id:'segoe', name:'Segoe UI' },
        { id:'inter', name:'Inter (если установлен)' },
        { id:'roboto', name:'Roboto (если установлен)' },
        { id:'monospace', name:'Моноширинный' },
        { id:'custom', name:'Custom CSS font-family' }
      ];

      const sel = h('select', { class:'w-full px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' },
        presets.map(p => h('option', { value:p.id, selected: ui.font.preset===p.id ? 'selected' : null }, p.name))
      );

      const custom = h('input', {
        class:'w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60',
        placeholder:'Например: "Comic Sans MS", system-ui, sans-serif',
        value: ui.font.custom || ''
      });

      const sample = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5 text-sm text-white/85' }, [
        h('div', { class:'text-sm font-semibold' }, 'Пример'),
        h('div', { class:'mt-2' }, 'The quick brown fox jumps over the lazy dog.'),
        h('div', { class:'mt-1 text-white/70 text-xs' }, 'Русский текст: Съешь ещё этих мягких французских булок, да выпей чаю.')
      ]);

      const apply = () => {
        ui.font.preset = sel.value;
        ui.font.custom = custom.value.trim() || null;
        persistUI();
        applyUI();
      };

      sel.addEventListener('change', () => {
        custom.style.display = (sel.value === 'custom') ? 'block' : 'none';
        apply();
      });
      custom.addEventListener('input', () => { if (sel.value === 'custom') apply(); });
      custom.style.display = (ui.font.preset === 'custom') ? 'block' : 'none';

      const reset = h('button', { class:'btn text-sm w-full' }, 'Сбросить шрифт');
      reset.addEventListener('click', () => {
        ui.font = { preset:'system', custom:null };
        persistUI();
        applyUI();
        refreshWindowContent(win.id);
      });

      wrap.append(
        h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5 space-y-2' }, [
          h('div', { class:'text-sm font-semibold' }, 'Выбор шрифта'),
          sel,
          custom
        ]),
        sample,
        reset
      );
      return wrap;
    }

    function buildAnimationStudio(win){
      const wrap = h('div', { class:'p-4 space-y-3' });
      wrap.append(
        h('div', { class:'flex items-center justify-between' }, [
          h('div', {}, [
            h('div', { class:'text-xl font-semibold' }, 'Настройка анимаций'),
            h('div', { class:'text-xs text-white/70 mt-1' }, 'Управляет длительностями анимаций окон/панелей и некоторыми стилями интерфейса.')
          ]),
          h('div', { class:'w-10 h-10', html: registry.animStudio.iconHtml })
        ])
      );

      ui.anim = ui.anim || { open:160, close:140, min:160, ui:160 };
      ui.animStyle = ui.animStyle || 'default';

      const mkRange = (label, key, min, max, step) => {
        const card = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' });
        const head = h('div', { class:'flex items-center justify-between gap-2' }, [
          h('div', { class:'text-sm font-semibold' }, label),
          h('div', { class:'text-xs text-white/60', 'data-val':'1' }, `${ui.anim[key]}ms`)
        ]);
        const input = h('input', { type:'range', min:String(min), max:String(max), step:String(step), value:String(ui.anim[key]), class:'w-full mt-3' });
        input.addEventListener('input', () => {
          ui.anim[key] = Number(input.value);
          head.querySelector('[data-val]').textContent = `${ui.anim[key]}ms`;
          persistUI();
          applyUI();
        });
        card.append(head, input);
        return card;
      };

      const styleSel = h('select', { class:'w-full px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, [
        h('option', { value:'default', selected: ui.animStyle==='default' ? 'selected' : null }, 'Стиль: Default'),
        h('option', { value:'bouncy', selected: ui.animStyle==='bouncy' ? 'selected' : null }, 'Стиль: Bouncy (пружина)'),
        h('option', { value:'sharp', selected: ui.animStyle==='sharp' ? 'selected' : null }, 'Стиль: Sharp (резко)')
      ]);
      styleSel.addEventListener('change', () => {
        ui.animStyle = styleSel.value;
        persistUI();
        applyUI();
      });

      const presets = h('div', { class:'grid sm:grid-cols-3 gap-2' }, [
        (() => {
          const b = h('button', { class:'btn text-sm' }, 'Быстро');
          b.addEventListener('click', () => {
            ui.anim = { open:120, close:110, min:120, ui:120 };
            persistUI(); applyUI(); refreshWindowContent(win.id);
          });
          return b;
        })(),
        (() => {
          const b = h('button', { class:'btn text-sm' }, 'Сбалансировано');
          b.addEventListener('click', () => {
            ui.anim = { open:160, close:140, min:160, ui:160 };
            persistUI(); applyUI(); refreshWindowContent(win.id);
          });
          return b;
        })(),
        (() => {
          const b = h('button', { class:'btn text-sm' }, 'Кинематографично');
          b.addEventListener('click', () => {
            ui.anim = { open:240, close:200, min:220, ui:220 };
            persistUI(); applyUI(); refreshWindowContent(win.id);
          });
          return b;
        })()
      ]);

      const note = h('div', { class:'text-xs text-white/60' }, 'Примечание: стиль “Bouncy”/“Sharp” влияет на easing в некоторых местах UI (демо).');

      wrap.append(
        h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5 space-y-2' }, [
          h('div', { class:'text-sm font-semibold' }, 'Стиль анимаций (beta)'),
          styleSel,
          note
        ]),
        h('div', { class:'text-sm font-semibold' }, 'Длительности'),
        mkRange('Открытие окна', 'open', 80, 420, 10),
        mkRange('Закрытие окна', 'close', 80, 420, 10),
        mkRange('Сворачивание', 'min', 80, 420, 10),
        mkRange('Flyout/меню', 'ui', 80, 420, 10),
        h('div', { class:'text-sm font-semibold' }, 'Пресеты'),
        presets
      );
      return wrap;
    }

    function buildPaint(win){
      const wrap = h('div', { class:'p-3' });
      const header = h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
        h('div', { class:'flex items-center gap-2' }, [
          h('div', { class:'w-6 h-6', html: registry.paint.iconHtml }),
          h('div', { class:'text-lg font-semibold' }, 'Paint')
        ]),
        h('div', { class:'text-xs text-white/70' }, 'Кисть/ластик/прямоугольник/круг • Сохранение PNG')
      ]);

      const toolbar = h('div', { class:'mt-3 flex items-center gap-2 flex-wrap' });
      const toolSel = h('select', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, [
        h('option', { value:'brush' }, 'Кисть'),
        h('option', { value:'eraser' }, 'Ластик'),
        h('option', { value:'rect' }, 'Прямоугольник'),
        h('option', { value:'circle' }, 'Круг')
      ]);
      const color = h('input', { type:'color', value:'#7c3aed', class:'h-10 w-12 rounded-xl border border-white/10 bg-white/5' });
      const size = h('input', { type:'range', min:'1', max:'40', value:'8', class:'w-44' });
      const btnClear = h('button', { class:'btn text-sm' }, 'Очистить');
      const btnSave = h('button', { class:'btn text-sm' }, 'Сохранить PNG');

      toolbar.append(toolSel,
        h('div', { class:'text-xs text-white/60' }, 'Цвет'), color,
        h('div', { class:'text-xs text-white/60' }, 'Размер'), size,
        btnClear, btnSave
      );

      const canvas = h('canvas', { class:'mt-3 w-full rounded-2xl border border-white/10 bg-white/3', width:'920', height:'520', style:'touch-action:none;' });
      const hint = h('div', { class:'mt-2 text-xs text-white/60' }, 'Подсказка: удерживайте и рисуйте. Фигуры: нажмите/потяните/отпустите.');

      wrap.append(header, toolbar, canvas, hint);

      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'rgba(255,255,255,0)';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      let drawing = false;
      let start = null;
      let snapshot = null;

      function getPos(e){
        const r = canvas.getBoundingClientRect();
        const sx = canvas.width / r.width;
        const sy = canvas.height / r.height;
        return { x: (e.clientX - r.left)*sx, y: (e.clientY - r.top)*sy };
      }

      function saveSnapshot(){
        snapshot = ctx.getImageData(0,0,canvas.width,canvas.height);
      }
      function restoreSnapshot(){
        if (snapshot) ctx.putImageData(snapshot,0,0);
      }

      function strokeLine(a,b){
        const tool = toolSel.value;
        const w = Number(size.value||8);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = w;
        if (tool === 'eraser') {
          ctx.globalCompositeOperation = 'destination-out';
          ctx.strokeStyle = 'rgba(0,0,0,1)';
        } else {
          ctx.globalCompositeOperation = 'source-over';
          ctx.strokeStyle = color.value;
        }
        ctx.beginPath();
        ctx.moveTo(a.x, a.y);
        ctx.lineTo(b.x, b.y);
        ctx.stroke();
        ctx.globalCompositeOperation = 'source-over';
      }

      function drawShape(a,b){
        const tool = toolSel.value;
        const w = Number(size.value||8);
        ctx.lineWidth = w;
        ctx.strokeStyle = color.value;
        ctx.fillStyle = 'transparent';
        if (tool === 'rect') {
          const x = Math.min(a.x,b.x), y = Math.min(a.y,b.y);
          const ww = Math.abs(a.x-b.x), hh = Math.abs(a.y-b.y);
          ctx.strokeRect(x,y,ww,hh);
        }
        if (tool === 'circle') {
          const cx = (a.x+b.x)/2, cy=(a.y+b.y)/2;
          const rx = Math.abs(a.x-b.x)/2;
          const ry = Math.abs(a.y-b.y)/2;
          const r = Math.max(2, Math.max(rx,ry));
          ctx.beginPath();
          ctx.arc(cx, cy, r, 0, Math.PI*2);
          ctx.stroke();
        }
      }

      let last = null;
      const endPaintStroke = (e) => {
        if (!drawing) return;
        drawing = false;
        try{ canvas.releasePointerCapture(e.pointerId);}catch{}
      };

      canvas.addEventListener('pointerdown', (e) => {
        // prevent scroll/gesture interference
        e.preventDefault();
        drawing = true;
        try { canvas.setPointerCapture(e.pointerId); } catch {}
        start = getPos(e);
        last = start;
        if (toolSel.value === 'rect' || toolSel.value === 'circle') saveSnapshot();
      });
      canvas.addEventListener('pointermove', (e) => {
        if (!drawing) return;
        e.preventDefault();
        const p = getPos(e);
        const tool = toolSel.value;
        if (tool === 'brush' || tool === 'eraser') {
          strokeLine(last, p);
          last = p;
        } else {
          restoreSnapshot();
          drawShape(start, p);
        }
      });
      canvas.addEventListener('pointerup', endPaintStroke);
      canvas.addEventListener('pointercancel', endPaintStroke);

      btnClear.addEventListener('click', () => {
        ctx.clearRect(0,0,canvas.width,canvas.height);
      });

      btnSave.addEventListener('click', () => {
        canvas.toBlob((blob) => {
          if (!blob) return;
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'paint.png';
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(() => URL.revokeObjectURL(url), 500);
        }, 'image/png');
        addNotification({ title:'Paint', body:'Экспорт PNG выполнен.', iconHtml: registry.paint.iconHtml, source:'Paint' });
      });

      return wrap;
    }

    function buildIconDesigner(win){
      const wrap = h('div', { class:'p-4 space-y-3' });
      wrap.append(
        h('div', { class:'flex items-center justify-between gap-2' }, [
          h('div', {}, [
            h('div', { class:'text-xl font-semibold' }, 'Дизайнер иконок'),
            h('div', { class:'text-xs text-white/70 mt-1' }, 'Соберите иконку из простых фигур и скачайте SVG/PNG.')
          ]),
          h('div', { class:'w-10 h-10', html: registry.iconDesigner.iconHtml })
        ])
      );

      const model = win.opts._ico || (win.opts._ico = {
        bg:'#0b1220',
        accent:'#6366f1',
        dot:'#38bdf8',
        size: 256,
        shape: 'slash'
      });

      const selShape = h('select', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, [
        h('option', { value:'slash', selected: model.shape==='slash'?'selected':null }, 'Diagonal'),
        h('option', { value:'circle', selected: model.shape==='circle'?'selected':null }, 'Circle'),
        h('option', { value:'grid', selected: model.shape==='grid'?'selected':null }, 'Grid'),
        h('option', { value:'badge', selected: model.shape==='badge'?'selected':null }, 'Badge')
      ]);
      const bg = h('input', { type:'color', value:model.bg, class:'h-10 w-12 rounded-xl border border-white/10 bg-white/5' });
      const acc = h('input', { type:'color', value:model.accent, class:'h-10 w-12 rounded-xl border border-white/10 bg-white/5' });
      const dot = h('input', { type:'color', value:model.dot, class:'h-10 w-12 rounded-xl border border-white/10 bg-white/5' });

      const preview = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5 flex items-center justify-center' });
      const svgBox = h('div', { class:'w-44 h-44' });
      preview.appendChild(svgBox);

      const btnSvg = h('button', { class:'btn text-sm' }, 'Скачать SVG');
      const btnPng = h('button', { class:'btn text-sm' }, 'Скачать PNG');

      function makeSvg(){
        const s = model.size;
        const rr = 48;
        const base = [`<svg xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 ${s} ${s}">`];
        base.push(`<rect x="0" y="0" width="${s}" height="${s}" rx="${rr}" fill="${model.bg}"/>`);
        if (model.shape === 'slash') {
          base.push(`<path d="M${s*0.25} ${s*0.75} L${s*0.75} ${s*0.25}" stroke="${model.accent}" stroke-width="${s*0.10}" stroke-linecap="round"/>`);
          base.push(`<circle cx="${s*0.32}" cy="${s*0.32}" r="${s*0.06}" fill="${model.dot}"/>`);
          base.push(`<circle cx="${s*0.68}" cy="${s*0.68}" r="${s*0.06}" fill="${model.dot}"/>`);
        }
        if (model.shape === 'circle') {
          base.push(`<circle cx="${s/2}" cy="${s/2}" r="${s*0.30}" fill="${model.accent}" opacity="0.75"/>`);
          base.push(`<circle cx="${s/2}" cy="${s/2}" r="${s*0.16}" fill="${model.dot}" opacity="0.9"/>`);
        }
        if (model.shape === 'grid') {
          const w = s*0.18;
          const gap = s*0.06;
          const x0 = s*0.24;
          const y0 = s*0.24;
          for (let r=0;r<2;r++){
            for (let c=0;c<2;c++){
              const x = x0 + c*(w+gap);
              const y = y0 + r*(w+gap);
              base.push(`<rect x="${x}" y="${y}" width="${w}" height="${w}" rx="${s*0.06}" fill="${(r+c)%2?model.dot:model.accent}" opacity="0.85"/>`);
            }
          }
        }
        if (model.shape === 'badge') {
          base.push(`<path d="M${s*0.28} ${s*0.58} C${s*0.26} ${s*0.36}, ${s*0.44} ${s*0.24}, ${s*0.58} ${s*0.30} C${s*0.76} ${s*0.38}, ${s*0.76} ${s*0.66}, ${s*0.58} ${s*0.72} C${s*0.44} ${s*0.76}, ${s*0.30} ${s*0.72}, ${s*0.28} ${s*0.58} Z" fill="${model.accent}" opacity="0.8"/>`);
          base.push(`<circle cx="${s*0.60}" cy="${s*0.48}" r="${s*0.06}" fill="${model.dot}"/>`);
        }
        base.push(`</svg>`);
        return base.join('');
      }

      function render(){
        model.shape = selShape.value;
        model.bg = bg.value;
        model.accent = acc.value;
        model.dot = dot.value;
        svgBox.innerHTML = makeSvg();
      }

      [selShape, bg, acc, dot].forEach(el => el.addEventListener('input', render));
      render();

      btnSvg.addEventListener('click', () => {
        const svg = makeSvg();
        downloadText('icon.svg', svg);
      });

      btnPng.addEventListener('click', async () => {
        const svg = makeSvg();
        const blob = new Blob([svg], { type:'image/svg+xml' });
        const url = URL.createObjectURL(blob);
        const img = new Image();
        img.onload = () => {
          const c = document.createElement('canvas');
          c.width = model.size;
          c.height = model.size;
          const x = c.getContext('2d');
          x.drawImage(img, 0, 0);
          c.toBlob((b) => {
            if (b) {
              const u = URL.createObjectURL(b);
              const a = document.createElement('a');
              a.href = u;
              a.download = 'icon.png';
              document.body.appendChild(a);
              a.click();
              a.remove();
              setTimeout(() => URL.revokeObjectURL(u), 500);
            }
            URL.revokeObjectURL(url);
          }, 'image/png');
        };
        img.src = url;
      });

      const controls = h('div', { class:'flex items-center gap-2 flex-wrap' }, [
        h('div', { class:'text-xs text-white/60' }, 'Шаблон'), selShape,
        h('div', { class:'text-xs text-white/60' }, 'Фон'), bg,
        h('div', { class:'text-xs text-white/60' }, 'Акцент'), acc,
        h('div', { class:'text-xs text-white/60' }, 'Точки'), dot,
        btnSvg, btnPng
      ]);

      wrap.append(controls, preview);
      return wrap;
    }

    function buildNewYearCountdown(win){
      const wrap = h('div', { class:'p-4 space-y-3' });
      wrap.append(
        h('div', { class:'flex items-center justify-between' }, [
          h('div', {}, [
            h('div', { class:'text-xl font-semibold' }, 'До Нового года'),
            h('div', { class:'text-xs text-white/70 mt-1' }, 'Счётчик до 1 января (локальное время).')
          ]),
          h('div', { class:'w-10 h-10', html: registry.nyCountdown.iconHtml })
        ])
      );

      const big = h('div', { class:'p-6 rounded-2xl border border-white/10 bg-white/5 text-center' });
      const line = h('div', { class:'text-3xl font-semibold tracking-tight', id:`nyc_${win.id}` }, '—');
      const sub = h('div', { class:'text-xs text-white/60 mt-2' }, 'Дни • Часы • Минуты');
      big.append(line, sub);
      wrap.append(big);

      const tick = () => {
        if (!state.windows.has(win.id)) return;
        const now = new Date();
        const year = now.getFullYear();
        const target = new Date(year + 1, 0, 1, 0, 0, 0);
        const ms = Math.max(0, target - now);
        const totalMin = Math.floor(ms/60000);
        const days = Math.floor(totalMin / (60*24));
        const hours = Math.floor((totalMin - days*60*24)/60);
        const mins = totalMin - days*60*24 - hours*60;
        const el = document.getElementById(`nyc_${win.id}`);
        if (el) el.textContent = `${days}д ${fmt2(hours)}ч ${fmt2(mins)}м`;
      };
      tick();
      const id = setInterval(tick, 1000);
      registerOnClose(win.id, () => clearInterval(id));
      return wrap;
    }

    function buildThemeManager(win){
      const wrap = h('div', { class:'p-3' });
      wrap.append(
        h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
          h('div', {}, [
            h('div', { class:'text-xl font-semibold' }, 'Менеджер тем'),
            h('div', { class:'text-xs text-white/70 mt-1' }, 'Наборы настроек: обои + акцент + иконки/фильтр + анимации + панель задач.')
          ]),
          h('div', { class:'w-10 h-10', html: registry.themeManager.iconHtml })
        ])
      );

      const themes = [
        {
          id:'auroraGlass',
          name:'Aurora Glass',
          desc:'Классический “акрил” + быстрая анимация.',
          accent:[99,102,241],
          wallpaper: Wallpapers.aurora,
          iconFilter:'none',
          taskbar:{ h:56, radius:18, alpha:.08, blur:18 },
          anim:{ open:160, close:140, min:160, ui:160 },
          font:{ preset:'system', custom:null },
          transparency:true,
          scheme:'dark',
          glassMode:'default'
        },
        {
          id:'light',
          name:'Светлая',
          desc:'Светлая схема интерфейса (как в Windows). Подходит для дневного режима.',
          accent:[59,130,246],
          wallpaper: `radial-gradient(900px 650px at 20% 20%, rgba(59,130,246,.25), transparent 60%),
                     radial-gradient(900px 650px at 80% 70%, rgba(34,211,238,.18), transparent 62%),
                     linear-gradient(180deg, #f8fafc, #e2e8f0)`,
          iconFilter:'none',
          taskbar:{ h:56, radius:18, alpha:.65, blur:14 },
          anim:{ open:160, close:140, min:160, ui:160 },
          font:{ preset:'system', custom:null },
          transparency:true,
          scheme:'light',
          glassMode:'default'
        },
        {
          id:'liquidGlass',
          name:'Liquid Glass',
          desc:'Полупрозрачная “жидкая” тема с динамическими бликами (beta).',
          accent:[56,189,248],
          wallpaper: `radial-gradient(1200px 800px at 20% 20%, rgba(56,189,248,.35), transparent 60%),
                     radial-gradient(900px 700px at 80% 30%, rgba(99,102,241,.30), transparent 60%),
                     radial-gradient(900px 700px at 55% 85%, rgba(244,114,182,.22), transparent 60%),
                     linear-gradient(180deg, #050813, #040615)`,
          iconFilter:'saturate(1.12) contrast(1.05)',
          taskbar:{ h:56, radius:20, alpha:.045, blur:28 },
          anim:{ open:180, close:160, min:170, ui:170 },
          font:{ preset:'segoe', custom:null },
          transparency:true,
          scheme:'dark',
          glassMode:'liquid'
        },
        {
          id:'graphitePro',
          name:'Graphite Pro',
          desc:'Моно-стиль, меньше блёсток, чуть резче.',
          accent:[148,163,184],
          wallpaper: Wallpapers.graphite,
          iconFilter:'grayscale(1) contrast(1.08) brightness(1.05)',
          taskbar:{ h:54, radius:16, alpha:.05, blur:10 },
          anim:{ open:140, close:120, min:140, ui:140 },
          font:{ preset:'monospace', custom:null },
          transparency:false,
          scheme:'dark',
          glassMode:'default'
        },
        {
          id:'blossom',
          name:'Blossom Night',
          desc:'Розово‑фиолетовая тема + чуть медленнее анимации.',
          accent:[244,114,182],
          wallpaper: Wallpapers.blossom,
          iconFilter:'saturate(1.15)',
          taskbar:{ h:60, radius:20, alpha:.10, blur:22 },
          anim:{ open:200, close:170, min:190, ui:190 },
          font:{ preset:'segoe', custom:null },
          transparency:true,
          scheme:'dark',
          glassMode:'default'
        },
        {
          id:'oceanCalm',
          name:'Ocean Calm',
          desc:'Холодная палитра + night light off.',
          accent:[34,211,238],
          wallpaper: Wallpapers.ocean,
          iconFilter:'none',
          taskbar:{ h:56, radius:18, alpha:.07, blur:18 },
          anim:{ open:170, close:150, min:170, ui:170 },
          font:{ preset:'system', custom:null },
          transparency:true,
          scheme:'dark',
          glassMode:'default'
        },
        {
          id:'newYearFun',
          name:'New Year Fun',
          desc:'Включает новогодние эффекты + яркий акцент.',
          accent:[56,189,248],
          wallpaper: Wallpapers.dunes,
          iconFilter:'none',
          taskbar:{ h:58, radius:20, alpha:.10, blur:22 },
          anim:{ open:180, close:150, min:180, ui:180 },
          font:{ preset:'segoe', custom:null },
          transparency:true,
          scheme:'dark',
          glassMode:'default',
          newYear:true
        }
      ];

      const grid = h('div', { class:'mt-3 grid sm:grid-cols-2 lg:grid-cols-3 gap-3' });

      const applyTheme = (t) => {
        ui.accent = t.accent;
        ui.wallpaperCustom = t.wallpaper;
        ui.iconFilter = t.iconFilter;
        ui.taskbar = t.taskbar;
        ui.anim = t.anim;
        ui.font = t.font;
        ui.scheme = t.scheme || 'dark';
        ui.glassMode = t.glassMode || 'default';
        state.transparency = (t.transparency ?? true);
        state.newYear = !!t.newYear;
        persistUI();
        applyUI();
        updateTaskbar();
        addNotification({ title:'Темы', body:`Применена тема: ${t.name}`, iconHtml: registry.themeManager.iconHtml, source:'Менеджер тем' });
      };

      themes.forEach(t => {
        const card = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/8 transition' });
        const thumb = h('div', { class:'h-20 rounded-xl border border-white/10', style:`background:${t.wallpaper};` });
        const name = h('div', { class:'mt-2 text-sm font-semibold' }, t.name);
        const desc = h('div', { class:'text-xs text-white/70 mt-1' }, t.desc);
        const btn = h('button', { class:'mt-3 w-full px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Применить');
        btn.style.background = `rgba(${t.accent.join(',')},.16)`;
        btn.style.borderColor = `rgba(${t.accent.join(',')},.22)`;
        btn.addEventListener('click', () => applyTheme(t));
        card.append(thumb, name, desc, btn);
        grid.appendChild(card);
      });

      const note = h('div', { class:'mt-3 text-xs text-white/60' }, 'Темы — демо. Они изменяют системные переменные (обои/акцент/анимации/шрифт/панель задач).');
      wrap.append(grid, note);
      return wrap;
    }

    // ---------- Extra apps (Store) ----------

    function buildTerminal(win){
      win.opts = win.opts || {};
      const wrap = h('div', { class:'p-3' });
      const header = h('div', { class:'flex items-center gap-2' }, [
        h('div', { class:'w-6 h-6', html: registry.terminal.iconHtml }),
        h('div', { class:'text-lg font-semibold' }, 'Terminal'),
        h('div', { class:'ml-auto text-xs text-white/60' }, 'Демо')
      ]);

      const out = h('div', { class:'mt-3 p-3 rounded-2xl border border-white/10 bg-black/30 font-mono text-[12px] text-white/85 h-[360px] overflow-auto scrollbar', style:'user-select:text;' });
      const row = h('div', { class:'mt-3 flex gap-2' });
      const inp = h('input', { class:'flex-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60 font-mono text-sm', placeholder:'help' });
      const btn = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Ввод');
      row.append(inp, btn);

      const print = (s='') => {
        out.appendChild(h('div', { class:'whitespace-pre-wrap break-words' }, s));
        out.scrollTop = out.scrollHeight;
      };

      const helpText = [
        'Команды:',
        '  help               — справка',
        '  clear              — очистить',
        '  date               — текущая дата/время',
        '  ls                 — список файлов (FS)',
        '  cat <name>         — показать файл (по имени)',
        '  open <appId>       — открыть приложение (например: store, notepad, paint)',
        '  yandex <query>     — поиск в Яндексе (откроет Edge)',
      ].join('\n');

      print('Windows Terminal (demo)');
      print('Введите: help');

      function run(line){
        const raw = (line||'').trim();
        if (!raw) return;
        print(`> ${raw}`);
        const [cmd, ...rest] = raw.split(' ');
        const arg = rest.join(' ').trim();

        if (cmd === 'help') { print(helpText); return; }
        if (cmd === 'clear') { out.innerHTML = ''; return; }
        if (cmd === 'date') { print(new Date().toString()); return; }
        if (cmd === 'ls') {
          const names = Object.values(fs.files||{}).map(f => f.name).slice(0, 80);
          print(names.length ? names.join('\n') : '(пусто)');
          return;
        }
        if (cmd === 'cat') {
          const name = arg.toLowerCase();
          const f = Object.values(fs.files||{}).find(x => (x.name||'').toLowerCase() === name);
          if (!f) { print('Файл не найден.'); return; }
          print(String(f.content||''));
          return;
        }
        if (cmd === 'open') {
          const id = (arg||'').trim();
          if (!id) { print('Укажите appId.'); return; }
          if (!registry[id]) { print('Неизвестное приложение.'); return; }
          openApp(id);
          return;
        }
        if (cmd === 'yandex') {
          if (!arg) { print('Укажите запрос.'); return; }
          openApp('edge', { url:'yandex:' + arg });
          return;
        }

        print('Неизвестная команда. help');
      }

      const submit = () => {
        const v = inp.value;
        inp.value = '';
        run(v);
      };
      btn.addEventListener('click', submit);
      inp.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); submit(); }
      });
      setTimeout(() => inp.focus(), 80);

      wrap.append(header, out, row);
      return wrap;
    }

    const TODO_KEY = 'w12_todo_v1';
    function todoLoad(){
      try { const raw = localStorage.getItem(TODO_KEY); if (raw) return JSON.parse(raw); } catch {}
      return { items: [ { id: uid(), text:'Установить тему Liquid Glass', done:false }, { id: uid(), text:'Попробовать Paint', done:false } ], filter:'all' };
    }
    function todoSave(m){ localStorage.setItem(TODO_KEY, JSON.stringify(m)); }

    function buildTodo(win){
      win.opts = win.opts || {};
      win.opts.todo = win.opts.todo || todoLoad();
      const model = win.opts.todo;

      const wrap = h('div', { class:'p-3' });
      const header = h('div', { class:'flex items-center gap-2' }, [
        h('div', { class:'w-6 h-6', html: registry.todo.iconHtml }),
        h('div', { class:'text-lg font-semibold' }, 'Список дел'),
        h('div', { class:'ml-auto text-xs text-white/60' }, 'Автосохранение')
      ]);

      const inputRow = h('div', { class:'mt-3 flex gap-2' });
      const inp = h('input', { class:'flex-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60', placeholder:'Новая задача' });
      const addBtn = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Добавить');
      inputRow.append(inp, addBtn);

      const filters = h('div', { class:'mt-3 flex gap-2 flex-wrap' });
      const mkFilter = (id, label) => {
        const b = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, label);
        const paint = () => {
          const on = model.filter === id;
          b.style.background = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.18)` : 'rgba(255,255,255,.05)';
          b.style.borderColor = on ? `rgba(${(ui.accent||[99,102,241]).join(',')},.28)` : 'rgba(255,255,255,.10)';
        };
        b.addEventListener('click', () => { model.filter = id; todoSave(model); renderList(); paintAll(); });
        b._paint = paint;
        paint();
        return b;
      };
      const fAll = mkFilter('all','Все');
      const fOpen = mkFilter('open','Активные');
      const fDone = mkFilter('done','Готово');
      filters.append(fAll, fOpen, fDone);
      const paintAll = () => [fAll,fOpen,fDone].forEach(b => b._paint && b._paint());

      const list = h('div', { class:'mt-3 space-y-2 max-h-[380px] overflow-auto scrollbar pr-1' });

      function renderList(){
        list.innerHTML = '';
        let items = model.items.slice();
        if (model.filter === 'open') items = items.filter(x => !x.done);
        if (model.filter === 'done') items = items.filter(x => x.done);

        if (!items.length) {
          list.appendChild(h('div', { class:'p-6 text-center text-white/60' }, 'Список пуст'));
          return;
        }

        for (const it of items) {
          const row = h('div', { class:'p-3 rounded-2xl border border-white/10 bg-white/5 flex items-center gap-2' });
          const chk = h('input', { type:'checkbox' });
          chk.checked = !!it.done;
          const txt = h('div', { class:'text-sm flex-1', style:`opacity:${it.done?0.65:1}; text-decoration:${it.done?'line-through':'none'};` }, it.text);
          const del = h('button', { class:'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' }, 'Удалить');

          chk.addEventListener('change', () => {
            it.done = chk.checked;
            todoSave(model);
            renderList();
          });
          del.addEventListener('click', () => {
            model.items = model.items.filter(x => x.id !== it.id);
            todoSave(model);
            renderList();
          });

          row.append(chk, txt, del);
          list.appendChild(row);
        }
      }

      function addTask(){
        const t = inp.value.trim();
        if (!t) return;
        model.items.unshift({ id: uid(), text: t, done:false });
        inp.value = '';
        todoSave(model);
        renderList();
      }
      addBtn.addEventListener('click', addTask);
      inp.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addTask(); } });

      const actions = h('div', { class:'mt-3 flex gap-2 flex-wrap' });
      const btnClearDone = h('button', { class:'btn text-sm' }, 'Очистить выполненные');
      btnClearDone.addEventListener('click', () => {
        model.items = model.items.filter(x => !x.done);
        todoSave(model);
        renderList();
      });
      const btnDemo = h('button', { class:'btn text-sm' }, 'Добавить демо-задачи');
      btnDemo.addEventListener('click', () => {
        model.items.unshift({ id: uid(), text:'Открыть Microsoft Store → Персонализация', done:false });
        model.items.unshift({ id: uid(), text:'Настроить панель задач', done:false });
        todoSave(model);
        renderList();
      });
      actions.append(btnClearDone, btnDemo);

      renderList();
      wrap.append(header, inputRow, filters, actions, list);
      setTimeout(() => inp.focus(), 80);
      return wrap;
    }

    // ---------- Multimedia / utility helpers ----------
    function fileExt(name){
      const s = String(name||'');
      const m = s.toLowerCase().match(/\.([a-z0-9]+)$/);
      return m ? m[1] : '';
    }

    function openFileById(fileId){
      const f = fs.files?.[fileId];
      if (!f) return;
      const ext = (f.ext || fileExt(f.name) || '').toLowerCase();
      const imgExts = new Set(['png','jpg','jpeg','webp','gif']);
      const audExts = new Set(['mp3','wav','ogg','m4a','aac']);
      if (imgExts.has(ext)) { openApp('photos', { fileId }); return; }
      if (audExts.has(ext)) { openApp('musicPlayer', { fileId }); return; }
      if (ext === 'wzip') { openApp('archiver', { fileId }); return; }
      openNotepadWithFile(fileId);
    }

    function fileToDataUrl(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result||''));
        r.onerror = () => reject(r.error);
        r.readAsDataURL(file);
      });
    }

    async function importBinaryToFS(file, folder='downloads'){
      const name = file.name || ('file_' + Date.now());
      const ext = fileExt(name) || 'bin';
      const dataUrl = await fileToDataUrl(file);
      const id = uid();
      fs.files[id] = { id, name, ext, updatedAt: Date.now(), kind:'blob', mime: file.type || 'application/octet-stream' };
      fs.blobs[id] = { mime: file.type || 'application/octet-stream', dataUrl };
      fs[folder] = Array.isArray(fs[folder]) ? fs[folder] : [];
      fs[folder].unshift({ type:'file', fileId: id, name, ext });
      fsSave(fs);
      return id;
    }

    function b64enc(str){
      return btoa(unescape(encodeURIComponent(String(str||''))));
    }
    function b64dec(str){
      return decodeURIComponent(escape(atob(String(str||''))));
    }

    // ---------- Photos ----------
    function buildPhotos(win){
      win.opts = win.opts || {};
      const wrap = h('div', { class:'p-3' });

      const header = h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
        h('div', { class:'flex items-center gap-2' }, [
          h('div', { class:'w-6 h-6', html: registry.photos.iconHtml }),
          h('div', { class:'text-lg font-semibold' }, 'Фото')
        ]),
        h('div', { class:'flex items-center gap-2 flex-wrap' }, [
          h('button', { class:'btn text-sm', id:`phImport_${win.id}` }, 'Импорт'),
          h('button', { class:'btn text-sm', id:`phSetWp_${win.id}` }, 'Сделать обоями')
        ])
      ]);

      const layout = h('div', { class:'mt-3 grid grid-cols-1 lg:grid-cols-[1fr_340px] gap-3 items-start' });
      const grid = h('div', { class:'grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 max-h-[520px] overflow-auto scrollbar pr-1' });
      const side = h('div', { class:'p-3 rounded-2xl border border-white/10 bg-white/5' });

      const img = h('img', { class:'w-full rounded-2xl border border-white/10 bg-black/20 object-contain', style:'height: 320px; display:block;' });
      const meta = h('div', { class:'mt-2 text-xs text-white/70 break-words' }, '—');
      const zoom = h('input', { type:'range', min:'50', max:'220', value:'100', class:'w-full mt-3' });
      const nav = h('div', { class:'mt-3 flex gap-2' }, [
        h('button', { class:'btn text-sm', id:`phPrev_${win.id}` }, '‹'),
        h('button', { class:'btn text-sm', id:`phNext_${win.id}` }, '›')
      ]);
      side.append(img, meta, h('div', { class:'text-xs text-white/60 mt-3' }, 'Масштаб'), zoom, nav);

      function listImages(){
        const out = [];
        const exts = new Set(['png','jpg','jpeg','webp','gif']);
        for (const f of Object.values(fs.files||{})) {
          const ext = (f.ext || fileExt(f.name)).toLowerCase();
          if (!exts.has(ext)) continue;
          if (fs.blobs?.[f.id]?.dataUrl) out.push(f);
        }
        out.sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
        return out;
      }

      const stateLocal = win.opts._ph || (win.opts._ph = { fileId: win.opts.fileId || null });

      function setActive(fileId){
        stateLocal.fileId = fileId;
        win.opts.fileId = fileId;
        renderSide();
        paintGrid();
      }

      function renderSide(){
        const f = stateLocal.fileId ? fs.files[stateLocal.fileId] : null;
        const blob = f ? fs.blobs?.[f.id] : null;
        if (!f || !blob) {
          img.removeAttribute('src');
          img.style.background = 'rgba(0,0,0,.2)';
          meta.textContent = 'Нет изображений. Импортируйте файл (PNG/JPG/WebP/GIF).';
          return;
        }
        img.src = blob.dataUrl;
        img.style.transform = `scale(${Number(zoom.value)/100})`;
        img.style.transformOrigin = 'center center';
        meta.textContent = `${f.name} • ${(blob.mime||'').split('/').pop() || ''}`;
      }

      function paintGrid(){
        const items = listImages();
        grid.innerHTML = '';
        if (!items.length) {
          grid.appendChild(h('div', { class:'col-span-full p-6 text-center text-white/60' }, 'В библиотеке нет изображений'));
          return;
        }
        if (!stateLocal.fileId) stateLocal.fileId = items[0].id;

        for (const f of items) {
          const blob = fs.blobs[f.id];
          const b = h('button', { class:'p-2 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-left transition' });
          const th = h('img', { class:'h-20 w-full rounded-xl border border-white/10 object-cover bg-black/20', src: blob.dataUrl });
          const t = h('div', { class:'mt-2 text-[12px] text-white/80 truncate' }, f.name);
          b.append(th, t);
          b.addEventListener('click', () => setActive(f.id));
          if (stateLocal.fileId === f.id) b.style.outline = `2px solid rgba(${(ui.accent||[99,102,241]).join(',')},.55)`;
          grid.appendChild(b);
        }
        renderSide();
      }

      function shift(delta){
        const items = listImages();
        if (!items.length) return;
        const idx = Math.max(0, items.findIndex(x => x.id === stateLocal.fileId));
        const ni = (idx + delta + items.length) % items.length;
        setActive(items[ni].id);
      }

      zoom.addEventListener('input', () => { renderSide(); });

      const btnPrev = side.querySelector(`#phPrev_${win.id}`);
      const btnNext = side.querySelector(`#phNext_${win.id}`);
      btnPrev && btnPrev.addEventListener('click', () => shift(-1));
      btnNext && btnNext.addEventListener('click', () => shift(1));

      const btnImport = header.querySelector(`#phImport_${win.id}`);
      const btnSetWp = header.querySelector(`#phSetWp_${win.id}`);

      btnImport && btnImport.addEventListener('click', async () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async () => {
          const f = input.files?.[0];
          if (!f) return;
          const id = await importBinaryToFS(f, 'pictures');
          addNotification({ title:'Фото', body:`Импортировано: ${fs.files[id].name}`, iconHtml: registry.photos.iconHtml, source:'Фото' });
          setActive(id);
          paintGrid();
        };
        input.click();
      });

      btnSetWp && btnSetWp.addEventListener('click', () => {
        const fid = stateLocal.fileId;
        const blob = fid ? fs.blobs?.[fid] : null;
        if (!fid || !blob) return;
        // Use as wallpaper via CSS image
        ui.wallpaperCustom = `url('${blob.dataUrl}')`;
        persistUI();
        applyUI();
        addNotification({ title:'Фото', body:'Установлено как обои (демо).', iconHtml: registry.photos.iconHtml, source:'Фото' });
      });

      paintGrid();
      layout.append(grid, side);
      wrap.append(header, layout);
      return wrap;
    }

    // ---------- Music ----------
    const MUSIC_KEY = 'w12_music_v1';
    function musicLoad(){
      try { const raw = localStorage.getItem(MUSIC_KEY); if (raw) return JSON.parse(raw); } catch {}
      return { queue: [], activeId: null };
    }
    function musicSave(m){ localStorage.setItem(MUSIC_KEY, JSON.stringify(m)); }

    function buildMusic(win){
      win.opts = win.opts || {};
      win.opts.music = win.opts.music || musicLoad();
      const model = win.opts.music;

      const wrap = h('div', { class:'p-3' });
      const header = h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
        h('div', { class:'flex items-center gap-2' }, [
          h('div', { class:'w-6 h-6', html: registry.musicPlayer.iconHtml }),
          h('div', { class:'text-lg font-semibold' }, 'Музыка')
        ]),
        h('div', { class:'flex items-center gap-2 flex-wrap' }, [
          h('button', { class:'btn text-sm', id:`muImport_${win.id}` }, 'Импорт'),
          h('button', { class:'btn text-sm', id:`muClear_${win.id}` }, 'Очистить')
        ])
      ]);

      const layout = h('div', { class:'mt-3 grid grid-cols-1 lg:grid-cols-[1fr_320px] gap-3 items-start' });
      const list = h('div', { class:'p-2 rounded-2xl border border-white/10 bg-white/5 max-h-[520px] overflow-auto scrollbar' });
      const side = h('div', { class:'p-3 rounded-2xl border border-white/10 bg-white/5' });

      const audio = document.createElement('audio');
      audio.controls = true;
      audio.style.width = '100%';

      const now = h('div', { class:'mt-2 text-sm font-semibold' }, '—');
      const sub = h('div', { class:'text-xs text-white/60 mt-1' }, 'Плеер (демо). Импортируйте mp3/ogg/wav.');

      const btnPrev = h('button', { class:'btn text-sm' }, '‹');
      const btnNext = h('button', { class:'btn text-sm' }, '›');
      const btnPlay = h('button', { class:'btn text-sm' }, 'Play/Pause');
      const controls = h('div', { class:'mt-3 flex gap-2' }, [btnPrev, btnPlay, btnNext]);

      side.append(audio, now, sub, controls);

      function queueFiles(){
        // Use saved queue if available, otherwise scan FS
        const audExts = new Set(['mp3','wav','ogg','m4a','aac']);
        const out = [];
        for (const f of Object.values(fs.files||{})) {
          const ext = (f.ext || fileExt(f.name)).toLowerCase();
          if (!audExts.has(ext)) continue;
          if (fs.blobs?.[f.id]?.dataUrl) out.push(f);
        }
        out.sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
        return out;
      }

      function setActive(fid){
        model.activeId = fid;
        musicSave(model);
        renderSide();
        renderList();
      }

      function renderSide(){
        const f = model.activeId ? fs.files[model.activeId] : null;
        const blob = f ? fs.blobs?.[f.id] : null;
        if (!f || !blob) {
          audio.removeAttribute('src');
          now.textContent = '—';
          return;
        }
        now.textContent = f.name;
        audio.src = blob.dataUrl;
      }

      function renderList(){
        const items = queueFiles();
        list.innerHTML = '';
        if (!items.length) {
          list.appendChild(h('div', { class:'p-6 text-center text-white/60' }, 'В библиотеке нет треков'));
          return;
        }
        if (!model.activeId) model.activeId = win.opts.fileId || items[0].id;

        for (const f of items) {
          const row = h('button', { class:'w-full text-left menu-item' }, [
            h('div', { class:'w-8 h-8 flex items-center justify-center', html: registry.musicPlayer.iconHtml }),
            h('div', { class:'min-w-0 flex-1' }, [
              h('div', { class:'text-sm font-semibold truncate' }, f.name),
              h('div', { class:'text-xs text-white/60' }, (fs.blobs?.[f.id]?.mime || 'audio').split('/').pop())
            ])
          ]);
          row.addEventListener('click', () => setActive(f.id));
          if (model.activeId === f.id) row.style.background = `rgba(${(ui.accent||[99,102,241]).join(',')},.12)`;
          list.appendChild(row);
        }
        renderSide();
      }

      function shift(delta){
        const items = queueFiles();
        if (!items.length) return;
        const idx = Math.max(0, items.findIndex(x => x.id === model.activeId));
        const ni = (idx + delta + items.length) % items.length;
        setActive(items[ni].id);
        audio.play().catch(()=>{});
      }

      btnPrev.addEventListener('click', () => shift(-1));
      btnNext.addEventListener('click', () => shift(1));
      btnPlay.addEventListener('click', () => {
        if (audio.paused) audio.play().catch(()=>{});
        else audio.pause();
      });

      const btnImport = header.querySelector(`#muImport_${win.id}`);
      const btnClear = header.querySelector(`#muClear_${win.id}`);

      btnImport && btnImport.addEventListener('click', async () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'audio/*';
        input.multiple = true;
        input.onchange = async () => {
          const files = Array.from(input.files||[]);
          for (const f of files) {
            const id = await importBinaryToFS(f, 'music');
            addNotification({ title:'Музыка', body:`Импортировано: ${fs.files[id].name}`, iconHtml: registry.musicPlayer.iconHtml, source:'Музыка' });
            model.activeId = model.activeId || id;
          }
          musicSave(model);
          renderList();
        };
        input.click();
      });

      btnClear && btnClear.addEventListener('click', () => {
        if (!confirm('Очистить библиотеку музыки (демо)?')) return;
        // remove only audio entries from FS
        const audExts = new Set(['mp3','wav','ogg','m4a','aac']);
        for (const f of Object.values(fs.files||{})) {
          const ext = (f.ext || fileExt(f.name)).toLowerCase();
          if (!audExts.has(ext)) continue;
          if (fs.blobs?.[f.id]) delete fs.blobs[f.id];
          delete fs.files[f.id];
        }
        for (const k of ['music','downloads']) {
          if (!Array.isArray(fs[k])) continue;
          fs[k] = fs[k].filter(it => {
            if (it?.type !== 'file') return true;
            const ff = fs.files?.[it.fileId];
            const ext = (ff?.ext || fileExt(ff?.name)).toLowerCase();
            return !audExts.has(ext);
          });
        }
        fsSave(fs);
        model.activeId = null;
        musicSave(model);
        renderList();
      });

      // Auto-open file if requested
      if (win.opts.fileId) {
        model.activeId = win.opts.fileId;
      }

      renderList();
      layout.append(list, side);
      wrap.append(header, layout);
      return wrap;
    }

    // ---------- Sticky Notes ----------
    const NOTES_KEY = 'w12_notes_v1';
    function notesLoad(){
      try { const raw = localStorage.getItem(NOTES_KEY); if (raw) return JSON.parse(raw); } catch {}
      return { notes: [ { id: uid(), text:'Добро пожаловать в «Заметки»!', color:'#fbbf24', updatedAt: Date.now() } ], q:'' };
    }
    function notesSave(m){ localStorage.setItem(NOTES_KEY, JSON.stringify(m)); }

    function buildStickyNotes(win){
      win.opts = win.opts || {};
      win.opts.notes = win.opts.notes || notesLoad();
      const model = win.opts.notes;

      const wrap = h('div', { class:'p-3' });
      const header = h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
        h('div', { class:'flex items-center gap-2' }, [
          h('div', { class:'w-6 h-6', html: registry.stickyNotes.iconHtml }),
          h('div', { class:'text-lg font-semibold' }, 'Заметки')
        ]),
        h('button', { class:'btn text-sm', id:`ntNew_${win.id}` }, 'Новая заметка')
      ]);

      const search = h('input', { class:'mt-3 w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60', placeholder:'Поиск по заметкам…', value: model.q || '' });
      const grid = h('div', { class:'mt-3 grid sm:grid-cols-2 lg:grid-cols-3 gap-3 max-h-[520px] overflow-auto scrollbar pr-1' });

      function addNote(){
        model.notes.unshift({ id: uid(), text:'', color:'#fde68a', updatedAt: Date.now() });
        notesSave(model);
        render();
      }

      function render(){
        grid.innerHTML = '';
        const q = (model.q || '').trim().toLowerCase();
        const list = model.notes.filter(n => !q || (n.text||'').toLowerCase().includes(q));
        if (!list.length) {
          grid.appendChild(h('div', { class:'col-span-full p-6 text-center text-white/60' }, 'Нет заметок'));
          return;
        }

        for (const n of list) {
          const card = h('div', { class:'p-3 rounded-2xl border border-white/10', style:`background: rgba(255,255,255,.06);` });
          card.style.boxShadow = '0 18px 40px rgba(0,0,0,.25)';
          const top = h('div', { class:'flex items-center justify-between gap-2' }, [
            h('div', { class:'text-xs text-white/60' }, new Date(n.updatedAt||Date.now()).toLocaleString('ru-RU')),
            h('button', { class:'px-2 py-1 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 text-xs' }, 'Удалить')
          ]);
          const delBtn = top.lastChild;

          const palette = ['#fde68a','#fca5a5','#a7f3d0','#bfdbfe','#e9d5ff','#fecaca','#fcd34d'];
          const palRow = h('div', { class:'mt-2 flex gap-2 flex-wrap items-center' });
          palette.forEach(c => {
            const b = h('button', { class:'w-6 h-6 rounded-lg border border-white/15', title:c });
            b.style.background = c;
            b.style.outline = (n.color === c) ? `2px solid rgba(${(ui.accent||[99,102,241]).join(',')},.6)` : 'none';
            b.addEventListener('click', () => {
              n.color = c;
              n.updatedAt = Date.now();
              notesSave(model);
              render();
            });
            palRow.appendChild(b);
          });

          const ta = h('textarea', { class:'mt-2 w-full h-40 resize-none rounded-xl border border-white/10 bg-white/5 p-3 outline-none scrollbar', style:`user-select:text; background:${n.color}22;` });
          ta.value = n.text || '';
          ta.addEventListener('input', () => {
            n.text = ta.value;
            n.updatedAt = Date.now();
            notesSave(model);
          });

          delBtn.addEventListener('click', () => {
            if (!confirm('Удалить заметку?')) return;
            model.notes = model.notes.filter(x => x.id !== n.id);
            notesSave(model);
            render();
          });

          card.append(top, palRow, ta);
          grid.appendChild(card);
        }
      }

      const btnNew = header.querySelector(`#ntNew_${win.id}`);
      btnNew && btnNew.addEventListener('click', addNote);
      search.addEventListener('input', () => { model.q = search.value; notesSave(model); render(); });

      wrap.append(header, search, grid);
      render();
      return wrap;
    }

    // ---------- Archiver (demo .wzip) ----------
    function buildArchiver(win){
      win.opts = win.opts || {};
      const wrap = h('div', { class:'p-3' });
      const header = h('div', { class:'flex items-center justify-between gap-2 flex-wrap' }, [
        h('div', { class:'flex items-center gap-2' }, [
          h('div', { class:'w-6 h-6', html: registry.archiver.iconHtml }),
          h('div', { class:'text-lg font-semibold' }, 'Архиватор (демо)')
        ]),
        h('div', { class:'text-xs text-white/60' }, 'Формат: .wzip (JSON)')
      ]);

      const layout = h('div', { class:'mt-3 grid grid-cols-1 lg:grid-cols-2 gap-3' });

      const createCard = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' });
      const openCard = h('div', { class:'p-4 rounded-2xl border border-white/10 bg-white/5' });

      // Create
      createCard.append(
        h('div', { class:'text-sm font-semibold' }, 'Создать архив'),
        h('div', { class:'text-xs text-white/70 mt-1' }, 'Выберите несколько файлов из виртуальной FS и создайте архив.'),
      );

      const nameInp = h('input', { class:'mt-3 w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]/60', value:'archive.wzip' });
      const filesBox = h('div', { class:'mt-3 max-h-[260px] overflow-auto scrollbar pr-1 space-y-1' });
      const btnCreate = h('button', { class:'mt-3 w-full btn text-sm' }, 'Создать');

      function listPackableFiles(){
        const out = Object.values(fs.files||{}).filter(f => (f.ext||fileExt(f.name)).toLowerCase() !== 'wzip');
        out.sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
        return out;
      }

      const sel = new Set();
      function renderPackList(){
        filesBox.innerHTML = '';
        const files = listPackableFiles();
        if (!files.length) filesBox.appendChild(h('div', { class:'text-sm text-white/60 p-2' }, 'Нет файлов'));
        for (const f of files.slice(0, 200)) {
          const row = h('label', { class:'flex items-center gap-2 px-2 py-2 rounded-xl hover:bg-white/8 cursor-pointer' });
          const cb = h('input', { type:'checkbox' });
          cb.checked = sel.has(f.id);
          cb.addEventListener('change', () => {
            if (cb.checked) sel.add(f.id); else sel.delete(f.id);
          });
          row.append(cb, h('div', { class:'text-sm font-semibold truncate flex-1' }, f.name), h('div', { class:'text-[11px] text-white/60' }, (f.ext||fileExt(f.name)).toUpperCase()));
          filesBox.appendChild(row);
        }
      }

      btnCreate.addEventListener('click', () => {
        const nm = (nameInp.value || 'archive.wzip').trim();
        if (!nm) return;
        if (!sel.size) { addNotification({ title:'Архиватор', body:'Выберите файлы для архива.', iconHtml: registry.archiver.iconHtml, source:'Архиватор' }); return; }

        const items = [];
        for (const fid of sel) {
          const f = fs.files[fid];
          if (!f) continue;
          const ext = (f.ext||fileExt(f.name)).toLowerCase();
          if (f.kind === 'blob' && fs.blobs?.[fid]?.dataUrl) {
            items.push({ name: f.name, ext, kind:'blob', mime: f.mime || fs.blobs[fid].mime, dataUrl: fs.blobs[fid].dataUrl });
          } else {
            items.push({ name: f.name, ext, kind:'text', content: String(f.content||'') });
          }
        }

        const pack = { type:'wzip', version:1, createdAt: Date.now(), items };
        const id = uid();
        const finalName = nm.endsWith('.wzip') ? nm : (nm + '.wzip');
        fs.files[id] = { id, name: finalName, ext:'wzip', updatedAt: Date.now(), content: b64enc(JSON.stringify(pack)) };
        fs.downloads = Array.isArray(fs.downloads) ? fs.downloads : [];
        fs.downloads.unshift({ type:'file', fileId:id, name: finalName, ext:'wzip' });
        fsSave(fs);
        addNotification({ title:'Архиватор', body:`Архив создан: ${finalName}`, iconHtml: registry.archiver.iconHtml, source:'Архиватор' });
        win.opts.fileId = id;
        refreshWindowContent(win.id);
      });

      createCard.append(nameInp, filesBox, btnCreate);

      // Open / extract
      openCard.append(
        h('div', { class:'text-sm font-semibold' }, 'Открыть и извлечь'),
        h('div', { class:'text-xs text-white/70 mt-1' }, 'Выберите архив .wzip и извлеките файлы в «Загрузки».')
      );

      const archSel = h('select', { class:'mt-3 w-full px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm' });
      const listBox = h('div', { class:'mt-3 max-h-[260px] overflow-auto scrollbar pr-1 space-y-1' });
      const btnExtract = h('button', { class:'mt-3 w-full btn text-sm' }, 'Извлечь в Загрузки');

      function listArchives(){
        const out = Object.values(fs.files||{}).filter(f => (f.ext||fileExt(f.name)).toLowerCase() === 'wzip');
        out.sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0));
        return out;
      }

      function renderArchives(){
        const arcs = listArchives();
        archSel.innerHTML = '';
        archSel.appendChild(h('option', { value:'' }, arcs.length ? 'Выберите архив…' : 'Архивов нет'));
        for (const f of arcs) {
          archSel.appendChild(h('option', { value:f.id, selected: (win.opts.fileId===f.id) ? 'selected' : null }, f.name));
        }
      }

      function readArchive(fid){
        const f = fs.files[fid];
        if (!f) return null;
        try {
          const json = b64dec(f.content||'');
          return JSON.parse(json);
        } catch {
          return null;
        }
      }

      function renderArchiveContents(){
        listBox.innerHTML = '';
        const fid = archSel.value || win.opts.fileId;
        if (!fid) { listBox.appendChild(h('div', { class:'text-sm text-white/60 p-2' }, 'Выберите архив')); return; }
        const pack = readArchive(fid);
        if (!pack || !Array.isArray(pack.items)) {
          listBox.appendChild(h('div', { class:'text-sm text-white/60 p-2' }, 'Архив повреждён или имеет неверный формат.'));
          return;
        }
        for (const it of pack.items) {
          listBox.appendChild(h('div', { class:'px-2 py-2 rounded-xl border border-white/10 bg-white/5 flex items-center justify-between gap-2' }, [
            h('div', { class:'text-sm font-semibold truncate' }, it.name),
            h('div', { class:'text-[11px] text-white/60' }, it.kind)
          ]));
        }
      }

      btnExtract.addEventListener('click', () => {
        const fid = archSel.value || win.opts.fileId;
        if (!fid) return;
        const pack = readArchive(fid);
        if (!pack || !Array.isArray(pack.items)) return;

        fs.downloads = Array.isArray(fs.downloads) ? fs.downloads : [];
        for (const it of pack.items) {
          const nid = uid();
          const ext = (it.ext || fileExt(it.name) || 'txt').toLowerCase();
          if (it.kind === 'blob' && it.dataUrl) {
            fs.files[nid] = { id:nid, name: it.name, ext, updatedAt: Date.now(), kind:'blob', mime: it.mime || 'application/octet-stream' };
            fs.blobs[nid] = { mime: it.mime || 'application/octet-stream', dataUrl: it.dataUrl };
          } else {
            fs.files[nid] = { id:nid, name: it.name, ext, updatedAt: Date.now(), content: String(it.content||'') };
          }
          fs.downloads.unshift({ type:'file', fileId:nid, name: it.name, ext });
        }
        fsSave(fs);
        addNotification({ title:'Архиватор', body:'Извлечение завершено (Загрузки).', iconHtml: registry.archiver.iconHtml, source:'Архиватор' });
      });

      archSel.addEventListener('change', () => {
        win.opts.fileId = archSel.value || null;
        renderArchiveContents();
      });

      renderPackList();
      renderArchives();
      renderArchiveContents();

      openCard.append(archSel, listBox, btnExtract);
      layout.append(createCard, openCard);
      wrap.append(header, layout);
      return wrap;
    }

    // ---------- Power actions ----------
    let shutdownTimer = null;
    let powerMode = null; // 'restart' | 'shutdown'

    function closeAllWindows(){
      for (const w of Array.from(state.windows.values())) {
        try { closeWindow(w.id); } catch {}
      }
    }

    function setSystemDisabled(disabled){
      const desk = $('#desktop');
      const tb = $('#taskbar');
      if (desk) desk.style.pointerEvents = disabled ? 'none' : '';
      if (tb) tb.style.pointerEvents = disabled ? 'none' : '';
    }

    function powerAction(kind){
      if (kind === 'sleep') {
        hideAllPopovers();
        $('#sleepOverlay').style.display = 'flex';
        addNotification({ title:'Питание', body:'Сон включён.', iconHtml: Icons.moon('w-6 h-6'), source:'Система' });
        return;
      }

      if (kind === 'restart') {
        hideAllPopovers();
        powerMode = 'restart';
        // Start closing windows for realism
        closeAllWindows();
        showShutdown({
          title: 'Перезагрузка',
          text: 'Перезагрузка…',
          ms: 1500,
          onDone: () => {
            // cleaner: reload the page (simulates reboot)
            location.reload();
          }
        });
        return;
      }

      if (kind === 'shutdown') {
        hideAllPopovers();
        powerMode = 'shutdown';
        // Start closing windows for realism
        closeAllWindows();
        showShutdown({
          title: 'Завершение работы',
          text: 'Завершение работы…',
          ms: 900,
          onDone: () => {
            // simulate power off
            $('#shutdownText').textContent = 'Компьютер выключен. Нажмите «Включить», чтобы продолжить.';
            const btn = $('#btnShutdownCancel');
            if (btn) btn.textContent = 'Включить';
            setSystemDisabled(true);
          }
        });
        return;
      }
    }

    function showShutdown({title='Завершение работы', text='Пожалуйста, подождите…', ms=1200, onDone=null}={}){
      const titleEl = $('#shutdownTitle');
      if (titleEl) titleEl.textContent = title;
      $('#shutdownText').textContent = text;
      $('#shutdownOverlay').classList.remove('hidden');
      const btn = $('#btnShutdownCancel');
      if (btn) btn.textContent = 'Отмена';
      setSystemDisabled(true);
      clearTimeout(shutdownTimer);
      shutdownTimer = setTimeout(() => onDone?.(), ms);
    }

    function hideShutdown(){
      clearTimeout(shutdownTimer);

      // If we were in simulated shutdown state, treat the button as "power on"
      if (powerMode === 'shutdown' && $('#shutdownText')?.textContent?.includes('Компьютер выключен')) {
        // Realistic power on: reload the page (fresh boot sequence)
        location.reload();
        return;
      }

      $('#shutdownOverlay').classList.add('hidden');
      $('#shutdownText').textContent = 'Пожалуйста, подождите…';
      const btn = $('#btnShutdownCancel');
      if (btn) btn.textContent = 'Отмена';
      setSystemDisabled(false);
      powerMode = null;
    }

    // ---------- Desktop selection rectangle ----------
    const selRect = $('#selRect');
    let selecting = null;
    function startSelection(e){
      selecting = { x: e.clientX, y: e.clientY, active: false };
      selRect.classList.add('hidden');
      selRect.style.left = selecting.x + 'px';
      selRect.style.top = selecting.y + 'px';
      selRect.style.width = '0px';
      selRect.style.height = '0px';
    }
    function updateSelection(e){
      if (!selecting) return;
      const dx = e.clientX - selecting.x;
      const dy = e.clientY - selecting.y;
      if (!selecting.active && Math.hypot(dx, dy) > 10) selecting.active = true;
      if (!selecting.active) return;

      const x1 = Math.min(selecting.x, e.clientX);
      const y1 = Math.min(selecting.y, e.clientY);
      const x2 = Math.max(selecting.x, e.clientX);
      const y2 = Math.max(selecting.y, e.clientY);
      selRect.classList.remove('hidden');
      selRect.style.left = x1 + 'px';
      selRect.style.top = y1 + 'px';
      selRect.style.width = (x2 - x1) + 'px';
      selRect.style.height = (y2 - y1) + 'px';

      const rect = { left:x1, top:y1, right:x2, bottom:y2 };
      const hits = [];
      $$('#desktopIcons .desktop-icon').forEach(icon => {
        const r = icon.getBoundingClientRect();
        const inter = !(r.right < rect.left || r.left > rect.right || r.bottom < rect.top || r.top > rect.bottom);
        if (inter) hits.push(icon.getAttribute('data-did'));
      });
      setSelection(hits);
    }
    function endSelection(){
      selecting = null;
      selRect.classList.add('hidden');
    }

    // ---------- Global click handling ----------
    function clickOutsideHandler(e){
      const target = (e.target instanceof Element) ? e.target : e.target?.parentElement;
      if (!target) return;

      const isOnTaskbar = target.closest('#taskbar');
      const isOnStart = target.closest('#startMenu');
      const isOnSearch = target.closest('#searchFlyout');
      const isOnQS = target.closest('#quickSettings');
      const isOnNotif = target.closest('#notifCenter');
      const isOnCal = target.closest('#calendarFlyout');
      const isOnCtx = target.closest('#ctxMenu');
      const isOnIconMenu = target.closest('#iconMenu');
      const isOnWidgets = target.closest('#widgetsFlyout');
      const isOnRun = target.closest('#runDialog');
      const isOnWindow = target.closest('[data-win]');
      const isOnIcon = target.closest('.desktop-icon');
      const isTaskCtx = !!(taskCtx && taskCtx.contains(target));
      // Generic safety: any flyout/context menu should be clickable without auto-close
      const isOnAnyFlyout = target.closest('.flyout');

      if (!isOnTaskbar && !isOnStart && !isOnSearch && !isOnQS && !isOnNotif && !isOnCal && !isOnCtx && !isOnWindow && !isTaskCtx && !isOnIconMenu && !isOnWidgets && !isOnRun && !isOnIcon && !isOnAnyFlyout) {
        hideAllPopovers();
      }
    }

    // ---------- Keyboard shortcuts ----------
    function altTab(){
      const visible = state.order.filter(id => {
        const w = state.windows.get(id);
        return w && !w.minimized;
      });
      if (!visible.length) return;
      state.altTabIndex = (state.altTabIndex + 1) % visible.length;
      focusWindow(visible[state.altTabIndex]);
    }

    // ---------- Init icons on static elements ----------
    function initStaticIcons(){
      setIcon('icoStart', Icons.win('w-6 h-6'));
      setIcon('icoSearch', Icons.search('w-5 h-5'));
      setIcon('icoSearch2', Icons.search('w-5 h-5'));
      setIcon('icoSearch3', Icons.search('w-5 h-5'));
      setIcon('icoBell', Icons.bell('w-5 h-5'));
      setIcon('icoFolder', Icons.folder('w-5 h-5'));
      setIcon('icoNote', Icons.note('w-5 h-5'));
      setIcon('icoSettings', Icons.settings('w-5 h-5'));
      setIcon('icoRefresh', Icons.refresh('w-5 h-5'));
      setIcon('icoUser', Icons.user('w-6 h-6'));
      setIcon('icoPower', Icons.power('w-5 h-5'));
      setIcon('icoDev', Icons.dots('w-5 h-5'));
      setIcon('icoMoon', Icons.moon('w-5 h-5'));
      setIcon('icoRestart', Icons.restart('w-5 h-5'));
      setIcon('icoShutdown', Icons.shutdown('w-5 h-5'));
      setIcon('icoWifi', Icons.wifi('w-5 h-5'));
      setIcon('icoBt', Icons.bluetooth('w-5 h-5'));
      setIcon('icoNight', Icons.night('w-5 h-5'));
      setIcon('icoWin', Icons.win('w-10 h-10'));
      setIcon('icoLock', Icons.lock('w-10 h-10'));
      setIcon('icoWinLogin', Icons.win('w-10 h-10'));
      setIcon('icoWidgets', Icons.widgets('w-6 h-6'));
      setIcon('icoWidgets2', Icons.widgets('w-5 h-5'));
      setIcon('icoRun', Icons.run('w-6 h-6'));

      // Boot overlay logo
      setIcon('bootLogo', Icons.win('w-14 h-14'));
    }

    // ---------- Widgets ----------
    const Tips = [
      'Ctrl/⌘ + клик по иконкам — мультивыделение. Затем перетащите — они поедут вместе.',
      'Проводник синхронизирован с рабочим столом: создавайте папки в разделе «Рабочий стол».',
      'Разверните окно — панель задач будет автоскрываться.',
      'Edge: любой текст без URL считается запросом и ищется в Яндексе.',
      'Microsoft Store: в «Персонализация» есть обои, темы и инструменты (Paint, Дизайнер иконок и др.).'
    ];
    let tipIdx = 0;

    function renderWidgets(){
      const mem = Math.round((performance?.memory?.usedJSHeapSize || 0) / 1024 / 1024);
      const now = new Date();
      const cpuFake = 8 + Math.round(Math.abs(Math.sin(Date.now()/1200)) * 42);
      $('#sysSummary').textContent = `Время: ${now.toLocaleTimeString('ru-RU')} • "CPU": ${cpuFake}% • Heap: ${mem ? mem+'MB' : '—'}`;

      $('#tipsBox').textContent = Tips[tipIdx % Tips.length];
      updateFocusUI();
    }

    function updateFocusUI(){
      const ms = state.focusTimer.remainingMs;
      const m = Math.floor(ms/60000);
      const s = Math.floor((ms%60000)/1000);
      $('#focusTime').textContent = `${fmt2(m)}:${fmt2(s)}`;
      $('#btnFocusStart').textContent = state.focusTimer.running ? 'Пауза' : 'Старт';
    }

    function focusStartPause(){
      const t = state.focusTimer;
      if (!t.running) {
        t.running = true;
        t.startedAt = Date.now();
        t.tickId = setInterval(() => {
          const dt = Date.now() - t.startedAt;
          t.startedAt = Date.now();
          t.remainingMs = Math.max(0, t.remainingMs - dt);
          updateFocusUI();
          if (t.remainingMs === 0) {
            clearInterval(t.tickId);
            t.tickId = null;
            t.running = false;
            addNotification({ title:'Фокус‑таймер', body:'Время вышло. Отличная работа!', iconHtml: Icons.widgets('w-6 h-6'), source:'Виджеты' });
          }
        }, 250);
      } else {
        t.running = false;
        clearInterval(t.tickId);
        t.tickId = null;
      }
      updateFocusUI();
    }

    function focusReset(){
      const t = state.focusTimer;
      t.running = false;
      clearInterval(t.tickId);
      t.tickId = null;
      t.remainingMs = 25*60*1000;
      updateFocusUI();
    }

    // ---------- Run dialog ----------
    function openRunDialog(){
      hideAllPopovers();
      const d = $('#runDialog');
      d.classList.remove('hidden');
      $('#runInput').value = '';
      setTimeout(() => $('#runInput').focus(), 50);
    }

    function runCommand(cmd){
      const c = (cmd||'').trim();
      if (!c) return;
      if (registry[c]) { openApp(c); hideAllPopovers(); return; }
      if (c.startsWith('win://')) { openApp('edge', { url: c }); hideAllPopovers(); return; }
      if (isProbablyUrl(c)) { openApp('edge', { url: c }); hideAllPopovers(); return; }
      openApp('edge', { url: 'yandex:' + c });
      hideAllPopovers();
    }

    // ---------- Boot ----------
    function boot(){
      fsMigrateAndEnsureDefaults();

      // Ensure multimedia apps are available (migration for older saves)
      // They are in Store but should work out-of-the-box for this build.
      try {
        ['photos','musicPlayer','stickyNotes'].forEach(id => state.installedApps.add(id));
        persistUI();
      } catch {}

      applyUI();
      renderDesktopIcons();
      updateTaskbar();
      tickClock();
      setInterval(tickClock, 1000);

      // Apply account name to Start menu + lock screen
      try {
        const nm = state.account?.username || 'Локальный пользователь';
        const btnUser = $('#btnUser');
        if (btnUser) {
          const label = btnUser.querySelector('span.text-sm');
          if (label) label.textContent = nm;
        }
        const lockName = $('#lockUserName');
        if (lockName) lockName.textContent = nm;
      } catch {}

      // If password exists — show lock overlay after boot
      if (state.account?.password) {
        const lock = $('#lockOverlay');
        if (lock) {
          lock.style.display = 'flex';
          const inp = $('#lockPass');
          const err = $('#lockError');
          const tryUnlock = () => {
            const v = String(inp?.value || '');
            if (v === String(state.account.password)) {
              if (err) err.classList.add('hidden');
              lock.style.display = 'none';
              if (inp) inp.value = '';

              // Enable developer mode only for specific credentials
              const un = String(state.account?.username || '').trim();
              const pw = String(state.account?.password || '').trim();
              state.devMode = (un === 'Врискас' && pw === '2468');
              if (state.devMode) {
                addNotification({ title:'Режим разработчика', body:'Активирован. Доступно меню разработчика.', iconHtml: Icons.win('w-6 h-6'), source:'Система' });
              }

              // Update Start menu dev button visibility if present
              try{
                const devBtn = document.getElementById('btnDev');
                if (devBtn) devBtn.style.display = state.devMode ? '' : 'none';
              }catch{}

              addNotification({ title:'Вход', body:'Добро пожаловать!', iconHtml: Icons.user('w-6 h-6'), source:'Система' });
            } else {
              if (err) err.classList.remove('hidden');
              SFX.error();
            }
          };
          const btn = $('#btnUnlock');
          if (btn) btn.onclick = (e) => { e?.stopPropagation?.(); tryUnlock(); };
          if (inp) inp.onkeydown = (e) => { if (e.key === 'Enter') { e.preventDefault(); tryUnlock(); } };
          setTimeout(() => inp && inp.focus(), 50);
        }
      }

      // Mobile warning (notifications only, no blocking)
      try {
        const warnedKey = 'w12_phone_warned_v1';
        const isCoarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
        const isPhoneLike = (window.innerWidth <= 520) && isCoarse;
        if (isPhoneLike && !localStorage.getItem(warnedKey)) {
          localStorage.setItem(warnedKey, '1');
          addNotification({
            title: 'Предупреждение',
            body: 'Похоже, вы используете телефон. На маленьком экране симуляция может лагать или работать менее удобно.',
            iconHtml: Icons.win('w-6 h-6'),
            source: 'Система'
          });
        }
      } catch {}

      // Welcome notification (only in notification center)
      setTimeout(() => {
        addNotification({
          title: 'Windows 12',
          body: 'Симуляция готова: мультивыделение иконок, синхронизация Проводника с рабочим столом, Microsoft Store, мультимедиа (Фото/Музыка), кастомизация и темы.',
          iconHtml: Icons.win('w-6 h-6'),
          source: 'Система'
        });
      }, 400);

      // New Year fireworks scheduler (auto at Jan 1 00:00)
      try { scheduleNewYearFireworks(); } catch {}

      // Fullscreen preference: requires user gesture in most browsers
      if (state.fullscreenPref && !isBrowserFullscreen()) {
        addNotification({
          title: 'Параметры',
          body: 'Включение полноэкранного режима требует действия пользователя. Кликните по экрану, чтобы включить.',
          iconHtml: registry.settings.iconHtml,
          source: 'Параметры'
        });
        const once = async () => {
          document.removeEventListener('pointerdown', once, true);
          await setBrowserFullscreen(true);
        };
        document.addEventListener('pointerdown', once, true);
      }

      // Bind UI events
      $('#btnStart').addEventListener('click', (e) => { e.stopPropagation(); toggleStart(); });
      $('#btnSearch').addEventListener('click', (e) => { e.stopPropagation(); toggleSearchFlyout(); });
      // tray: quick settings by default, but clock/date open calendar
      $('#btnTray').addEventListener('click', (e) => { e.stopPropagation(); toggleQuickSettings(); });
      $('#clock').addEventListener('click', (e) => { e.stopPropagation(); toggleCalendar(); });
      $('#date').addEventListener('click', (e) => { e.stopPropagation(); toggleCalendar(); });

      // Calendar navigation
      $('#btnCalPrev').addEventListener('click', (e) => {
        e.stopPropagation();
        calState.m -= 1;
        if (calState.m < 0) { calState.m = 11; calState.y -= 1; }
        renderCalendar();
      });
      $('#btnCalNext').addEventListener('click', (e) => {
        e.stopPropagation();
        calState.m += 1;
        if (calState.m > 11) { calState.m = 0; calState.y += 1; }
        renderCalendar();
      });
      $('#btnCalToday').addEventListener('click', (e) => {
        e.stopPropagation();
        const now = new Date();
        calState.y = now.getFullYear();
        calState.m = now.getMonth();
        calState.selected = `${calState.y}-${calState.m}-${now.getDate()}`;
        renderCalendar();
      });

      $('#btnNotifs').addEventListener('click', (e) => { e.stopPropagation(); toggleNotifCenter(); });
      $('#btnWidgets').addEventListener('click', (e) => { e.stopPropagation(); toggleWidgets(); });
      $('#btnWidgetsClose').addEventListener('click', (e) => { e.stopPropagation(); hideAllPopovers(); });

      $('#btnSearchClose').addEventListener('click', (e) => { e.stopPropagation(); hideAllPopovers(); });

      $('#startSearch').addEventListener('input', (e) => renderStartSearch(e.target.value));
      $('#startSearch').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const q = e.target.value.trim().toLowerCase();
          const match = Object.values(registry).find(a => a.name.toLowerCase().includes(q) || a.id.includes(q));
          if (match) { openApp(match.id); hideAllPopovers(); }
        }
      });

      $('#globalSearch').addEventListener('input', (e) => renderGlobalSearch(e.target.value));
      $('#globalSearch').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const q = e.target.value.trim().toLowerCase();
          const matchApp = Object.values(registry).find(a => a.name.toLowerCase().includes(q) || a.id.includes(q));
          const matchFile = Object.values(fs.files).find(f => (f.name||'').toLowerCase().includes(q));
          if (matchApp) { openApp(matchApp.id); hideAllPopovers(); }
          else if (matchFile) { openNotepadWithFile(matchFile.id); hideAllPopovers(); }
        }
      });

      $('#btnStartAll').addEventListener('click', () => {
        openApp('explorer');
        addNotification({ title:'Пуск', body:'Открыт «Проводник» (демо вместо списка «Все приложения»).', iconHtml: Icons.win('w-6 h-6'), source:'Пуск' });
        hideAllPopovers();
      });

      $('#btnClearRecent').addEventListener('click', () => {
        state.recent = [];
        persistUI();
        renderRecommended();
        addNotification({ title:'Пуск', body:'Недавние элементы очищены.', iconHtml: Icons.win('w-6 h-6'), source:'Пуск' });
      });

      $('#btnPower').addEventListener('click', (e) => {
        e.stopPropagation();
        $('#powerMenu').classList.toggle('hidden');
      });

      // Developer menu (only for devMode)
      function toggleDevMenu(){
        const m = $('#devMenu');
        const showing = !m.classList.contains('hidden');
        hideAllPopovers();
        if (!state.devMode) return;
        if (!showing) m.classList.remove('hidden');
      }

      const devBtn = $('#btnDev');
      if (devBtn) {
        devBtn.style.display = state.devMode ? '' : 'none';
        devBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleDevMenu(); });
      }
      const devClose = $('#btnDevClose');
      if (devClose) devClose.addEventListener('click', (e) => { e.stopPropagation(); hideAllPopovers(); });

      const devFire = $('#btnDevFireworks');
      if (devFire) devFire.addEventListener('click', (e) => { e.stopPropagation(); startFireworks({ durationMs: 15000 }); hideAllPopovers(); });

      const devNY = $('#btnDevToggleNY');
      if (devNY) devNY.addEventListener('click', (e) => {
        e.stopPropagation();
        state.newYear = !state.newYear;
        persistUI();
        applyUI();
      });

      const devLiquid = $('#btnDevToggleLiquid');
      if (devLiquid) devLiquid.addEventListener('click', (e) => {
        e.stopPropagation();
        ui.glassMode = (ui.glassMode === 'liquid') ? 'default' : 'liquid';
        persistUI();
        applyUI();
      });

      const devToast = $('#btnDevToastTest');
      if (devToast) devToast.addEventListener('click', (e) => {
        e.stopPropagation();
        addNotification({ title:'Dev', body:'Тест уведомления/пасхалки.', iconHtml: Icons.win('w-6 h-6'), source:'Dev menu' });
      });

      $('#powerMenu').addEventListener('click', (e) => {
        const btn = e.target.closest('[data-power]');
        if (!btn) return;
        powerAction(btn.getAttribute('data-power'));
      });

      $('#btnOpenSettings').addEventListener('click', () => { openApp('settings', { section:'network' }); hideAllPopovers(); });

      $$('.qs-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
          const k = btn.getAttribute('data-toggle');
          setToggle(k, !state.toggles[k]);
          renderQuickSettings();
        });
      });

      $('#volSlider').value = String(state.volume);
      $('#volSlider').addEventListener('input', (e) => {
        state.volume = Number(e.target.value);
        persistUI();
        updateTaskbar();
      });

      $('#btnClearNotifs').addEventListener('click', () => {
        state.notifications = [];
        renderNotifCenter();
        updateTaskbar();
      });

      // Widgets handlers
      $('#btnBoost').addEventListener('click', () => {
        addNotification({ title:'Виджеты', body:'Оптимизация выполнена (демо).', iconHtml: Icons.widgets('w-6 h-6'), source:'Виджеты' });
        renderWidgets();
      });
      $('#btnTipNext').addEventListener('click', () => { tipIdx++; renderWidgets(); });
      $('#btnOpenRun').addEventListener('click', () => openRunDialog());
      $('#btnFocusStart').addEventListener('click', () => focusStartPause());
      $('#btnFocusReset').addEventListener('click', () => focusReset());

      // Run dialog
      $('#btnRunCancel').addEventListener('click', () => hideAllPopovers());
      $('#btnRunOk').addEventListener('click', () => runCommand($('#runInput').value));
      $('#runInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); runCommand($('#runInput').value); }
        if (e.key === 'Escape') { e.preventDefault(); hideAllPopovers(); }
      });

      // Desktop click deselect
      $('#desktop').addEventListener('click', (e) => {
        if (!DESKTOP_SELECTION_ENABLED) return;
        const target = (e.target instanceof Element) ? e.target : e.target?.parentElement;
        if (!target) return;
        // Don't clear selection when interacting with any flyout/context menu
        if (target.closest('.desktop-icon') || target.closest('[data-win]') || target.closest('#taskbar') || target.closest('.flyout')) return;
        clearSelection();
      });

      document.addEventListener('pointerdown', clickOutsideHandler);

      // Prevent context menus from closing before item click
      $('#iconMenu').addEventListener('pointerdown', (e) => e.stopPropagation());
      $('#iconMenu').addEventListener('click', (e) => e.stopPropagation());
      $('#ctxMenu').addEventListener('pointerdown', (e) => e.stopPropagation());
      $('#ctxMenu').addEventListener('click', (e) => e.stopPropagation());

      // Desktop context menu
      $('#desktop').addEventListener('contextmenu', (e) => {
        const target = (e.target instanceof Element) ? e.target : e.target?.parentElement;
        if (!target) return;
        if (target.closest('[data-win]') || target.closest('#taskbar') || target.closest('#startMenu') || target.closest('#searchFlyout') || target.closest('#quickSettings') || target.closest('#notifCenter') || target.closest('#widgetsFlyout') || target.closest('#runDialog') || target.closest('.desktop-icon') || target.closest('.flyout')) {
          return;
        }
        e.preventDefault();
        showCtxMenu(e.clientX, e.clientY);
      });

      $('#ctxMenu').addEventListener('click', (e) => {
        const btn = e.target.closest('[data-action]');
        if (!btn) return;
        const act = btn.getAttribute('data-action');
        if (act === 'refresh') doRefresh();
        if (act === 'new-folder') createDesktopFolder();
        if (act === 'new-note') createDesktopNote();
        if (act === 'personalize') openApp('settings', { section:'personal' });
        hideAllPopovers();
      });

      // Sleep overlay wake
      function wake(){
        $('#sleepOverlay').style.display = 'none';
        addNotification({ title:'Питание', body:'Выход из сна.', iconHtml: Icons.power('w-6 h-6'), source:'Система' });
      }
      $('#sleepOverlay').addEventListener('click', wake);
      document.addEventListener('keydown', (e) => {
        if ($('#sleepOverlay').style.display === 'flex') {
          e.preventDefault();
          wake();
        }
      }, { capture: true });

      // Shutdown overlay cancel
      $('#btnShutdownCancel').addEventListener('click', hideShutdown);

      // Selection rectangle (desktop)
      if (DESKTOP_SELECTION_ENABLED) {
        const desk = $('#desktop');
        let selPid = null;

        desk.addEventListener('pointerdown', (e) => {
          if (e.button !== 0) return;
          const target = (e.target instanceof Element) ? e.target : e.target?.parentElement;
          if (!target) return;
          // IMPORTANT: menus/flyouts live inside #desktop too, so don't start selection there
          if (target.closest('.desktop-icon') || target.closest('[data-win]') || target.closest('#taskbar') || target.closest('.flyout')) return;

          // Only now prevent defaults (so we don't break clicks inside apps)
          e.preventDefault();

          hideAllPopovers();
          clearSelection();
          startSelection(e);
          selPid = e.pointerId;
          try { desk.setPointerCapture(e.pointerId); } catch {}
        });

        desk.addEventListener('pointermove', (e) => {
          if (selPid == null || e.pointerId !== selPid) return;
          updateSelection(e);
        });

        const endSel = (e) => {
          if (selPid == null || e.pointerId !== selPid) return;
          try { desk.releasePointerCapture(e.pointerId); } catch {}
          selPid = null;
          endSelection();
        };

        desk.addEventListener('pointerup', endSel);
        desk.addEventListener('pointercancel', endSel);
      }

      // Taskbar reveal on bottom edge when autohide
      window.addEventListener('pointermove', (e) => {
        if (!document.body.classList.contains('tb-autohide')) return;
        const margin = 8;
        if (e.clientY > window.innerHeight - margin) revealTaskbar();
      });
      $('#taskbar').addEventListener('pointerenter', () => {
        if (document.body.classList.contains('tb-autohide')) document.body.classList.add('tb-reveal');
      });
      $('#taskbar').addEventListener('pointerleave', () => {
        if (document.body.classList.contains('tb-autohide')) {
          clearTimeout(tbHideTimer);
          tbHideTimer = setTimeout(() => document.body.classList.remove('tb-reveal'), 700);
        }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          hideAllPopovers();
          hideTaskContextMenu();
        }
        if (e.key === 'F5') {
          e.preventDefault();
          doRefresh();
        }

        if ((e.key === 'Meta' || e.key === 'OS') && !e.repeat) {
          e.preventDefault();
          toggleStart();
        }

        if (e.metaKey && e.key.toLowerCase() === 'r') {
          e.preventDefault();
          openRunDialog();
        }

        if (e.altKey && e.key === 'Tab') {
          e.preventDefault();
          altTab();
        }
      });

      // Fullscreen state sync
      document.addEventListener('fullscreenchange', () => {
        state.fullscreenPref = isBrowserFullscreen();
        persistUI();
      });

      // Liquid Glass pointer highlight (rAF-throttled)
      let lgRAF = null;
      window.addEventListener('pointermove', (e) => {
        if ((ui.glassMode || 'default') !== 'liquid') return;
        if (lgRAF) return;
        lgRAF = requestAnimationFrame(() => {
          lgRAF = null;
          const xp = clamp((e.clientX / Math.max(1, window.innerWidth)) * 100, 0, 100).toFixed(2) + '%';
          const yp = clamp((e.clientY / Math.max(1, window.innerHeight)) * 100, 0, 100).toFixed(2) + '%';
          document.documentElement.style.setProperty('--pointer-xp', xp);
          document.documentElement.style.setProperty('--pointer-yp', yp);
        });
      }, { passive: true });

      // window resize
      window.addEventListener('resize', () => {
        for (const w of state.windows.values()) {
          if (w.maximized) {
            maximizeWindow(w.id, true);
          } else {
            const area = desktopWorkAreaRect();
            w.rect.x = clamp(w.rect.x, 0, area.w - w.rect.w);
            w.rect.y = clamp(w.rect.y, 0, area.h - w.rect.h);
            const el = document.querySelector(`[data-win="${w.id}"]`);
            if (el) applyRect(el, w.rect);
          }
        }
      });

      renderQuickSettings();
      renderNotifCenter();
      $('#volSlider').value = String(state.volume);
      updateTaskbar();

      // periodic widget refresh when opened
      setInterval(() => {
        if (!$('#widgetsFlyout').classList.contains('hidden')) renderWidgets();
      }, 1500);
    }

    function startBootSequence(){
      // ensure logo is rendered immediately
      initStaticIcons();

      const ov = document.getElementById('bootOverlay');
      if (!ov) { boot(); return; }

      // keep overlay visible for ~5 seconds, then fade out and boot
      const ms = 5000;
      setTimeout(() => {
        ov.classList.add('boot-out');
        setTimeout(() => {
          ov.classList.add('hidden');
          boot();
        }, 260);
      }, ms);
    }

    startBootSequence();
  </script>
</body>
</html>
